!!!
%html
  %head
    %title= content_for(:title) || "OurGruuv"
    %meta{name: "viewport", content: "width=device-width,initial-scale=1"}
    %meta{name: "apple-mobile-web-app-capable", content: "yes"}
    %meta{name: "mobile-web-app-capable", content: "yes"}
    = csrf_meta_tags
    = csp_meta_tag

    = yield :head

    / Enable PWA manifest for installable apps
    = tag.link rel: "manifest", href: pwa_manifest_path(format: :json)

    / Favicon links for all devices and browsers
    %link{rel: "icon", href: "/favicon.ico", type: "image/x-icon"}
    %link{rel: "icon", href: "/favicon-16x16.png", type: "image/png", sizes: "16x16"}
    %link{rel: "icon", href: "/favicon-32x32.png", type: "image/png", sizes: "32x32"}
    %link{rel: "apple-touch-icon", href: "/apple-touch-icon.png"}
    %link{rel: "icon", href: "/android-chrome-192x192.png", sizes: "192x192", type: "image/png"}
    %link{rel: "icon", href: "/android-chrome-512x512.png", sizes: "512x512", type: "image/png"}

    / Includes all stylesheet files in app/assets/stylesheets
    = stylesheet_link_tag "application", "data-turbo-track": "reload"
    = javascript_importmap_tags
    
    / Highcharts for charts
    %script{src: "https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.3.0/highcharts.js", defer: true}

  %body
    / Toast Container
    .toast-container.position-fixed.top-0.end-0.p-3{style: "z-index: 1055;"}
      - if notice
        .toast.align-items-center.text-white.bg-success.border-0{role: "alert", "aria-live": "assertive", "aria-atomic": "true", "data-bs-autohide": "true", "data-bs-delay": "5000"}
          .d-flex
            .toast-body
              %i.bi.bi-check-circle.me-2
              = notice
            %button.btn-close.btn-close-white.me-2.m-auto{type: "button", "data-bs-dismiss": "toast", "aria-label": "Close"}
      
      - if alert
        .toast.align-items-center.text-white.bg-danger.border-0{role: "alert", "aria-live": "assertive", "aria-atomic": "true", "data-bs-autohide": "true", "data-bs-delay": "5000"}
          .d-flex
            .toast-body
              %i.bi.bi-exclamation-triangle.me-2
              = alert
            %button.btn-close.btn-close-white.me-2.m-auto{type: "button", "data-bs-dismiss": "toast", "aria-label": "Close"}
      
      - if flash[:error]
        .toast.align-items-center.text-white.bg-danger.border-0{role: "alert", "aria-live": "assertive", "aria-atomic": "true", "data-bs-autohide": "true", "data-bs-delay": "5000"}
          .d-flex
            .toast-body
              %i.bi.bi-x-circle.me-2
              = flash[:error]
            %button.btn-close.btn-close-white.me-2.m-auto{type: "button", "data-bs-dismiss": "toast", "aria-label": "Close"}
    
    / Main Navigation
    %nav.navbar.navbar-expand-lg.navbar-dark.bg-primary
      .container
        - if current_person && current_organization
          = link_to dashboard_organization_path(current_organization), class: "navbar-brand fw-bold" do
            = "#{current_organization.display_name}'s Gruuv"
        - else
          = link_to "OurGruuv", root_path, class: "navbar-brand fw-bold"
        
        %button.navbar-toggler{type: "button", "data-bs-toggle": "collapse", "data-bs-target": "#navbarMain", "aria-controls": "navbarMain", "aria-expanded": "false", "aria-label": "Toggle navigation"}
          %span.navbar-toggler-icon
        
        .collapse.navbar-collapse#navbarMain
          %ul.navbar-nav.me-auto
            %li.nav-item.dropdown
              %a.nav-link.dropdown-toggle{href: "#", role: "button", "data-bs-toggle": "dropdown", "aria-expanded": "false"}
                Align
              %ul.dropdown-menu
                - if current_organization
                  -#%li= link_to "Observations", organization_observations_path(current_organization), class: "dropdown-item"
                  %li= link_to "Milestones", organization_abilities_path(current_organization), class: "dropdown-item"
                  %li= link_to "Accountability", accountability_path, class: "dropdown-item"
                  %li= link_to "Positions", organization_positions_path(current_organization), class: "dropdown-item"
            
            %li.nav-item.dropdown
              %a.nav-link.dropdown-toggle{href: "#", role: "button", "data-bs-toggle": "dropdown", "aria-expanded": "false"}
                Collab
              %ul.dropdown-menu
                %li= link_to "Oppties", good_issues_coming_soon_path, class: "dropdown-item"
                %li= link_to "D<=>C", diverge_converge_coming_soon_path, class: "dropdown-item"
                %li= link_to "Huddles", huddles_path, class: "dropdown-item"

            %li.nav-item.dropdown
              %a.nav-link.dropdown-toggle{href: "#", role: "button", "data-bs-toggle": "dropdown", "aria-expanded": "false"}
                Transform
              %ul.dropdown-menu
                %li= link_to "Signals", team_signals_coming_soon_path, class: "dropdown-item"
                %li= link_to "Hypotheses", hypothesis_management_coming_soon_path, class: "dropdown-item"
                %li= link_to "OKR3s", okr3_management_coming_soon_path, class: "dropdown-item"
          
          %ul.navbar-nav
            - if current_person
              %li.nav-item.me-3
                = link_to search_path, class: "nav-link", title: "Search" do
                  %i.bi.bi-search
              %li.nav-item.dropdown
                %a.nav-link.dropdown-toggle{href: "#", role: "button", "data-bs-toggle": "dropdown", "aria-expanded": "false"}
                  - if impersonating?
                    %i.bi.bi-exclamation-triangle.text-warning.me-1
                  %i.bi.bi-person-circle.me-1
                  = current_person.full_name
                %ul.dropdown-menu.dropdown-menu-end
                  - if impersonating?
                    %li
                      = button_to impersonation_path(1), method: :delete, class: "dropdown-item text-danger", form: { style: "display: inline;" } do
                        %i.bi.bi-person-x.me-2
                        Stop Impersonation
                    %li
                      %hr.dropdown-divider
                  %li= link_to "My Profile", profile_path, class: "dropdown-item"
                  - if current_organization
                    %li= link_to "Home / Dashboard", dashboard_organization_path(current_organization), class: "dropdown-item"
                  %li
                    %hr.dropdown-divider
                  - if current_organization
                    %li.dropdown-header
                      %small.text-muted Current Organization
                    %li
                      = link_to organization_path(current_organization), class: "dropdown-item text-primary" do
                        %i.bi.bi-building.me-2
                        = current_organization.display_name
                        - if current_organization.team?
                          %small.text-muted.ms-1= "(#{current_organization.parent&.name})"
                    %li
                      %hr.dropdown-divider
                  - else
                    %li.dropdown-header
                      %small.text-muted No Organization Selected
                    %li
                      %hr.dropdown-divider
                  - if current_organization
                    %li= link_to "View Teammates", organization_employees_path(current_organization), class: "dropdown-item"

                  %li= link_to "Switch Organization", switch_organizations_path, class: "dropdown-item"
                  - if current_person&.og_admin?
                    %li= link_to "Manage Organizations", organizations_path, class: "dropdown-item"
                    %li
                      %hr.dropdown-divider
                    %li= link_to "Interest Submissions", interest_submissions_path, class: "dropdown-item"
                  %li
                    %hr.dropdown-divider
                  %li= button_to "Logout", logout_path, method: :delete, class: "dropdown-item", form: { style: "display: inline;" }
    
    / Main Content Container with Structured Areas
    .container.mt-4
      / Header Area - Title (left) + Primary Action/View Switcher (right)
      - if content_for?(:header)
        .row.mb-1
          .col-12
            .d-flex.justify-content-between.align-items-center
              .flex-grow-1
                = yield :header
              -# TODO: Remove this once we have a consistent way to handle header actions
              - if content_for?(:header_action)
                .ms-3
                  = yield :header_action
              / Action Area - Top-right actions (optional, designed for 1 button but flexible)
              - if content_for?(:top_actions)
                .ms-3
                  = yield :top_actions
      
      / Navigation Area - "Back to X" links (optional)
      - if content_for?(:go_back_link)
        .row.mb-3
          .col-12
            = yield :go_back_link
      
      
      / Impersonation Warning Banner
      - if impersonating?
        .row.mb-3
          .col-12
            .alert.alert-warning.alert-dismissible.fade.show{role: "alert"}
              .d-flex.align-items-center
                %i.bi.bi-exclamation-triangle.me-2
                %strong.me-2 Impersonation Active
                %span You are currently impersonating #{current_person.display_name}. 
                %small.text-muted.ms-2 All actions will be performed as this user.
              %button.btn-close{type: "button", "data-bs-dismiss": "alert", "aria-label": "Close"}
              .mt-2
                = button_to impersonation_path(1), method: :delete, class: "btn btn-sm btn-outline-danger", form: { style: "display: inline;" } do
                  %i.bi.bi-person-x.me-1
                  Stop Impersonation
      
      / Content Area - Main page content
      = yield 
    
    / Participant Detail Modal
    .modal.fade#participantDetailModal{tabindex: "-1", "aria-labelledby": "participantDetailModalLabel", "aria-hidden": "true"}
      .modal-dialog.modal-lg
        .modal-content
          .modal-header
            %h5.modal-title#participantDetailModalLabel Participant Details
            %button.btn-close{type: "button", "data-bs-dismiss": "modal", "aria-label": "Close"}
          .modal-body
            .row
              .col-md-6
                %p
                  %strong Name:
                  %span#modalParticipantName
                %p
                  %strong Role:
                  %span#modalParticipantRole
                %p
                  %strong Status:
                  %span#modalParticipantStatus
              .col-md-6
                %h6 Ratings
                %p
                  %strong Informed:
                  %span#modalInformedRating
                %p
                  %strong Connected:
                  %span#modalConnectedRating
                %p
                  %strong Goals:
                  %span#modalGoalsRating
                %p
                  %strong Valuable:
                  %span#modalValuableRating
                %p
                  %strong Total Score:
                  %span#modalTotalScore
            .row.mt-3
              .col-md-6
                %h6 Personal Conflict Style
                %div#modalPersonalConflict
              .col-md-6
                %h6 Team Conflict Style
                %div#modalTeamConflict
            .row.mt-3
              .col-12
                %h6 Appreciation
                %div#modalAppreciation
            .row.mt-3
              .col-12
                %h6 Change Suggestion
                %div#modalChangeSuggestion
            .row.mt-3
              .col-12
                %h6 Private Feedback
                %div#modalPrivateFeedback
          .modal-footer
            %button.btn.btn-secondary{type: "button", "data-bs-dismiss": "modal"} Close

    / JavaScript content area
    = yield :javascript
