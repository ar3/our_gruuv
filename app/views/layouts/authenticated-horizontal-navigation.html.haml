!!!
%html
  %head
    = render partial: 'layouts/head_common', locals: { title_default: "OurGruuv" }

  %body
    = render partial: 'layouts/toast_container'
      
    
    / Main Navigation
    %nav.navbar.navbar-expand-lg.navbar-dark.bg-primary
      .container
        - if current_person && current_organization
          - if current_company_teammate
            = link_to about_me_organization_company_teammate_path(current_organization, current_company_teammate), class: "navbar-brand fw-bold" do
              = "#{current_organization.display_name}'s Gruuv"
          - else
            = link_to dashboard_organization_path(current_organization), class: "navbar-brand fw-bold" do
              = "#{current_organization.display_name}'s Gruuv"
        - else
          = link_to "OurGruuv", root_path, class: "navbar-brand fw-bold"
        
        %button.navbar-toggler{type: "button", "data-bs-toggle": "collapse", "data-bs-target": "#navbarMain", "aria-controls": "navbarMain", "aria-expanded": "false", "aria-label": "Toggle navigation"}
          %span.navbar-toggler-icon
        
        .collapse.navbar-collapse#navbarMain
          %ul.navbar-nav.me-auto  
            - if current_organization && current_person
              / Clarity dropdown
              %li.nav-item.dropdown
                %a.nav-link.dropdown-toggle{href: "#", role: "button", "data-bs-toggle": "dropdown", "aria-expanded": "false"}
                  Clarity
                %ul.dropdown-menu
                  - if current_organization.present? && policy(current_organization).show?
                    %li= link_to "Positions", organization_positions_path(current_organization), class: "dropdown-item"
                  - if policy(current_company).view_assignments?
                    %li= link_to "Assignments", organization_assignments_path(current_organization), class: "dropdown-item"
                  - if policy(Organization).show?
                    %li= link_to "View Teammates", organization_employees_path(current_organization), class: "dropdown-item"
                  - if current_company_teammate&.has_direct_reports? && policy(Organization).show?
                    %li= link_to "My Employees", organization_employees_path(current_organization, manager_teammate_id: current_company_teammate&.id, view: 'managers_view', spotlight: 'manager_lite'), class: "dropdown-item"
                  - if policy(current_organization).show?
                    %li= link_to "Departments", organization_departments_path(current_organization), class: "dropdown-item"
                  - if policy(current_company).view_goals?
                    %li= link_to "Goals", organization_goals_path(current_organization), class: "dropdown-item"
                  - if policy(current_company).view_abilities?
                    %li= link_to "Abilities", organization_abilities_path(current_organization), class: "dropdown-item"
                  - if policy(current_company).view_aspirations?
                    %li= link_to "Aspirational Values", organization_aspirations_path(current_organization), class: "dropdown-item"
                  - if policy(current_company).view_prompt_templates?
                    %li= link_to "Prompt Templates", organization_prompt_templates_path(current_organization), class: "dropdown-item"
                  - if policy(current_company).view_seats?
                    %li= link_to "Seats", organization_seats_path(current_organization), class: "dropdown-item"
                  %li= link_to "Accountability", accountability_path, class: "dropdown-item"
            
              / Challenge dropdown
              %li.nav-item.dropdown
                %a.nav-link.dropdown-toggle{href: "#", role: "button", "data-bs-toggle": "dropdown", "aria-expanded": "false"}
                  Challenge
                %ul.dropdown-menu
                  - if policy(current_organization).show?
                    %li= link_to "Celebrate Milestones", celebrate_milestones_organization_path(current_organization), class: "dropdown-item"
                  %li
                    = link_to hypothesis_management_coming_soon_path, class: "dropdown-item" do
                      Hypotheses
                      %span.badge.bg-secondary.ms-2 Coming Soon
                  %li
                    = link_to okr3_management_coming_soon_path, class: "dropdown-item" do
                      OKR3s
                      %span.badge.bg-secondary.ms-2 Coming Soon
                  %li
                    = link_to team_signals_coming_soon_path, class: "dropdown-item" do
                      Signals
                      %span.badge.bg-secondary.ms-2 Coming Soon
                  %li
                    = link_to good_issues_coming_soon_path, class: "dropdown-item" do
                      Oppties
                      %span.badge.bg-secondary.ms-2 Coming Soon
                  %li
                    = link_to diverge_converge_coming_soon_path, class: "dropdown-item" do
                      D<=>C
                      %span.badge.bg-secondary.ms-2 Coming Soon
            
              / Continuous Feedback dropdown
              %li.nav-item.dropdown
                %a.nav-link.dropdown-toggle{href: "#", role: "button", "data-bs-toggle": "dropdown", "aria-expanded": "false"}
                  Continuous Feedback
                %ul.dropdown-menu
                  - if current_company_teammate && policy(current_company_teammate).view_check_ins?
                    %li= link_to "About Me", about_me_organization_company_teammate_path(current_organization, current_company_teammate), class: "dropdown-item"
                  - if current_company_teammate && policy(current_company_teammate).view_check_ins?
                    %li= link_to "My Check-In", organization_company_teammate_check_ins_path(current_organization, current_company_teammate), class: "dropdown-item"
                  - if policy(current_company).view_observations?
                    %li= link_to "Observations", organization_observations_path(current_organization), class: "dropdown-item"
                  - if policy(current_company).view_prompts?
                    %li= link_to company_label_plural('prompt', 'Prompts'), organization_prompts_path(current_organization), class: "dropdown-item"
                  - if policy(current_organization).show?
                    %li= link_to "Huddle Review", huddles_review_organization_path(current_organization), class: "dropdown-item"
                  - if policy(Huddle).show?
                    %li= link_to "My Huddles", my_huddles_path, class: "dropdown-item"
                  - if policy(Huddle).show?
                    %li= link_to "Today's Huddles", huddles_path, class: "dropdown-item"
            
              / Admin dropdown
              %li.nav-item.dropdown
                %a.nav-link.dropdown-toggle{href: "#", role: "button", "data-bs-toggle": "dropdown", "aria-expanded": "false"}
                  Admin
                %ul.dropdown-menu
                  - if policy(current_organization).manage_employment?
                    %li= link_to "Slack Settings", organization_slack_path(current_organization), class: "dropdown-item"
                  - if policy(current_company).view_feedback_requests?
                    %li= link_to "Feedback Requests", organization_feedback_requests_path(current_organization), class: "dropdown-item"
                  - if policy(current_company).customize_company?
                    %li= link_to "#{current_company.name} Preferences", edit_organization_company_preference_path(current_organization), class: "dropdown-item"
                  - if policy(current_company).view_bulk_sync_events?
                    %li= link_to "Bulk Events", organization_bulk_sync_events_path(current_organization), class: "dropdown-item"
                  - if policy(current_company).view_bulk_sync_events?
                    %li= link_to "Bulk Downloads", organization_bulk_downloads_path(current_organization), class: "dropdown-item"
                  - if policy(current_organization).manage_employment?
                    %li= link_to "Check-ins Health", organization_check_ins_health_path(current_organization), class: "dropdown-item"
                  - if current_company_teammate
                    - about_me_path = about_me_organization_company_teammate_path(current_organization, current_company_teammate)
                    - company_name = current_company&.name || current_organization&.name || 'OurGruuv'
                    - help_improve_path = interest_submissions_path(return_url: about_me_path, return_text: "back to #{company_name}'s Gruuv")
                    %li= link_to "Help Improve OG", help_improve_path, class: "dropdown-item"

            %li.nav-item.dropdown
              %a.nav-link.dropdown-toggle{href: "#", role: "button", "data-bs-toggle": "dropdown", "aria-expanded": "false"}
                Recently Visited
              %ul.dropdown-menu
                - if recent_page_visits.any?
                  - recent_page_visits.each do |visit|
                    %li= link_to visit.page_title, visit.url, class: "dropdown-item"
                - elsif current_organization
                  %li= link_to "Dashboard", dashboard_organization_path(current_organization), class: "dropdown-item"
                - else
                  %li.dropdown-item.text-muted No recent visits
              
          %ul.navbar-nav
            - if current_person
              %li.nav-item.me-3
                - if current_organization
                  = link_to organization_search_path(current_organization), class: "nav-link", title: "Search" do
                    %i.bi.bi-search
              %li.nav-item.dropdown
                %a.nav-link.dropdown-toggle{href: "#", role: "button", "data-bs-toggle": "dropdown", "aria-expanded": "false"}
                  - if impersonating?
                    %i.bi.bi-exclamation-triangle.text-warning.me-1
                  %i.bi.bi-person-circle.me-1
                  = current_person.full_name
                  - if current_organization && current_company_teammate
                    - pending_count = pending_get_shit_done_count(current_company_teammate)
                    - if pending_count > 0
                      = link_to organization_get_shit_done_path(current_organization), class: "badge bg-danger rounded-pill ms-2 text-decoration-none", title: "Get Shit Done (#{pending_count} items)" do
                        = pending_count
                %ul.dropdown-menu.dropdown-menu-end
                  - if impersonating?
                    %li
                      = button_to impersonation_path(1), method: :delete, class: "dropdown-item text-danger", form: { style: "display: inline;" } do
                        %i.bi.bi-person-x.me-2
                        Stop Impersonation
                    %li
                      %hr.dropdown-divider
                  - if current_organization
                    %li= link_to "My Profile", organization_company_teammate_path(current_organization, current_company_teammate), class: "dropdown-item"
                  - else
                    %li= link_to "My Profile", public_person_path(current_person), class: "dropdown-item"
                  - if current_organization
                    %li= link_to "Home / Dashboard", dashboard_organization_path(current_organization), class: "dropdown-item"
                  %li
                    %hr.dropdown-divider
                  - if current_organization
                    %li.dropdown-header
                      %small.text-muted Current Organization
                    %li
                      = link_to organization_path(current_organization), class: "dropdown-item text-primary" do
                        %i.bi.bi-building.me-2
                        = current_organization.display_name
                    %li
                      %hr.dropdown-divider
                  - else
                    %li.dropdown-header
                      %small.text-muted No Organization Selected
                    %li
                      %hr.dropdown-divider
                  - if current_organization
                    %li= link_to "View Teammates", organization_employees_path(current_organization), class: "dropdown-item"
                    - if current_organization && policy(current_organization).manage_employment?
                      %li= link_to "Check-ins Health", organization_check_ins_health_path(current_organization), class: "dropdown-item"
                    - if current_company_teammate&.has_direct_reports?
                      %li= link_to "My Employees", organization_employees_path(current_organization, manager_teammate_id: current_company_teammate&.id, view: 'managers_view', spotlight: 'manager_lite'), class: "dropdown-item"

                  / Layout switcher
                  %li
                    %hr.dropdown-divider
                  %li.dropdown-header
                    %small.text-muted Navigation Layout
                  %li
                    = button_to layout_user_preferences_path, method: :patch, params: { layout: 'horizontal' }, class: "dropdown-item #{'active' if current_user_preferences&.layout == 'horizontal'}", form: { style: "display: inline;" } do
                      %i.bi.bi-list.me-2
                      Horizontal Navigation
                  %li
                    = button_to layout_user_preferences_path, method: :patch, params: { layout: 'vertical' }, class: "dropdown-item #{'active' if current_user_preferences&.layout == 'vertical'}", form: { style: "display: inline;" } do
                      %i.bi.bi-layout-sidebar.me-2
                      Vertical Navigation
                  
                  %li= link_to "Switch Organization", switch_organizations_path, class: "dropdown-item"
                  - if current_person&.og_admin?
                    %li= link_to "Manage Organizations", organizations_path, class: "dropdown-item"
                    %li
                      %hr.dropdown-divider
                    %li= link_to "Interest Submissions", interest_submissions_path, class: "dropdown-item"
                  %li
                    %hr.dropdown-divider
                  %li= button_to "Logout", logout_path, method: :delete, class: "dropdown-item", form: { style: "display: inline;" }
    
    / Main Content Container with Structured Areas
    .container.mt-4
      / Header Area - Title (left) + Primary Action/View Switcher (right)
      - if content_for?(:header)
        .row.mb-1
          .col-12
            .d-flex.justify-content-between.align-items-center
              .flex-grow-1
                = yield :header
              - if content_for?(:header_action)
                .ms-3
                  = yield :header_action
      
      / Navigation Area - "Back to X" links (optional)
      - if content_for?(:go_back_link)
        .row.mb-3
          .col-12
            = yield :go_back_link
      
      
      / Impersonation Warning Banner
      - if impersonating? && current_person
        .row.mb-3
          .col-12
            .alert.alert-warning.alert-dismissible.fade.show{role: "alert"}
              .d-flex.align-items-center
                %i.bi.bi-exclamation-triangle.me-2
                %strong.me-2 Impersonation Active
                %span You are currently impersonating #{current_person.display_name}. 
                %small.text-muted.ms-2 All actions will be performed as this user.
              %button.btn-close{type: "button", "data-bs-dismiss": "alert", "aria-label": "Close"}
              .mt-2
                = button_to impersonation_path(1), method: :delete, class: "btn btn-sm btn-outline-danger", form: { style: "display: inline;" } do
                  %i.bi.bi-person-x.me-1
                  Stop Impersonation
      
      / Content Area - Main page content
      = yield 
    / JavaScript content area
    = yield :javascript
