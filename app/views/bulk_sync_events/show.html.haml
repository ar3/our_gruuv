.container-fluid
  -# Define all data variables at the very top level for proper scope
  - preview_actions = @bulk_sync_event.preview_actions.is_a?(Hash) ? @bulk_sync_event.preview_actions : {}
  - results = @bulk_sync_event.results.is_a?(Hash) ? @bulk_sync_event.results : {}
  
  -# Back navigation
  .row.mb-3
    .col-12
      = link_to organization_bulk_sync_events_path(current_organization), class: "text-muted text-decoration-none" do
        %i.bi.bi-arrow-left.me-2
        Back to Bulk Sync Events
  
  -# Debug: Let's see what we're working with
  -# preview_actions_debug = preview_actions.inspect
  -# results_debug = results.inspect
  
  - people_data = Array(preview_actions&.dig('people'))
  - assignments_data = Array(preview_actions&.dig('assignments'))
  - tenures_data = Array(preview_actions&.dig('assignment_tenures'))
  - check_ins_data = Array(preview_actions&.dig('assignment_check_ins'))
  - external_refs_data = Array(preview_actions&.dig('external_references'))
  
  -# UploadEmployees data
  - managers_data = Array(preview_actions&.dig('managers'))
  - departments_data = Array(preview_actions&.dig('departments'))
  - unassigned_employees_data = Array(preview_actions&.dig('unassigned_employees'))
  - titles_data = Array(preview_actions&.dig('titles'))
  - positions_data = Array(preview_actions&.dig('positions'))
  - teammates_data = Array(preview_actions&.dig('teammates'))
  - employment_tenures_data = Array(preview_actions&.dig('employment_tenures'))
  
  -# RefreshNamesSync data
  - preferred_name_updates_data = Array(preview_actions&.dig('preferred_name_updates'))
  
  -# RefreshSlackSync data
  - update_slack_identities_data = Array(preview_actions&.dig('update_slack_identities'))
  - create_slack_associations_data = Array(preview_actions&.dig('create_slack_associations'))
  - suggest_terminations_data = Array(preview_actions&.dig('suggest_terminations'))
  
  -# EnsureAssignmentTenuresSync data
  - assignment_tenures_data = Array(preview_actions&.dig('assignment_tenures'))
  
  -# UploadAssignmentsAndAbilities data
  - assignments_upload_data = Array(preview_actions&.dig('assignments'))
  - abilities_upload_data = Array(preview_actions&.dig('abilities'))
  - assignment_abilities_data = Array(preview_actions&.dig('assignment_abilities'))
  - position_assignments_data = Array(preview_actions&.dig('position_assignments'))
  
  - successes_data = Array(results&.dig('successes'))
  - failures_data = Array(results&.dig('failures'))
  
  -# Ensure all variables are arrays and never nil - with explicit assignments
  - people_data = people_data.nil? ? [] : people_data
  - assignments_data = assignments_data.nil? ? [] : assignments_data
  - tenures_data = tenures_data.nil? ? [] : tenures_data
  - check_ins_data = check_ins_data.nil? ? [] : check_ins_data
  - external_refs_data = external_refs_data.nil? ? [] : external_refs_data
  - managers_data = managers_data.nil? ? [] : managers_data
  - departments_data = departments_data.nil? ? [] : departments_data
  - unassigned_employees_data = unassigned_employees_data.nil? ? [] : unassigned_employees_data
  - titles_data = titles_data.nil? ? [] : titles_data
  - positions_data = positions_data.nil? ? [] : positions_data
  - teammates_data = teammates_data.nil? ? [] : teammates_data
  - employment_tenures_data = employment_tenures_data.nil? ? [] : employment_tenures_data
  - successes_data = successes_data.nil? ? [] : successes_data
  - failures_data = failures_data.nil? ? [] : failures_data
  
  -# Final safety check - ensure all are arrays
  - people_data = people_data.is_a?(Array) ? people_data : []
  - assignments_data = assignments_data.is_a?(Array) ? assignments_data : []
  - tenures_data = tenures_data.is_a?(Array) ? tenures_data : []
  - check_ins_data = check_ins_data.is_a?(Array) ? check_ins_data : []
  - external_refs_data = external_refs_data.is_a?(Array) ? external_refs_data : []
  - managers_data = managers_data.is_a?(Array) ? managers_data : []
  - departments_data = departments_data.is_a?(Array) ? departments_data : []
  - unassigned_employees_data = unassigned_employees_data.is_a?(Array) ? unassigned_employees_data : []
  - titles_data = titles_data.is_a?(Array) ? titles_data : []
  - positions_data = positions_data.is_a?(Array) ? positions_data : []
  - teammates_data = teammates_data.is_a?(Array) ? teammates_data : []
  - employment_tenures_data = employment_tenures_data.is_a?(Array) ? employment_tenures_data : []
  - successes_data = successes_data.is_a?(Array) ? successes_data : []
  - failures_data = failures_data.is_a?(Array) ? failures_data : []
  - assignments_upload_data = assignments_upload_data.is_a?(Array) ? assignments_upload_data : []
  - abilities_upload_data = abilities_upload_data.is_a?(Array) ? abilities_upload_data : []
  - assignment_abilities_data = assignment_abilities_data.is_a?(Array) ? assignment_abilities_data : []
  - position_assignments_data = position_assignments_data.is_a?(Array) ? position_assignments_data : []
  
  .row
    .col-12
      -# Safety check - ensure we have valid data
      - if @bulk_sync_event.preview_actions.blank? && @bulk_sync_event.results.blank?
        .alert.alert-warning
          %strong No data available:
          This upload event doesn't have any preview actions or results to display.
      
      .d-flex.justify-content-between.align-items-center.mb-4
        %h1 Upload Details
        .d-flex.gap-2
          = link_to 'Back to Uploads', organization_bulk_sync_events_path(current_organization), class: 'btn btn-outline-secondary'
          - if @bulk_sync_event.can_destroy?
            = link_to 'Delete', organization_bulk_sync_event_path(current_organization, @bulk_sync_event), method: :delete, data: { confirm: 'Are you sure?' }, class: 'btn btn-outline-danger'
      
  .row
    .col-md-12
      .card.mb-4
        .card-header
          %h5.card-title.mb-0 Upload Information
        .card-body
          %dl.row
            %dt.col-sm-4 Status
            %dd.col-sm-8
              %span{class: "badge bg-#{@bulk_sync_event.status == 'completed' ? 'success' : @bulk_sync_event.status == 'failed' ? 'danger' : @bulk_sync_event.status == 'processing' ? 'warning' : 'secondary'}"}
                = @bulk_sync_event.status.humanize
            
            %dt.col-sm-4 Filename
            %dd.col-sm-8
              %code= @bulk_sync_event.filename
            
            %dt.col-sm-4 Created
            %dd.col-sm-8= format_time_in_user_timezone(@bulk_sync_event.created_at)
            
            %dt.col-sm-4 Creator
            %dd.col-sm-8= @bulk_sync_event.creator.display_name
            
            %dt.col-sm-4 Initiator
            %dd.col-sm-8= @bulk_sync_event.initiator.display_name
            
            - if @bulk_sync_event.attempted_at
              %dt.col-sm-4 Attempted
              %dd.col-sm-8= @bulk_sync_event.attempted_at.strftime('%B %d, %Y at %I:%M %p')
            
            - if @bulk_sync_event.completed?
              %dt.col-sm-4 Results
              %dd.col-sm-8
                %span.text-success= "#{@bulk_sync_event.success_count} successful"
                %br
                %span.text-danger= "#{@bulk_sync_event.failure_count} failed"
      
      .card.mb-4
        .card-header
          %h5.card-title.mb-0 Format Requirements
        .card-body
          .alert.alert-info.mb-0
            %h6.mb-2= "#{@bulk_sync_event.display_name} Format Requirements:"
            - if @bulk_sync_event.type == 'BulkSyncEvent::UploadAssignmentCheckins'
              %p.mb-1
                %strong Required columns:
                %code email
                and 
                %code assignment_name
              %p.mb-0
                %strong Optional columns:
                check_in_date, energy_percentage, manager_rating, employee_rating, official_rating, manager_private_notes, employee_private_notes
            - elsif @bulk_sync_event.type == 'BulkSyncEvent::UploadEmployees'
              %p.mb-1
                %strong Required columns:
                %code Name
                , 
                %code Email
                , and 
                %code Start Date
              %p.mb-0
                %strong Optional columns:
                Preferred Name, Location, Gender, Department, Employment Type, Manager, Country, Manager Email, Job Title, Job Title Level
            - elsif @bulk_sync_event.type == 'BulkSyncEvent::UploadAssignmentsAndAbilities'
              %p.mb-1
                %strong Required columns:
                %code Assignment
              %p.mb-0
                %strong Optional columns:
                Position(s), Team(s), Tagline, Outcomes, Abilities, Required Activities
            - elsif @bulk_sync_event.type == 'BulkSyncEvent::UploadAssignmentsBulk'
              %p.mb-1
                %strong Required columns:
                %code Assignment ID
                or 
                %code Title
              %p.mb-0
                %strong Optional columns:
                Tagline, Department, Positions, Milestones, Outcomes, Required Activities, Handbook, Version, Changes Count, Public URL, Created At, Updated At
            - elsif @bulk_sync_event.type == 'BulkSyncEvent::RefreshNamesSync'
              %p.mb-0
                This sync operation does not require a file upload. It will find all active company teammates where preferred_name is nil or empty, and set it to their first_name.
            - elsif @bulk_sync_event.type == 'BulkSyncEvent::RefreshSlackSync'
              %p.mb-0
                This sync operation does not require a file upload. It will:
                %ul.mb-0
                  %li Update existing Slack identities with latest data from Slack
                  %li Match unassociated company teammates to available Slack users
                  %li Suggest terminations for teammates whose Slack accounts are deleted, bots, or disabled
            - elsif @bulk_sync_event.type == 'BulkSyncEvent::EnsureAssignmentTenuresSync'
              %p.mb-0
                This sync operation does not require a file upload. It will ensure all active teammates have assignment tenures for all required assignments of their active employment tenure's position. Missing assignment tenures will be created with calculated energy percentages based on the position's assignment requirements.
            - else
              %p.mb-0.text-muted
                Format requirements not specified for this bulk event type.
      
      - if @bulk_sync_event.preview? && @bulk_sync_event.preview_actions.present?
        .card.mb-4
          .card-header
            %h5.card-title.mb-0 Preview Actions
            %p.text-muted.mb-0 Review the actions that will be taken and select which ones to process
          .card-body
            = form_with url: process_sync_organization_bulk_sync_event_path(current_organization, @bulk_sync_event), method: :post, local: true do |form|
              - if people_data.present?
                %h6 People (#{people_data.length})
                .table-responsive.mb-3
                  %table.table.table-sm
                    %thead
                      %tr
                        %th
                          = check_box_tag 'select_all_people', '1', true, class: 'form-check-input', data: { target: 'people-checkbox' }
                          %label.form-check-label.ms-1 Select All
                        %th Name
                        %th Email
                        %th Action
                        %th Existing Record
                        %th Row
                    %tbody
                      - people_data.each do |person|
                        %tr
                          %td
                            = check_box_tag "selected_people[]", person['row'], true, class: 'form-check-input people-checkbox'
                          %td= person['name']
                          %td= person['email']
                          %td
                            - if person['will_create']
                              %span.badge.bg-success New
                            - else
                              %span.badge.bg-warning Update
                          %td
                            - if person['existing_id']
                              = link_to person['existing_name'], organization_company_teammate_path(@organization || organization, person['existing_id']), class: 'text-decoration-none'
                            - else
                              %span.text-muted None
                          %td= person['row']
              
              - if assignments_data.present? && @bulk_sync_event.type != 'BulkSyncEvent::UploadAssignmentsAndAbilities'
                %h6 Assignments (#{assignments_data.length})
                .table-responsive.mb-3
                  %table.table.table-sm
                    %thead
                      %tr
                        %th
                          = check_box_tag 'select_all_assignments', '1', true, class: 'form-check-input', data: { target: 'assignments-checkbox' }
                          %label.form-check-label.ms-1 Select All
                        %th Assignment Name
                        %th Description
                        %th External Reference
                        %th Action
                        %th Existing Record
                        %th Row
                    %tbody
                      - assignments_data.each do |assignment|
                        -# Find external reference for this assignment
                        - external_ref = external_refs_data.find { |ref| ref['assignment_name'] == assignment['assignment_name'] }
                        %tr
                          %td
                            = check_box_tag "selected_assignments[]", assignment['row'], true, class: 'form-check-input assignments-checkbox'
                          %td= assignment['assignment_name']
                          %td= assignment['assignment_description']
                          %td
                            - if external_ref
                              = link_to external_ref['external_url'], external_ref['external_url'], target: '_blank', class: 'text-decoration-none'
                            - else
                              %span.text-muted None
                          %td
                            - if assignment['will_create']
                              %span.badge.bg-success New
                            - else
                              %span.badge.bg-warning Update
                          %td
                            - if assignment['existing_id']
                              = link_to assignment['existing_title'], organization_assignment_path(current_organization, assignment['existing_id']), class: 'text-decoration-none'
                            - else
                              %span.text-muted None
                          %td= assignment['row']
              
              - if tenures_data.present? && @bulk_sync_event.type != 'BulkSyncEvent::EnsureAssignmentTenuresSync'
                %h6 Assignment Tenures (#{tenures_data.length})
                .table-responsive.mb-3
                  %table.table.table-sm
                    %thead
                      %tr
                        %th
                          = check_box_tag 'select_all_tenures', '1', true, class: 'form-check-input', data: { target: 'tenures-checkbox' }
                          %label.form-check-label.ms-1 Select All
                        %th Person
                        %th Assignment
                        %th Energy %
                        %th Start Date
                        %th End Date
                        %th Action
                        %th Existing Record
                        %th Row
                    %tbody
                      - tenures_data.each do |tenure|
                        %tr
                          %td
                            = check_box_tag "selected_tenures[]", tenure['row'], true, class: 'form-check-input tenures-checkbox'
                          %td
                            - if tenure['person_reference']
                              %strong= tenure['person_reference']['name']
                              %br
                              %small.text-muted= tenure['person_reference']['email']
                            - else
                              %span.text-danger Missing person reference
                          %td
                            - if tenure['assignment_reference']
                              %strong= tenure['assignment_reference']['assignment_name']
                              %br
                              %small.text-muted= tenure['assignment_reference']['assignment_description']
                            - else
                              %span.text-danger Missing assignment reference
                          %td= tenure['anticipated_energy_percentage']
                          %td= tenure['assignment_tenure_start_date']
                          %td= tenure['assignment_tenure_end_date']
                          %td
                            - if tenure['will_create']
                              %span.badge.bg-success New
                            - else
                              %span.badge.bg-warning Update
                          %td
                            - if tenure['existing_id']
                              %span.text-muted Existing tenure
                            - else
                              %span.text-muted None
                          %td= tenure['row']
              
              - if check_ins_data.present?
                %h6 Assignment Check-Ins (#{check_ins_data.length})
                .table-responsive.mb-3
                  %table.table.table-sm
                    %thead
                      %tr
                        %th
                          = check_box_tag 'select_all_check_ins', '1', true, class: 'form-check-input', data: { target: 'check-ins-checkbox' }
                          %label.form-check-label.ms-1 Select All
                        %th Person
                        %th Assignment
                        %th Check-in Date
                        %th Energy %
                        %th Manager Rating
                        %th Employee Rating
                        %th Official Rating
                        %th Action
                        %th Existing Record
                        %th Row
                    %tbody
                      - check_ins_data.each do |check_in|
                        %tr
                          %td
                            = check_box_tag "selected_check_ins[]", check_in['row'], true, class: 'form-check-input check-ins-checkbox'
                          %td
                            - if check_in['person_reference']
                              %strong= check_in['person_reference']['name']
                              %br
                              %small.text-muted= check_in['person_reference']['email']
                            - else
                              %span.text-danger Missing person reference
                          %td
                            - if check_in['assignment_reference']
                              %strong= check_in['assignment_reference']['assignment_name']
                              %br
                              %small.text-muted= check_in['assignment_reference']['assignment_description']
                            - else
                              %span.text-danger Missing assignment reference
                          %td= check_in['check_in_date']
                          %td= check_in['energy_percentage']
                          %td= check_in['manager_rating']
                          %td= check_in['employee_rating']
                          %td= check_in['official_rating']
                          %td
                            - if check_in['will_create']
                              %span.badge.bg-success New
                            - else
                              %span.badge.bg-warning Update
                          %td
                            - if check_in['existing_id']
                              %span.text-muted Existing check-in
                            - else
                              %span.text-muted None
                          %td= check_in['row']
              
              - if external_refs_data.present?
                %h6 External References (#{external_refs_data.length})
                .table-responsive.mb-3
                  %table.table.table-sm
                    %thead
                      %tr
                        %th
                          = check_box_tag 'select_all_external_refs', '1', true, class: 'form-check-input', data: { target: 'external-refs-checkbox' }
                          %label.form-check-label.ms-1 Select All
                        %th Assignment
                        %th URL
                        %th Row
                    %tbody
                      - external_refs_data.each do |ref|
                        %tr
                          %td
                            = check_box_tag "selected_external_refs[]", ref['row'], true, class: 'form-check-input external-refs-checkbox'
                          %td= ref['assignment_name']
                          %td
                            = link_to ref['external_url'], ref['external_url'], target: '_blank', class: 'text-decoration-none'
                          %td= ref['row']
              
              -# UploadEmployees sections - in creation order
              - if departments_data.present?
                %h6 Departments (#{departments_data.length})
                .table-responsive.mb-3
                  %table.table.table-sm
                    %thead
                      %tr
                        %th
                          = check_box_tag 'select_all_departments', '1', true, class: 'form-check-input', data: { target: 'departments-checkbox' }
                          %label.form-check-label.ms-1 Select All
                        %th Name
                        %th Action
                        %th Existing Record
                        %th Row
                    %tbody
                      - departments_data.each do |department|
                        %tr
                          %td
                            = check_box_tag "selected_departments[]", department['row'], true, class: 'form-check-input departments-checkbox'
                          %td= department['name']
                          %td
                            - if department['will_create']
                              %span.badge.bg-success New
                            - else
                              %span.badge.bg-warning Update
                          %td
                            - if department['existing_id']
                              %span.text-muted Existing department
                            - else
                              %span.text-muted None
                          %td= department['row']
              
              - if managers_data.present?
                %h6 Managers (#{managers_data.length})
                .table-responsive.mb-3
                  %table.table.table-sm
                    %thead
                      %tr
                        %th
                          = check_box_tag 'select_all_managers', '1', true, class: 'form-check-input', data: { target: 'managers-checkbox' }
                          %label.form-check-label.ms-1 Select All
                        %th Name
                        %th Email
                        %th Action
                        %th Existing Record
                        %th Row
                    %tbody
                      - managers_data.each do |manager|
                        %tr
                          %td
                            = check_box_tag "selected_managers[]", manager['row'], true, class: 'form-check-input managers-checkbox'
                          %td= manager['name']
                          %td= manager['email']
                          %td
                            - if manager['will_create']
                              %span.badge.bg-success New
                            - else
                              %span.badge.bg-warning Update
                          %td
                            - if manager['existing_id']
                              = link_to manager['existing_name'], organization_company_teammate_path(@organization || organization, manager['existing_id']), class: 'text-decoration-none'
                            - else
                              %span.text-muted None
                          %td= manager['row']
              
              - if titles_data.present?
                %h6 Titles (#{titles_data.length})
                .table-responsive.mb-3
                  %table.table.table-sm
                    %thead
                      %tr
                        %th
                          = check_box_tag 'select_all_titles', '1', true, class: 'form-check-input', data: { target: 'titles-checkbox' }
                          %label.form-check-label.ms-1 Select All
                        %th External Title
                        %th Action
                        %th Existing Record
                        %th Row
                    %tbody
                      - titles_data.each do |title|
                        %tr
                          %td
                            = check_box_tag "selected_titles[]", title['row'], true, class: 'form-check-input titles-checkbox'
                          %td= title['external_title']
                          %td
                            - if title['will_create']
                              %span.badge.bg-success New
                            - else
                              %span.badge.bg-warning Update
                          %td
                            - if title['existing_id']
                              %span.text-muted Existing title
                            - else
                              %span.text-muted None
                          %td= title['row']
              
              - if positions_data.present?
                %h6 Positions (#{positions_data.length})
                .table-responsive.mb-3
                  %table.table.table-sm
                    %thead
                      %tr
                        %th
                          = check_box_tag 'select_all_positions', '1', true, class: 'form-check-input', data: { target: 'positions-checkbox' }
                          %label.form-check-label.ms-1 Select All
                        %th Title
                        %th Level
                        %th Action
                        %th Existing Record
                        %th Row
                    %tbody
                      - positions_data.each do |position|
                        %tr
                          %td
                            = check_box_tag "selected_positions[]", position['row'], true, class: 'form-check-input positions-checkbox'
                          %td= position['title_name']
                          %td= position['position_level']
                          %td
                            - if position['will_create']
                              %span.badge.bg-success New
                            - else
                              %span.badge.bg-warning Update
                          %td
                            - if position['existing_id']
                              %span.text-muted Existing position
                            - else
                              %span.text-muted None
                          %td= position['row']
              
              - if unassigned_employees_data.present?
                %h6 Unassigned Employees (#{unassigned_employees_data.length})
                .table-responsive.mb-3
                  %table.table.table-sm
                    %thead
                      %tr
                        %th
                          = check_box_tag 'select_all_unassigned_employees', '1', true, class: 'form-check-input', data: { target: 'unassigned-employees-checkbox' }
                          %label.form-check-label.ms-1 Select All
                        %th Name
                        %th Email
                        %th Job Title
                        %th Department
                        %th Manager
                        %th Start Date
                        %th Action
                        %th Existing Record
                        %th Row
                    %tbody
                      - unassigned_employees_data.each do |employee|
                        %tr
                          %td
                            = check_box_tag "selected_unassigned_employees[]", employee['row'], true, class: 'form-check-input unassigned-employees-checkbox'
                          %td= employee['name']
                          %td= employee['email']
                          %td= employee['job_title']
                          %td= employee['department']
                          %td= employee['manager_name']
                          %td= employee['start_date']
                          %td
                            - if employee['will_create']
                              %span.badge.bg-success New
                            - else
                              %span.badge.bg-warning Update
                          %td
                            - if employee['existing_id']
                              = link_to employee['existing_name'], organization_company_teammate_path(@organization || organization, employee['existing_id']), class: 'text-decoration-none'
                            - else
                              %span.text-muted None
                          %td= employee['row']
              
              - if teammates_data.present?
                %h6 Teammates (#{teammates_data.length})
                .table-responsive.mb-3
                  %table.table.table-sm
                    %thead
                      %tr
                        %th
                          = check_box_tag 'select_all_teammates', '1', true, class: 'form-check-input', data: { target: 'teammates-checkbox' }
                          %label.form-check-label.ms-1 Select All
                        %th Person Name
                        %th Person Email
                        %th Organization
                        %th Type
                        %th Start Date
                        %th Action
                        %th Existing Record
                        %th Row
                    %tbody
                      - teammates_data.each do |teammate|
                        %tr
                          %td
                            = check_box_tag "selected_teammates[]", teammate['row'], true, class: 'form-check-input teammates-checkbox'
                          %td= teammate['person_name']
                          %td= teammate['person_email']
                          %td= teammate['organization_name']
                          %td= teammate['type']
                          %td= teammate['first_employed_at']
                          %td
                            - if teammate['will_create']
                              %span.badge.bg-success New
                            - else
                              %span.badge.bg-warning Update
                          %td
                            - if teammate['existing_id']
                              %span.text-muted Existing teammate
                            - else
                              %span.text-muted None
                          %td= teammate['row']
              
              - if employment_tenures_data.present?
                %h6 Employment Tenures (#{employment_tenures_data.length})
                .table-responsive.mb-3
                  %table.table.table-sm
                    %thead
                      %tr
                        %th
                          = check_box_tag 'select_all_employment_tenures', '1', true, class: 'form-check-input', data: { target: 'employment-tenures-checkbox' }
                          %label.form-check-label.ms-1 Select All
                        %th Person Name
                        %th Person Email
                        %th Position Title
                        %th Manager Name
                        %th Start Date
                        %th Action
                        %th Existing Record
                        %th Row
                    %tbody
                      - employment_tenures_data.each do |employment_tenure|
                        %tr
                          %td
                            = check_box_tag "selected_employment_tenures[]", employment_tenure['row'], true, class: 'form-check-input employment-tenures-checkbox'
                          %td= employment_tenure['person_name']
                          %td= employment_tenure['person_email']
                          %td= employment_tenure['position_title']
                          %td= employment_tenure['manager_name']
                          %td= employment_tenure['started_at']
                          %td
                            - if employment_tenure['will_create']
                              %span.badge.bg-success New
                            - else
                              %span.badge.bg-warning Update
                          %td
                            - if employment_tenure['existing_id']
                              %span.text-muted Existing employment tenure
                            - else
                              %span.text-muted None
                          %td= employment_tenure['row']
              
              -# RefreshNamesSync sections
              - if preferred_name_updates_data.present?
                %h6 Preferred Name Updates (#{preferred_name_updates_data.length})
                .table-responsive.mb-3
                  %table.table.table-sm
                    %thead
                      %tr
                        %th
                          = check_box_tag 'select_all_preferred_name_updates', '1', true, class: 'form-check-input', data: { target: 'preferred-name-updates-checkbox' }
                          %label.form-check-label.ms-1 Select All
                        %th Person Name
                        %th Email
                        %th Current Preferred Name
                        %th New Preferred Name
                        %th Row
                    %tbody
                      - preferred_name_updates_data.each do |update|
                        %tr
                          %td
                            = check_box_tag "selected_preferred_name_updates[]", update['row'], true, class: 'form-check-input preferred-name-updates-checkbox'
                          %td= update['person_name']
                          %td= update['email']
                          %td= update['current_preferred_name']
                          %td
                            %strong= update['new_preferred_name']
                          %td= update['row']
              
              -# RefreshSlackSync sections
              - if update_slack_identities_data.present?
                - updatable_count = update_slack_identities_data.count { |u| u['will_update'] == true }
                %h6 Slack Identities (#{update_slack_identities_data.length})
                - if updatable_count > 0
                  %p.text-muted.small
                    #{updatable_count} need updates, #{update_slack_identities_data.length - updatable_count} already synced
                .table-responsive.mb-3
                  %table.table.table-sm
                    %thead
                      %tr
                        %th
                          - if updatable_count > 0
                            = check_box_tag 'select_all_update_slack_identities', '1', true, class: 'form-check-input', data: { target: 'update-slack-identities-checkbox' }
                            %label.form-check-label.ms-1 Select All (#{updatable_count})
                          - else
                            %span.text-muted All synced
                        %th Person Name
                        %th Slack User
                        %th Status
                        %th Changes
                        %th Row
                    %tbody
                      - update_slack_identities_data.each do |update|
                        - status = update['status'] || (update['will_update'] ? 'needs_update' : 'already_synced')
                        %tr{class: status == 'already_synced' ? 'table-secondary' : status == 'not_found' ? 'table-warning' : ''}
                          %td
                            - if update['will_update']
                              = check_box_tag "selected_update_slack_identities[]", update['row'], true, class: 'form-check-input update-slack-identities-checkbox'
                            - else
                              = check_box_tag "selected_update_slack_identities[]", update['row'], false, class: 'form-check-input update-slack-identities-checkbox', disabled: true
                          %td= update['person_name']
                          %td= update['slack_user_name']
                          %td
                            - if status == 'already_synced'
                              %span.badge.bg-success Already Synced
                            - elsif status == 'not_found'
                              %span.badge.bg-warning Not Found
                            - else
                              %span.badge.bg-info Needs Update
                          %td
                            %small= update['changes']
                          %td= update['row']
              
              - if create_slack_associations_data.present?
                %h6 Create Slack Associations (#{create_slack_associations_data.length})
                .table-responsive.mb-3
                  %table.table.table-sm
                    %thead
                      %tr
                        %th
                          = check_box_tag 'select_all_create_slack_associations', '1', true, class: 'form-check-input', data: { target: 'create-slack-associations-checkbox' }
                          %label.form-check-label.ms-1 Select All
                        %th Person Name
                        %th Person Email
                        %th Slack User
                        %th Row
                    %tbody
                      - create_slack_associations_data.each do |association|
                        %tr
                          %td
                            = check_box_tag "selected_create_slack_associations[]", association['row'], true, class: 'form-check-input create-slack-associations-checkbox'
                          %td= association['person_name']
                          %td= association['person_email']
                          %td= association['slack_user_name']
                          %td= association['row']
              
              - if suggest_terminations_data.present?
                %h6 Suggest Terminations (#{suggest_terminations_data.length})
                .table-responsive.mb-3
                  %table.table.table-sm
                    %thead
                      %tr
                        %th
                          = check_box_tag 'select_all_suggest_terminations', '1', true, class: 'form-check-input', data: { target: 'suggest-terminations-checkbox' }
                          %label.form-check-label.ms-1 Select All
                        %th Person Name
                        %th Slack User
                        %th Reason
                        %th Suggested Date
                        %th Row
                    %tbody
                      - suggest_terminations_data.each do |termination|
                        %tr
                          %td
                            = check_box_tag "selected_suggest_terminations[]", termination['row'], true, class: 'form-check-input suggest-terminations-checkbox'
                          %td= termination['person_name']
                          %td= termination['slack_user_name']
                          %td
                            %span.badge.bg-warning= termination['termination_reason']
                          %td= termination['suggested_termination_date']
                          %td= termination['row']
              
              -# EnsureAssignmentTenuresSync sections
              - if assignment_tenures_data.present? && @bulk_sync_event.type == 'BulkSyncEvent::EnsureAssignmentTenuresSync'
                - create_count = assignment_tenures_data.count { |t| t['will_create'] }
                - skip_count = assignment_tenures_data.count { |t| t['will_skip'] }
                %h6 Assignment Tenures (#{assignment_tenures_data.length} total: #{create_count} to create, #{skip_count} to skip)
                .table-responsive.mb-3
                  %table.table.table-sm
                    %thead
                      %tr
                        %th
                          = check_box_tag 'select_all_assignment_tenures', '1', true, class: 'form-check-input', data: { target: 'assignment-tenures-checkbox' }
                          %label.form-check-label.ms-1 Select All
                        %th Teammate
                        %th Assignment
                        %th Position
                        %th Anticipated Energy %
                        %th Action
                        %th Row
                    %tbody
                      - assignment_tenures_data.each do |tenure|
                        - teammate = Teammate.find_by(id: tenure['teammate_id'])
                        - assignment = Assignment.find_by(id: tenure['assignment_id'])
                        - position = Position.find_by(id: tenure['position_id'])
                        %tr
                          %td
                            = check_box_tag "selected_assignment_tenures[]", tenure['row'], true, class: 'form-check-input assignment-tenures-checkbox'
                          %td
                            - if teammate
                              = link_to tenure['teammate_name'], internal_organization_company_teammate_path(current_organization, teammate), class: 'text-decoration-none'
                            - else
                              = tenure['teammate_name']
                          %td
                            - if assignment
                              = link_to tenure['assignment_title'], organization_assignment_path(current_organization, assignment), class: 'text-decoration-none'
                            - else
                              = tenure['assignment_title']
                          %td
                            - if position
                              = link_to tenure['position_display_name'], organization_position_path(current_organization, position), class: 'text-decoration-none'
                            - else
                              = tenure['position_display_name']
                          %td
                            - if position
                              = link_to manage_assignments_organization_position_path(current_organization, position), class: 'text-decoration-none', title: 'Manage assignments for this position' do
                                %strong= "#{tenure['anticipated_energy_percentage']}%"
                                %small.text-muted
                                  (min: #{tenure['min_estimated_energy'] || 'N/A'}%, max: #{tenure['max_estimated_energy'] || 'N/A'}%)
                            - else
                              %strong= "#{tenure['anticipated_energy_percentage']}%"
                              %small.text-muted
                                (min: #{tenure['min_estimated_energy'] || 'N/A'}%, max: #{tenure['max_estimated_energy'] || 'N/A'}%)
                          %td
                            - if tenure['will_create']
                              %span.badge.bg-success New
                            - elsif tenure['will_skip']
                              %span.badge.bg-secondary Skipped
                              %small.text-muted.d-block
                                (already exists)
                            - else
                              %span.badge.bg-warning Unknown
                          %td= tenure['row']
              
              -# UploadAssignmentsAndAbilities preview sections
              - if assignments_upload_data.present?
                %h6 Assignments (#{assignments_upload_data.length})
                .table-responsive.mb-3
                  %table.table.table-sm
                    %thead
                      %tr
                        %th
                          = check_box_tag 'select_all_assignments_upload', '1', true, class: 'form-check-input', data: { target: 'assignments-upload-checkbox' }
                          %label.form-check-label.ms-1 Select All
                        %th Title
                        %th Tagline
                        %th Outcomes Count
                        %th Action
                        %th Existing Record
                        %th Row
                    %tbody
                      - assignments_upload_data.each do |assignment|
                        - next if assignment['title'].blank?
                        %tr
                          %td
                            = check_box_tag "selected_assignments[]", assignment['row'], true, class: 'form-check-input assignments-upload-checkbox'
                          %td= assignment['title']
                          %td= assignment['tagline']
                          %td= assignment['outcomes_count'] || 0
                          %td
                            - if assignment['will_create']
                              %span.badge.bg-success New
                            - else
                              %span.badge.bg-warning Update
                          %td
                            - if assignment['existing_id'].present?
                              - link_text = assignment['existing_title'].presence || assignment['title'].presence || "Assignment ##{assignment['existing_id']}"
                              = link_to link_text, organization_assignment_path(current_organization, assignment['existing_id']), class: 'text-decoration-none'
                            - else
                              %span.text-muted None
                          %td= assignment['row']
              
              - if abilities_upload_data.present?
                %h6 Abilities (#{abilities_upload_data.length})
                .table-responsive.mb-3
                  %table.table.table-sm
                    %thead
                      %tr
                        %th
                          = check_box_tag 'select_all_abilities', '1', true, class: 'form-check-input', data: { target: 'abilities-checkbox' }
                          %label.form-check-label.ms-1 Select All
                        %th Name
                        %th Action
                        %th Existing Record
                        %th Row
                    %tbody
                      - abilities_upload_data.each do |ability|
                        - next if ability['name'].blank?
                        %tr
                          %td
                            = check_box_tag "selected_abilities[]", ability['row'], true, class: 'form-check-input abilities-checkbox'
                          %td= ability['name']
                          %td
                            - if ability['will_create']
                              %span.badge.bg-success New
                            - else
                              %span.badge.bg-warning Update
                          %td
                            - if ability['existing_id'].present?
                              - link_text = ability['existing_name'].presence || ability['name'].presence || "Ability ##{ability['existing_id']}"
                              = link_to link_text, organization_ability_path(current_organization, ability['existing_id']), class: 'text-decoration-none'
                            - else
                              %span.text-muted None
                          %td= ability['row']
              
              - if assignment_abilities_data.present?
                %h6 Assignment-Ability Links (#{assignment_abilities_data.length})
                .table-responsive.mb-3
                  %table.table.table-sm
                    %thead
                      %tr
                        %th
                          = check_box_tag 'select_all_assignment_abilities', '1', true, class: 'form-check-input', data: { target: 'assignment-abilities-checkbox' }
                          %label.form-check-label.ms-1 Select All
                        %th Assignment
                        %th Ability
                        %th Milestone Level
                        %th Action
                        %th Row
                    %tbody
                      - assignment_abilities_data.each do |aa|
                        %tr
                          %td
                            = check_box_tag "selected_assignment_abilities[]", aa['row'], true, class: 'form-check-input assignment-abilities-checkbox'
                          %td= aa['assignment_title']
                          %td= aa['ability_name']
                          %td= aa['milestone_level'] || 1
                          %td
                            %span.badge.bg-success= aa['action'] || 'create'
                          %td= aa['row']
              
              - if position_assignments_data.present?
                %h6 Position-Assignment Links (#{position_assignments_data.length})
                .table-responsive.mb-3
                  %table.table.table-sm
                    %thead
                      %tr
                        %th
                          = check_box_tag 'select_all_position_assignments', '1', true, class: 'form-check-input', data: { target: 'position-assignments-checkbox' }
                          %label.form-check-label.ms-1 Select All
                        %th Assignment
                        %th Position
                        %th Position Type
                        %th Seats
                        %th Departments
                        %th Action
                        %th Row
                    %tbody
                      - position_assignments_data.each do |pa|
                        %tr
                          %td
                            = check_box_tag "selected_position_assignments[]", pa['row'], true, class: 'form-check-input position-assignments-checkbox'
                          %td= pa['assignment_title']
                          %td
                            - if pa['position_display_name']
                              = pa['position_display_name']
                              - if pa['will_create_position']
                                %span.badge.bg-success.ms-1 New
                              - elsif pa['position_id']
                                %span.badge.bg-info.ms-1 Existing
                            - else
                              = pa['position_title']
                              %span.badge.bg-warning.ms-1 Title Not Found
                          %td
                            - if pa['title_name']
                              = pa['title_name']
                            - else
                              %span.text-muted Not found
                          %td
                            - if pa['seats_count'] && pa['seats_count'] > 0
                              %span.badge.bg-secondary= "#{pa['seats_count']} seat#{pa['seats_count'] == 1 ? '' : 's'}"
                              - if pa['will_update_seat_department']
                                %br
                                %small.text-muted Will update department
                            - else
                              %span.text-muted No seats
                              - if pa['will_update_seat_department']
                                %br
                                %small.text-muted Will update department when seats are created
                          %td= Array(pa['department_names']).join(', ')
                          %td
                            %span.badge.bg-success= pa['action'] || 'create'
                          %td= pa['row']
              
              .d-flex.gap-2.mt-4
                = form.submit 'Process Selected Items', class: 'btn btn-success btn-lg', data: { confirm: 'Are you sure you want to process the selected items? This action cannot be undone.' }
                = link_to 'Cancel', organization_bulk_sync_events_path(current_organization), class: 'btn btn-outline-secondary'

    
    .col-md-8
      -# Processing Results Section
      - if @bulk_sync_event.completed? && @bulk_sync_event.results.present?
        .card.mb-4
          .card-header
            %h5.card-title.mb-0 Processing Results
          .card-body
            -# Check if we have successful operations
            - if @bulk_sync_event.results&.dig('successes')&.present?
              %h6.text-success Successful Operations (#{@bulk_sync_event.results&.dig('successes')&.length})
              .table-responsive.mb-3
                %table.table.table-sm.table-success
                  %thead
                    %tr
                      %th Type
                      %th Action
                      %th Details
                      %th Row
                  %tbody
                    - @bulk_sync_event.results&.dig('successes')&.each do |success|
                      - success = success || {}
                      %tr
                        %td= (success['type'] || 'Unknown').to_s.humanize
                        %td= (success['action'] || 'Unknown').to_s.humanize
                        %td
                          != @bulk_sync_event.success_details_for(success)
                        %td= success['row']
            
            -# Check if we have failed operations
            - if @bulk_sync_event.results&.dig('failures')&.present?
              %h6.text-danger Failed Operations (#{@bulk_sync_event.results&.dig('failures')&.length})
              .table-responsive.mb-3
                %table.table.table-sm.table-danger
                  %thead
                    %tr
                      %th Type
                      %th Error
                      %th Data
                      %th Row
                  %tbody
                    - @bulk_sync_event.results&.dig('failures')&.each do |failure|
                      %tr
                        %td= failure['type'].humanize
                        %td= failure['error']
                        %td
                          %small.text-muted= failure['data'].inspect
                        %td= failure['row']
      
      -# Processing Failed Section
      - if @bulk_sync_event.failed?
        .card.mb-4
          .card-header
            %h5.card-title.mb-0 Processing Failed
          .card-body
            .alert.alert-danger
              %strong Error:
              = @bulk_sync_event.results&.dig('error') || 'Unknown error occurred'
            
            -# Check if we have failed operations
            - if @bulk_sync_event.results&.dig('failures')&.present?
              %h6 Failed Operations (#{@bulk_sync_event.results&.dig('failures')&.length})
              .table-responsive
                %table.table.table-sm.table-danger
                  %thead
                    %tr
                      %th Type
                      %th Error
                      %th Data
                      %th Row
                  %tbody
                    - @bulk_sync_event.results&.dig('failures')&.each do |failure|
                      %tr
                        %td= failure['type'].humanize
                        %td= failure['error']
                        %td
                          %small.text-muted= failure['data'].inspect
                        %td= failure['row']
      
      -# Processing Section
      - if @bulk_sync_event.processing?
        .card.mb-4
          .card-header
            %h5.card-title.mb-0 Processing
          .card-body
            .text-center.py-4
              .spinner-border.text-primary.mb-3{role: "status"}
                %span.visually-hidden Loading...
              %p Processing upload... This may take a few minutes.
              %p.text-muted You can refresh this page to check the status.



:javascript
  document.addEventListener('DOMContentLoaded', function() {
    // Handle "Select All" checkboxes
    const selectAllCheckboxes = document.querySelectorAll('[data-target]');
    
    selectAllCheckboxes.forEach(function(selectAll) {
      const targetClass = selectAll.dataset.target;
      const targetCheckboxes = document.querySelectorAll('.' + targetClass);
      
      selectAll.addEventListener('change', function() {
        targetCheckboxes.forEach(function(checkbox) {
          checkbox.checked = selectAll.checked;
        });
      });
      
      // Update "Select All" when individual checkboxes change
      targetCheckboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
          const allChecked = Array.from(targetCheckboxes).every(cb => cb.checked);
          const someChecked = Array.from(targetCheckboxes).some(cb => cb.checked);
          
          selectAll.checked = allChecked;
          selectAll.indeterminate = someChecked && !allChecked;
        });
      });
    });
  });