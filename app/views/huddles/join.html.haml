- content_for :title, "Join Huddle"

.container.mt-4
  .row.justify-content-center
    .col-lg-6
      .card
        .card-header.bg-success.text-white
          %h3.mb-0
            %i.bi.bi-people-fill.me-2
            Join Huddle
          %p.mb-0.mt-2= "Join #{@huddle.display_name}"
        
        .card-body
          - current_participant = @huddle.huddle_participants.joins(:company_teammate).find_by(teammates: { person: @current_person }) if @current_person
          
          - if @current_person && current_participant
            / State 3: Already logged in and associated with huddle
            .alert.alert-success
              %i.bi.bi-check-circle.me-2
              %strong Welcome back, #{@current_person.casual_name}!
              %br
              %small You're already a member of this huddle. Please verify your role.
            
            = form_with url: join_huddle_huddle_path(@huddle), method: :post, local: true do |form|
              .mb-3.field-readonly
                = form.label :name, "Your name", class: "form-label"
                = form.text_field :name, value: @current_person.casual_name, readonly: true, class: "form-control"
              
              .mb-3.field-readonly
                = form.label :email, "Your email", class: "form-label"
                = form.email_field :email, value: @current_person.email, readonly: true, class: "form-control"
              
              .mb-3
                = form.label :role, "Your Role in This Huddle", class: "form-label"
                = form.select :role, role_options_for_select(current_participant.role), {}, { class: "form-select", required: true }
              
              .d-grid.gap-2.d-md-flex.justify-content-md-end
                = link_to "Cancel", huddles_path, class: "btn btn-outline-secondary me-md-2"
                = form.submit "Update Role", class: "btn btn-success btn-lg"
          
          - elsif @current_person
            - teammate = @current_person.teammates.find_by(organization: @huddle.company)
            - if teammate.nil?
              / State 2b: Logged in but no teammate record for this organization â€” cannot join
              .alert.alert-warning
                %i.bi.bi-lock.me-2
                %strong You can't join this huddle yet
                %br
                %small You must be added to #{@huddle.company.name} by someone with access (e.g. an admin or manager) before you can join. We don't create organization access from a link for security reasons.
              .d-grid.gap-2.d-md-flex.justify-content-md-end.mt-3
                = link_to "Back to huddles", huddles_path, class: "btn btn-outline-secondary"
            - else
              / State 2a: Logged in, has teammate for this org, not yet in huddle
              - if teammate.follower?
                .alert.alert-warning
                  %i.bi.bi-heart.me-2
                  %strong Welcome, #{@current_person.casual_name}!
                  %br
                  %small You're following this organization. Please confirm your information and select your role to participate in this huddle.
              - else
                .alert.alert-info
                  %i.bi.bi-person-check.me-2
                  %strong Welcome, #{@current_person.casual_name}!
                  %br
                  %small You're logged in. Please confirm your information and select your role.
              
              = form_with url: join_huddle_huddle_path(@huddle), method: :post, local: true do |form|
                .mb-3.field-readonly
                  = form.label :name, "Your name", class: "form-label"
                  = form.text_field :name, value: @current_person.casual_name, readonly: true, class: "form-control"
                
                .mb-3.field-readonly
                  = form.label :email, "Your email", class: "form-label"
                  = form.email_field :email, value: @current_person.email, readonly: true, class: "form-control"
                
                .mb-3
                  = form.label :role, "What role will you play in this huddle?", class: "form-label"
                  = form.select :role, role_options_for_select, { class: "form-select", required: true }
                
                .d-grid.gap-2.d-md-flex.justify-content-md-end
                  = link_to "Cancel", huddles_path, class: "btn btn-outline-secondary me-md-2"
                  = form.submit "Join Huddle", class: "btn btn-success btn-lg"
          
          - else
            / State 1: Not logged in - require authentication
            .alert.alert-info.text-center
              %i.bi.bi-shield-check.me-2
              %strong Authentication Required
              %br
              %small Please sign in with Google to join this huddle and participate in feedback.
            
            .text-center.mt-4
              = link_to '/auth/google_oauth2', class: "btn btn-primary btn-lg" do
                %i.bi.bi-google.me-2
                Sign in with Google
              
              .mt-3
                = link_to "Cancel", huddles_path, class: "btn btn-outline-secondary" 