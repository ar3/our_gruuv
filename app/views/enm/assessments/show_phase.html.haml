%h1 Assessment Phase #{@phase}

.row
  -if @phase == 1
    .col-md-4
      .card
        .card-header
          %h5 Analysis
        .card-body
          - if @phase == 1
            - if @partial_analysis
              = render 'partial_analysis', analysis: @partial_analysis
            - else
              %p Complete questions to see your analysis
          - else
            %p Phase #{@phase} analysis will appear here
  
  .col-12{class: @phase == 1 ? 'col-md-8' : 'col-md-12'}
    .card
      .card-body
        = form_with model: @form, url: phase_enm_assessment_path(@assessment.code, phase: @phase), method: :patch, local: true do |f|
          = hidden_field_tag :save_progress, '', id: 'save_progress_flag'
          = hidden_field_tag :anchor, '', id: 'anchor_field'
          - if @phase == 1
            .question-group.mb-4
              %h5 Q1: Core Openness
              %p.question-text "I'm good with my partner passively being open to a relationship evolving to being romantic (emotionally and/or sexually) at some point"
              
              .row
                .col-md-6
                  .form-group
                    = f.label "Same Biological Sex", class: "form-label"
                    = f.select :core_openness_same_sex, agreement_likert_options, { prompt: "Select..." }, class: "form-control"
                
                .col-md-6
                  .form-group
                    = f.label "Opposite Biological Sex", class: "form-label"
                    = f.select :core_openness_opposite_sex, agreement_likert_options, { prompt: "Select..." }, class: "form-control"
              
              .alert.alert-warning.mt-2
                %small If either partner disagrees for both sexes, this partnership is not ethically non-monogamous. Answer no more questions and seek alignment.
            
            .question-group.mb-4
              %h5 Q2: Passive Emotional Openness
              %p.question-text "I'm good with my partner passively being open to a friendship evolving to being emotionally romantic at some point"
              
              .row
                .col-md-6
                  .form-group
                    = f.label "Same Biological Sex", class: "form-label"
                    = f.select :passive_emotional_same_sex, agreement_likert_options, { prompt: "Select..." }, class: "form-control"
                
                .col-md-6
                  .form-group
                    = f.label "Opposite Biological Sex", class: "form-label"
                    = f.select :passive_emotional_opposite_sex, agreement_likert_options, { prompt: "Select..." }, class: "form-control"
            
            .question-group.mb-4
              %h5 Q3: Passive Physical Openness
              %p.question-text "I'm good with my partner passively being open to a relationship evolving to being physically/sexually romantic at some point"
              
              .row
                .col-md-6
                  .form-group
                    = f.label "Same Biological Sex", class: "form-label"
                    = f.select :passive_physical_same_sex, agreement_likert_options, { prompt: "Select..." }, class: "form-control"
                
                .col-md-6
                  .form-group
                    = f.label "Opposite Biological Sex", class: "form-label"
                    = f.select :passive_physical_opposite_sex, agreement_likert_options, { prompt: "Select..." }, class: "form-control"
              
              .alert.alert-warning.mt-2
                %small If either partner disagrees for the above four responses, this partnership is not ethically non-monogamous, but is confusing. Answer no more questions and seek alignment.
            
            .question-group.mb-4
              %h5 Q4: Active Emotional Readiness
              %p.question-text "I'm good with my partner actively seeking an emotionally romantic relationship (on sites like Feeld, OKCupid, etc)"
              
              .row
                .col-md-6
                  .form-group
                    = f.label "Same Biological Sex", class: "form-label"
                    = f.select :active_emotional_same_sex, agreement_likert_options, { prompt: "Select..." }, class: "form-control"
                
                .col-md-6
                  .form-group
                    = f.label "Opposite Biological Sex", class: "form-label"
                    = f.select :active_emotional_opposite_sex, agreement_likert_options, { prompt: "Select..." }, class: "form-control"
            
            .question-group.mb-4
              %h5 Q5: Active Physical Readiness
              %p.question-text "I'm good with my partner actively seeking a physically/sexually romantic relationship (on sites/apps like Feeld, OKCupid, FetLife, etc)"
              
              .row
                .col-md-6
                  .form-group
                    = f.label "Same Biological Sex", class: "form-label"
                    = f.select :active_physical_same_sex, agreement_likert_options, { prompt: "Select..." }, class: "form-control"
                
                .col-md-6
                  .form-group
                    = f.label "Opposite Biological Sex", class: "form-label"
                    = f.select :active_physical_opposite_sex, agreement_likert_options, { prompt: "Select..." }, class: "form-control"
              
              .alert.alert-info.mt-2
                %small If either partner disagrees, you are ENM, but passively so. You should definitely go down to the escalator ratings below.
          
          - elsif @phase == 2
            - comfortability_popover_content = capture_haml do
              %table.table.table-bordered.table-sm.mb-0
                %tr
                  %td
                    %strong Very Comfortable
                  %td This would feel natural and safe within our relationship.
                %tr
                  %td
                    %strong Comfortable
                  %td This would feel fine if disclosure expectations are met.
                %tr
                  %td
                    %strong Slightly Comfortable
                  %td I'd probably be okay with this, if handled carefully.
                %tr
                  %td
                    %strong Slightly Uncomfortable
                  %td Could try to be okay / need significant emotional prep.
                %tr
                  %td
                    %strong Uncomfortable
                  %td Disclosure helps, but I'd still feel deeply uncomfortable.
                %tr
                  %td
                    %strong Very Uncomfortable
                  %td Regardless of disclosure, this would feel unsafe.
            
            - prior_popover_content = capture_haml do
              %table.table.table-bordered.table-responsive.table-striped.table-sm
                %tr
                  %td
                    No Notification or Agreement Expected 
                  %td 
                    I desire for you to navigate this autonomously.
                %tr
                  %td
                    Notification Expected 
                  %td 
                    I need awareness beforehand so I can emotionally prepare.
                %tr
                  %td
                    Agreement Expected 
                  %td 
                    I need to talk and agree before this happens to feel emotionally safe.
            
            - post_popover_content = capture_haml do
              %table.table.table-bordered.table-responsive.table-striped.table-sm
                %tr
                  %td
                    Desired, but not Expected 
                  %td 
                    I appreciate transparency but don’t require it.” - Exploring partner is willing to say yes to show things like text messages, shared location, et
                %tr
                  %td
                    Full, Expected 
                  %td 
                    I expect full transparency afterward to maintain trust.” - Exploring partner is expected to show things like text messages, shared locations, etc after every %encounter 
                %tr
                  %td
                    Unwanted 
                  %td 
                    I’d rather not know afterward; it would cause distress.
      
            %h5 Escalator Assessment
            %p Rate your comfort level and disclosure preferences for each step of intimacy.
            
            %h6.mt-4 Distant Steps (1-3) - Used for Both Physical and Emotional Intimacy
            
            %table.table.table-bordered.table-responsive.table-striped.table-hover
              %thead
                %tr
                  %th{width: '30%'} Step
                  %th{width: '70%'} Answers
              %tbody
                = render 'reminder_row', escalator_type: 'Emotional and Physical'
                = render 'escalator_step_row', step_number: 1, step_name: 'Distant: Curiosity', description: 'Neutral curiosity; minimal personal energy', examples: 'Likes or brief replies in group/app; Comms in dating or group App; Comms once or twice per week; No photos shared', escalator_type: 'distant', form: f, comfortability_popover_content: comfortability_popover_content, prior_popover_content: prior_popover_content, post_popover_content: post_popover_content
                = render 'escalator_step_row', step_number: 2, step_name: 'Distant: Acquainted', description: 'Awareness, interest, and digital familiarity', examples: 'Social media exchanged; Occasional DMs; light compliments; Sharing of G-rated/clothed photos common', escalator_type: 'distant', form: f, comfortability_popover_content: comfortability_popover_content, prior_popover_content: prior_popover_content, post_popover_content: post_popover_content
                = render 'escalator_step_row', step_number: 3, step_name: 'Distant: Connected', description: 'Early compatibility; casual comfort', examples: 'Real phone numbers exchanged; Text or calls most days; Sharing of PG-rated/innocent bathing suit/workout clothed photos', escalator_type: 'distant', form: f, comfortability_popover_content: comfortability_popover_content, prior_popover_content: prior_popover_content, post_popover_content: post_popover_content
            
            #physical-intimacy-section.mt-4
              .d-flex.justify-content-between.align-items-center.mb-3
                %h2 Physical Intimacy Steps (4-9)
                = f.submit "Save Progress", 
                           class: "btn btn-outline-success btn-sm",
                           name: "save_progress_physical",
                           formnovalidate: true
            
            %table.table.table-bordered.table-responsive.table-striped.table-hover
              %thead
                %tr
                  %th{width: '30%'} Step
                  %th{width: '70%'} Answers
              %tbody
                = render 'reminder_row', escalator_type: 'Physical'
                = render 'escalator_step_row', step_number: 4, step_name: 'Physical: Surface: Present', description: 'First physical comfort test', examples: 'Meet in public place & short hugs/cheek-only kisses; Meet up no more than once per month; Sharing of PG-rated photos (more sexy, but still clothed)', escalator_type: 'physical', form: f, comfortability_popover_content: comfortability_popover_content, prior_popover_content: prior_popover_content, post_popover_content: post_popover_content
                = render 'escalator_step_row', step_number: 5, step_name: 'Physical: Surface: Warm', description: 'Safe, social intimacy', examples: 'Meet in public place & hand holding, cuddling, playful affection; Meet up every other week or so; Sharing of lingerie pics', escalator_type: 'physical', form: f, comfortability_popover_content: comfortability_popover_content, prior_popover_content: prior_popover_content, post_popover_content: post_popover_content
                = render 'escalator_step_row', step_number: 6, step_name: 'Physical: Surface: Aroused', description: 'Erotic curiosity expressed', examples: 'Meet in semi-public places (movies), on-lips kissing (no tongue), over clothes touching; Meet up every week or so; Sharing of nude pics', escalator_type: 'physical', form: f, comfortability_popover_content: comfortability_popover_content, prior_popover_content: prior_popover_content, post_popover_content: post_popover_content
                = render 'reminder_row', escalator_type: 'Physical'
                = render 'escalator_step_row', step_number: 7, step_name: 'Physical: Intimate: Near-Sexual', description: 'Sexual intent clear', examples: 'Private encounters (houses, hotels, etc), makeout-sessions, & non-genital sexual foreplay; Meet up multiple times per week', escalator_type: 'physical', form: f, comfortability_popover_content: comfortability_popover_content, prior_popover_content: prior_popover_content, post_popover_content: post_popover_content
                = render 'escalator_step_row', step_number: 8, step_name: 'Physical: Intimate: Sexual', description: 'Active sexual engagement', examples: 'Oral sex (Fellatio and/or Cunnilingus); Mutual masturbation (Handjobs/fingering); No penetration (vaginal or anal)', escalator_type: 'physical', form: f, comfortability_popover_content: comfortability_popover_content, prior_popover_content: prior_popover_content, post_popover_content: post_popover_content
                = render 'escalator_step_row', step_number: 9, step_name: 'Physical: Intimate: Intimate Union', description: 'Ongoing physical relationship', examples: 'Full penetration intercourse (vaginal or anal); Repeated encounters', escalator_type: 'physical', form: f, comfortability_popover_content: comfortability_popover_content, prior_popover_content: prior_popover_content, post_popover_content: post_popover_content
            
            #emotional-intimacy-section.mt-4
              .d-flex.justify-content-between.align-items-center.mb-3
                %h2 Emotional Intimacy Steps (4-9)
                = f.submit "Save Progress", 
                           class: "btn btn-outline-success btn-sm",
                           name: "save_progress_emotional",
                           formnovalidate: true
            
            %table.table.table-bordered.table-responsive.table-striped.table-hover
              %thead
                %tr
                  %th{width: '30%'} Step
                  %th{width: '70%'} Answers
              %tbody
                = render 'reminder_row', escalator_type: 'Emotional'
                = render 'escalator_step_row', step_number: 4, step_name: 'Surface: Present', description: 'Emotional care begins', examples: 'Mild venting (not about original partner); Genuine concern; Texting, talking, or visiting 1-3 times per week', escalator_type: 'emotional', form: f, comfortability_popover_content: comfortability_popover_content, prior_popover_content: prior_popover_content, post_popover_content: post_popover_content
                = render 'escalator_step_row', step_number: 5, step_name: 'Surface: Vulnerability', description: 'Attachment deepens', examples: 'Sharing fears, insecurities, personal reflections; Texting, talking, or visiting multiple times per week', escalator_type: 'emotional', form: f, comfortability_popover_content: comfortability_popover_content, prior_popover_content: prior_popover_content, post_popover_content: post_popover_content
                = render 'escalator_step_row', step_number: 6, step_name: 'Surface: Supportive', description: 'Emotional responsibility forming', examples: 'Offering comfort; reaching out during stress; Discuss issues about original partner; Common "I miss you"; Texting, talking, or visiting daily', escalator_type: 'emotional', form: f, comfortability_popover_content: comfortability_popover_content, prior_popover_content: prior_popover_content, post_popover_content: post_popover_content
                = render 'reminder_row', escalator_type: 'Emotional'
                = render 'escalator_step_row', step_number: 7, step_name: 'Intimate: Integration', description: 'Connection becomes visible', examples: 'Meeting poly-aware friends; Ok with being publicly acknowledged; If original partner is unavailable, the other partner satisfies "primary partner" roles', escalator_type: 'emotional', form: f, comfortability_popover_content: comfortability_popover_content, prior_popover_content: prior_popover_content, post_popover_content: post_popover_content
                = render 'escalator_step_row', step_number: 8, step_name: 'Intimate: Entwined', description: 'Deep interdependence', examples: 'Meeting poly-aware family; Life planning; Lines blur at high emotion times; Hard to imagine life without them', escalator_type: 'emotional', form: f, comfortability_popover_content: comfortability_popover_content, prior_popover_content: prior_popover_content, post_popover_content: post_popover_content
                = render 'escalator_step_row', step_number: 9, step_name: 'Intimate: Bonded', description: 'Full emotional partnership', examples: '"I love you"; Shared rituals and future plans', escalator_type: 'emotional', form: f, comfortability_popover_content: comfortability_popover_content, prior_popover_content: prior_popover_content, post_popover_content: post_popover_content
          
          - elsif @phase == 3
            %h5 Confirm Results
            %p Review your assessment results and confirm.
            %p Your code: #{@assessment.full_code}
            %p Typology: #{@assessment.typology_description[:nickname]}
          
          .form-group.mt-3
            = f.submit "Continue", class: "btn btn-primary"

