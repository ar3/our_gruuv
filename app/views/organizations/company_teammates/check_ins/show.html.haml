- content_for :title, "Check-Ins - #{@teammate.person.display_name}"

- content_for :header do
  %h1.mb-0 Check-Ins for #{@teammate.person.display_name}
  %p.text-muted.mb-0= "View Mode: #{@view_mode.to_s.titleize}"
        
- content_for :header_action do
  .d-flex.align-items-center.gap-2
    = render 'people/view_switcher'

- content_for :go_back_link do
  - if @teammate.person.active_employment_tenure_for(organization)
    = link_to organization_company_teammate_finalization_path(organization, @teammate), class: "go-back-link" do
      %i.bi.bi-arrow-left.me-2
      Go to Finalization
  - else
    = link_to organization_company_teammate_path(organization, @teammate), class: "go-back-link" do
      %i.bi.bi-arrow-left.me-2
      Back to Profile

= render 'shared/check_in_wizard_header', organization: organization, teammate: @teammate, current_step: 1

-# Authorization Debug Section
- if params[:debug] == 'true' && @debug_data
  .alert.alert-secondary.mt-3
    %h5.mb-3
      %i.bi.bi-bug.me-2
      Authorization Debug
    .row
      .col-md-6
        %strong Logged-in Teammate:
        %br
        - if current_company_teammate
          - teammate = current_company_teammate
          ID: #{teammate.id}
          %br
          Person: #{teammate.person.display_name} (ID: #{teammate.person.id})
          %br
          Organization: #{teammate.organization.name} (ID: #{teammate.organization.id})
          %br
          - if teammate.person.og_admin?
            %span.badge.bg-danger Admin
        - else
          %span.text-muted Not logged in
      .col-md-6
        %strong Policy Information:
        %br
        Policy Class: #{@debug_data[:policy_class]}
        %br
        Policy Record: #{@debug_data[:policy_record].display_name} (ID: #{@debug_data[:policy_record].id})
        %br
        Policy Action: #{@debug_data[:policy_action]}
    %hr
    %strong Policy Conditions Breakdown (audit? method):
    %br
    %small.text-muted Each condition is checked in order. The first true condition grants access.
    .mt-2
      - conditions = @debug_data[:conditions]
      -# Condition 1: admin_bypass?
      - admin_bypass = conditions[:admin_bypass]
      .mb-2
        - if admin_bypass[:result]
          %span.text-success
            %i.bi.bi-check-circle-fill.me-1
        - else
          %span.text-muted
            %i.bi.bi-circle.me-1
        %code= admin_bypass[:description]
        - if admin_bypass[:result]
          %span.text-success (PASS - Admin bypass granted)
        - else
          %span.text-muted (FAIL - #{admin_bypass[:details]})
      -# Condition 2: viewing_teammate && record
      - both_exist = conditions[:viewing_teammate_and_record]
      .mb-2
        - if both_exist[:result]
          %span.text-success
            %i.bi.bi-check-circle-fill.me-1
        - else
          %span.text-danger
            %i.bi.bi-x-circle-fill.me-1
        %code= both_exist[:description]
        - if both_exist[:result]
          %span.text-success (PASS)
        - else
          %span.text-danger (FAIL - #{both_exist[:details]})
      -# Condition 3: viewing_teammate.terminated?
      - not_terminated = conditions[:not_terminated]
      - if not_terminated[:result] != nil
        .mb-2
          - if not_terminated[:result]
            %span.text-success
              %i.bi.bi-check-circle-fill.me-1
          - else
            %span.text-danger
              %i.bi.bi-x-circle-fill.me-1
          %code= not_terminated[:description]
          - if not_terminated[:result]
            %span.text-success (PASS - #{not_terminated[:details]})
          - else
            %span.text-danger (FAIL - #{not_terminated[:details]})
      -# Condition 4: viewing_teammate.person == record
      - own_profile = conditions[:own_profile]
      - if own_profile[:result] != nil
        .mb-2
          - if own_profile[:result]
            %span.text-success
              %i.bi.bi-check-circle-fill.me-1
          - else
            %span.text-muted
              %i.bi.bi-circle.me-1
          %code= own_profile[:description]
          - if own_profile[:result]
            %span.text-success (PASS - #{own_profile[:details]})
          - else
            %span.text-muted (FAIL - #{own_profile[:details]})
      -# Condition 5: viewing_teammate.has_active_employment_tenure?
      - has_active_tenure = conditions[:has_active_employment_tenure]
      - if has_active_tenure[:result] != nil
        .mb-2
          - if has_active_tenure[:result]
            %span.text-success
              %i.bi.bi-check-circle-fill.me-1
          - else
            %span.text-danger
              %i.bi.bi-x-circle-fill.me-1
          %code= has_active_tenure[:description]
          - if has_active_tenure[:result]
            %span.text-success (PASS - #{has_active_tenure[:details]})
          - else
            %span.text-danger (FAIL - #{has_active_tenure[:details]})
      -# Condition 6: viewing_teammate.can_manage_employment?
      - can_manage = conditions[:can_manage_employment]
      - if can_manage[:result] != nil
        .mb-2
          - if can_manage[:result]
            %span.text-success
              %i.bi.bi-check-circle-fill.me-1
          - else
            %span.text-muted
              %i.bi.bi-circle.me-1
          %code= can_manage[:description]
          - if can_manage[:result]
            %span.text-success (PASS - #{can_manage[:details]})
          - else
            %span.text-muted (FAIL - #{can_manage[:details]})
      -# Condition 7: viewing_teammate.person.in_managerial_hierarchy_of?(record, viewing_teammate.organization)
      - in_hierarchy = conditions[:in_managerial_hierarchy]
      - if in_hierarchy[:result] != nil
        .mb-2
          - if in_hierarchy[:result]
            %span.text-success
              %i.bi.bi-check-circle-fill.me-1
          - else
            %span.text-muted
              %i.bi.bi-circle.me-1
          %code= in_hierarchy[:description]
          - if in_hierarchy[:result]
            %span.text-success (PASS - #{in_hierarchy[:details]})
          - else
            %span.text-muted (FAIL - #{in_hierarchy[:details]})
    %hr
    %strong Final Result:
    - final_result = @debug_data[:final_result]
    - if final_result
      %span.badge.bg-success.fs-6
        %i.bi.bi-check-circle-fill.me-1
        #{@debug_data[:policy_action]} = TRUE (Access Granted)
    - else
      %span.badge.bg-danger.fs-6
        %i.bi.bi-x-circle-fill.me-1
        #{@debug_data[:policy_action]} = FALSE (Access Denied)

= form_with url: organization_company_teammate_check_ins_path(organization, @teammate), method: :patch, scope: :check_ins do |f|
  
  -# Position Section
  = render 'shared/section_header', 
           title: 'Position/Overall', 
           icon: 'bi-briefcase', 
           description: 'Assess role performance and growth'
  
  = render 'position_check_ins_table',
           position_check_in: @position_check_in,
           form: f,
           view_mode: @view_mode
  .row.mt-4
    .col-12
      .d-flex.gap-2
        = f.submit 'Save All & Continue Editing', name: 'save_and_continue_editing', class: 'btn btn-outline-primary btn-lg'
        = f.submit 'Save All & Proceed to Review Check-Ins', class: 'btn btn-primary btn-lg'

  -# Assignment Section
  = render 'shared/section_header', 
           title: 'Assignments/Outcomes', 
           icon: 'bi-clipboard-check', 
           description: 'Evaluate project contributions and energy',
           action_link: { url: assignment_selection_organization_company_teammate_path(organization, @teammate), icon: 'bi-plus-circle', text: '', title: 'Manage assignments' }
  
  = render 'assignment_check_ins_table',
           assignment_check_ins: @assignment_check_ins,
           form: f,
           view_mode: @view_mode
  
  .row.mt-4
    .col-12
      .d-flex.gap-2
        = f.submit 'Save All & Continue Editing', name: 'save_and_continue_editing', class: 'btn btn-outline-primary btn-lg'
        = f.submit 'Save All & Proceed to Review Check-Ins', class: 'btn btn-primary btn-lg'
  
  -# Aspiration Section
  = render 'shared/section_header', 
           title: 'Aspirational Values', 
           icon: 'bi-star', 
           description: 'Track progress toward personal goals'

  = render 'aspiration_check_ins_table',
           aspiration_check_ins: @aspiration_check_ins,
           form: f,
           view_mode: @view_mode
  
  .row.mt-4
    .col-12
      .d-flex.gap-2
        = f.submit 'Save All & Continue Editing', name: 'save_and_continue_editing', class: 'btn btn-outline-primary btn-lg'
        = f.submit 'Save All & Proceed to Review Check-Ins', class: 'btn btn-primary btn-lg'

  -# Abilities Section
  = render 'shared/section_header', 
           title: 'Abilities/Skills/Knowledge', 
           icon: 'bi-briefcase', 
           description: 'View abilities relevant to your role and assignments',
           collapsible: true,
           collapse_target: 'abilities-section'
  
  .collapse#abilities-section
    = render 'abilities_table',
             relevant_abilities: @relevant_abilities,
             view_mode: @view_mode,
             person: @person,
             main_form: f

