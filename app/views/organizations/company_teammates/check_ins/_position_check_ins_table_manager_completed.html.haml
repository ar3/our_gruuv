-# Position Check-In Table View - Manager Completed State
.table-responsive
  %table.table.table-striped
    %thead
      %tr
        %th Position
        %th Manager Rating
        %th Manager Notes
        %th Employee Status
        %th Actions
    %tbody
      %tr
        %td
          - return_text = "Return to #{check_in.teammate.person.casual_name}'s check-in"
          - return_url = organization_company_teammate_check_ins_path(organization, @teammate)
          - position_url = organization_teammate_position_path(organization, check_in.teammate, return_text: return_text, return_url: return_url)
          = button_to save_and_redirect_organization_company_teammate_check_ins_path(organization, @teammate), method: :post, params: { redirect_url: position_url }, class: "btn btn-link text-decoration-none p-0 border-0 bg-transparent text-start", form: { class: "d-inline", data: { save_and_redirect: true } }, "data-bs-toggle" => "popover", "data-bs-trigger" => "hover", "data-bs-placement" => "right", "data-bs-html" => "true", "data-bs-content" => latest_position_check_in_popover_content(check_in.teammate) do
            = check_in.employment_tenure.position.display_name
            %i.bi.bi-clock-history.ms-1.text-muted
        %td
          = position_rating_display(check_in.manager_rating)
        %td
          = simple_format(check_in.manager_private_notes)
        %td
          - if check_in.employee_completed?
            .badge.bg-success Ready for Finalization
            %br
            %small.text-muted #{@person.first_name} completed #{time_ago_in_words(check_in.employee_completed_at)} ago
          - else
            .badge.bg-warning Waiting for Employee
            %br
            %small.text-muted #{@person.first_name} has to complete their self-assessment
        %td
          - if check_in.employee_completed?
            = link_to "Go to Finalization", organization_company_teammate_finalization_path(organization, @teammate), 
                      class: 'btn btn-success btn-sm',
                      data: { confirm: 'Are you ready to finalize this check-in? This will create the official rating.' }
          - else
            %small.text-muted Waiting for #{@person.first_name} to complete their assessment

.form-group.mt-3
  %label Status
  = form.fields_for :position_check_in do |pf|
    -# Hidden fields to preserve existing values when form is submitted
    = pf.hidden_field :manager_rating, value: check_in.manager_rating
    = pf.hidden_field :manager_private_notes, value: check_in.manager_private_notes
    
    .btn-group-vertical{role: "group", "aria-label": "Status selection"}
      = pf.radio_button :status, 'draft', checked: !check_in.manager_completed?, class: 'btn-check', id: "position_manager_completed_status_draft_#{check_in.id}"
      = pf.label :status_draft, 'Make Changes', class: 'btn btn-outline-secondary', for: "position_manager_completed_status_draft_#{check_in.id}"
      = pf.radio_button :status, 'complete', checked: check_in.manager_completed?, class: 'btn-check', id: "position_manager_completed_status_complete_#{check_in.id}"
      = pf.label :status_complete, 'Ready for Finalization', class: 'btn btn-outline-primary', for: "position_manager_completed_status_complete_#{check_in.id}"
  
  .small.text-muted.mt-1
    Select "Make Changes" to edit your assessment and notes
