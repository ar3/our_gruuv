- stories_indicator = shareable_observations_status_indicator(@teammate, organization)
= render 'shared/section_header', 
         title: "#{@teammate.person.casual_name} observations / stories", 
         icon: 'bi-book', 
         description: 'Recent observations and feedback',
         collapsible: true,
         collapse_target: 'storiesSection',
         status_indicator: stories_indicator

-# Summary view (shown when collapsed)
%div{class: "alert mb-4 collapse-summary #{status_indicator_alert_class(stories_indicator)}", "data-bs-toggle" => "collapse", "data-bs-target" => "#storiesSection", "aria-expanded" => "false", "aria-controls" => "storiesSection", "data-status-popover" => "true", "data-bs-trigger" => "hover", "data-bs-placement" => "top", "data-bs-html" => "true", "data-bs-content" => status_conditions_popover_content(:stories), style: "cursor: pointer;"}
  %p.mb-0
    %i{class: "#{status_indicator_icon(stories_indicator)} #{status_indicator_badge_class(stories_indicator)} me-2"}
    = "#{@teammate.person.casual_name} has given ".html_safe
    %span.inline-sentence-highlight= pluralize(@observations_given_count, 'observation')
    = " and has received ".html_safe
    %span.inline-sentence-highlight= pluralize(@observations_received_count, 'observation')
    = " in the past 30 days.".html_safe

-# Collapsible content
.collapse#storiesSection
  .card.mb-4
    .card-body
      .row.mb-4
        .col-md-6
          - if @draft_observation_count.to_i > 0
            .d-grid
              = link_to @draft_observations_url,
                        class: "btn btn-primary" do
                Review your #{pluralize(@draft_observation_count, "draft observation")}
        .col-md-6
          - if @teammate.present?
            .d-grid
              = link_to @observations_involving_url,
                        class: "btn btn-outline-primary" do
                View All observations involving #{@teammate.person.casual_name}
      .row
        -# Left side: Observations given
        .col-md-6
          %h5.mb-3 Observations Given
          %p.mb-2
            %strong= pluralize(@observations_given_count, 'shareable observation')
            given in the last 30 days
          
          - if @recent_observations_given.any?
            .list-group.mb-3
              - @recent_observations_given.each do |observation|
                .list-group-item
                  .d-flex.justify-content-between.align-items-start
                    .flex-grow-1
                      %h6.mb-1
                        = format_date_in_user_timezone(observation.observed_at)
                      %p.mb-1.text-muted
                        = truncate(observation.story, length: 100)
                      %small
                        %span.badge.bg-secondary= observation.privacy_level.humanize
                        - if observation.observed_teammates.any?
                          %span.text-muted.ms-2
                            = observation.observed_teammates.map { |t| t.person.casual_name }.join(', ')
                    - if policy(observation).show?
                      = link_to organization_observation_path(organization, observation), 
                                class: "btn btn-sm btn-outline-primary ms-2",
                                target: "_blank" do
                        %i.bi.bi-eye.me-1
                        View
          - else
            %p.text-muted.mb-3 No observations given in the last 30 days.
          
          .d-grid
            = link_to "View All Observations Given", 
                      @observations_given_url,
                      class: "btn btn-outline-primary"
        
        -# Right side: Observations received
        .col-md-6
          %h5.mb-3 Observations Received
          %p.mb-2
            %strong= pluralize(@observations_received_count, 'shareable observation')
            received in the last 30 days
          
          - if @recent_observations_received.any?
            .list-group.mb-3
              - @recent_observations_received.each do |observation|
                .list-group-item
                  .d-flex.justify-content-between.align-items-start
                    .flex-grow-1
                      %h6.mb-1
                        = format_date_in_user_timezone(observation.observed_at)
                      %p.mb-1.text-muted
                        = truncate(observation.story, length: 100)
                      %small
                        %span.badge.bg-secondary= observation.privacy_level.humanize
                        %span.text-muted.ms-2
                          by #{observation.observer.casual_name}
                    - if policy(observation).show?
                      = link_to organization_observation_path(organization, observation), 
                                class: "btn btn-sm btn-outline-primary ms-2",
                                target: "_blank" do
                        %i.bi.bi-eye.me-1
                        View
          - else
            %p.text-muted.mb-3 No observations received in the last 30 days.
          
          .d-grid
            = link_to "View All Observations Received", 
                      @observations_received_url,
                      class: "btn btn-outline-primary"
      
      - if policy(Observation).create?
        .d-grid.mt-4
          = link_to select_type_organization_observations_path(organization, return_url: about_me_organization_company_teammate_path(organization, @teammate), return_text: "Back to About #{@teammate.person.casual_name}"),
                    class: "btn btn-primary" do
            Add New Observation

