- goals_indicator = goals_status_indicator(@teammate)
= render 'shared/section_header', 
         title: 'Active Goals', 
         icon: 'bi-bullseye', 
         description: 'View goals and confidence ratings',
         collapsible: true,
         collapse_target: 'goalsSection',
         status_indicator: goals_indicator

-# Summary view (shown when collapsed)
- all_goals = @now_goals + @next_goals + @later_goals
- goals_needing_check_in = all_goals.count { |goal| goal.instance_variable_get(:@needs_check_in) }
%div{class: "alert mb-4 collapse-summary #{status_indicator_alert_class(goals_indicator)}"}
  %p.mb-0
    %i{class: "#{status_indicator_icon(goals_indicator)} #{status_indicator_badge_class(goals_indicator)} me-2"}
    - if all_goals.any?
      %strong= pluralize(all_goals.count, 'active goal')
      - if goals_needing_check_in > 0
        , #{pluralize(goals_needing_check_in, 'needs check-in')}
      - if defined?(@goals_completed_recently) && !@goals_completed_recently
        , no goals are completed in the last 90 days
    - else
      No active goals found.

-# Collapsible content
.collapse#goalsSection
  .card.mb-4
    .card-body
      - if all_goals.any?
        .table-responsive
          %table.table.table-hover
            %thead
              %tr
                %th Goal
                %th Timeframe
                %th Last Confidence
                %th Status
            %tbody
              - all_goals.each do |goal|
                - latest_check_in = goal.instance_variable_get(:@latest_check_in)
                - needs_check_in = goal.instance_variable_get(:@needs_check_in)
                %tr
                  %td
                    = link_to goal.title, organization_goal_path(organization, goal), class: "text-decoration-none"
                  %td
                    - if @now_goals.include?(goal)
                      %span.badge.bg-primary Now
                    - elsif @next_goals.include?(goal)
                      %span.badge.bg-info Next
                    - elsif @later_goals.include?(goal)
                      %span.badge.bg-secondary Later
                  %td
                    - if latest_check_in
                      %strong= "#{latest_check_in.confidence_percentage}%"
                      %br
                      %small.text-muted= latest_check_in.check_in_week_start.strftime('%b %d, %Y')
                    - else
                      %span.text-muted No check-in yet
                  %td
                    - if needs_check_in
                      %span.badge.bg-warning.text-dark New check-in needed
                    - elsif latest_check_in
                      %span.badge.bg-success Up to date
                    - else
                      %span.badge.bg-secondary No check-in yet
      - else
        %p.text-muted.mb-3 No active goals found.
      
      .d-grid.mt-3
        = link_to "Manage Goals & Confidence Ratings", 
                  organization_company_teammate_goal_check_ins_path(organization, @teammate, 
                    return_url: about_me_organization_company_teammate_path(organization, @teammate),
                    return_text: "Back to About Me"),
                  class: "btn btn-outline-primary"

