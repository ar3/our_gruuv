- one_on_one_indicator = one_on_one_status_indicator(@one_on_one_link)
= render 'shared/section_header', 
         title: '1:1 Area', 
         icon: 'bi-link-45deg', 
         description: 'Headlines, todos, and topics to discuss',
         collapsible: true,
         collapse_target: 'oneOnOneSection',
         status_indicator: one_on_one_indicator

- source = @one_on_one_link&.external_project_source
- cache = @one_on_one_link&.external_project_cache_for(source) if source
- incomplete_count = cache ? cache.incomplete_items.length : 0
- recently_completed_count = cache ? cache.recently_completed_items.length : 0

-# Summary view (shown when collapsed)
- sections_count = cache ? cache.sections_data.length : 0
- incomplete_tasks_count = cache ? cache.incomplete_items.length : 0
%div{class: "alert mb-4 collapse-summary #{status_indicator_alert_class(one_on_one_indicator)}", "data-bs-toggle" => "collapse", "data-bs-target" => "#oneOnOneSection", "aria-expanded" => "false", "aria-controls" => "oneOnOneSection", style: "cursor: pointer;"}
  %p.mb-0
    %i{class: "#{status_indicator_icon(one_on_one_indicator)} #{status_indicator_badge_class(one_on_one_indicator)} me-2"}
    = "#{@teammate.person.casual_name}'s 1:1 document is ".html_safe
    - if @one_on_one_link&.url.present?
      %span.inline-sentence-highlight
        = link_to @one_on_one_link.url, @one_on_one_link.url, target: '_blank', rel: 'noopener noreferrer', class: 'text-decoration-none'
      - if source == 'asana' && cache
        = ". This Asana project has ".html_safe
        %span.inline-sentence-highlight= pluralize(sections_count, 'section')
        = " and ".html_safe
        %span.inline-sentence-highlight= pluralize(incomplete_tasks_count, 'incomplete task')
        = " within those sections.".html_safe
      - else
        = ".".html_safe
    - else
      %span.inline-sentence-highlight not defined yet
      = ".".html_safe

-# Collapsible content
.collapse#oneOnOneSection
  .card.mb-4
    .card-body
      - if @one_on_one_link&.url.present?
        - if source == 'asana' && cache
          -# Display cached project summary for Asana
          .mb-3
            %p.mb-2
              %strong 1:1 Source:
              = link_to @one_on_one_link.url, @one_on_one_link.url, target: '_blank', rel: 'noopener noreferrer'
            %span.badge.bg-info Asana Project
            %span.badge.bg-success.ms-2 Integrated
          
          .mt-3
            %h5.mb-3 Project Summary
            - cache.sections_data.each do |section|
              - section_incomplete = cache.items_for_section(section['gid']).select { |item| !item['completed'] }.length
              - section_completed = cache.recently_completed_items.select { |item| item['section_gid'] == section['gid'] }.length
              - if section_incomplete > 0 || section_completed > 0
                .card.mb-2
                  .card-body
                    %strong= section['name'] || 'Unnamed Section'
                    %br
                    - if section_incomplete > 0
                      %small.text-muted
                        #{pluralize(section_incomplete, 'incomplete task')}
                    - if section_incomplete > 0 && section_completed > 0
                      %span.mx-2 |
                    - if section_completed > 0
                      %small.text-muted
                        #{pluralize(section_completed, 'recently completed task')}
        - else
          -# Display iframe for non-Asana links
          .mb-3
            %p.mb-2
              %strong 1:1 Source:
              = link_to @one_on_one_link.url, @one_on_one_link.url, target: '_blank', rel: 'noopener noreferrer'
            - if source
              %span.badge.bg-info= "#{source_display_name(source)} Project"
              - if cache
                %span.badge.bg-success.ms-2 Integrated
          
          -# Embedded iframe for non-Asana links
          .mt-3
            %iframe{src: @one_on_one_link.url, width: "100%", height: "600px", frameborder: "0", style: "border: 1px solid #dee2e6; border-radius: 0.375rem;"}
            
            - if source && !has_external_identity?(@teammate, source)
              .alert.alert-warning.mt-3
                %strong #{source_display_name(source)} Project Detected
                %p.mb-0.mt-2
                  This is a #{source_display_name(source)} project link. 
                  %br
                  Connect your #{source_display_name(source)} account to enable automatic syncing of sections and #{item_term(source).pluralize}.
            - elsif source && !cache
              .alert.alert-info.mt-3
                %strong Ready to Sync
                %p.mb-0.mt-2
                  This #{source_display_name(source)} project is ready to be synced. 
                  %br
                  Visit the 1:1 Area page to sync and view project data.
            - elsif !source
              .alert.alert-info.mt-3
                %strong No Deep Integration
                %p.mb-0.mt-2
                  This 1:1 link is not yet integrated. 
                  %br
                  Connect your account to enable automatic syncing of headlines, todos, and discussion topics.
      - else
        %p.text-muted.mb-3 No 1:1 link configured yet.
        %p.text-muted.mb-3
          Add a link to your 1:1 document, project, or system to get started.
      
      .d-grid
        = link_to "Manage / View Full Details about 1:1", 
                  @one_on_one_url,
                  class: "btn btn-outline-primary"
