- content_for :title, "Finalize Check-Ins - #{@teammate.person.display_name}"

- content_for :header do
  %h1.mb-0 Finalize Check-Ins for #{@teammate.person.display_name}
        
- content_for :header_action do
  = render 'people/view_switcher'

- content_for :go_back_link do
  = link_to organization_company_teammate_check_ins_path(organization, @teammate), class: "go-back-link" do
    %i.bi.bi-arrow-left.me-2
    Back to Check-Ins

= render 'shared/check_in_wizard_header', organization: @organization, teammate: @teammate, current_step: 2

= form_with url: organization_company_teammate_finalization_path(organization, @teammate), method: :post, local: true do |f|
  
  -# Position Section
  = render 'shared/section_header', 
           title: 'Position/Overall', 
           icon: 'bi-briefcase', 
           description: 'Set official position rating'
  
  = render 'organizations/finalizations/position_finalization_table', form: f, view_mode: @view_mode
  
  -# Assignment Section
  = render 'shared/section_header', 
           title: 'Assignments/Outcomes', 
           icon: 'bi-clipboard-check', 
           description: 'Finalize individual assignment ratings and energy'
  
  = render 'organizations/finalizations/assignment_finalization_table', form: f, view_mode: @view_mode
  
  -# Aspiration Section
  = render 'shared/section_header', 
           title: 'Aspirational Values', 
           icon: 'bi-star', 
           description: 'Set official aspiration ratings'
  
  = render 'organizations/finalizations/aspiration_finalization_table', form: f, view_mode: @view_mode
  
  -# Finalization button section
  - if @ready_position_check_in || @ready_assignment_check_ins&.any? || @ready_aspiration_check_ins&.any?
    .row.mt-4
      .col-12
        - if @view_mode == :manager
          .alert.alert-warning
            %strong ⚠️ This will:
            %ul
              %li Create an Audit record for #{@person.casual_name} to acknowledge
              %li Close selected check-ins and open new ones
              %li Send notification to #{@person.casual_name} (coming soon)
          
          .mb-3
            = f.label :maap_snapshot_reason, "Reason (optional)", class: "form-label"
            = f.text_field :maap_snapshot_reason, 
                           class: "form-control", 
                           placeholder: "e.g., Q4 2024 Performance Review, Annual Check-in, etc.",
                           value: "Check-in finalization for #{@teammate.person.display_name}"
          
          = f.submit 'Finalize Selected Check-Ins', class: 'btn btn-success btn-lg',
                     data: { confirm: 'Are you sure you want to finalize these check-ins?' }
        - else
          .alert.alert-info
            %i.bi.bi-info-circle.me-2
            %strong
              %i.bi.bi-exclamation-triangle.me-2
              Your manager will finalize these check-ins. You can view the status below.
          
          = f.submit 'Finalize Selected Check-Ins', class: 'btn btn-success btn-lg', disabled: true
  - else
    .row.mt-4
      .col-12
        .alert.alert-info
          %i.bi.bi-info-circle.me-2
          %strong No check-ins are ready for finalization at this time.

:javascript
  document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.finalize-checkbox');
    
    checkboxes.forEach(function(checkbox) {
      checkbox.addEventListener('change', function() {
        if (!this.checked) {
          const alertMessage = this.dataset.alert || 'This row will not be saved if this stays unchecked';
          alert(alertMessage);
        }
      });
    });
  });