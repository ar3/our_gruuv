- content_for :title, "1:1 Area - #{@teammate.person.display_name}"

- content_for :header do
  %h1.mb-0 1:1 Area for #{@teammate.person.display_name}
  %p.text-muted.mb-0 Manage your 1:1 link and integration

- content_for :go_back_link do
  - return_url = params[:return_url].presence || organization_company_teammate_check_ins_path(organization, @teammate)
  - return_text = params[:return_text].presence || 'Back to Check-Ins'
  = link_to return_url, class: "go-back-link" do
    %i.bi.bi-arrow-left.me-2
    = return_text

- casual_name = @teammate.person.casual_name
- return_to_about_me_url = params[:return_url].presence || about_me_organization_company_teammate_path(organization, @teammate)
- return_to_about_me_text = "Return to About #{casual_name}"

- if @one_on_one_link.url.present?
  -# Top section: 1:1 Link display
  .card.mb-4
    .card-header.d-flex.justify-content-between.align-items-center
      %h5.mb-0
        %i.bi.bi-link-45deg.me-2
        1:1 Link
      = link_to return_to_about_me_url, class: "btn btn-sm btn-outline-secondary" do
        %i.bi.bi-arrow-left.me-2
        = return_to_about_me_text
    
    .card-body
      - if @one_on_one_link.url.present?
        .mb-3
          %strong Current Link:
          = link_to @one_on_one_link.url, @one_on_one_link.url, target: '_blank', rel: 'noopener noreferrer', class: "ms-2"
          - if @source
            %span.badge.bg-info.ms-2= "#{source_display_name(@source)} Project Detected"
      
      - source = @one_on_one_link.external_project_source
      - cache = @one_on_one_link.external_project_cache_for(source) if source
      
      - if source && cache
        -# Display cached project
        = render 'shared/external_project/project_display',
                 cache: cache,
                 cacheable: @one_on_one_link,
                 current_teammate: @teammate,
                 source: source,
                 return_url: request.fullpath
      - elsif source && !cache
        -# Prompt to sync
        = render 'shared/external_project/sync_prompt',
                 cacheable: @one_on_one_link,
                 current_teammate: @teammate,
                 source: source,
                 return_url: request.fullpath
      - elsif source && !has_external_identity?(@teammate, source)
        -# Prompt to connect
        = render 'shared/external_project/associate_prompt',
                 cacheable: @one_on_one_link,
                 current_teammate: @teammate,
                 source: source,
                 return_url: request.fullpath
      - else
        -# Display iframe for non-integrated links
        .mb-3
          %iframe{src: @one_on_one_link.url, style: "width: 100%; height: 600px; border: 1px solid #dee2e6; border-radius: 0.25rem;"}
  
  -# Bottom section: Change the 1:1 link
  .card
    .card-header.d-flex.justify-content-between.align-items-center
      %h5.mb-0 Change the 1:1 link
      = link_to return_to_about_me_url, class: "btn btn-sm btn-outline-secondary" do
        %i.bi.bi-arrow-left.me-2
        = return_to_about_me_text
    
    .card-body
      = form_with model: [@organization, @person, @one_on_one_link], url: organization_company_teammate_one_on_one_link_path(organization, @teammate), method: :patch, local: true do |f|
        .mb-3
          = f.label :url, "1:1 Link URL", class: "form-label"
          = f.url_field :url, class: "form-control", placeholder: "https://app.asana.com/0/123456/789 or https://docs.google.com/..."
          - if @one_on_one_link.errors[:url].any?
            .invalid-feedback.d-block
              = @one_on_one_link.errors[:url].join(', ')
          %small.form-text.text-muted
            Enter a link to your 1:1 document, project, or system. 
            %br
            Supported systems: Asana (with integration), Google Docs, Notion, etc.
        
        .d-flex.gap-2
          = f.submit "Save 1:1 Link", class: "btn btn-primary"
          - cancel_url = params[:return_url].presence || organization_company_teammate_check_ins_path(organization, @teammate)
          = link_to "Cancel", cancel_url, class: "btn btn-outline-secondary"

- else
  -# Single section when no link exists
  .card
    .card-header.d-flex.justify-content-between.align-items-center
      %h5.mb-0 Set Up 1:1 Link
      = link_to return_to_about_me_url, class: "btn btn-sm btn-outline-secondary" do
        %i.bi.bi-arrow-left.me-2
        = return_to_about_me_text
    
    .card-body
      = form_with model: [@organization, @person, @one_on_one_link], url: organization_company_teammate_one_on_one_link_path(organization, @teammate), method: :post, local: true do |f|
        .mb-3
          = f.label :url, "1:1 Link URL", class: "form-label"
          = f.url_field :url, class: "form-control", placeholder: "https://app.asana.com/0/123456/789 or https://docs.google.com/..."
          - if @one_on_one_link.errors[:url].any?
            .invalid-feedback.d-block
              = @one_on_one_link.errors[:url].join(', ')
          %small.form-text.text-muted
            Enter a link to your 1:1 document, project, or system. 
            %br
            Supported systems: Asana (with integration), Google Docs, Notion, etc.
        
        .d-flex.gap-2
          = f.submit "Save 1:1 Link", class: "btn btn-primary"
          - cancel_url = params[:return_url].presence || organization_company_teammate_check_ins_path(organization, @teammate)
          = link_to "Cancel", cancel_url, class: "btn btn-outline-secondary"
