- if @form && @form.errors.any?
  .alert.alert-danger
    %h5= "#{pluralize(@form.errors.count, "error")} prohibited this position from being saved:"
    %ul.mb-0
      - @form.errors.full_messages.each do |message|
        %li= message

.row
  .col-md-12
    = render 'shared/organization_dropdown', form: form, selected_organization: @position.position_type&.organization, current_organization: @organization

.row
  .col-md-6
    .mb-3
      = form.label :position_type_id, "Position Type", class: "form-label"
      .d-flex
        = form.select :position_type_id, 
          options_from_collection_for_select(@position_types, :id, :external_title, @position.position_type_id), 
          { prompt: 'Select a position type' }, 
          { class: "form-select", required: true, id: "position_type_select" }
        = link_to new_position_type_path, class: "btn btn-outline-secondary ms-2", target: "_blank" do
          %i.bi.bi-plus
      %small.form-text.text-muted Choose the type of position or create a new one
  
  .col-md-6
    .mb-3
      = form.label :position_level_id, "Position Level", class: "form-label"
      = form.select :position_level_id, 
        options_from_collection_for_select(@position_levels, :id, :level, @position.position_level_id), 
        { prompt: 'Select a position level' }, 
        { class: "form-select", required: true, id: "position_level_select" }
      %small.form-text.text-muted Choose the level within the selected position type

.row
  .col-md-12
    .mb-3
      = form.label :position_summary, "Position Summary", class: "form-label"
      = form.text_area :position_summary, class: "form-control", rows: 4,
        placeholder: "Optional description of this position's responsibilities and expectations..."
      %small.form-text.text-muted A brief description of what this position entails

- level_1_template = "• Living Values. Above the bar on all Values for 2+ quarters in the last 4 quarters \n\n• Meeting Required Assignments: Has met expectations of 80% of Required Assignments for 2 quarters in a row\n\n• Demonstrated Abilities: \n\nManager says, \"I want to entrust this person with more responsibility, because they have demonstrated the Abilities needed for the Assignments they are taking on\"\n\n• Achievement\n\nWTWT. If your team is meeting expectations for 2+ quarters in a row that directly contributes to every member of that team "
- level_2_template = "• Living Values. Above the bar on all Values for 2+ quarters in a row\n\n• Meeting Required Assignments: Has met expectations of 100% of Required Assignments for 2 quarters in a row\n\n• Demonstrated Abilities: \n\nManager says, \"I want to entrust this person with more responsibility, because they have demonstrated the Abilities needed for the Assignments they are taking on, and are above the expected milestone for 33% of the Abilities.\" \n\n• Achievement\n\nWTWT. If your team is exceeding expectations for 2+ quarters in a row that directly contributes to every member of that team "
- level_3_template = "• Living Values. Above the bar on all Values for 2+ quarters in a row\n\n• Meeting Required Assignments: Has met expectations of 100% of Required Assignments, and exceeding expectations for 50% of those, for 2 quarters in a row\n\n• Additional Assignment \n\nHas a \"Unique-to-You Assignment\" and has met expectations on it for 2 of the last 4 quarters. \n\n• Demonstrated Abilities: \n\nManager says, \"I want to entrust this person with more responsibility, because they have demonstrated the Abilities needed for the Assignments they are taking on, and are above the expected milestone for 33% of the Abilities.\" \n\n• Achievement\n\nWTWT. If your team is exceeding expectations for 2+ quarters in a row that directly contributes to every member of that team "
- eligibility_template = (@position.persisted? && @position.position_level) ? (minor_level = @position.position_level.level.split('.').last.to_i; case minor_level; when 1; level_1_template; when 2; level_2_template; when 3; level_3_template; else; level_1_template; end) : level_1_template

.row
  .col-md-12
    .mb-3
      .d-flex.justify-content-between.align-items-center.mb-2
        = form.label :eligibility_requirements_summary, "Eligibility Requirements Summary", class: "form-label mb-0"
        - if @position.persisted?
          %button.btn.btn-sm.btn-outline-secondary{type: "button", id: "use_template_btn"}
            Use Template
      = form.text_area :eligibility_requirements_summary, class: "form-control", rows: 8,
        placeholder: eligibility_template, id: "eligibility_requirements_summary_textarea"
      %small.form-text.text-muted Requirements for eligibility at this position level

.row{"data-controller" => "position-assignments"}
  .col-md-6
    .mb-3
      = form.label :required_assignments, "Required Assignments", class: "form-label"
      .border.rounded.p-3.bg-light{"data-position-assignments-type-value" => "required", "data-position-assignments-available-assignments-value" => @assignments.reject { |a| @position.required_assignments.map(&:assignment_id).include?(a.id) }.map { |a| { id: a.id, title: a.title } }.to_json}
        .mb-3{"data-position-assignments-target" => "container"}
          - @position.required_assignments.each do |pa|
            .assignment-card.card.mb-2{"data-assignment-id" => pa.assignment_id}
              .card-body.p-3
                .d-flex.justify-content-between.align-items-start.mb-2
                  %h6.card-title.mb-0.assignment-title= pa.assignment.title
                  %button.btn-close.btn-sm{type: "button", "data-action" => "click->position-assignments#removeAssignment"}
                
                .row.g-2
                  .col-6
                    %label.form-label.small.mb-1 Min % of effort
                    %input.form-control.form-control-sm.min-energy{type: "number", placeholder: "0", min: "0", max: "100", step: "5", value: pa.min_estimated_energy, "data-action" => "input->position-assignments#updateEnergy"}
                  .col-6
                    %label.form-label.small.mb-1 Max % of effort
                    %input.form-control.form-control-sm.max-energy{type: "number", placeholder: "100", min: "0", max: "100", step: "5", value: pa.max_estimated_energy, "data-action" => "input->position-assignments#updateEnergy"}
                
                .energy-error.text-danger.small.mt-1.d-none
                
                %input{type: "hidden", name: "position[required_assignment_ids][]", value: pa.assignment_id}
                %input{type: "hidden", name: "position[required_assignment_min_energy][]", value: pa.min_estimated_energy}
                %input{type: "hidden", name: "position[required_assignment_max_energy][]", value: pa.max_estimated_energy}
        
        = form.select :new_required_assignment_id, 
          options_from_collection_for_select(@assignments.reject { |a| @position.required_assignments.map(&:assignment_id).include?(a.id) }, :id, :title), 
          { prompt: 'Add required assignment' }, 
          { class: "form-select", "data-position-assignments-target" => "dropdown", "data-action" => "change->position-assignments#addAssignment" }
        %small.form-text.text-muted Assignments that must be completed for this position
  
  .col-md-6
    .mb-3
      = form.label :suggested_assignments, "Suggested Assignments", class: "form-label"
      .border.rounded.p-3.bg-light{"data-position-assignments-type-value" => "suggested", "data-position-assignments-available-assignments-value" => @assignments.reject { |a| @position.suggested_assignments.map(&:assignment_id).include?(a.id) }.map { |a| { id: a.id, title: a.title } }.to_json}
        .mb-3{"data-position-assignments-target" => "container"}
          - @position.suggested_assignments.each do |pa|
            .assignment-card.card.mb-2{"data-assignment-id" => pa.assignment_id}
              .card-body.p-3
                .d-flex.justify-content-between.align-items-start.mb-2
                  %h6.card-title.mb-0.assignment-title= pa.assignment.title
                  %button.btn-close.btn-sm{type: "button", "data-action" => "click->position-assignments#removeAssignment"}
                
                .row.g-2
                  .col-6
                    %label.form-label.small.mb-1 Min % of effort
                    %input.form-control.form-control-sm.min-energy{type: "number", placeholder: "0", min: "0", max: "100", step: "5", value: pa.min_estimated_energy, "data-action" => "input->position-assignments#updateEnergy"}
                  .col-6
                    %label.form-label.small.mb-1 Max % of effort
                    %input.form-control.form-control-sm.max-energy{type: "number", placeholder: "100", min: "0", max: "100", step: "5", value: pa.max_estimated_energy, "data-action" => "input->position-assignments#updateEnergy"}
                
                .energy-error.text-danger.small.mt-1.d-none
                
                %input{type: "hidden", name: "position[suggested_assignment_ids][]", value: pa.assignment_id}
                %input{type: "hidden", name: "position[suggested_assignment_min_energy][]", value: pa.min_estimated_energy}
                %input{type: "hidden", name: "position[suggested_assignment_max_energy][]", value: pa.max_estimated_energy}
        
        = form.select :new_suggested_assignment_id, 
          options_from_collection_for_select(@assignments.reject { |a| @position.suggested_assignments.map(&:assignment_id).include?(a.id) }, :id, :title), 
          { prompt: 'Add suggested assignment' }, 
          { class: "form-select", "data-position-assignments-target" => "dropdown", "data-action" => "change->position-assignments#addAssignment" }
        %small.form-text.text-muted Optional assignments that would be beneficial for this position

.row
  .col-md-6
    .mb-3
      = form.label :published_source_url, "Published External Reference", class: "form-label"
      = form.url_field :published_source_url, class: "form-control", 
        value: @position.published_url,
        placeholder: "https://docs.google.com/document/d/..."
      %small.form-text.text-muted URL to the published version of this position
  
  .col-md-6
    .mb-3
      = form.label :draft_source_url, "Draft External Reference", class: "form-label"
      = form.url_field :draft_source_url, class: "form-control", 
        value: @position.draft_url,
        placeholder: "https://docs.google.com/document/d/..."
      %small.form-text.text-muted URL to the draft version of this position


:javascript
  document.addEventListener('DOMContentLoaded', function() {
    const positionTypeSelect = document.getElementById('position_type_select');
    const positionLevelSelect = document.getElementById('position_level_select');
    
    if (positionTypeSelect && positionLevelSelect) {
      positionTypeSelect.addEventListener('change', function() {
        const positionTypeId = this.value;
        if (positionTypeId) {
          fetch(`/organizations/#{@organization.id}/positions/position_levels?position_type_id=${positionTypeId}`)
            .then(response => response.json())
            .then(data => {
              positionLevelSelect.innerHTML = '<option value="">Select a position level</option>';
              data.forEach(level => {
                const option = document.createElement('option');
                option.value = level.id;
                option.textContent = level.level_name;
                positionLevelSelect.appendChild(option);
              });
            });
        } else {
          positionLevelSelect.innerHTML = '<option value="">Select a position level</option>';
        }
      });
    }
    
    const useTemplateBtn = document.getElementById('use_template_btn');
    const eligibilityTextarea = document.getElementById('eligibility_requirements_summary_textarea');
    
    if (useTemplateBtn && eligibilityTextarea) {
      useTemplateBtn.addEventListener('click', function() {
        eligibilityTextarea.value = eligibilityTextarea.placeholder;
      });
    }
  }); 