- content_for :title, @department.name

- content_for :go_back_link do
  = link_to organization_departments_path(@organization), class: "go-back-link" do
    %i.bi.bi-arrow-left.me-2
    Back to Departments

- content_for :header do
  .d-flex.align-items-center.justify-content-between
    %h1.mb-0
      %i.bi.bi-diagram-3.me-2
      = @department.name
    .d-flex.gap-2
      - if policy(@department).update?
        = link_to edit_organization_department_path(@organization, @department), class: "btn btn-outline-primary" do
          %i.bi.bi-pencil.me-2
          Edit
      - if policy(@department).archive?
        = link_to archive_organization_department_path(@organization, @department), method: :patch, class: "btn btn-outline-danger", data: { confirm: "Are you sure you want to archive this department?" } do
          %i.bi.bi-archive.me-2
          Archive

.row.justify-content-center
  .col-lg-12
    .card.mb-4
      .card-header
        %h5.mb-0
          %i.bi.bi-info-circle.me-2
          Details
      .card-body
        %dl.row
          %dt.col-sm-3 Type
          %dd.col-sm-9
            %span.badge.bg-primary
              Department
          %dt.col-sm-3 Company
          %dd.col-sm-9
            = link_to organization_path(@department.company), class: "text-decoration-none" do
              = @department.company.name
          %dt.col-sm-3 Parent Department
          %dd.col-sm-9
            - if @department.parent_department
              -# Build hierarchy path from root to parent
              - hierarchy_path = @department.ancestors_list.reverse
              -# Display hierarchy with links
              - hierarchy_path.each_with_index do |dept, index|
                - if policy(dept).show?
                  = link_to organization_department_path(@organization, dept), class: "text-decoration-none" do
                    = dept.name
                - else
                  %span= dept.name
                - unless index == hierarchy_path.length - 1
                  %span.text-muted.mx-1
                    %i.bi.bi-chevron-right
            - else
              %span.text-muted (Root Department)

    - if @child_departments.any?
      .card.mb-4
        .card-header
          %h5.mb-0
            %i.bi.bi-diagram-3.me-2
            Child Departments (#{@child_departments.count})
        .card-body
          .table-responsive
            %table.table.table-hover
              %thead
                %tr
                  %th Name
                  %th Children
              %tbody
                - @child_departments.each do |child_dept|
                  %tr
                    %td
                      - if policy(child_dept).show?
                        = link_to organization_department_path(@organization, child_dept), class: "text-decoration-none" do
                          = child_dept.name
                      - else
                        %span= child_dept.name
                    %td
                      - child_count = child_dept.child_departments.active.count
                      - if child_count > 0
                        %span.text-muted
                          = pluralize(child_count, 'sub-department')
                      - else
                        %span.text-muted —

    - if @seats_as_department.any?
      .card.mb-4
        .card-header
          %h5.mb-0
            %i.bi.bi-person-badge.me-2
            Seats (#{@seats_as_department.count})
        .card-body
          .table-responsive
            %table.table.table-hover
              %thead
                %tr
                  %th Seat
                  %th Position Type
                  %th Needed By
                  %th State
                  %th Filled By
              %tbody
                - @seats_as_department.each do |seat|
                  - active_tenure = seat.employment_tenures.active.first
                  %tr
                    %td
                      = link_to organization_seat_path(@organization, seat), class: "text-decoration-none" do
                        = seat.display_name
                    %td= seat.title.external_title
                    %td= seat.seat_needed_by.strftime('%B %d, %Y')
                    %td
                      %span.badge{class: seat_state_badge_class(seat.state)}
                        = seat.state.titleize
                    %td
                      - if active_tenure&.teammate&.person
                        = link_to internal_organization_company_teammate_path(@organization, active_tenure.teammate), class: "text-decoration-none" do
                          = active_tenure.teammate.person.display_name
                      - else
                        %span.text-muted —

    / Titles Section
    .card.mb-4
      .card-header.d-flex.justify-content-between.align-items-center
        %h5.mb-0
          %i.bi.bi-briefcase.me-2
          Titles (#{@titles.count})
        - if policy(@department).update?
          = link_to associate_titles_organization_department_path(@organization, @department), class: "btn btn-sm btn-outline-primary" do
            %i.bi.bi-plus-circle.me-1
            Associate Titles
      .card-body
        - if @titles.any?
          .table-responsive
            %table.table.table-hover
              %thead
                %tr
                  %th Title
                  %th Level
                  %th Positions
              %tbody
                - @titles.each do |title|
                  %tr
                    %td
                      = link_to organization_title_path(@organization, title), class: "text-decoration-none" do
                        = title.external_title
                    %td= title.position_major_level.description
                    %td= title.positions.count
        - else
          .text-muted.text-center.py-3
            No titles associated with this department yet.

    / Assignments Section
    .card.mb-4
      .card-header.d-flex.justify-content-between.align-items-center
        %h5.mb-0
          %i.bi.bi-list-task.me-2
          Assignments (#{@assignments.count})
        - if policy(@department).update?
          = link_to associate_assignments_organization_department_path(@organization, @department), class: "btn btn-sm btn-outline-primary" do
            %i.bi.bi-plus-circle.me-1
            Associate Assignments
      .card-body
        - if @assignments.any?
          .table-responsive
            %table.table.table-hover
              %thead
                %tr
                  %th Title
                  %th Tagline
              %tbody
                - @assignments.each do |assignment|
                  %tr
                    %td
                      = link_to organization_assignment_path(@organization, assignment), class: "text-decoration-none" do
                        = assignment.title
                    %td= truncate(assignment.tagline, length: 100)
        - else
          .text-muted.text-center.py-3
            No assignments associated with this department yet.

    / Abilities Section
    .card.mb-4
      .card-header.d-flex.justify-content-between.align-items-center
        %h5.mb-0
          %i.bi.bi-award.me-2
          Abilities (#{@abilities.count})
        - if policy(@department).update?
          = link_to associate_abilities_organization_department_path(@organization, @department), class: "btn btn-sm btn-outline-primary" do
            %i.bi.bi-plus-circle.me-1
            Associate Abilities
      .card-body
        - if @abilities.any?
          .table-responsive
            %table.table.table-hover
              %thead
                %tr
                  %th Name
                  %th Description
              %tbody
                - @abilities.each do |ability|
                  %tr
                    %td
                      = link_to organization_ability_path(@organization, ability), class: "text-decoration-none" do
                        = ability.name
                    %td= truncate(ability.description, length: 100)
        - else
          .text-muted.text-center.py-3
            No abilities associated with this department yet.

    / Aspirations Section
    .card.mb-4
      .card-header.d-flex.justify-content-between.align-items-center
        %h5.mb-0
          %i.bi.bi-star.me-2
          Aspirations (#{@aspirations.count})
        - if policy(@department).update?
          = link_to associate_aspirations_organization_department_path(@organization, @department), class: "btn btn-sm btn-outline-primary" do
            %i.bi.bi-plus-circle.me-1
            Associate Aspirations
      .card-body
        - if @aspirations.any?
          .table-responsive
            %table.table.table-hover
              %thead
                %tr
                  %th Name
                  %th Description
              %tbody
                - @aspirations.each do |aspiration|
                  %tr
                    %td
                      = link_to organization_aspiration_path(@organization, aspiration), class: "text-decoration-none" do
                        = aspiration.name
                    %td= truncate(aspiration.description || '', length: 100)
        - else
          .text-muted.text-center.py-3
            No aspirations associated with this department yet.
