- content_for :title, "Feedback Requests"

- content_for :header do
  .d-flex.align-items-center
    %h1.mb-0.me-2
      %i.bi.bi-chat-dots.me-2
      Feedback Requests
    .d-flex.align-items-center
      - if policy(FeedbackRequest.new(company: organization.root_company || organization)).create?
        = link_to new_organization_feedback_request_path(organization), class: "btn btn-primary ml-2" do
          %i.bi.bi-plus
          New Request

- content_for :go_back_link do
  = link_to dashboard_organization_path(organization), class: "go-back-link" do
    %i.bi.bi-arrow-left.me-2
    Back to Dashboard

- content_for :header_action do
  = link_to customize_view_organization_feedback_requests_path(organization, params.except(:controller, :action, :page).permit!.to_h), class: "btn btn-outline-secondary" do
    %i.bi.bi-gear.me-2
    Customize

/ Spotlight Section
.row.justify-content-center.mb-4
  .col-lg-12
    .card.border-0.shadow-sm
      .card-body
        - case @current_spotlight
        - when 'open_requests'
          = render partial: 'organizations/feedback_requests/spotlights/open_requests'
        - when 'open_responders'
          = render partial: 'organizations/feedback_requests/spotlights/open_responders'
        - when 'responder_count'
          = render partial: 'organizations/feedback_requests/spotlights/responder_count'
        - else
          = render partial: 'organizations/feedback_requests/spotlights/overview'
      .card-footer.bg-light
        .row.align-items-center
          .col-md-6
            %small.text-muted
              %i.bi.bi-funnel.me-1
              Filters: 
              - filter_parts = []
              - filter_parts << (@current_filters[:show_archived] == '1' ? 'Archived' : 'Active')
              - filter_parts << (@current_filters[:subject] ? "Subject: #{CompanyTeammate.find(@current_filters[:subject])&.person&.display_name}" : 'All Subjects')
              - filter_parts << (@current_filters[:requestor] ? "Requestor: #{CompanyTeammate.find(@current_filters[:requestor])&.person&.display_name}" : 'All Requestors')
              - filter_parts << (@current_filters[:rateable_type] ? "#{@current_filters[:rateable_type]}" : 'All Types')
              = filter_parts.join(' / ')
              %br
              %i.bi.bi-sort-down.me-1
              - sort_display = case @current_sort
              - when 'created_at_desc' then 'Created Date (Newest First)'
              - when 'created_at_asc' then 'Created Date (Oldest First)'
              - when 'updated_at_desc' then 'Updated Date (Newest First)'
              - when 'updated_at_asc' then 'Updated Date (Oldest First)'
              - when 'subject_name' then 'Subject Name (A-Z)'
              - when 'subject_name_desc' then 'Subject Name (Z-A)'
              - else 'Created Date (Newest First)'
              Sort: #{sort_display}
          .col-md-6.text-end
            %small.text-muted
              %i.bi.bi-table.me-1
              View: #{@current_view.capitalize}
              %br
              %i.bi.bi-eye.me-1
              Spotlight: #{@current_spotlight&.humanize || 'Overview'}

/ Feedback Requests Table
.row.justify-content-center
  .col-lg-12
    - if @feedback_requests.any?
      .table-responsive
        %table.table.table-hover
          %thead
            %tr
              %th Subject
              %th Requestor
              %th Resource
              %th Questions
              %th Responders
              %th Observations
              %th Created
              %th Actions
          %tbody
            - @feedback_requests.each do |request|
              %tr{class: "#{'text-muted' if request.archived?}"}
                %td
                  = request.subject_of_feedback_teammate.person.display_name
                  - if request.archived?
                    %span.badge.bg-secondary.ms-2 Archived
                %td= request.requestor_teammate.person.display_name
                %td
                  - rateable = request.feedback_request_questions.first&.rateable
                  - if rateable
                    - case rateable.class.name
                    - when 'Assignment'
                      %span.badge.bg-primary= rateable.title
                    - when 'Ability'
                      %span.badge.bg-info= rateable.name
                    - when 'Aspiration'
                      %span.badge.bg-success= rateable.name
                  - else
                    %span.text-muted Generic
                %td
                  %span.badge.bg-secondary= request.feedback_request_questions.count
                %td
                  %span.badge.bg-secondary= request.responders.count
                %td
                  %span.badge.bg-secondary= request.observations.count
                %td= format_time_in_user_timezone(request.created_at)
                %td
                  .btn-group.btn-group-sm
                    = link_to organization_feedback_request_path(organization, request), class: "btn btn-outline-primary", title: "View" do
                      %i.bi.bi-eye
                    - if policy(request).update?
                      = link_to edit_organization_feedback_request_path(organization, request), class: "btn btn-outline-secondary", title: "Edit" do
                        %i.bi.bi-pencil
                    - if policy(request).answer?
                      = link_to answer_organization_feedback_request_path(organization, request), class: "btn btn-outline-success", title: "Answer" do
                        %i.bi.bi-reply
    - else
      .alert.alert-info
        %h6.mb-2
          %i.bi.bi-info-circle.me-2
          No Feedback Requests
        %p.mb-2
          - if @current_filters[:show_archived] == '1'
            There are no archived feedback requests.
          - else
            Create your first feedback request to gather structured feedback from teammates.
        - if policy(FeedbackRequest.new(company: organization.root_company || organization)).create?
          = link_to "Create First Feedback Request", new_organization_feedback_request_path(organization), class: "btn btn-primary btn-sm"
