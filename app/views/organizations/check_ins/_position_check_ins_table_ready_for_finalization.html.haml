-# Position Check-In Table View - Ready for Finalization State
.table-responsive
  %table.table.table-striped
    %thead
      %tr
        %th Position
        %th Your Assessment
        %th Other Person's Assessment
        %th Status
        %th Actions
    %tbody
      %tr
        %td
          = button_tag type: "submit", 
                       name: "redirect_to", 
                       value: history_organization_person_position_check_ins_path(@organization, @person),
                       "data-bs-toggle" => "popover", 
                       "data-bs-trigger" => "hover", 
                       "data-bs-placement" => "right", 
                       "data-bs-html" => "true", 
                       "data-bs-content" => latest_position_check_in_popover_content(check_in.teammate),
                       class: "btn btn-link text-decoration-none p-0 border-0 bg-transparent text-start" do
            = check_in.employment_tenure.position.display_name
            %i.bi.bi-clock-history.ms-1.text-muted
        %td
          - if view_mode == :manager
            = form.fields_for :position_check_in, check_in do |pf|
              = pf.select :manager_rating, options_for_select([['Select...', ''], ['üî¥ Performance Improvement Plan - Monitoring after PIP', 'performance_improvement_plan'], ['‚≠ïÔ∏è Written Warning - Monitoring after written warning', 'written_warning'], ['üü† Verbal Warning - Monitoring after verbal warning', 'verbal_warning'], ['üü° Actively Coaching - Mostly meeting expectations', 'actively_coaching'], ['üîµ Praising/Trusting - Consistent strong performance', 'praising_trusting'], ['üü¢ Looking to Reward - Exceptional, seeking to increase responsibility', 'looking_to_reward']], check_in.manager_rating), {}, class: 'form-control form-control-sm'
          - else
            %p.mb-2
              %strong Rating:
              = position_rating_display(check_in.send("#{view_mode}_rating"))
            %p.mb-0
              %strong Notes:
              = simple_format(check_in.send("#{view_mode}_private_notes"))
        %td
          - if view_mode == :manager
            = form.fields_for :position_check_in, check_in do |pf|
              = pf.text_area :manager_private_notes, class: 'form-control form-control-sm', rows: 2, placeholder: 'Manager notes...'
          - else
            - other_view_mode = view_mode == :manager ? :employee : :manager
            %p.mb-2
              %strong Rating:
              = position_rating_display(check_in.send("#{other_view_mode}_rating"))
            %p.mb-0
              %strong Notes:
              = simple_format(check_in.send("#{other_view_mode}_private_notes"))
        %td
          = form.fields_for :position_check_in, check_in do |pf|
            -# Hidden fields to preserve existing values
            = pf.hidden_field :manager_rating, value: check_in.manager_rating
            = pf.hidden_field :manager_private_notes, value: check_in.manager_private_notes
            = pf.hidden_field :employee_rating, value: check_in.employee_rating
            = pf.hidden_field :employee_private_notes, value: check_in.employee_private_notes
            
            .form-check
              = pf.radio_button :status, 'complete', checked: true
              = pf.label :status_complete, 'Complete', class: 'form-check-label'
            .form-check
              = pf.radio_button :status, 'draft'
              = pf.label :status_draft, 'Draft', class: 'form-check-label'
        %td
          - confirm_message = view_mode == :manager ? 'Are you ready to finalize this check-in? This will create the official rating.' : 'Your manager will review and finalize this check-in.'
          = link_to "Go to Finalization", organization_person_finalization_path(@organization, @person), 
                    class: 'btn btn-success btn-sm',
                    data: { confirm: confirm_message }

.small.text-muted.mt-2
  - if view_mode == :manager
    This will allow you to set the official rating and create a MAAP snapshot.
  - else
    Your manager will review both assessments and set the official rating.
