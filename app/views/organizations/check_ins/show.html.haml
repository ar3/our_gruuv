- content_for :header do
  %h1.mb-0 Check-Ins for #{@person.display_name}
  %p.text-muted.mb-0= "View Mode: #{@view_mode.to_s.titleize}"
        
- content_for :header_action do
  .d-flex.align-items-center.gap-2
    -# View Toggle Buttons
    .btn-group.me-3{"role" => "group"}
      = link_to organization_person_check_ins_path(@organization, @person, view: 'table'), 
                class: "btn btn-sm #{'btn-primary' if @view_mode_param == 'table'} #{'btn-outline-primary' if @view_mode_param != 'table'}",
                "data-view" => "table",
                title: "Table View" do
        %i.bi.bi-table.me-1
        Table
      = link_to organization_person_check_ins_path(@organization, @person, view: 'card'), 
                class: "btn btn-sm #{'btn-primary' if @view_mode_param == 'card'} #{'btn-outline-primary' if @view_mode_param != 'card'}",
                "data-view" => "card",
                title: "Card View" do
        %i.bi.bi-grid.me-1
        Card
    
    = render 'people/view_switcher'

- content_for :go_back_link do
  - if @person.active_employment_tenure_for(@organization)
    = link_to organization_person_finalization_path(@organization, @person), class: "go-back-link" do
      %i.bi.bi-arrow-left.me-2
      Go to Finalization
  - else
    = link_to organization_person_path(@organization, @person), class: "go-back-link" do
      %i.bi.bi-arrow-left.me-2
      Back to Profile

= render 'shared/check_in_wizard_header', organization: @organization, person: @person, current_step: 1

-# Show pending acknowledgement banner if applicable
- if @view_mode == :employee && @person.maap_snapshots.executed.where(employee_acknowledged_at: nil).any?
  .alert.alert-warning
    %strong ⚠️ Your manager has finalized check-ins.
    = link_to 'Review and Acknowledge', organization_person_finalization_path(@organization, @person), class: 'btn btn-sm btn-warning'

-# Mobile warning for table view
- if @view_mode_param == 'table'
  .alert.alert-info.d-md-none
    %strong ℹ️ Mobile Notice:
    This view performs better on larger screens. 
    = link_to 'Switch to card view for mobile', organization_person_check_ins_path(@organization, @person, view: 'card'), class: 'btn btn-sm btn-outline-primary ms-2'

-# Authorization Debug Section
- if params[:debug] == 'true' && @debug_data
  .alert.alert-secondary.mt-3
    %h5.mb-3
      %i.bi.bi-bug.me-2
      Authorization Debug
    .row
      .col-md-6
        %strong Logged-in Teammate:
        %br
        - if current_company_teammate
          - teammate = current_company_teammate
          ID: #{teammate.id}
          %br
          Person: #{teammate.person.display_name} (ID: #{teammate.person.id})
          %br
          Organization: #{teammate.organization.name} (ID: #{teammate.organization.id})
          %br
          - if teammate.person.og_admin?
            %span.badge.bg-danger Admin
        - else
          %span.text-muted Not logged in
      .col-md-6
        %strong Policy Information:
        %br
        Policy Class: #{@debug_data[:policy_class]}
        %br
        Policy Record: #{@debug_data[:policy_record].display_name} (ID: #{@debug_data[:policy_record].id})
        %br
        Policy Action: #{@debug_data[:policy_action]}
    %hr
    %strong Policy Conditions Breakdown (audit? method):
    %br
    %small.text-muted Each condition is checked in order. The first true condition grants access.
    .mt-2
      - conditions = @debug_data[:conditions]
      -# Condition 1: admin_bypass?
      - admin_bypass = conditions[:admin_bypass]
      .mb-2
        - if admin_bypass[:result]
          %span.text-success
            %i.bi.bi-check-circle-fill.me-1
        - else
          %span.text-muted
            %i.bi.bi-circle.me-1
        %code= admin_bypass[:description]
        - if admin_bypass[:result]
          %span.text-success (PASS - Admin bypass granted)
        - else
          %span.text-muted (FAIL - #{admin_bypass[:details]})
      -# Condition 2: viewing_teammate && record
      - both_exist = conditions[:viewing_teammate_and_record]
      .mb-2
        - if both_exist[:result]
          %span.text-success
            %i.bi.bi-check-circle-fill.me-1
        - else
          %span.text-danger
            %i.bi.bi-x-circle-fill.me-1
        %code= both_exist[:description]
        - if both_exist[:result]
          %span.text-success (PASS)
        - else
          %span.text-danger (FAIL - #{both_exist[:details]})
      -# Condition 3: viewing_teammate.terminated?
      - not_terminated = conditions[:not_terminated]
      - if not_terminated[:result] != nil
        .mb-2
          - if not_terminated[:result]
            %span.text-success
              %i.bi.bi-check-circle-fill.me-1
          - else
            %span.text-danger
              %i.bi.bi-x-circle-fill.me-1
          %code= not_terminated[:description]
          - if not_terminated[:result]
            %span.text-success (PASS - #{not_terminated[:details]})
          - else
            %span.text-danger (FAIL - #{not_terminated[:details]})
      -# Condition 4: viewing_teammate.person == record
      - own_profile = conditions[:own_profile]
      - if own_profile[:result] != nil
        .mb-2
          - if own_profile[:result]
            %span.text-success
              %i.bi.bi-check-circle-fill.me-1
          - else
            %span.text-muted
              %i.bi.bi-circle.me-1
          %code= own_profile[:description]
          - if own_profile[:result]
            %span.text-success (PASS - #{own_profile[:details]})
          - else
            %span.text-muted (FAIL - #{own_profile[:details]})
      -# Condition 5: viewing_teammate.has_active_employment_tenure?
      - has_active_tenure = conditions[:has_active_employment_tenure]
      - if has_active_tenure[:result] != nil
        .mb-2
          - if has_active_tenure[:result]
            %span.text-success
              %i.bi.bi-check-circle-fill.me-1
          - else
            %span.text-danger
              %i.bi.bi-x-circle-fill.me-1
          %code= has_active_tenure[:description]
          - if has_active_tenure[:result]
            %span.text-success (PASS - #{has_active_tenure[:details]})
          - else
            %span.text-danger (FAIL - #{has_active_tenure[:details]})
      -# Condition 6: viewing_teammate.can_manage_employment?
      - can_manage = conditions[:can_manage_employment]
      - if can_manage[:result] != nil
        .mb-2
          - if can_manage[:result]
            %span.text-success
              %i.bi.bi-check-circle-fill.me-1
          - else
            %span.text-muted
              %i.bi.bi-circle.me-1
          %code= can_manage[:description]
          - if can_manage[:result]
            %span.text-success (PASS - #{can_manage[:details]})
          - else
            %span.text-muted (FAIL - #{can_manage[:details]})
      -# Condition 7: viewing_teammate.person.in_managerial_hierarchy_of?(record, viewing_teammate.organization)
      - in_hierarchy = conditions[:in_managerial_hierarchy]
      - if in_hierarchy[:result] != nil
        .mb-2
          - if in_hierarchy[:result]
            %span.text-success
              %i.bi.bi-check-circle-fill.me-1
          - else
            %span.text-muted
              %i.bi.bi-circle.me-1
          %code= in_hierarchy[:description]
          - if in_hierarchy[:result]
            %span.text-success (PASS - #{in_hierarchy[:details]})
          - else
            %span.text-muted (FAIL - #{in_hierarchy[:details]})
    %hr
    %strong Final Result:
    - final_result = @debug_data[:final_result]
    - if final_result
      %span.badge.bg-success.fs-6
        %i.bi.bi-check-circle-fill.me-1
        #{@debug_data[:policy_action]} = TRUE (Access Granted)
    - else
      %span.badge.bg-danger.fs-6
        %i.bi.bi-x-circle-fill.me-1
        #{@debug_data[:policy_action]} = FALSE (Access Denied)

-# Stories Section (Read-Only)
= render 'stories_section'

-# Active Goals Section (Read-Only)
= render 'goals_section'

-# Prompts/Reflections Section (Read-Only)
= render 'prompts_section'

-# 1:1 Area Section (Read-Only)
= render 'one_on_one_section'

= form_with url: organization_person_check_ins_path(@organization, @person), method: :patch, scope: :check_ins do |f|
  
  -# Position Section
  = render 'shared/section_header', 
           title: 'Position/Overall', 
           icon: 'bi-briefcase', 
           description: 'Assess role performance and growth'
  
  - if @view_mode_param == 'table'
    = render 'position_check_ins_table',
             position_check_in: @position_check_in,
             form: f,
             view_mode: @view_mode
  - else
    = render 'position_check_in_card',
             position_check_in: @position_check_in,
             form: f,
             view_mode: @view_mode
  .row.mt-4
    .col-12
      = f.submit 'Save All Check-Ins', class: 'btn btn-primary btn-lg'

  -# Assignment Section
  = render 'shared/section_header', 
           title: 'Assignments/Outcomes', 
           icon: 'bi-clipboard-check', 
           description: 'Evaluate project contributions and energy',
           action_link: { url: assignment_selection_organization_person_path(@organization, @person), icon: 'bi-plus-circle', text: '', title: 'Manage assignments' }
  
  - if @view_mode_param == 'table'
    = render 'assignment_check_ins_table',
             assignment_check_ins: @assignment_check_ins,
             form: f,
             view_mode: @view_mode
  - else
    = render 'assignment_check_ins_card',
             assignment_check_ins: @assignment_check_ins,
             form: f,
             view_mode: @view_mode
  
  .row.mt-4
    .col-12
      = f.submit 'Save All Check-Ins', class: 'btn btn-primary btn-lg'
  
  -# Aspiration Section
  = render 'shared/section_header', 
           title: 'Aspirations/Values', 
           icon: 'bi-star', 
           description: 'Track progress toward personal goals'

  - if @view_mode_param == 'table'
    = render 'aspiration_check_ins_table',
             aspiration_check_ins: @aspiration_check_ins,
             form: f,
             view_mode: @view_mode
  - else
    = render 'aspiration_check_ins_card',
             aspiration_check_ins: @aspiration_check_ins,
             form: f,
             view_mode: @view_mode
  
  .row.mt-4
    .col-12
      = f.submit 'Save All Check-Ins', class: 'btn btn-primary btn-lg'

  -# Abilities Section
  = render 'shared/section_header', 
           title: 'Abilities/Skills/Knowledge', 
           icon: 'bi-briefcase', 
           description: 'View abilities relevant to your role and assignments'
  
  = render 'abilities_table',
           relevant_abilities: @relevant_abilities,
           view_mode: @view_mode,
           person: @person
    


  = render 'shared/section_header', 
           title: '1:1 Todos', 
           icon: 'bi-briefcase', 
           description: 'Connect to Asana for 1:1 todos?'

  = render 'shared/section_header', 
           title: '1:1 Topics/Issues/Opportunities', 
           icon: 'bi-briefcase', 
           description: 'Connect to Asana for 1:1 oppties?'

-# Dream Goals Section