- content_for :header do
  %h1.mb-0 Finalize Check-Ins for #{@person.display_name}
  - if @position_check_in&.officially_completed?
    %p.text-muted.mb-0 Review finalized check-ins and acknowledge changes
  - elsif current_person == @person
    %p.text-muted.mb-0 Review your check-ins that are ready for finalization
  - else
    %p.text-muted.mb-0 Review ready check-ins and finalize selected ones
        
- content_for :header_action do
  = render 'people/view_switcher'

- content_for :go_back_link do
  = link_to organization_person_check_ins_path(@organization, @person), class: "go-back-link" do
    %i.bi.bi-arrow-left.me-2
    Back to Check-Ins
  
  - if @position_check_in&.officially_completed?
    -# Employee Acknowledgment View
    .card.mb-4
      .card-header
        %h3 Position Check-In - Finalized
        %p.text-muted Completed on #{@position_check_in.official_check_in_completed_at.to_date}
      
      .card-body
        .row
          .col-md-4
            .card
              .card-header Employee Perspective
              .card-body
                %p= position_rating_display(@position_check_in.employee_rating)
                %p.small= simple_format(@position_check_in.employee_private_notes)
          
          .col-md-4
            .card
              .card-header Manager Perspective
              .card-body
                %p= position_rating_display(@position_check_in.manager_rating)
                %p.small= simple_format(@position_check_in.manager_private_notes)
          
          .col-md-4
            .card.border-success
              .card-header.bg-success.text-white Official Rating
              .card-body
                %h3= position_rating_display(@position_check_in.official_rating)
                %p.small Finalized by #{@position_check_in.finalized_by.display_name}
        
        - if @position_check_in.shared_notes.present?
          .card.mt-3
            .card-header Shared Notes
            .card-body= simple_format(@position_check_in.shared_notes)
        
        .row.mt-4
          .col-12
            = form_with url: acknowledge_organization_person_finalization_path(@organization, @person), method: :patch do |f|
              = f.submit 'Acknowledge Finalized Check-Ins', class: 'btn btn-success btn-lg',
                         data: { confirm: 'Are you sure you want to acknowledge these finalized check-ins?' }
  
  - elsif current_person == @person
    -# Employee Read-Only View
    .card.mb-4
      .card-header
        %h3 Position Check-In - Ready for Finalization
        %p.text-muted Your manager will review and finalize this check-in
      
      .card-body
        .row
          .col-md-6
            .card.border-primary
              .card-header.bg-primary.text-white
                %h5.mb-0 Your Assessment
              .card-body
                %p.mb-2
                  %strong Rating:
                  = position_rating_display(@position_check_in.employee_rating)
                %p.mb-0
                  %strong Notes:
                  = simple_format(@position_check_in.employee_private_notes)
          
          .col-md-6
            .card.border-info
              .card-header.bg-info.text-white
                %h5.mb-0 Manager's Assessment
              .card-body
                %p.mb-2
                  %strong Rating:
                  = position_rating_display(@position_check_in.manager_rating)
                %p.mb-0
                  %strong Notes:
                  = simple_format(@position_check_in.manager_private_notes)
        
        .alert.alert-info.mt-3
          %i.bi.bi-info-circle.me-2
          %strong Your manager will review both assessments and set the official rating.
          You will be notified when the finalization is complete.
  
  - else
    -# Manager Finalization View
    = form_with url: organization_person_finalization_path(@organization, @person), method: :post do |f|
      
      -# Position Finalization
      - if @position_check_in
        .card.mb-4
          .card-header
            %h3 Position Check-In
            = check_box_tag 'finalize_position', '1', true
            = label_tag 'finalize_position', 'Finalize Position'
          
          .card-body
            .row
              .col-md-6
                %h5 Employee Perspective
                %p= position_rating_display(@position_check_in.employee_rating)
                %p.small= simple_format(@position_check_in.employee_private_notes)
              
              .col-md-6
                %h5 Manager Perspective
                %p= position_rating_display(@position_check_in.manager_rating)
                %p.small= simple_format(@position_check_in.manager_private_notes)
            
            .row.mt-3
              .col-12
                .form-group
                  = label_tag :position_official_rating, "Official Rating"
                  = select_tag :position_official_rating,
                              options_for_select(position_rating_options, @position_check_in.manager_rating),
                              class: 'form-control'
                
                .form-group
                  = label_tag :position_shared_notes, "Shared Notes"
                  = text_area_tag :position_shared_notes, nil, rows: 3, class: 'form-control',
                                 placeholder: 'Summary, action items, career development plans...'
      
      -# Assignment Finalizations (Phase 2)
      -# Aspiration Finalizations (Phase 3)
      
      .row.mt-4
        .col-12
          .alert.alert-warning
            %strong ⚠️ This will:
            %ul
              %li Create MAAP snapshot with complete ratings
              %li Close selected tenures and open new ones
              %li Make all notes visible to #{@person.first_name}
              %li Send notification to #{@person.first_name}
          
          = f.submit 'Finalize Selected Check-Ins', class: 'btn btn-success btn-lg',
                     data: { confirm: 'Are you sure you want to finalize these check-ins?' }




