- content_for :title, "Huddles Review"

.container-fluid
  .row
    .col-12
      .d-flex.justify-content-between.align-items-center.mb-4
        %h1.mb-0 Huddles Review
        = link_to organization_path(@organization), class: "btn btn-outline-secondary" do
          %i.bi.bi-arrow-left.me-2
          Back to Organization
      
      / Date Range Filter
      .card.mb-4
        .card-body
          %h5.card-title Date Range
          = form_with url: huddles_review_organization_path(@organization), method: :get, local: true, class: "row g-3" do |form|
            .col-md-4
              = form.label :start_date, "Start Date", class: "form-label"
              = form.date_field :start_date, value: @start_date, class: "form-control"
            .col-md-4
              = form.label :end_date, "End Date", class: "form-label"
              = form.date_field :end_date, value: @end_date, class: "form-control"
            .col-md-4.d-flex.align-items-end
              = form.submit "Update Range", class: "btn btn-primary me-2"
              = link_to "Reset to 6 Weeks", huddles_review_organization_path(@organization), class: "btn btn-outline-secondary"
      
      / Slack Channel Management Sidebar
      .row.mb-4
        .col-12
          .card
            .card-header
              %h5.mb-0
                %i.bi.bi-slack.me-2
                Weekly Notifications Setup
            .card-body
              - if !@organization.slack_configured?
                .alert.alert-warning
                  %i.bi.bi-exclamation-triangle.me-2
                  Slack must be configured to set up weekly notifications.
                  = link_to "Configure Slack", organization_slack_path(@organization), class: "btn btn-sm btn-warning ms-2"
              - else
                .row
                  .col-md-5
                    - slack_channels = @organization.third_party_objects.slack_channels.order(:display_name)
                    - last_refresh = slack_channels.maximum(:updated_at)

                    = form_with url: update_huddle_review_channel_organization_path(@organization), method: :patch, local: true, class: "row g-3" do |form|
                      .col-md-6
                        = form.label :channel_id, "Notification Channel", class: "form-label"
                        = form.select :channel_id,
                                    options_from_collection_for_select(slack_channels, :third_party_id, :display_name, @organization.huddle_review_notification_channel_id),
                                    { prompt: "Select Slack channel" },
                                    { class: "form-select" }
                      .col-md-3.d-flex.align-items-end
                        = form.submit "Save Channel", class: "btn btn-primary"

                  .col-md-3
                    = form_with url: refresh_slack_channels_organization_path(@organization), method: :post, local: true, class: "d-inline" do |refresh_form|
                      = refresh_form.submit "Refresh Channels",
                                            class: "btn btn-outline-secondary",
                                            data: { confirm: "This will refresh the list of available Slack channels. Continue?" }
                      %br/
                      %small.text-muted
                        %i.bi.bi-clock.me-1
                        Channels last refreshed: #{last_refresh.present? ? last_refresh.strftime("%B %d, %Y at %I:%M %p") : "Never"}

                  .col-md-4
                    - if @organization.huddle_review_notification_channel
                      = form_with url: trigger_weekly_notification_organization_path(@organization), method: :post, local: true, class: "d-inline" do |trigger_form|
                        = trigger_form.submit "Send Weekly Notification",
                                             class: "btn btn-success w-100",
                                             data: { confirm: "This will send a weekly notification to the selected channel. Continue?" }

                      - week_start = Date.current.beginning_of_week(:monday)
                      - existing_notification = Notification.where(notifiable: @organization, notification_type: 'huddle_summary', created_at: week_start..week_start.end_of_week).first
                      - if existing_notification&.message_id.present?
                        %small.text-muted.d-block.mt-1
                          %i.bi.bi-check-circle.me-1
                          Notification sent this week
                          = link_to "View in Slack", "https://slack.com/app_redirect?channel=#{@organization.huddle_review_notification_channel.third_party_id}&message_ts=#{existing_notification.message_id}",
                                    target: "_blank",
                                    class: "ms-1"
                    - else
                      %button.btn.btn-secondary.w-100{disabled: true}
                        %i.bi.bi-send.me-2
                        Send Weekly Notification
                      %small.text-muted.d-block.mt-1
                        Configure a notification channel first
      
      / Summary Cards
      .row.mb-4
        .col-md-3
          .card.text-center
            .card-body
              %h3.card-title.text-primary= @overall_metrics[:total_huddles]
              %p.card-text Huddles
        .col-md-3
          .card.text-center
            .card-body
              %h3.card-title.text-success{title: @overall_metrics[:distinct_participant_names].join(", "), data: {bs_toggle: "tooltip", bs_placement: "top"}}= @overall_metrics[:distinct_participant_count]
              %p.card-text Distinct Participants
        .col-md-3
          .card.text-center
            .card-body
              %h3.card-title.text-info= @overall_metrics[:average_rating]
              %p.card-text Avg Rating
        .col-md-3
          .card.text-center
            .card-body
              %h3.card-title.text-warning= "#{@overall_metrics[:participation_rate]}%"
              %p.card-text Participation Rate
      
      / Charts Section
      .row.mb-4
        .col-12
          .card
            .card-header
              %h5.mb-0 Rating Trends
            .card-body
              #rating-chart{style: "height: 400px;"}
      
      .row.mb-4
        .col-md-6
          .card
            .card-header
              %h5.mb-0 Participation Rate
            .card-body
              #participation-chart{style: "height: 300px;"}
        .col-md-6
          .card
            .card-header
              %h5.mb-0 Huddles per Week
            .card-body
              #huddles-chart{style: "height: 300px;"}
      
      / Weekly Breakdown
      .row.mb-4
        .col-12
          .card
            .card-header
              %h5.mb-0 Weekly Breakdown
            .card-body
              .table-responsive
                %table.table.table-striped
                  %thead
                    %tr
                      %th Week Starting
                      %th Huddles
                      %th Distinct Participants
                      %th Feedbacks
                      %th Avg Rating
                      %th Participation Rate
                  %tbody
                    - @weekly_metrics.sort.reverse.each do |week_start, metrics|
                      %tr
                        %td= week_start.strftime("%B %d, %Y")
                        %td= metrics[:total_huddles]
                        %td{title: metrics[:distinct_participant_names]&.join(", ") || "No participants", data: {bs_toggle: "tooltip", bs_placement: "top"}}= metrics[:distinct_participant_count]
                        %td= metrics[:total_feedbacks]
                        %td= metrics[:average_rating]
                        %td= "#{metrics[:participation_rate]}%"
      
      / Conflict Style Distribution
      .row.mb-4
        .col-md-6
          .card
            .card-header
              %h5.mb-0 Personal Conflict Styles
            .card-body
              #personal-conflict-chart{style: "height: 300px;"}
        .col-md-6
          .card
            .card-header
              %h5.mb-0 Team Conflict Styles
            .card-body
              #team-conflict-chart{style: "height: 300px;"}
      
      / Rating Distribution
      .row.mb-4
        .col-12
          .card
            .card-header
              %h5.mb-0 Rating Distribution
            .card-body
              #rating-distribution-chart{style: "height: 300px;"}
      
      / Team Comparison Section
      - if @team_metrics.any?
        .row.mb-4
          .col-12
            .card
              .card-header
                %h5.mb-0 Team Comparison
              .card-body
                .table-responsive
                  %table.table.table-striped
                    %thead
                      %tr
                        %th Team
                        %th Department
                        %th Huddles
                        %th Distinct Participants
                        %th Member Attendance Rate
                        %th Feedbacks
                        %th Avg Rating
                        %th Participant Feedback Given Rate
                        %th Actions
                    %tbody
                      - @team_metrics.sort_by { |team_id, metrics| -metrics[:average_rating] }.each do |team_id, metrics|
                        - team = Team.find_by(id: team_id)
                        - next unless team
                        %tr
                          %td
                            %strong= team.display_name
                          %td
                            %small= team.department&.display_name || '—'
                          %td= metrics[:total_huddles]
                          %td{title: metrics[:distinct_participant_names]&.join(", ") || "No participants", data: {bs_toggle: "tooltip", bs_placement: "top"}}= metrics[:distinct_participant_count]
                          %td
                            %span{class: (metrics[:member_attendance_rate] || 0) >= 80 ? 'text-success' : (metrics[:member_attendance_rate] || 0) >= 60 ? 'text-warning' : 'text-danger'}
                              = "#{metrics[:member_attendance_rate] || 0}%"
                          %td= metrics[:total_feedbacks]
                          %td
                            %span{class: metrics[:average_rating] >= 16 ? 'text-success' : metrics[:average_rating] >= 12 ? 'text-warning' : 'text-danger'}
                              = metrics[:average_rating]
                          %td
                            %span{class: metrics[:participation_rate] >= 80 ? 'text-success' : metrics[:participation_rate] >= 60 ? 'text-warning' : 'text-danger'}
                              = "#{metrics[:participation_rate]}%"
                          %td
                            %button.btn.btn-sm.btn-outline-primary{type: "button", "data-bs-toggle": "modal", "data-bs-target": "#teamModal", "data-team-id": team_id} View Details

      / Team Trends Chart
      - if @team_metrics.count > 1
        .row.mb-4
          .col-12
            .card
              .card-header
                %h5.mb-0 Team Rating Trends
              .card-body
                #team-trends-chart{style: "height: 400px;"}

      / Team Details Modal
      .modal.fade#teamModal{tabindex: "-1", "aria-labelledby": "teamModalLabel", "aria-hidden": "true"}
        .modal-dialog.modal-xl
          .modal-content
            .modal-header
              %h5.modal-title#teamModalLabel Team Details
              %button.btn-close{type: "button", "data-bs-dismiss": "modal", "aria-label": "Close"}
            .modal-body
              .row
                .col-md-6
                  #team-rating-chart{style: "height: 300px;"}
                .col-md-6
                  #team-participation-chart{style: "height: 300px;"}
              .row.mt-3
                .col-md-6
                  #team-conflict-personal-chart{style: "height: 250px;"}
                .col-md-6
                  #team-conflict-team-chart{style: "height: 250px;"}
              .row.mt-3
                .col-12
                  %h6 Recent Huddles
                  .table-responsive
                    %table.table.table-sm
                      %thead
                        %tr
                          %th Date
                          %th Team
                          %th Participants
                          %th Avg Rating
                          %th Participation
                      %tbody#team-huddles-list
            .modal-footer
              %button.btn.btn-secondary{type: "button", "data-bs-dismiss": "modal"} Close

:javascript
  console.log('Huddles Review JavaScript loaded');

  // Chart data from Rails
  var chartData = #{raw @chart_data.to_json};
  var overallMetrics = #{raw @overall_metrics.to_json};
  var teamMetrics = #{raw @team_metrics.to_json};

  console.log('Chart data loaded:', chartData);
  console.log('Overall metrics loaded:', overallMetrics);
  console.log('Team metrics count:', Object.keys(teamMetrics).length);
  
  function initializeCharts() {
    console.log('Initializing charts...');
    console.log('Highcharts available:', typeof Highcharts !== 'undefined');
    
    try {
      // Rating Trends Chart
      if (chartData.rating_data && chartData.rating_data.length > 0) {
        console.log('Creating rating chart with data:', chartData.rating_data);
        Highcharts.chart('rating-chart', {
          chart: { type: 'line' },
          title: { text: 'Average Rating Over Time' },
          xAxis: { type: 'datetime', title: { text: 'Week' } },
          yAxis: { title: { text: 'Average Rating' }, min: 0, max: 20 },
          series: [{
            name: 'Average Rating',
            data: chartData.rating_data,
            color: '#007bff'
          }],
          tooltip: {
            formatter: function() {
              return '<b>' + Highcharts.dateFormat('%B %d, %Y', this.x) + '</b><br/>' +
                     '<b>Rating:</b> ' + this.y;
            }
          }
        });
        console.log('Rating chart created successfully');
      }
      
      // Participation Rate Chart
      if (chartData.participation_data && chartData.participation_data.length > 0) {
        console.log('Creating participation chart with data:', chartData.participation_data);
        Highcharts.chart('participation-chart', {
          chart: { type: 'line' },
          title: { text: 'Participation Rate' },
          xAxis: { type: 'datetime', title: { text: 'Week' } },
          yAxis: { title: { text: 'Participation Rate (%)' }, min: 0, max: 100 },
          series: [{
            name: 'Participation Rate',
            data: chartData.participation_data,
            color: '#28a745'
          }],
          tooltip: {
            formatter: function() {
              return '<b>' + Highcharts.dateFormat('%B %d, %Y', this.x) + '</b><br/>' +
                     '<b>Participation:</b> ' + this.y + '%';
            }
          }
        });
        console.log('Participation chart created successfully');
      }
      
      // Huddles per Week Chart
      if (chartData.huddles_data && chartData.huddles_data.length > 0) {
        console.log('Creating huddles chart with data:', chartData.huddles_data);
        Highcharts.chart('huddles-chart', {
          chart: { type: 'column' },
          title: { text: 'Huddles per Week' },
          xAxis: { type: 'datetime', title: { text: 'Week' } },
          yAxis: { title: { text: 'Number of Huddles' }, min: 0 },
          series: [{
            name: 'Huddles',
            data: chartData.huddles_data,
            color: '#ffc107'
          }],
          tooltip: {
            formatter: function() {
              return '<b>' + Highcharts.dateFormat('%B %d, %Y', this.x) + '</b><br/>' +
                     '<b>Huddles:</b> ' + this.y;
            }
          }
        });
        console.log('Huddles chart created successfully');
      }
      
      // Personal Conflict Styles Chart
      if (overallMetrics.personal_conflict_styles && Object.keys(overallMetrics.personal_conflict_styles).length > 0) {
        console.log('Creating personal conflict chart');
        var personalConflictData = Object.keys(overallMetrics.personal_conflict_styles).map(function(style) {
          return [style, overallMetrics.personal_conflict_styles[style]];
        });
        
        Highcharts.chart('personal-conflict-chart', {
          chart: { type: 'pie' },
          title: { text: 'Personal Conflict Styles' },
          series: [{
            name: 'Count',
            data: personalConflictData
          }],
          tooltip: {
            pointFormat: '{series.name}: <b>{point.y}</b> ({point.percentage:.1f}%)'
          },
          legend: { enabled: true },
          plotOptions: {
            pie: {
              allowPointSelect: true,
              cursor: 'pointer',
              showInLegend: true
            }
          }
        });
        console.log('Personal conflict chart created successfully');
      }
      
      // Team Conflict Styles Chart
      if (overallMetrics.team_conflict_styles && Object.keys(overallMetrics.team_conflict_styles).length > 0) {
        console.log('Creating team conflict chart');
        var teamConflictData = Object.keys(overallMetrics.team_conflict_styles).map(function(style) {
          return [style, overallMetrics.team_conflict_styles[style]];
        });
        
        Highcharts.chart('team-conflict-chart', {
          chart: { type: 'pie' },
          title: { text: 'Team Conflict Styles' },
          series: [{
            name: 'Count',
            data: teamConflictData
          }],
          tooltip: {
            pointFormat: '{series.name}: <b>{point.y}</b> ({point.percentage:.1f}%)'
          },
          legend: { enabled: true },
          plotOptions: {
            pie: {
              allowPointSelect: true,
              cursor: 'pointer',
              showInLegend: true
            }
          }
        });
        console.log('Team conflict chart created successfully');
      }
      
      // Rating Distribution Chart
      if (overallMetrics.rating_distribution && Object.keys(overallMetrics.rating_distribution).length > 0) {
        console.log('Creating rating distribution chart');
        Highcharts.chart('rating-distribution-chart', {
          chart: { type: 'column' },
          title: { text: 'Rating Distribution' },
          xAxis: {
            categories: Object.keys(overallMetrics.rating_distribution),
            title: { text: 'Rating Score' }
          },
          yAxis: { title: { text: 'Number of Feedbacks' }, min: 0 },
          series: [{
            name: 'Feedbacks',
            data: Object.values(overallMetrics.rating_distribution),
            color: '#6f42c1'
          }],
          tooltip: {
            formatter: function() {
              return '<b>Rating ' + this.x + '</b><br/>' +
                     '<b>Feedbacks:</b> ' + this.y;
            }
          }
        });
        console.log('Rating distribution chart created successfully');
      }
      
      // Team Trends Chart (if multiple teams)
      var teamTrendsData = [];
      if (Object.keys(teamMetrics).length > 1) {
        console.log('Creating team trends chart');
        teamTrendsData = Object.keys(teamMetrics).map(function(key) {
          var team = teamMetrics[key];
          return {
            name: team.display_name + ' (' + (team.department_name || '—') + ')',
            data: team.weekly_trends ? Object.keys(team.weekly_trends).sort().map(function(week) {
              return [new Date(week).getTime(), team.weekly_trends[week].average_rating];
            }) : []
          };
        });
      }

      var teamTrendsChart = document.getElementById('team-trends-chart');
      if (teamTrendsChart && teamTrendsData.length > 0) {
        console.log('Creating team trends chart with data:', teamTrendsData);
        Highcharts.chart('team-trends-chart', {
          chart: { type: 'line' },
          title: { text: 'Team Rating Trends' },
          xAxis: { type: 'datetime', title: { text: 'Week' } },
          yAxis: { title: { text: 'Average Rating' }, min: 0, max: 20 },
          series: teamTrendsData,
          tooltip: {
            formatter: function() {
              return '<b>' + Highcharts.dateFormat('%B %d, %Y', this.x) + '</b><br/>' +
                     '<b>' + this.series.name + ':</b> ' + this.y;
            }
          },
          legend: { enabled: true }
        });
        console.log('Team trends chart created successfully');
      }

      // Team Modal Event Handler (using vanilla JS instead of jQuery)
      var teamModal = document.getElementById('teamModal');
      if (teamModal) {
        teamModal.addEventListener('show.bs.modal', function (event) {
          console.log('Team modal opening');
          var button = event.relatedTarget;
          var teamId = button.getAttribute('data-team-id');
          var team = teamMetrics[teamId]; // Direct access using ID as key

          if (team) {
            console.log('Loading team data for modal:', team);
            var modalLabel = document.getElementById('teamModalLabel');
            if (modalLabel) {
              modalLabel.innerHTML = team.display_name + ' Details';
            }

            var ratingData = team.weekly_trends ?
              Object.keys(team.weekly_trends).sort().map(function(week) {
                return [new Date(week).getTime(), team.weekly_trends[week].average_rating];
              }) : [];

            Highcharts.chart('team-rating-chart', {
              chart: { type: 'line' },
              title: { text: 'Rating Trends' },
              xAxis: { type: 'datetime' },
              yAxis: { title: { text: 'Average Rating' }, min: 0, max: 20 },
              series: [{ name: 'Rating', data: ratingData, color: '#007bff' }],
              tooltip: {
                formatter: function() {
                  return '<b>' + Highcharts.dateFormat('%B %d, %Y', this.x) + '</b><br/>' +
                         '<b>Rating:</b> ' + this.y;
                }
              }
            });

            var participationData = team.weekly_trends ?
              Object.keys(team.weekly_trends).sort().map(function(week) {
                return [new Date(week).getTime(), team.weekly_trends[week].participation_rate];
              }) : [];

            Highcharts.chart('team-participation-chart', {
              chart: { type: 'line' },
              title: { text: 'Participation Trends' },
              xAxis: { type: 'datetime' },
              yAxis: { title: { text: 'Participation Rate (%)' }, min: 0, max: 100 },
              series: [{ name: 'Participation', data: participationData, color: '#28a745' }],
              tooltip: {
                formatter: function() {
                  return '<b>' + Highcharts.dateFormat('%B %d, %Y', this.x) + '</b><br/>' +
                         '<b>Participation:</b> ' + this.y + '%';
                }
              }
            });

            var personalConflictData = team.personal_conflict_styles ?
              Object.keys(team.personal_conflict_styles).map(function(style) {
                return [style, team.personal_conflict_styles[style]];
              }) : [];

            Highcharts.chart('team-conflict-personal-chart', {
              chart: { type: 'pie' },
              title: { text: 'Personal Conflict Styles' },
              series: [{ name: 'Count', data: personalConflictData }],
              tooltip: { pointFormat: '{series.name}: <b>{point.y}</b> ({point.percentage:.1f}%)' },
              legend: { enabled: true },
              plotOptions: {
                pie: {
                  allowPointSelect: true,
                  cursor: 'pointer',
                  showInLegend: true
                }
              }
            });

            var teamConflictData = team.team_conflict_styles ?
              Object.keys(team.team_conflict_styles).map(function(style) {
                return [style, team.team_conflict_styles[style]];
              }) : [];

            Highcharts.chart('team-conflict-team-chart', {
              chart: { type: 'pie' },
              title: { text: 'Team Conflict Styles' },
              series: [{ name: 'Count', data: teamConflictData }],
              tooltip: { pointFormat: '{series.name}: <b>{point.y}</b> ({point.percentage:.1f}%)' },
              legend: { enabled: true },
              plotOptions: {
                pie: {
                  allowPointSelect: true,
                  cursor: 'pointer',
                  showInLegend: true
                }
              }
            });

            var huddlesList = '';
            if (team.huddles) {
              team.huddles.forEach(function(huddle) {
                huddlesList += '<tr>' +
                  '<td>' + new Date(huddle.started_at).toLocaleDateString() + '</td>' +
                  '<td>' + (team.display_name || 'Unknown Team') + '</td>' +
                  '<td>' + (huddle.huddle_participants_count || (huddle.huddle_participants ? huddle.huddle_participants.length : 0)) + '</td>' +
                  '<td>' + (huddle.average_rating || 'N/A') + '</td>' +
                  '<td>' + (huddle.participation_rate || 'N/A') + '%</td>' +
                  '</tr>';
              });
            }
            var huddlesListElement = document.getElementById('team-huddles-list');
            if (huddlesListElement) {
              huddlesListElement.innerHTML = huddlesList;
            }
            console.log('Team modal charts created successfully');
          }
        });
      }

      console.log('All charts initialized successfully');
      
      // Initialize popovers after charts are done
      initializePopovers();
    } catch (error) {
      console.error('Error initializing charts:', error);
    }
  }
  
  // Initialize Bootstrap popovers for participant data
  function initializePopovers() {
    console.log('Initializing popovers...');
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
      return new bootstrap.Popover(popoverTriggerEl, {
        html: true,
        sanitize: false
      });
    });
    console.log('Popovers initialized:', popoverList.length);
  }
  
  // Multiple initialization strategies
  function tryInitializeCharts() {
    console.log('Attempting to initialize charts...');
    console.log('Document ready state:', document.readyState);
    console.log('Highcharts available:', typeof Highcharts !== 'undefined');
    
    if (typeof Highcharts !== 'undefined' && document.readyState === 'complete') {
      console.log('Both Highcharts and DOM are ready, initializing...');
      initializeCharts();
    } else if (typeof Highcharts !== 'undefined') {
      console.log('Highcharts available but DOM not complete, waiting...');
      setTimeout(tryInitializeCharts, 100);
    } else {
      console.log('Highcharts not available, waiting...');
      setTimeout(tryInitializeCharts, 100);
    }
  }
  
  // Wait for both DOM and Highcharts to be ready
  var attempts = 0;
  function waitForHighcharts() {
    attempts++;
    console.log('Waiting for Highcharts... (attempt ' + attempts + ')');
    
    if (typeof Highcharts !== 'undefined') {
      console.log('Highcharts found, initializing charts');
      initializeCharts();
    } else if (attempts < 100) { // Wait up to 10 seconds
      setTimeout(waitForHighcharts, 100);
    } else {
      console.error('Highcharts failed to load after 10 seconds. Trying alternative CDN...');
      loadHighchartsAlternative();
    }
  }
  
  function loadHighchartsAlternative() {
    console.log('Loading Highcharts from alternative CDN...');
    var script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.3.0/highcharts.js';
    script.onload = function() {
      console.log('Highcharts loaded from alternative CDN');
      initializeCharts();
    };
    script.onerror = function() {
      console.error('Failed to load Highcharts from alternative CDN');
    };
    document.head.appendChild(script);
  }
  
  // Multiple event listeners to ensure initialization
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOMContentLoaded fired');
      waitForHighcharts();
    });
  } else {
    console.log('Document already loaded, checking Highcharts');
    waitForHighcharts();
  }
  
  // Also try on window load
  window.addEventListener('load', function() {
    console.log('Window load fired');
    tryInitializeCharts();
  });
  
  // Immediate attempt
  console.log('Making immediate attempt to initialize');
  tryInitializeCharts(); 