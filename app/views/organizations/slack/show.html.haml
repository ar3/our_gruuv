- content_for :title, "Slack Configuration"

- content_for :header do
  %h1.mb-0{id: "slack-title"}
    %i.bi.bi-slack.me-2
    Slack Configuration

- content_for :go_back_link do
  = link_to organization_path(@organization), class: "text-muted text-decoration-none" do
    %i.bi.bi-arrow-left.me-2
    Back to Organization

- can_manage_slack = policy(@organization).manage_employment?
- slack_disabled_tooltip = "Requires permission to manage employment to modify Slack settings."

.row.justify-content-center
  .col-lg-10
    - unless can_manage_slack
      .alert.alert-info.mb-4
        %strong Only the following teammates can make adjustments to #{@organization.display_name} Slack settings:
        - if @teammates_with_manage_employment.present?
          = @teammates_with_manage_employment.to_sentence
        - else
          %em No teammates with this permission in this organization.

    / Section 1: Slack Setup/Configuration
    .card.mb-4
      .card-header
        %h5.mb-0
          %i.bi.bi-slack.me-2
          Slack Setup & Configuration
      .card-body
        = slack_configuration_status(@organization)
        
        - if @slack_config&.configured?
          / Workspace info and who installed
          .row.mt-3
            .col-md-6
              %h6.text-muted.mb-2 Workspace
              %ul.list-unstyled.small
                %li
                  %strong Workspace:
                  = @slack_config.workspace_name
                %li
                  %strong Workspace ID:
                  = @slack_config.workspace_id
                - if @slack_config.workspace_url.present?
                  %li
                    %strong URL:
                    = link_to @slack_config.workspace_url, @slack_config.workspace_url, target: "_blank", rel: "noopener"
                %li
                  %strong Installed at:
                  = @slack_config.installed_at.strftime("%B %d, %Y at %l:%M %p")
            .col-md-6
              %h6.text-muted.mb-2 Installed by
              %p.small.mb-0
                = @slack_config.configured_by_name
          
          %hr
          / Bot Configuration Form (always visible, no edit button)
          .row.mt-3
            .col-12
              %h6.mb-3 Bot Configuration
              = form_with model: @slack_config, url: update_configuration_organization_slack_path(@organization), method: :patch, local: true do |form|
                .row
                  .col-md-4
                    = form.label :default_channel, "Default Channel", class: "form-label"
                    = form.text_field :default_channel, class: "form-control", placeholder: "#bot-test", value: @slack_config.default_channel_or_general, disabled: !can_manage_slack
                  .col-md-4
                    = form.label :bot_username, "Bot Username", class: "form-label"
                    = form.text_field :bot_username, class: "form-control", placeholder: "OG", value: @slack_config.bot_username_or_default, disabled: !can_manage_slack
                  .col-md-4
                    = form.label :bot_emoji, "Bot Emoji", class: "form-label"
                    = form.text_field :bot_emoji, class: "form-control", placeholder: ":sparkles:", value: @slack_config.bot_emoji_or_default, disabled: !can_manage_slack
                .row.mt-3
                  .col-12.d-flex.align-items-center.gap-2
                    = form.submit "Update Configuration", class: "btn btn-primary btn-sm", disabled: !can_manage_slack
                    - unless can_manage_slack
                      %i.bi.bi-exclamation-triangle.text-warning{data: {bs_toggle: "tooltip", bs_title: slack_disabled_tooltip}, style: "font-size: 1rem;"}
          
          / Test Buttons
          .row.mt-4{"data-controller" => "slack-test", "data-slack-test-organization-id-value" => @organization.id}
            .col-md-6
              %h6 Test Connection
              .d-flex.align-items-center.gap-2
                %button.btn.btn-outline-primary.btn-sm{data: {action: "click->slack-test#testConnection"}, disabled: !can_manage_slack}
                  %i.bi.bi-wifi.me-1
                  Test Connection
                - unless can_manage_slack
                  %i.bi.bi-exclamation-triangle.text-warning{data: {bs_toggle: "tooltip", bs_title: slack_disabled_tooltip}, style: "font-size: 1rem;"}
              #connectionResult.mt-2
            
            .col-md-6
              %h6 List Channels
              .d-flex.align-items-center.gap-2
                %button.btn.btn-outline-secondary.btn-sm{data: {action: "click->slack-test#listChannels"}, disabled: !can_manage_slack}
                  %i.bi.bi-list.me-1
                  List Channels
                - unless can_manage_slack
                  %i.bi.bi-exclamation-triangle.text-warning{data: {bs_toggle: "tooltip", bs_title: slack_disabled_tooltip}, style: "font-size: 1rem;"}
              #channelsResult.mt-2
          
          .row.mt-3{"data-controller" => "slack-test", "data-slack-test-organization-id-value" => @organization.id}
            .col-12
              %h6 Send Test Message
              .d-flex.align-items-center.gap-2
                .input-group.flex-grow-1
                  %input.form-control#testMessage{type: "text", placeholder: "Enter test message...", value: "ðŸ§ª Test message from OurGruuv!", data: {slack_test_target: "messageInput"}, disabled: !can_manage_slack}
                  %button.btn.btn-outline-success{data: {action: "click->slack-test#sendTestMessage"}, disabled: !can_manage_slack}
                    %i.bi.bi-send.me-1
                    Send
                - unless can_manage_slack
                  %i.bi.bi-exclamation-triangle.text-warning{data: {bs_toggle: "tooltip", bs_title: slack_disabled_tooltip}, style: "font-size: 1rem;"}
              #messageResult.mt-2
          
          / Uninstall Button
          .row.mt-4
            .col-12.d-flex.align-items-center.gap-2
              = button_to oauth_uninstall_organization_slack_path(@organization), method: :delete, class: "btn btn-outline-danger", disabled: !can_manage_slack, data: { confirm: can_manage_slack ? "Are you sure you want to uninstall Slack from #{@organization.display_name}?" : nil } do
                %i.bi.bi-trash.me-2
                Uninstall Slack
              - unless can_manage_slack
                %i.bi.bi-exclamation-triangle.text-warning{data: {bs_toggle: "tooltip", bs_title: slack_disabled_tooltip}, style: "font-size: 1rem;"}
        - else
          - if can_manage_slack
            = link_to oauth_authorize_organization_slack_path(@organization), class: "btn btn-primary mt-3" do
              %i.bi.bi-slack.me-2
              Install Slack for #{@organization.display_name}
          - else
            .d-inline-flex.align-items-center.gap-2.mt-3
              %button.btn.btn-primary.disabled{type: "button"}
                %i.bi.bi-slack.me-2
                Install Slack for #{@organization.display_name}
              %i.bi.bi-exclamation-triangle.text-warning{data: {bs_toggle: "tooltip", bs_title: slack_disabled_tooltip}, style: "font-size: 1rem;"}
    
    / Section 2: Teammate Associations Summary
    - if @slack_config&.configured?
      = teammate_association_stats(@organization, @total_slack_users, @total_teammates, @linked_teammates)
      
      / Refresh Slack Profiles Button
      .card.mb-4
        .card-body.d-flex.align-items-center.gap-2
          = button_to refresh_slack_profiles_organization_path(@organization), method: :post, class: "btn btn-outline-primary", disabled: !can_manage_slack, data: { confirm: can_manage_slack ? "This will match Slack profiles to teammates by email. Existing associations will not be changed. Continue?" : nil } do
            %i.bi.bi-arrow-clockwise.me-2
            Refresh Slack Profiles
          - unless can_manage_slack
            %i.bi.bi-exclamation-triangle.text-warning{data: {bs_toggle: "tooltip", bs_title: slack_disabled_tooltip}, style: "font-size: 1rem;"}
    
    / Section 3: Channel & Group Associations Summary
    - if @slack_config&.configured?
      = channel_association_stats(@organization, @total_channels, @total_groups, @total_departments, @total_teams)
