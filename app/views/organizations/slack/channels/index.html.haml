- content_for :title, "Manage Channels"

- content_for :header do
  %h1.mb-0{id: "channels-title"}
    %i.bi.bi-hash.me-2
    Manage Channel & Group Associations

- content_for :go_back_link do
  = link_to organization_slack_path(@organization), class: "text-muted text-decoration-none" do
    %i.bi.bi-arrow-left.me-2
    Back to Slack Configuration

.row.justify-content-center
  .col-lg-12
    .card.mb-4
      .card-header.d-flex.justify-content-between.align-items-center
        %h5.mb-0
          %i.bi.bi-hash.me-2
          Organization Channel & Group Associations
        .btn-group
          = button_to refresh_channels_organization_slack_path(@organization), method: :post, class: "btn btn-sm btn-outline-primary" do
            %i.bi.bi-arrow-clockwise.me-1
            Refresh Channels
          = button_to refresh_groups_organization_slack_path(@organization), method: :post, class: "btn btn-sm btn-outline-secondary" do
            %i.bi.bi-arrow-clockwise.me-1
            Refresh Groups
      .card-body
        - if @slack_channels.empty? && @slack_groups.empty?
          .alert.alert-warning
            %i.bi.bi-exclamation-triangle.me-2
            Slack is not configured or no channels/groups found. Please refresh channels and groups.
        - else
          / Section 1: Company-Only Channels (Huddle Review)
          - if @organization.company?
            .card.mb-4.border-primary
              .card-header.bg-primary.text-white.d-flex.justify-content-between.align-items-center
                %h6.mb-0
                  %i.bi.bi-building.me-2
                  Company Settings
                = link_to edit_company_channel_organization_slack_path(@organization, target_organization_id: @organization.id), class: "btn btn-sm btn-light" do
                  %i.bi.bi-pencil-square.me-1
                  Edit
              .card-body
                - company_record = @organization.becomes(Company)
                .mb-3
                  .row.align-items-center
                    .col-md-8
                      %label.form-label Huddle Review Channel
                      - if company_record.huddle_review_notification_channel_id.present?
                        - channel = @slack_channels.find { |c| c.third_party_id == company_record.huddle_review_notification_channel_id }
                        %p.mb-1
                          = channel&.display_name || company_record.huddle_review_notification_channel_id
                      - else
                        %p.mb-1.text-muted None
                      %small.form-text.text-muted
                        Channel where weekly huddle review summaries will be posted
                    .col-md-4.text-end
                      - if company_record.huddle_review_notification_channel_id.present?
                        %span.badge.bg-success
                          %i.bi.bi-check-circle.me-1
                          Configured
                .mb-3
                  .row.align-items-center
                    .col-md-8
                      %label.form-label MAAP Object Comment Channel
                      - if company_record.maap_object_comment_channel_id.present?
                        - channel = @slack_channels.find { |c| c.third_party_id == company_record.maap_object_comment_channel_id }
                        %p.mb-1
                          = channel&.display_name || company_record.maap_object_comment_channel_id
                      - else
                        %p.mb-1.text-muted None
                      %small.form-text.text-muted
                        Channel where notifications for new root-level comments will be posted
                    .col-md-4.text-end
                      - if company_record.maap_object_comment_channel_id.present?
                        %span.badge.bg-success
                          %i.bi.bi-check-circle.me-1
                          Configured

          / Section 2: Organization-Wide Channels (Kudos & Groups)
          .card.mb-4
            .card-header
              %h6.mb-0
                %i.bi.bi-people.me-2
                Organization-Wide Settings
            .card-body
              .table-responsive
                %table.table.table-hover
                  %thead
                    %tr
                      %th{style: "width: 30%;"} Organization
                      %th{style: "width: 25%;"} Kudos Channel
                      %th{style: "width: 25%;"} Slack Group
                      %th{style: "width: 10%;"} Status
                      %th{style: "width: 10%;"} Actions
                  %tbody
                    - @organizations.each do |org|
                      - indent_level = org.ancestry_depth
                      - indent_px = indent_level * 20
                      %tr{ data: { organization_id: org.id } }
                        %td{style: "padding-left: #{indent_px}px;"}
                          - if indent_level > 0
                            %i.bi.bi-arrow-return-right.me-2.text-muted
                            = org.name
                          - else
                            %strong= org.name
                          %br
                          %small.text-muted= org.type.underscore.humanize
                        %td
                          - kudos_channel = org.kudos_channel
                          - if kudos_channel.present?
                            = kudos_channel.display_name
                          - else
                            %span.text-muted None
                        %td
                          - if org.respond_to?(:slack_group) && org.slack_group.present?
                            = org.slack_group.display_name
                          - else
                            %span.text-muted None
                        %td
                          - if org.kudos_channel_id.present?
                            %span.badge.bg-success.me-1
                              %i.bi.bi-check-circle.me-1
                              Kudos
                          - if org.respond_to?(:slack_group_id) && org.slack_group_id.present?
                            %span.badge.bg-info
                              %i.bi.bi-check-circle.me-1
                              Group
                        %td.text-end
                          = link_to edit_channel_organization_slack_path(@organization, target_organization_id: org.id), class: "btn btn-sm btn-outline-primary" do
                            %i.bi.bi-pencil-square.me-1
                            Edit
