- content_for :title, "Manage Channels"

- content_for :header do
  %h1.mb-0{id: "channels-title"}
    %i.bi.bi-hash.me-2
    Manage Channel & Group Associations

- content_for :go_back_link do
  = link_to organization_slack_path(@organization), class: "text-muted text-decoration-none" do
    %i.bi.bi-arrow-left.me-2
    Back to Slack Configuration

- can_manage_slack = policy(@organization).manage_employment?

.row.justify-content-center
  .col-lg-12
    - unless can_manage_slack
      .alert.alert-warning.mb-4
        %strong
          %i.bi.bi-exclamation-triangle.me-2
          You cannot modify channel or group associations on this page.
        %p.mb-1.mt-2
          Only teammates with permission to manage employment can change or refresh these settings. If you see something that should be changed, contact one of them:
        - if @teammates_with_manage_employment.present?
          %ul.mb-0.mt-1
            - @teammates_with_manage_employment.each do |name|
              %li= name
        - else
          %p.mb-0.small
            %em No teammates with this permission in this organization.

    .card.mb-4
      .card-header.d-flex.justify-content-between.align-items-center
        %h5.mb-0
          %i.bi.bi-hash.me-2
          Organization Channel & Group Associations
        - if can_manage_slack
          .btn-group
            = button_to refresh_channels_organization_slack_path(@organization), method: :post, class: "btn btn-sm btn-outline-primary" do
              %i.bi.bi-arrow-clockwise.me-1
              Refresh Channels
            = button_to refresh_groups_organization_slack_path(@organization), method: :post, class: "btn btn-sm btn-outline-secondary" do
              %i.bi.bi-arrow-clockwise.me-1
              Refresh Groups
      .card-body
        - if @slack_channels.empty? && @slack_groups.empty?
          .alert.alert-warning
            %i.bi.bi-exclamation-triangle.me-2
            Slack is not configured or no channels/groups found. Please refresh channels and groups.
        - else
          / Section 1: Organization Settings (Huddle Review, Comments)
          .card.mb-4.border-primary
            .card-header.bg-primary.text-white.d-flex.justify-content-between.align-items-center
              %h6.mb-0
                %i.bi.bi-building.me-2
                Organization Settings
              - if can_manage_slack
                .btn-group.btn-group-sm{role: "group"}
                  = link_to edit_company_channel_organization_slack_path(@organization, target_organization_id: @organization.id), class: "btn btn-light btn-sm" do
                    %i.bi.bi-pencil-square.me-1
                    Edit
            .card-body
              .mb-3
                .row.align-items-center
                  .col-md-8
                    %label.form-label Huddle Review Channel
                    - if @organization.huddle_review_notification_channel_id.present?
                      - channel = @slack_channels.find { |c| c.third_party_id == @organization.huddle_review_notification_channel_id }
                      %p.mb-1
                        = channel&.display_name || @organization.huddle_review_notification_channel_id
                    - else
                      %p.mb-1.text-muted None
                    %small.form-text.text-muted
                      Channel where weekly huddle review summaries will be posted
                  .col-md-4.text-end
                    - if @organization.huddle_review_notification_channel_id.present?
                      %span.badge.bg-success
                        %i.bi.bi-check-circle.me-1
                        Configured
              .mb-3
                .row.align-items-center
                  .col-md-8
                    %label.form-label Comment Channel
                    - if @organization.maap_object_comment_channel_id.present?
                      - channel = @slack_channels.find { |c| c.third_party_id == @organization.maap_object_comment_channel_id }
                      %p.mb-1
                        = channel&.display_name || @organization.maap_object_comment_channel_id
                    - else
                      %p.mb-1.text-muted None
                    %small.form-text.text-muted
                      Channel where notifications for new root-level comments on assignments, abilities, and aspirations will be posted
                  .col-md-4.text-end
                    - if @organization.maap_object_comment_channel_id.present?
                      %span.badge.bg-success
                        %i.bi.bi-check-circle.me-1
                        Configured
              .mb-3
                .row.align-items-center
                  .col-md-8
                    %label.form-label Kudos Channel
                    - if @organization.kudos_channel_id.present?
                      - channel = @slack_channels.find { |c| c.third_party_id == @organization.kudos_channel_id }
                      %p.mb-1
                        = channel&.display_name || @organization.kudos_channel_id
                    - else
                      %p.mb-1.text-muted None
                    %small.form-text.text-muted
                      Channel where kudos messages will be posted
                  .col-md-4.text-end
                    - if @organization.kudos_channel_id.present?
                      %span.badge.bg-success
                        %i.bi.bi-check-circle.me-1
                        Configured

          / Section 2: Department-Related Channels (Kudos & Slack Group per department)
          .card.mb-4
            .card-header
              %h6.mb-0
                %i.bi.bi-people.me-2
                Department-Related Channels
            .card-body
              .table-responsive
                %table.table.table-hover
                  %thead
                    %tr
                      %th{style: "width: 30%;"} Department
                      %th{style: "width: 25%;"} Kudos Channel
                      %th{style: "width: 25%;"} Slack Group
                      %th{style: "width: 10%;"} Status
                      - if can_manage_slack
                        %th{style: "width: 10%;"} Actions
                  %tbody
                    - @organizations.each do |org|
                      - indent_level = org.respond_to?(:ancestry_depth) ? org.ancestry_depth : 0
                      - indent_px = indent_level * 20
                      %tr{ data: { organization_id: org.id } }
                        %td{style: "padding-left: #{indent_px}px;"}
                          - if indent_level > 0
                            %i.bi.bi-arrow-return-right.me-2.text-muted
                            = org.name
                          - else
                            %strong= org.name
                          %br
                          %small.text-muted= org.department? ? 'Department' : 'Organization'
                        %td
                          - kudos_channel = org.kudos_channel
                          - if kudos_channel.present?
                            = kudos_channel.display_name
                          - else
                            %span.text-muted None
                        %td
                          - if org.respond_to?(:slack_group) && org.slack_group.present?
                            = org.slack_group.display_name
                          - else
                            %span.text-muted None
                        %td
                          - if org.kudos_channel_id.present?
                            %span.badge.bg-success.me-1
                              %i.bi.bi-check-circle.me-1
                              Kudos
                          - if org.respond_to?(:slack_group_id) && org.slack_group_id.present?
                            %span.badge.bg-info
                              %i.bi.bi-check-circle.me-1
                              Group
                        - if can_manage_slack
                          %td.text-end
                            - if org.department?
                              = link_to edit_channel_organization_slack_path(@organization, target_organization_id: org.id), class: "btn btn-sm btn-outline-primary" do
                                %i.bi.bi-pencil-square.me-1
                                Edit

          / Section 3: Team-Related Channels (Huddle channel per team)
          - if @teams.present?
            .card.mb-4
              .card-header
                %h6.mb-0
                  %i.bi.bi-people-fill.me-2
                  Team-Related Channels
              .card-body
                .table-responsive
                  %table.table.table-hover
                    %thead
                      %tr
                        %th{style: "width: 40%;"} Team
                        %th{style: "width: 40%;"} Huddle Channel
                        %th{style: "width: 10%;"} Status
                        - if can_manage_slack
                          %th{style: "width: 10%;"} Actions
                    %tbody
                      - @teams.each do |team|
                        %tr{ data: { team_id: team.id } }
                          %td
                            %strong= team.name
                          %td
                            - huddle_channel = team.huddle_channel
                            - if huddle_channel.present?
                              = huddle_channel.display_name
                            - else
                              %span.text-muted None
                          %td
                            - if team.huddle_channel_id.present?
                              %span.badge.bg-success
                                %i.bi.bi-check-circle.me-1
                                Configured
                            - else
                              %span.badge.bg-warning.text-dark
                                %i.bi.bi-exclamation-triangle.me-1
                                Not Configured
                          - if can_manage_slack
                            %td.text-end
                              = link_to edit_team_channel_organization_slack_path(@organization, team_id: team.id), class: "btn btn-sm btn-outline-primary" do
                                %i.bi.bi-pencil-square.me-1
                                Edit
