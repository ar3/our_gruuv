- allowed_levels ||= Observation.privacy_levels.keys
- disabled_levels ||= {}
- observation_type ||= @observation_type || @observation&.observation_type || 'generic'
- observee_names ||= @observee_names || []
- manager_names ||= @manager_names || []
- direct_manager_names ||= @direct_manager_names || []
- other_manager_names ||= @other_manager_names || []
- only_observee_is_observer ||= @only_observee_is_observer || false
- organization ||= local_assigns[:organization] || @organization
- observation ||= @observation
- display_only ||= false
- company_name = observation&.company&.name || organization&.name || 'company'
- is_non_generic = ['quick_note', 'feedback', 'kudos'].include?(observation_type.to_s)

- if display_only
  %label.form-label Privacy Level
  - Observation.privacy_levels.keys.each do |key|
    - is_current = observation&.privacy_level == key
    .form-check
      = radio_button_tag 'privacy_level_display', key, is_current, class: 'form-check-input', disabled: true, id: "privacy_display_#{key}"
      = label_tag "privacy_display_#{key}", class: 'form-check-label' do
        - case key
        - when 'observer_only'
          ğŸ”’ Just for me (Journal)
        - when 'observed_only'
          - if observee_names.any?
            ğŸ‘¤ Just #{observee_names.join(', ')}
          - else
            ğŸ‘¤ Just for their eyes only
        - when 'managers_only'
          - if direct_manager_names.any?
            ğŸ‘” Just Managers: #{direct_manager_names.join(', ')}
            - if other_manager_names.any?
              %i.bi.bi-info-circle.ms-1{"data-bs-toggle" => "popover", "data-bs-trigger" => "hover", "data-bs-placement" => "top", "data-bs-html" => "true", "data-bs-content" => other_managers_popover_content(other_manager_names)}
          - else
            ğŸ‘” Just for their manager's eyes only
        - when 'observed_and_managers'
          - if observee_names.any? || direct_manager_names.any?
            - stakeholder_parts = []
            - stakeholder_parts << observee_names.join(', ') if observee_names.any?
            - stakeholder_parts << direct_manager_names.join(', ') if direct_manager_names.any?
            ğŸ‘¥ Stakeholders: #{stakeholder_parts.join(', ')}
            - if other_manager_names.any?
              %i.bi.bi-info-circle.ms-1{"data-bs-toggle" => "popover", "data-bs-trigger" => "hover", "data-bs-placement" => "top", "data-bs-html" => "true", "data-bs-content" => other_managers_popover_content(other_manager_names)}
          - else
            ğŸ‘¥ Stakeholder
        - when 'public_to_company'
          ğŸ¢ Public to #{company_name}
        - when 'public_to_world'
          ğŸŒ Public to world
- elsif is_non_generic
  .row.mb-3
    .col-md-6
      = form.label :privacy_level, "Privacy Level", class: 'form-label'
      - Observation.privacy_levels.keys.each do |key|
        - is_allowed = allowed_levels.nil? || allowed_levels.include?(key.to_sym)
        - disabled_message = disabled_levels[key.to_sym]
        - should_disable_observed_only = (key == 'observed_only' && only_observee_is_observer)
        - is_disabled = !is_allowed || should_disable_observed_only
        
        .form-check
          = form.radio_button :privacy_level, key, class: 'form-check-input', disabled: is_disabled
          = form.label :"privacy_level_#{key}", class: "form-check-label #{'text-muted' unless is_allowed}" do
            - case key
            - when 'observer_only'
              ğŸ”’ Just for me (Journal)
            - when 'observed_only'
              - if observee_names.any?
                ğŸ‘¤ Just #{observee_names.join(', ')}
              - else
                ğŸ‘¤ Just for their eyes only
            - when 'managers_only'
              - if direct_manager_names.any?
                ğŸ‘” Just Managers: #{direct_manager_names.join(', ')}
                - if other_manager_names.any?
                  %i.bi.bi-info-circle.ms-1{"data-bs-toggle" => "popover", "data-bs-trigger" => "hover", "data-bs-placement" => "top", "data-bs-html" => "true", "data-bs-content" => other_managers_popover_content(other_manager_names)}
              - else
                ğŸ‘” Just for their manager's eyes only
            - when 'observed_and_managers'
              - if observee_names.any? || direct_manager_names.any?
                - stakeholder_parts = []
                - stakeholder_parts << observee_names.join(', ') if observee_names.any?
                - stakeholder_parts << direct_manager_names.join(', ') if direct_manager_names.any?
                ğŸ‘¥ Stakeholders: #{stakeholder_parts.join(', ')}
                - if other_manager_names.any?
                  %i.bi.bi-info-circle.ms-1{"data-bs-toggle" => "popover", "data-bs-trigger" => "hover", "data-bs-placement" => "top", "data-bs-html" => "true", "data-bs-content" => other_managers_popover_content(other_manager_names)}
              - else
                ğŸ‘¥ Stakeholder
            - when 'public_to_company'
              ğŸ¢ Public to #{company_name}
            - when 'public_to_world'
              ğŸŒ Public to world
          
          - if should_disable_observed_only
            %small.text-muted.d-block.ms-4 There is no difference between this and a journal when you are the only observee.
          - elsif disabled_message
            %small.text-muted.d-block.ms-4= disabled_message
    
    .col-md-6
      .card.bg-light
        .card-body
          %h6.mb-2 Convert to Generic
          - case observation_type.to_s
          - when 'quick_note'
            %p.small.mb-2 If you want to share this publicly or with managers only, you can convert to generic and nothing will be lost.
          - when 'feedback'
            %p.small.mb-2 If you want to share this publicly, you can convert to generic and nothing will be lost.
          - when 'kudos'
            %p.small.mb-2 If you want to make this a journal entry, you can convert to generic and nothing will be lost.
          - if @observation&.persisted? && organization
            = form.button type: 'submit',
                    class: 'btn btn-sm btn-outline-secondary',
                    name: 'save_and_convert_to_generic',
                    value: 'Convert to Generic',
                    formaction: update_draft_organization_observation_path(organization, @observation.new_record? ? :new : @observation),
                    formmethod: :post,
                    data: { confirm: "This will enable all privacy levels and features. Continue?" },
                    onclick: "var field = document.getElementById('form_method_field'); if (field) field.value = 'patch'; return true;" do
              %i.bi.bi-arrow-right-circle.me-1
              Convert to Generic
- else
  = form.label :privacy_level, "Privacy Level", class: 'form-label'
  - all_levels_disabled = allowed_levels.is_a?(Array) && allowed_levels.empty?
  - if all_levels_disabled
    .alert.alert-warning.mb-3
      %i.bi.bi-exclamation-triangle.me-2
      Privacy levels require at least one observee.
  - Observation.privacy_levels.keys.each do |key|
    - is_allowed = allowed_levels.nil? || allowed_levels.include?(key.to_sym)
    - disabled_message = disabled_levels[key.to_sym]
    - should_disable_observed_only = (key == 'observed_only' && only_observee_is_observer)
    - is_disabled = !is_allowed || should_disable_observed_only
    
    .form-check
      = form.radio_button :privacy_level, key, class: 'form-check-input', disabled: is_disabled
      = form.label :"privacy_level_#{key}", class: "form-check-label #{'text-muted' unless is_allowed}" do
        - case key
        - when 'observer_only'
          ğŸ”’ Just for me (Journal)
        - when 'observed_only'
          - if observee_names.any?
            ğŸ‘¤ Just #{observee_names.join(', ')}
          - else
            ğŸ‘¤ Just for their eyes only
        - when 'managers_only'
          - if direct_manager_names.any?
            ğŸ‘” Just Managers: #{direct_manager_names.join(', ')}
            - if other_manager_names.any?
              %i.bi.bi-info-circle.ms-1{"data-bs-toggle" => "popover", "data-bs-trigger" => "hover", "data-bs-placement" => "top", "data-bs-html" => "true", "data-bs-content" => other_managers_popover_content(other_manager_names)}
          - else
            ğŸ‘” Just for their manager's eyes only
        - when 'observed_and_managers'
          - if observee_names.any? || direct_manager_names.any?
            - stakeholder_parts = []
            - stakeholder_parts << observee_names.join(', ') if observee_names.any?
            - stakeholder_parts << direct_manager_names.join(', ') if direct_manager_names.any?
            ğŸ‘¥ Stakeholders: #{stakeholder_parts.join(', ')}
            - if other_manager_names.any?
              %i.bi.bi-info-circle.ms-1{"data-bs-toggle" => "popover", "data-bs-trigger" => "hover", "data-bs-placement" => "top", "data-bs-html" => "true", "data-bs-content" => other_managers_popover_content(other_manager_names)}
          - else
            ğŸ‘¥ Stakeholder
        - when 'public_to_company'
          ğŸ¢ Public to #{company_name}
        - when 'public_to_world'
          ğŸŒ Public to world
      
      - if should_disable_observed_only
        %small.text-muted.d-block.ms-4 There is no difference between this and a journal when you are the only observee.
      - elsif disabled_message
        %small.text-muted.d-block.ms-4= disabled_message
