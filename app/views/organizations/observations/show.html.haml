- content_for :header do
  .d-flex.justify-content-between.align-items-center.mb-2
    %h1.mb-0{id: "page-title"}
      %i.bi.bi-eye.me-2
      Observation Details
    .d-flex.align-items-center
      = content_for :header_action

- content_for :go_back_link do
  = link_to organization_observations_path(@organization), class: "text-muted text-decoration-none" do
    %i.bi.bi-arrow-left.me-2
    Back to Observations

- content_for :header_action do
  .d-flex.align-items-center.gap-2
    - if @observation.draft? && policy(@observation).publish?
      = form_with url: publish_organization_observation_path(@organization, @observation), method: :post, local: true, data: { turbo: false } do |form|
        = form.submit 'Publish', class: 'btn btn-primary'
    - elsif @observation.draft? && !policy(@observation).publish?
      .d-flex.align-items-center.gap-2
        %button.btn.btn-primary.disabled{disabled: true, "data-bs-toggle" => "tooltip", "data-bs-title" => "Only the creator can publish this observation"}
          Publish
        %i.bi.bi-exclamation-triangle.text-warning{"data-bs-toggle" => "tooltip", "data-bs-title" => "Only the creator can publish this observation"}
    = render 'mode_switcher', organization: @organization, observation: @observation

.mb-4
  = content_for :go_back_link

.row
  .col-md-8
    / Main content sections
    .card.mb-4{ role: "region", "aria-labelledby": "observation-story" }
      .card-header
        %h5.mb-0{ id: "observation-story" }
          %i.bi.bi-chat-text.me-2
          Story
      .card-body
        = @observation.decorate.story_html.html_safe
        
    .card.mb-4{ role: "region", "aria-labelledby": "observation-details" }
      .card-header
        %h5.mb-0{ id: "observation-details" }
          %i.bi.bi-info-circle.me-2
          Details
      .card-body
        .row
          .col-md-6
            %p
              %strong Observer: 
              = @observation.observer.preferred_name || @observation.observer.first_name
            %p
              %strong Observed: 
              = @observation.observed_at.strftime('%B %d, %Y at %l:%M %p')
            %p
              %strong Status: 
              - if @observation.draft?
                %span.text-muted Draft
              - else
                Published on #{@observation.published_at.strftime('%B %d, %Y at %l:%M %p')}
            %p
              %strong Privacy: 
              %span{class: @observation.decorate.visibility_text_style}
                = @observation.decorate.visibility_icon
                = @observation.decorate.visibility_text
          .col-md-6
            - if @observation.primary_feeling.present?
              %p
                %strong Feelings: 
                = @observation.decorate.feelings_display_html.html_safe
            %p
              %strong Permalink: 
              = link_to @observation.decorate.permalink_url, @observation.decorate.permalink_url, target: '_blank', class: 'text-decoration-none'
              %i.bi.bi-box-arrow-up-right.ms-1

    - if @observation.observed_teammates.any?
      .card.mb-4{ role: "region", "aria-labelledby": "observation-observees" }
        .card-header
          %h5.mb-0{ id: "observation-observees" }
            %i.bi.bi-people.me-2
            Observed People
        .card-body
          - @observation.observed_teammates.each do |teammate|
            .d-flex.align-items-center.mb-2
              %i.bi.bi-person-circle.me-2
              = teammate.person.preferred_name || teammate.person.first_name
              %small.text-muted.ms-2
                = teammate.person.email

    - if @observation.observation_ratings.any?
      .card.mb-4{ role: "region", "aria-labelledby": "observation-ratings" }
        .card-header
          %h5.mb-0{ id: "observation-ratings" }
            %i.bi.bi-star.me-2
            Ratings
        .card-body
          - @observation.observation_ratings.each do |rating|
            .d-flex.align-items-center.mb-2
              = rating.decorate.to_descriptive_html.html_safe
          
          / Links to public MAAP resources
          - rated_abilities = @observation.abilities
          - rated_assignments = @observation.assignments
          - rated_aspirations = @observation.aspirations
          - if rated_abilities.any? || rated_assignments.any? || rated_aspirations.any?
            %hr
            %h6.mb-3 Related Public MAAP Resources
            - if rated_abilities.any?
              %p.mb-2
                %strong Abilities:
                - rated_abilities.each_with_index do |ability, index|
                  = link_to ability.name, organization_public_maap_ability_path(ability.organization, ability), class: "text-decoration-none"
                  - unless index == rated_abilities.count - 1
                    %span.text-muted , 
            - if rated_assignments.any?
              %p.mb-2
                %strong Assignments:
                - rated_assignments.each_with_index do |assignment, index|
                  = link_to assignment.title, organization_public_maap_assignment_path(assignment.company, assignment), class: "text-decoration-none"
                  - unless index == rated_assignments.count - 1
                    %span.text-muted , 
            - if rated_aspirations.any?
              %p.mb-2
                %strong Aspirations:
                - rated_aspirations.each_with_index do |aspiration, index|
                  = link_to aspiration.name, organization_public_maap_aspiration_path(aspiration.organization, aspiration), class: "text-decoration-none"
                  - unless index == rated_aspirations.count - 1
                    %span.text-muted , 

    - if @observation.notifications.successful.any?
      .card.mb-4{ role: "region", "aria-labelledby": "notification-history" }
        .card-header
          %h5.mb-0{ id: "notification-history" }
            %i.bi.bi-bell.me-2
            Notification History
        .card-body
          - @observation.notifications.successful.each do |notification|
            .d-flex.align-items-center.mb-2
              %i.bi.bi-check-circle.text-success.me-2
              %span
                Sent to 
                %strong= notification.notification_type.humanize
                - if notification.metadata['channel'].present?
                  %span.text-muted
                    (#{notification.metadata['channel']})
              %small.text-muted.ms-auto
                = notification.created_at.strftime('%m/%d/%y %l:%M %p')

    / Slack posting section
    - if policy(@observation).post_to_slack?
      .card.mb-4{ role: "region", "aria-labelledby": "slack-posting" }
        .card-header
          %h5.mb-0{ id: "slack-posting" }
            %i.bi.bi-slack.me-2
            Send Notifications
        .card-body
          - if @observation.privacy_level == 'public_observation'
            / Post to Kudos Channel section
            .mb-4
              %h6.mb-3
                %i.bi.bi-hash.me-2
                Post to Kudos Channel
              - if @organization.slack_configured?
                - if defined?(@kudos_channel_options) && @kudos_channel_options.any?
                  = form_with url: post_to_slack_organization_observation_path(@organization, @observation), method: :post, local: true do |form|
                    .mb-3
                      = form.label :kudos_channel_organization_id, "Select Kudos Channel", class: "form-label"
                      = form.select :kudos_channel_organization_id, options_for_select(@kudos_channel_options), { prompt: 'Select channel...' }, { class: 'form-select', id: 'kudos_channel_org_select', required: true }
                    .d-grid
                      = form.submit 'Send Notification', class: 'btn btn-primary'
                - else
                  .alert.alert-info
                    %i.bi.bi-info-circle.me-2
                    No kudos channels configured.
                    = link_to "Configure kudos channels", channels_organization_slack_path(@organization), class: "alert-link"
              - else
                .alert.alert-warning
                  %i.bi.bi-exclamation-triangle.me-2
                  Slack is not configured.
                  = link_to "Configure Slack", organization_slack_path(@organization), class: "alert-link"
          
          / DM Notifications section (Phase 5 - Mocked)
          - if @observation.privacy_level != 'observer_only'
            .mb-4
              %h6.mb-3
                %i.bi.bi-envelope.me-2
                Send DM Notifications
              %p.text-muted.mb-3
                DM notifications will be available in a future release.
              - if defined?(@dm_recipients) && @dm_recipients.any?
                - @dm_recipients.each do |recipient|
                  .form-check.mb-2
                    = check_box_tag 'dm_recipients[]', recipient[:name], false, class: 'form-check-input', id: "dm_#{recipient[:name].parameterize}", disabled: true
                    = label_tag "dm_#{recipient[:name].parameterize}", "#{recipient[:name]} - #{recipient[:role]}", class: 'form-check-label'
                    %span.badge.bg-secondary.ms-2 Coming Soon
              .d-grid.mt-3
                %button.btn.btn-primary.disabled{disabled: true, "data-bs-toggle" => "tooltip", "data-bs-title" => "Coming soon"}
                  Send DM Notifications
    - else
      .card.mb-4{ role: "region", "aria-labelledby": "slack-posting" }
        .card-header
          %h5.mb-0{ id: "slack-posting" }
            %i.bi.bi-slack.me-2
            Send Notifications
        .card-body
          .d-flex.align-items-center.gap-2
            %button.btn.btn-primary.disabled{disabled: true, "data-bs-toggle" => "tooltip", "data-bs-title" => "Only the observer can send notifications"}
              Send Notification
            %i.bi.bi-exclamation-triangle.text-warning{"data-bs-toggle" => "tooltip", "data-bs-title" => "Only the observer can send notifications"}
            %span.text-muted.ms-2 Only the observer can send notifications

  .col-md-4
    / Spotlight section with analytics and interesting tidbits
    .card.mb-4
      .card-header
        %h6.mb-0
          %i.bi.bi-star.me-2
          Spotlight
      .card-body
        %p
          %strong Total Ratings: 
          = @observation.observation_ratings.count
        - if @observation.observation_ratings.positive.any?
          %p
            %strong Positive Ratings: 
            = @observation.observation_ratings.positive.count
        - if @observation.has_negative_ratings?
          %p
            %strong Negative Ratings: 
            = @observation.observation_ratings.negative.count
            %small.text-muted.ms-1 (Restricted visibility)
        
        %hr
        
        %p
          %strong Created: 
          = @observation.created_at.strftime('%B %d, %Y')
        - if @observation.updated_at != @observation.created_at
          %p
            %strong Last Updated: 
            = @observation.updated_at.strftime('%B %d, %Y')
