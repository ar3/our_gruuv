- content_for :title, "Observation"

- content_for :header do
  .d-flex.justify-content-between.align-items-center.mb-2
    %h1.mb-0{id: "page-title"}
      %i.bi.bi-eye.me-2
      Observation Details
    .d-flex.align-items-center
      = content_for :header_action

- content_for :go_back_link do
  = link_to organization_observations_path(@organization), class: "text-muted text-decoration-none" do
    %i.bi.bi-arrow-left.me-2
    Back to Observations

- content_for :header_action do
  .d-flex.align-items-center.gap-2
    - if @observation.draft? && policy(@observation).publish?
      = form_with url: publish_organization_observation_path(@organization, @observation), method: :post, local: true, data: { turbo: false } do |form|
        = form.submit 'Publish', class: 'btn btn-primary'
    - elsif @observation.draft? && !policy(@observation).publish?
      .d-flex.align-items-center.gap-2
        %button.btn.btn-primary.disabled{disabled: true, "data-bs-toggle" => "tooltip", "data-bs-title" => "Only the creator can publish this observation"}
          Publish
        %i.bi.bi-exclamation-triangle.text-warning{"data-bs-toggle" => "tooltip", "data-bs-title" => "Only the creator can publish this observation"}
    - elsif @observation.soft_deleted? && policy(@observation).restore?
      = button_to 'Restore', restore_organization_observation_path(@organization, @observation), method: :patch, class: 'btn btn-outline-success', data: { turbo: false }
    = render 'mode_switcher', organization: @organization, observation: @observation
/ Share prompt section - shown when observation is published, has no notifications, is not journal, and user is the observer
- if @observation.published? && @observation.notifications.none? && @observation.privacy_level != 'observer_only' && current_person == @observation.observer
  .row
    .col-12 
      = render 'nudge_to_notify_observation'
.row
  .col-md-8

    / Main content sections
    - if @observation.observation_trigger.present?
      .card.mb-4{ role: "region", "aria-labelledby": "observation-trigger" }
        .card-body
          .d-flex.align-items-center
            %i.bi.bi-info-circle.text-info.me-2
            %span.me-2
              Story was triggered from #{@observation.observation_trigger.display_text}
            %i.bi.bi-question-circle.text-muted{"data-bs-toggle" => "tooltip", "data-bs-html" => "true", "data-bs-title" => render_markdown(@observation.observation_trigger.formatted_trigger_data)}
    
    .card.mb-4{ role: "region", "aria-labelledby": "observation-story" }
      .card-header
        %h5.mb-0{ id: "observation-story" }
          %i.bi.bi-chat-text.me-2
          Story
      .card-body
        = @observation.decorate.story_html.html_safe
        
    - if @observation.decorate.gifs_html.present?
      .card.mb-4{ role: "region", "aria-labelledby": "observation-gifs" }
        .card-header
          %h5.mb-0{ id: "observation-gifs" }
            %i.bi.bi-images.me-2
            GIFs
        .card-body
          != @observation.decorate.gifs_html.html_safe
        
    .card.mb-4{ role: "region", "aria-labelledby": "observation-details" }
      .card-header
        %h5.mb-0{ id: "observation-details" }
          %i.bi.bi-info-circle.me-2
          Details
      .card-body
        .row
          .col-md-6
            %p
              %strong Observer: 
              = @observation.observer.preferred_name || @observation.observer.first_name
            %p
              %strong Observed: 
              = format_time_in_user_timezone(@observation.observed_at)
            %p
              %strong Status: 
              - if @observation.soft_deleted?
                %span.badge.bg-secondary.me-2 Archived
              - if @observation.draft?
                %span.text-muted Draft
              - else
                Published on #{format_time_in_user_timezone(@observation.published_at)}
            %p
              %strong Privacy:
              - observee_names = @observee_names || []
              - direct_manager_names = @direct_manager_names || []
              - other_manager_names = @other_manager_names || []
              - company_name = @observation.company&.name || @organization&.name || 'company'
              %span{class: @observation.decorate.visibility_text_style}
                - case @observation.privacy_level
                - when 'observer_only'
                  ðŸ”’ Just for me (Journal)
                - when 'observed_only'
                  - if observee_names.any?
                    ðŸ‘¤ Just #{observee_names.join(', ')}
                  - else
                    ðŸ‘¤ Just for their eyes only
                - when 'managers_only'
                  - if direct_manager_names.any?
                    ðŸ‘” Just Managers: #{direct_manager_names.join(', ')}
                    - if other_manager_names.any?
                      %i.bi.bi-info-circle.ms-1{"data-bs-toggle" => "popover", "data-bs-trigger" => "hover", "data-bs-placement" => "top", "data-bs-html" => "true", "data-bs-content" => other_managers_popover_content(other_manager_names)}
                  - else
                    ðŸ‘” Just for their manager's eyes only
                - when 'observed_and_managers'
                  - if observee_names.any? || direct_manager_names.any?
                    - stakeholder_parts = []
                    - stakeholder_parts << observee_names.join(', ') if observee_names.any?
                    - stakeholder_parts << direct_manager_names.join(', ') if direct_manager_names.any?
                    ðŸ‘¥ Stakeholders: #{stakeholder_parts.join(', ')}
                    - if other_manager_names.any?
                      %i.bi.bi-info-circle.ms-1{"data-bs-toggle" => "popover", "data-bs-trigger" => "hover", "data-bs-placement" => "top", "data-bs-html" => "true", "data-bs-content" => other_managers_popover_content(other_manager_names)}
                  - else
                    ðŸ‘¥ Stakeholder
                - when 'public_to_company'
                  ðŸ¢ Public to #{company_name}
                - when 'public_to_world'
                  ðŸŒ Public to world
                - else
                  = @observation.decorate.visibility_icon
                  = @observation.decorate.visibility_text
          .col-md-6
            - if @observation.primary_feeling.present?
              %p
                %strong Feelings: 
                = @observation.decorate.feelings_display_html.html_safe
            - if policy(@observation).view_permalink?
              %p
                %strong Permalink: 
                = link_to @observation.decorate.permalink_url, @observation.decorate.permalink_url, target: '_blank', class: 'text-decoration-none'
                %i.bi.bi-box-arrow-up-right.ms-1
            - if @observation.feedback_request_question.present?
              %p
                %strong Created from: 
                = link_to organization_feedback_request_path(@organization, @observation.feedback_request_question.feedback_request), class: 'text-decoration-none' do
                  Feedback Request
                  %i.bi.bi-box-arrow-up-right.ms-1

    - if @observation.observed_teammates.any?
      .card.mb-4{ role: "region", "aria-labelledby": "observation-observees" }
        .card-header
          %h5.mb-0{ id: "observation-observees" }
            %i.bi.bi-people.me-2
            Observed People
        .card-body
          - @observation.observed_teammates.each do |teammate|
            .d-flex.align-items-center.mb-2
              %i.bi.bi-person-circle.me-2
              = teammate.person.preferred_name || teammate.person.first_name
              %small.text-muted.ms-2
                = teammate.person.email

    - if @observation.observation_ratings.any?
      .card.mb-4{ role: "region", "aria-labelledby": "observation-ratings" }
        .card-header
          %h5.mb-0{ id: "observation-ratings" }
            %i.bi.bi-star.me-2
            Ratings
        .card-body
          - rating_sentences = @observation.format_ratings_by_type_and_level(format: :html)
          - if rating_sentences.any?
            - rating_sentences.each do |sentence|
              %p.mb-2
                != sentence.html_safe
          - else
            %p.text-muted No ratings 

    / Notifications section
    .card.mb-4{ role: "region", "aria-labelledby": "notifications" }
      .card-header
        %h5.mb-0{ id: "notifications" }
          %i.bi.bi-bell.me-2
          Notifications
      .card-body
        / Action buttons
        - can_send_public = !@observation.draft? && policy(@observation).post_to_slack? && @observation.privacy_level != 'observer_only' && (@observation.privacy_level == 'public_to_company' || @observation.privacy_level == 'public_to_world')
        - can_send_private = !@observation.draft? && policy(@observation).post_to_slack? && @observation.privacy_level != 'observer_only'
        - send_public_disabled = !can_send_public
        - send_private_disabled = !can_send_private
        
        / Determine tooltip messages
        - public_tooltip = ''
        - if @observation.draft?
          - public_tooltip = 'Draft observations cannot be shared'
        - elsif @observation.privacy_level == 'observer_only'
          - public_tooltip = 'Journal entries cannot be shared publicly'
        - elsif @observation.privacy_level != 'public_to_company' && @observation.privacy_level != 'public_to_world'
          - public_tooltip = 'Only public observations can be shared publicly'
        - elsif !policy(@observation).post_to_slack?
          - public_tooltip = 'Only the observer can send notifications'
        
        - private_tooltip = ''
        - if @observation.draft?
          - private_tooltip = 'Draft observations cannot be shared'
        - elsif @observation.privacy_level == 'observer_only'
          - private_tooltip = 'Journal entries cannot be shared privately'
        - elsif !policy(@observation).post_to_slack?
          - private_tooltip = 'Only the observer can send notifications'
        
        .d-flex.gap-2.mb-4
          - if send_public_disabled
            .d-flex.align-items-center.gap-2
              .flex-grow-1
                %button.btn.btn-outline-secondary.w-100.disabled{disabled: true}
                  Send Public
              - if public_tooltip.present?
                %i.bi.bi-exclamation-triangle.text-warning{"data-bs-toggle" => "tooltip", "data-bs-title" => public_tooltip}
          - else
            = link_to 'Send Public', share_publicly_organization_observation_path(@organization, @observation), class: 'btn btn-primary'
          
          - if send_private_disabled
            .d-flex.align-items-center.gap-2
              .flex-grow-1
                %button.btn.btn-outline-secondary.w-100.disabled{disabled: true}
                  Send Private
              - if private_tooltip.present?
                %i.bi.bi-exclamation-triangle.text-warning{"data-bs-toggle" => "tooltip", "data-bs-title" => private_tooltip}
          - else
            = link_to 'Send Private', share_privately_organization_observation_path(@organization, @observation), class: 'btn btn-outline-primary'
        
        / Public notifications list
        - public_notifications = @observation.notifications.where(notification_type: 'observation_channel', status: 'sent_successfully')
        - if public_notifications.any?
          .mb-4
            %h6.mb-3
              %i.bi.bi-hash.me-2
              Public Notifications
            - public_notifications.each do |notification|
              .d-flex.align-items-center.mb-2
                %i.bi.bi-check-circle.text-success.me-2
                %span
                  - org_id = notification.metadata['organization_id']
                  - if org_id.present?
                    - org = Organization.find_by(id: org_id)
                    - if org
                      = org.display_name
                      - if notification.metadata['channel'].present?
                        %span.text-muted
                          - # Channel ID is stored in metadata, need to get channel name
                          - channel_id = notification.metadata['channel']
                          - channel = org.third_party_objects.slack_channels.find_by(third_party_id: channel_id)
                          - if channel
                            = " - #{channel.display_name}"
                  - if notification.slack_url.present?
                    = link_to 'View Message', notification.slack_url, target: '_blank', class: 'ms-2 text-decoration-none'
                    %i.bi.bi-box-arrow-up-right.ms-1
                %small.text-muted.ms-auto
                  = format_time_in_user_timezone(notification.created_at, format: '%m/%d/%y %l:%M %p')
        
        / Private notifications list
        - private_notifications = @observation.notifications.where(notification_type: 'observation_dm', status: 'sent_successfully').order(created_at: :desc)
        - if private_notifications.any?
          .mb-4
            %h6.mb-3
              %i.bi.bi-envelope.me-2
              Private Notifications
            - private_notifications.group_by { |n| n.created_at.to_date }.each do |date, notifications|
              .mb-2
                %small.text-muted
                  Shared privately on #{date.strftime('%B %d, %Y')}
                - notifications.each do |notification|
                  - if notification.slack_url.present?
                    = link_to 'View Message', notification.slack_url, target: '_blank', class: 'ms-2 text-decoration-none'
                    %i.bi.bi-box-arrow-up-right.ms-1

    / Debug Section
    - if params[:debug] == 'true' && @debug_data
      .card.mb-4{ role: "region", "aria-labelledby": "slack-debug" }
        .card-header.bg-secondary
          %h5.mb-0{ id: "slack-debug" }
            %i.bi.bi-bug.me-2
            Slack Notification Debug
        .card-body
          / People Table
          %h6.mb-3 Observer and Observed People
          .table-responsive
            %table.table.table-sm.table-bordered
              %thead
                %tr
                  %th Role
                  %th Casual Name
                  %th Slack Handle
                  %th Slack Image
              %tbody
                / Observer row
                - observer_data = @debug_data[:observer]
                %tr
                  %td
                    %strong Observer
                  %td= observer_data[:casual_name]
                  %td
                    - if observer_data[:slack_identity]&.dig(:uid).present?
                      %code= observer_data[:slack_identity][:uid]
                      %br
                      %small.text-muted Slack ID
                    - else
                      %span.text-muted No Slack identity
                  %td
                    - if observer_data[:slack_identity]&.dig(:profile_image_url).present?
                      = image_tag observer_data[:slack_identity][:profile_image_url], class: "rounded-circle", style: "width: 32px; height: 32px; object-fit: cover;", alt: "Slack profile"
                      %br
                      %small.text-muted
                        = link_to observer_data[:slack_identity][:profile_image_url], observer_data[:slack_identity][:profile_image_url], target: '_blank', class: 'text-decoration-none'
                    - else
                      %span.text-muted No image
                / Observed rows
                - @debug_data[:observed].each do |observed_data|
                  %tr
                    %td
                      %strong Observed
                    %td= observed_data[:casual_name]
                    %td
                      - if observed_data[:slack_identity]&.dig(:uid).present?
                        %code= observed_data[:slack_identity][:uid]
                        %br
                        %small.text-muted Slack ID
                      - else
                        %span.text-muted No Slack identity
                    %td
                      - if observed_data[:slack_identity]&.dig(:profile_image_url).present?
                        = image_tag observed_data[:slack_identity][:profile_image_url], class: "rounded-circle", style: "width: 32px; height: 32px; object-fit: cover;", alt: "Slack profile"
                        %br
                        %small.text-muted
                          = link_to observed_data[:slack_identity][:profile_image_url], observed_data[:slack_identity][:profile_image_url], target: '_blank', class: 'text-decoration-none'
                      - else
                        %span.text-muted No image
          
          %hr.mt-4.mb-4
          
          / What will be sent to Slack
          - slack_metadata = @debug_data[:slack_metadata]
          %h6.mb-3 What Will Be Sent to Slack
          .row
            .col-md-6
              %p.mb-2
                %strong Username Override:
                %br
                %code= slack_metadata[:username_override]
            .col-md-6
              %p.mb-2
                %strong Icon URL:
                %br
                %code.small= slack_metadata[:icon_url]
                - if slack_metadata[:using_slack_image]
                  %br
                  %small.text-success
                    %i.bi.bi-check-circle.me-1
                    Using observer's Slack profile image
                - else
                  %br
                  %small.text-warning
                    %i.bi.bi-exclamation-triangle.me-1
                    Falling back to favicon
          
          %hr.mt-3.mb-3
          
          / Slack mentions that will be used
          - slack_mentions = @debug_data[:slack_mentions]
          %h6.mb-3 Slack Mentions in Message
          .row
            .col-md-6
              %p.mb-2
                %strong Observer Mention:
                %br
                %code= slack_mentions[:observer]
            .col-md-6
              %p.mb-2
                %strong Observed Mentions:
                %br
                %code= slack_mentions[:observed].join(', ')

  .col-md-4
    / Observable Moment and Trigger details (only for observer)
    - if current_person == @observation.observer
      - if @observation.observable_moment.present?
        .card.mb-4
          .card-header
            %h6.mb-0
              %i.bi.bi-clock-history.me-2
              Observable Moment
          .card-body
            %p.mb-2
              %strong= @observation.observable_moment.display_name
            %p.mb-2
              %small.text-muted= @observation.observable_moment.description
            %p.mb-2
              %small
                %strong Occurred: 
                = format_time_in_user_timezone(@observation.observable_moment.occurred_at)
            - if @observation.observable_moment.processed?
              %p.mb-2
                %small
                  %strong Processed: 
                  = format_time_in_user_timezone(@observation.observable_moment.processed_at)
            - other_observations = @observation.observable_moment.observations.where.not(id: @observation.id)
            - if other_observations.any?
              %hr.my-2
              %p.mb-2
                %small
                  %strong Other Observations: 
                  %br
                  - other_observations.each do |obs|
                    = link_to "Observation ##{obs.id}", organization_observation_path(@organization, obs), class: "text-decoration-none me-2"
                    %small.text-muted
                      (#{format_date_in_user_timezone(obs.observed_at)})
                    %br
            - if @observable_moment_bank_award.present?
              %hr.my-2
              %p.mb-2
                %small
                  %strong Awarded from #{@organization.name} Bank:
                  - give = @observable_moment_bank_award.points_to_give_delta.to_f
                  - spend = @observable_moment_bank_award.points_to_spend_delta.to_f
                  - parts = []
                  - parts << "#{give} to give" if give > 0
                  - parts << "#{spend} to redeem" if spend > 0
                  = parts.join(', ')
      
      - if @observation.observation_trigger.present?
        .card.mb-4
          .card-header
            %h6.mb-0
              %i.bi.bi-lightning-charge.me-2
              Observation Trigger
          .card-body
            %p.mb-2
              %strong= @observation.observation_trigger.display_text
            - if @observation.observation_trigger.trigger_data.present?
              %p.mb-2
                %small.text-muted
                  = render_markdown(@observation.observation_trigger.formatted_trigger_data)
            - other_trigger_observations = @observation.observation_trigger.observations.where.not(id: @observation.id)
            - if other_trigger_observations.any?
              %hr.my-2
              %p.mb-2
                %small
                  %strong Other Observations: 
                  %br
                  - other_trigger_observations.each do |obs|
                    = link_to "Observation ##{obs.id}", organization_observation_path(@organization, obs), class: "text-decoration-none me-2"
                    %small.text-muted
                      (#{format_date_in_user_timezone(obs.observed_at)})
                    %br
    
    / Spotlight section with analytics and interesting tidbits
    .card.mb-4
      .card-header
        %h6.mb-0
          %i.bi.bi-star.me-2
          Spotlight
      .card-body
        - if @observation_kudos_awards.present?
          %p.mb-2
            %strong Awards granted:
            - kudos_label_plural = company_label_plural('kudos_point', 'Kudos Point')
            - link_opts = { target: '_blank', rel: 'noopener noreferrer' }
            = safe_join(@observation_kudos_awards.map { |a| "#{a[:points]} #{(a[:points] == 1 ? company_label_for('kudos_point', 'Kudos Point') : kudos_label_plural)} to ".html_safe + link_to(a[:person].casual_name, public_person_path(a[:person]), **link_opts) }, ', '.html_safe)
          %hr
        %p
          %strong Total Ratings: 
          = @observation.observation_ratings.count
        - if @observation.observation_ratings.positive.any?
          %p
            %strong Positive Ratings: 
            = @observation.observation_ratings.positive.count
        - if @observation.has_negative_ratings?
          %p
            %strong Negative Ratings: 
            = @observation.observation_ratings.negative.count
            %small.text-muted.ms-1 (Restricted visibility)
        
        %hr
        
        %p
          %strong Created: 
          = format_date_in_user_timezone(@observation.created_at)
        - if @observation.updated_at != @observation.created_at
          %p
            %strong Last Updated: 
            = format_date_in_user_timezone(@observation.updated_at)
        
        %hr
        
        = render 'page_visit_stats'
    
    / Actions section
    .card.mb-4
      .card-header
        %h6.mb-0
          %i.bi.bi-gear.me-2
          Actions
      .card-body
        .d-grid.gap-2
          / View Public Version
          - if policy(@observation).view_permalink?
            = link_to @observation.decorate.permalink_path, target: '_blank', class: 'btn btn-outline-secondary w-100' do
              %i.bi.bi-globe.me-2
              View Public Version
          - else
            .d-flex.align-items-center.gap-2
              .flex-grow-1
                %button.btn.btn-outline-secondary.w-100.disabled{disabled: true}
                  %i.bi.bi-globe.me-2
                  View Public Version
              - view_public_tooltip = 'You do not have permission to view the public version'
              - if !@observation.published?
                - view_public_tooltip = 'Public version is only available for published observations'
              - elsif @observation.privacy_level != 'public_to_world'
                - view_public_tooltip = 'Public version is only available for observations with "Public to World" privacy level'
              
              - if view_public_tooltip.present?
                %i.bi.bi-exclamation-triangle.text-warning{"data-bs-toggle" => "tooltip", "data-bs-title" => view_public_tooltip}
          
          / Edit Observation
          - if policy(@observation).update?
            = link_to edit_organization_observation_path(@organization, @observation, return_url: organization_observation_path(@organization, @observation), return_text: 'Back to Observation'), class: 'btn btn-outline-secondary w-100' do
              %i.bi.bi-pencil.me-2
              Edit Observation
          - else
            .d-flex.align-items-center.gap-2
              .flex-grow-1
                %button.btn.btn-outline-secondary.w-100.disabled{disabled: true}
                  %i.bi.bi-pencil.me-2
                  Edit Observation
              %i.bi.bi-exclamation-triangle.text-warning{"data-bs-toggle" => "tooltip", "data-bs-title" => "You need to be the observer to edit this observation"}
          
          / Archive Observation
          - if !@observation.soft_deleted? && policy(@observation).destroy?
            = button_to organization_observation_path(@organization, @observation), method: :delete, class: 'btn btn-outline-secondary w-100', data: { confirm: 'Are you sure you want to archive this observation?', turbo: false } do
              %i.bi.bi-archive.me-2
              Archive Observation
          - elsif @observation.soft_deleted? && policy(@observation).restore?
            = button_to restore_organization_observation_path(@organization, @observation), method: :patch, class: 'btn btn-outline-success w-100', data: { turbo: false } do
              %i.bi.bi-arrow-counterclockwise.me-2
              Restore Observation
          - else
            .d-flex.align-items-center.gap-2
              .flex-grow-1
                %button.btn.btn-outline-secondary.w-100.disabled{disabled: true}
                  %i.bi.bi-archive.me-2
                  Archive Observation
              %i.bi.bi-exclamation-triangle.text-warning{"data-bs-toggle" => "tooltip", "data-bs-title" => "You need to be the observer to archive this observation"}
