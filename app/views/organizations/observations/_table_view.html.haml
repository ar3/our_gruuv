.table-responsive
  %table.table.table-hover
    %thead
      %tr
        %th Story
        %th Privacy
        %th Feelings
        %th Ratings
        %th Observer
        %th Observed
        %th Date
        %th Notifications
        %th Actions
    %tbody
      - @observations.each do |observation|
        %tr
          %td
            = truncate(observation.story, length: 100)
          %td
            %span{title: observation.decorate.visibility_text, "data-bs-toggle" => "tooltip"}
              = observation.decorate.privacy_rings_with_label
          %td
            - if observation.primary_feeling.present?
              = observation.decorate.feelings_display_html
            - else
              %span.text-muted No feelings
          %td
            - if observation.observation_ratings.any?
              - assignment_ratings = observation.observation_ratings.select { |r| r.rateable_type == 'Assignment' }
              - ability_ratings = observation.observation_ratings.select { |r| r.rateable_type == 'Ability' }
              - aspiration_ratings = observation.observation_ratings.select { |r| r.rateable_type == 'Aspiration' }
              - rating_texts = []
              - assignment_ratings.each do |rating|
                - rating_texts << capture { render('organizations/observations/assignment_rating', observation_rating: rating, include_assignment_name: true) }
              - ability_ratings.each do |rating|
                - rating_texts << capture { render('organizations/observations/ability_rating', observation_rating: rating, include_ability_name: true) }
              - aspiration_ratings.each do |rating|
                - rating_texts << capture { render('organizations/observations/aspiration_rating', observation_rating: rating, include_aspiration_name: true) }
              != rating_texts.join(', ')
            - else
              .alert.alert-danger.mb-0.small.py-1.px-2
                %i.bi.bi-exclamation-triangle.me-1
                nothing rated
          %td
            = observation.observer.preferred_name || observation.observer.first_name
          %td
            - if observation.observed_teammates.any?
              - names = observation.observed_teammates.map { |teammate| teammate.person.preferred_name || teammate.person.first_name }
              = names.join(', ')
            - else
              %span.text-muted No one
          %td
            = format_date_in_user_timezone(observation.observed_at, format: '%b %d, %Y')
          %td
            - latest_notification = observation.last_successful_notification
            - if latest_notification&.slack_url.present?
              = link_to latest_notification.slack_url, target: "_blank", class: "btn btn-outline-primary btn-sm", title: "View in Slack" do
                %i.bi.bi-slack
            - elsif observation.privacy_level == 'public_to_world' || observation.privacy_level == 'public_to_company'
              %i.bi.bi-exclamation-triangle.text-danger{title: "Public observation has no notifications"}
            - elsif observation.privacy_level == 'observer_only' || observation.draft?
              %span.text-muted N/A
            - else
              %i.bi.bi-x.text-muted{title: "No notifications"}
          %td
            .btn-group.btn-group-sm
              - if policy(observation).view_permalink?
                = link_to observation.decorate.permalink_path, class: "btn btn-outline-primary", title: "Public permalink" do
                  %i.bi.bi-globe
              = link_to organization_observation_path(@organization, observation), class: "btn btn-outline-primary", title: "Show page" do
                %i.bi.bi-eye
              - if policy(observation).update?
                = link_to edit_organization_observation_path(@organization, observation, return_url: organization_observation_path(@organization, observation), return_text: 'Back to Observation'), class: "btn btn-outline-secondary" do
                  %i.bi.bi-pencil

