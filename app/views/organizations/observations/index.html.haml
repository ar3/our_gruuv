- content_for :header do
  .d-flex.align-items-center
    %h1.mb-0.me-2
      %i.bi.bi-eye.me-2
      Observations
    .d-flex.align-items-center
      - if policy(Observation).create?
        = link_to new_organization_observation_path(@organization), class: "btn btn-primary ml-2" do
          %i.bi.bi-plus
      - else
        .btn.btn-primary.disabled.disabled-button
          %i.bi.bi-plus
        %i.bi.bi-exclamation-triangle.text-warning.ms-2{"data-bs-toggle" => "tooltip", "data-bs-title" => "You need to be a teammate to create observations"}

- content_for :go_back_link do
  = link_to dashboard_organization_path(@organization), class: "go-back-link" do
    %i.bi.bi-arrow-left.me-2
    Back to Dashboard

- content_for :header_action do
  %button.btn.btn-outline-secondary{"data-bs-toggle" => "modal", "data-bs-target" => "#observations-filter-modal", type: "button"}
    %i.bi.bi-funnel.me-2
    Filter & Sort

/ Spotlight Section
.row.justify-content-center.mb-4
  .col-lg-12
    .card.border-0.shadow-sm
      .card-body
        .row
          .col-md-8
            / Main statistics/metrics area - varies by spotlight
            .row.text-center
              - case @current_spotlight
              - when 'my_journal'
                .col-3
                  .h3.text-primary= @spotlight_stats[:total_observations] || 0
                  %small.text-muted Total Journal
                .col-3
                  .h3.text-info= @spotlight_stats[:this_week] || 0
                  %small.text-muted This Week
                .col-3
                  .h3.text-success= @spotlight_stats[:this_month] || 0
                  %small.text-muted This Month
                .col-3
                  .h3.text-warning= @spotlight_stats[:with_ratings] || 0
                  %small.text-muted With Ratings
              - when 'team_wins'
                .col-3
                  .h3.text-primary= @spotlight_stats[:total_public] || 0
                  %small.text-muted Total Public
                .col-3
                  .h3.text-info= @spotlight_stats[:this_week] || 0
                  %small.text-muted This Week
                .col-3
                  .h3.text-success= @spotlight_stats[:positive_ratings] || 0
                  %small.text-muted Positive Ratings
                .col-3
                  .h3.text-warning= @spotlight_stats[:with_ratings] || 0
                  %small.text-muted With Ratings
              - when 'this_week'
                .col-3
                  .h3.text-primary= @spotlight_stats[:total_this_week] || 0
                  %small.text-muted Total This Week
                .col-3
                  .h3.text-info= @spotlight_stats[:journal_entries] || 0
                  %small.text-muted Journal Entries
                .col-3
                  .h3.text-success= @spotlight_stats[:public_observations] || 0
                  %small.text-muted Public
                .col-3
                  .h3.text-warning= @spotlight_stats[:with_ratings] || 0
                  %small.text-muted With Ratings
              - else
                .col-3
                  .h3.text-primary= @spotlight_stats[:this_week] || 0
                  %small.text-muted This Week
                .col-3
                  .h3.text-info= @spotlight_stats[:journal_entries] || 0
                  %small.text-muted Journal Entries
                .col-3
                  .h3.text-success= @spotlight_stats[:public_observations] || 0
                  %small.text-muted Public Recognition
                .col-3
                  .h3.text-warning= @spotlight_stats[:with_ratings] || 0
                  %small.text-muted With Ratings
          .col-md-4
            / Action alerts or status messages
            - if @observations.empty?
              .alert.alert-info.small
                %i.bi.bi-info-circle.me-2
                %strong Start giving feedback to your teammates
            - elsif @current_spotlight == 'overview' && @spotlight_stats[:journal_entries] > @spotlight_stats[:public_observations]
              .alert.alert-warning.small
                %i.bi.bi-lightbulb.me-2
                %strong Consider sharing more observations publicly
      .card-footer.bg-light
        .row.align-items-center
          .col-md-6
            %small.text-muted
              %i.bi.bi-funnel.me-1
              Filters:
              - if @current_filters.any?
                = @current_filters.map { |k, v| "#{k}: #{Array(v).join(', ')}" }.join('; ')
              - else
                All observations
              %br
              %i.bi.bi-sort-down.me-1
              Sort:
              = observation_sort_options.find { |o| o[1] == @current_sort }&.first || 'Most recent'
          .col-md-6.text-end
            %small.text-muted
              %i.bi.bi-table.me-1
              View:
              = @current_view.humanize
              %br
              %i.bi.bi-eye.me-1
              Spotlight:
              = @current_spotlight.humanize

/ Pagination Info
.row.justify-content-center.mb-2
  .col-lg-12
    .d-flex.justify-content-between.align-items-center
      %small.text-muted= raw pagy_info(@pagy) if @pagy
      - if @observations&.count.to_i > 0
        %small.text-muted Showing #{@current_view.humanize} view

/ Main Content Area
.row.justify-content-center
  .col-lg-12
    - if @observations&.any?
      - case @current_view
      - when 'cards'
        = render 'organizations/observations/card_view'
      - when 'list'
        = render 'organizations/observations/list_view'
      - else
        = render 'organizations/observations/table_view'
      
      / Pagination Navigation
      - if @pagy && @pagy.pages > 1
        .d-flex.justify-content-center.mt-4
          = raw pagy_nav(@pagy)
    - else
      .alert.alert-info
        %h6.mb-2
          %i.bi.bi-info-circle.me-2
          No Observations Created
        %p.mb-2 
          Start by creating your first observation to give feedback to your teammates.
          = link_to "Create First Observation", new_organization_observation_path(@organization), class: "btn btn-primary btn-sm"

/ Modal for Filter & Sort
.modal.fade#observations-filter-modal{"aria-hidden" => "true", "aria-labelledby" => "observations-filter-modal-label", tabindex: "-1"}
  .modal-dialog.modal-lg
    .modal-content
      .modal-header
        %h5.modal-title#observations-filter-modal-label
          %i.bi.bi-funnel.me-2
          Filter & Sort Observations
        %button.btn-close{"aria-label" => "Close", "data-bs-dismiss" => "modal", type: "button"}
      = form_tag organization_observations_path(@organization), method: :get, local: true do
        .modal-body
        .row
          .col-md-6
            %h6.mb-3
              %i.bi.bi-funnel.me-2
              Filters
            %h6 Privacy Level
            .form-check
              = check_box_tag 'privacy[]', 'observer_only', @current_filters[:privacy]&.include?('observer_only'), class: 'form-check-input', id: 'privacy_observer_only'
              = label_tag 'privacy_observer_only', 'ðŸ”’ Journal Entries', class: 'form-check-label'
            .form-check
              = check_box_tag 'privacy[]', 'observed_only', @current_filters[:privacy]&.include?('observed_only'), class: 'form-check-input', id: 'privacy_observed_only'
              = label_tag 'privacy_observed_only', 'ðŸ‘¤ 1-on-1 Feedback', class: 'form-check-label'
            .form-check
              = check_box_tag 'privacy[]', 'managers_only', @current_filters[:privacy]&.include?('managers_only'), class: 'form-check-input', id: 'privacy_managers_only'
              = label_tag 'privacy_managers_only', 'ðŸ‘” Managers Only', class: 'form-check-label'
            .form-check
              = check_box_tag 'privacy[]', 'observed_and_managers', @current_filters[:privacy]&.include?('observed_and_managers'), class: 'form-check-input', id: 'privacy_observed_and_managers'
              = label_tag 'privacy_observed_and_managers', 'ðŸ‘¥ Full Transparency', class: 'form-check-label'
            .form-check
              = check_box_tag 'privacy[]', 'public_observation', @current_filters[:privacy]&.include?('public_observation'), class: 'form-check-input', id: 'privacy_public'
              = label_tag 'privacy_public', 'ðŸŒ Public Recognition', class: 'form-check-label'
            .mb-3
              %h6 Timeframe
              .form-check
                = radio_button_tag 'timeframe', 'this_week', @current_filters[:timeframe] == 'this_week', class: 'form-check-input', id: 'timeframe_this_week'
                = label_tag 'timeframe_this_week', 'This Week', class: 'form-check-label'
              .form-check
                = radio_button_tag 'timeframe', 'this_month', @current_filters[:timeframe] == 'this_month', class: 'form-check-input', id: 'timeframe_this_month'
                = label_tag 'timeframe_this_month', 'This Month', class: 'form-check-label'
              .form-check
                = radio_button_tag 'timeframe', 'all', @current_filters[:timeframe].blank? || @current_filters[:timeframe] == 'all', class: 'form-check-input', id: 'timeframe_all'
                = label_tag 'timeframe_all', 'All Time', class: 'form-check-label'
          .col-md-6
            %h6.mb-3
              %i.bi.bi-sort-down.me-2
              Sort Options
            = select_tag 'sort', options_for_select(observation_sort_options, @current_sort), { class: 'form-select' }
            .mb-3
              %label.form-label View Style
              .form-check
                = radio_button_tag 'viewStyle', 'table', @current_view == 'table', class: 'form-check-input', id: 'view_table'
                = label_tag 'view_table', 'Table View', class: 'form-check-label' do
                  %i.bi.bi-table.me-2
                  Table View
              .form-check
                = radio_button_tag 'viewStyle', 'cards', @current_view == 'cards', class: 'form-check-input', id: 'view_cards'
                = label_tag 'view_cards', 'Card View', class: 'form-check-label' do
                  %i.bi.bi-grid.me-2
                  Card View
              .form-check
                = radio_button_tag 'viewStyle', 'list', @current_view == 'list', class: 'form-check-input', id: 'view_list'
                = label_tag 'view_list', 'List View', class: 'form-check-label' do
                  %i.bi.bi-list.me-2
                  List View
            .mb-3
              %label.form-label Spotlight
              = select_tag 'spotlight', options_for_select([['Overview', 'overview'], ['My Journal', 'my_journal'], ['Team Wins', 'team_wins'], ['This Week', 'this_week']], @current_spotlight), { class: 'form-select' }
        .modal-footer
          = link_to organization_observations_path(@organization), class: "btn btn-link text-decoration-none" do
            Clear All
          %button.btn.btn-secondary{"data-bs-dismiss" => "modal", type: "button"} Cancel
          = submit_tag "Apply Filters", class: "btn btn-primary"
