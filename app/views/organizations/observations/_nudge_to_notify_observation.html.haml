.card.mb-4.border-success{ role: "region", "aria-labelledby": "share-prompt" }
  .card-body.bg-light
    - kudos_points_disabled = @organization.kudos_points_disabled?
    - kudos_disabled_tooltip = kudos_points_disabled ? "#{@organization.name} has not yet configured the #{company_label_plural('kudos_point', 'Kudos Point')} system" : nil
    .text-center.py-3.mb-3
      %h4.mb-0{ id: "share-prompt" }
        ðŸŽ‰GREAT Observation... almost done!
      %h6.mt-1.mb0 #{@observation.observer.casual_name} helping #{@observation.company.name} grow with one great story at a time ðŸ“–
      %p.text-muted.small.mt-2.mb-0
        Two optional steps: decide if any points will be awarded, then whether to announce via Slack.
    
    / [Org name] Bank celebratory points for this observable moment (above peer-to-peer)
    - if @observation.observable_moment.present? && @celebratory_bank_config.present? && !@celebratory_bank_already_awarded
      - bank_opts = @celebratory_bank_point_options || {}
      - kudos_label_plural = company_label_plural('kudos_point', 'Kudos Point')
      .row.mb-4
        .col-12
          %h4 #{@organization.name} Bank awards up to the following points for this observable moment
          %hr.my-2.mb-2.mt-2
          = form_with url: award_celebratory_kudos_organization_observation_path(@organization, @observation), method: :post, local: true, data: { turbo: false }, html: { id: 'award_celebratory_kudos_form' } do |form|
            .d-flex.flex-wrap.align-items-center.gap-3.mb-2
              - if bank_opts[:max_points_to_give].to_f > 0
                .d-flex.align-items-center.gap-2
                  %label.form-label.mb-0 Points to give
                  = select_tag :points_to_give, options_for_select(bank_opts[:points_to_give_options].to_a.map { |n| [n.to_s, n] }, bank_opts[:max_points_to_give]), class: 'form-select form-select-sm', style: 'width: 5rem;', disabled: kudos_points_disabled
              - if bank_opts[:max_points_to_spend].to_f > 0
                .d-flex.align-items-center.gap-2
                  %label.form-label.mb-0 Points to redeem
                  = select_tag :points_to_spend, options_for_select(bank_opts[:points_to_spend_options].to_a.map { |n| [n.to_s, n] }, bank_opts[:max_points_to_spend]), class: 'form-select form-select-sm', style: 'width: 5rem;', disabled: kudos_points_disabled
            .d-flex.align-items-center.gap-2
              = form.submit "Award from #{@organization.name} Bank", class: 'btn btn-sm btn-success', disabled: kudos_points_disabled, onclick: kudos_points_disabled ? nil : "return confirm('Are you sure you want to award these #{kudos_label_plural} from #{@organization.name} Bank? This cannot be undone.');"
              - if kudos_disabled_tooltip.present?
                %i.bi.bi-exclamation-triangle.text-warning{"aria-label" => kudos_disabled_tooltip, "data-bs-toggle" => "tooltip", "data-bs-title" => kudos_disabled_tooltip, title: kudos_disabled_tooltip}
    
    / Observation summary + points row (when eligible observees)
    - if @observees_for_kudos.present?
      - link_opts = { target: '_blank', rel: 'noopener noreferrer' }
      - observee_links = @observees_for_kudos.map { |h| link_to(h[:person].casual_name, public_person_path(h[:person]), **link_opts) }
      - observee_sentence = observee_links.size <= 1 ? safe_join(observee_links) : (safe_join(observee_links[0..-2], ', ') + ', and '.html_safe + observee_links.last)
      - observer_link = link_to(@observation.observer.casual_name, public_person_path(@observation.observer), **link_opts)
      - phrase_entries = @observation.rating_phrase_entries_for_sentence
      - included_phrase = phrase_entries.any? ? ("that included ".html_safe + safe_join(phrase_entries.map { |e| e[:text_before_name].html_safe + link_to(e[:name], internal_rateable_path(@organization, e[:rateable]), **link_opts) }, ', ')) : "that shared their story"
      - kudos_label_plural = company_label_plural('kudos_point', 'Kudos Point')
      - if @kudos_not_yet_awarded && @observer_ledger && !@observation.has_negative_ratings? && @positive_rating_reward_options.present?
        .row.mb-4
          .col-md-4
            %h4 Observation summary
            %hr.my-2.mb-2.mt-2
            %p.mb-2
              = safe_join([observee_sentence, " were recognized in a story retold by ", observer_link, " ", included_phrase, "."], '')
          
            %p.mb-2
              = safe_join([" And ", observer_link, " could reward up to ", @observer_ledger.points_to_give, " ", (@observer_ledger.points_to_give == 1 ? company_label_for('kudos_point', 'Kudos Point') : kudos_label_plural), "."], '')
            - if @observees_for_kudos.size > 1
              %p.small.text-muted.mt-2.mb-0
                #{kudos_label_plural} awarded will be split equally between the observees.
          .col-md-8
            %h4 Award points (optional)
            %hr.my-2.mb-2.mt-2
            = form_with url: award_kudos_organization_observation_path(@organization, @observation), method: :post, local: true, data: { turbo: false }, html: { id: 'award_kudos_form' } do |form|
              .d-flex.flex-wrap.align-items-center.gap-2.mb-2
                %label.form-label.mb-0.me-1 Your banked #{kudos_label_plural} to give
                %strong.me-2= kudos_points_display(@observer_ledger.points_to_give)
              - @positive_rating_reward_options.each do |option|
                - rating_id = option[:rating].id
                .mb-3
                  .d-flex.flex-wrap.align-items-center.gap-2.mb-1
                    = check_box_tag "award_by_rating[#{rating_id}][reward]", "1", false, class: 'form-check-input', id: "award_by_rating_#{rating_id}_reward", disabled: kudos_points_disabled
                    = label_tag "award_by_rating_#{rating_id}_reward", "Reward this rating: #{option[:label]}", class: 'form-check-label mb-0'
                  .d-flex.flex-wrap.align-items-center.gap-2.ms-4
                    = label_tag "award_by_rating_#{rating_id}_points", "#{kudos_label_plural} for this rating", class: 'form-label mb-0 small'
                    = select_tag "award_by_rating[#{rating_id}][points]", options_for_select(option[:point_options].map { |n| [n.to_s, n] }, option[:min]), class: 'form-select form-select-sm', style: 'width: 5rem;', id: "award_by_rating_#{rating_id}_points", disabled: kudos_points_disabled
              .d-flex.align-items-center.gap-2
                = form.submit "Send #{kudos_label_plural}", class: 'btn btn-sm btn-primary', disabled: kudos_points_disabled, onclick: kudos_points_disabled ? nil : "return confirm('Are you sure you want to send these #{kudos_label_plural}? This cannot be undone.');"
                - if kudos_disabled_tooltip.present?
                  %i.bi.bi-exclamation-triangle.text-warning{"aria-label" => kudos_disabled_tooltip, "data-bs-toggle" => "tooltip", "data-bs-title" => kudos_disabled_tooltip, title: kudos_disabled_tooltip}
    
    .row
      / Left column - Privacy selector and view stats
      .col-md-4
        %h4 Some people could see this, but...
        %hr.my-2.mb-2.mt-2
        / Privacy selector (display only, all disabled) - use names like the form partial
        = render 'organizations/observations/form_sections/privacy_selector',
          display_only: true,
          observation: @observation,
          observee_names: @observee_names,
          direct_manager_names: @direct_manager_names,
          other_manager_names: @other_manager_names,
          organization: @organization
          
        / Page visit statistics
        = render 'page_visit_stats'
      
      / Right column - Slack announcement options
      .col-md-8
        / Top section: Celebrate with Slack Post
        .mb-4
          %h4 ... No one has been notified yet...
          %hr.my-2.mb-2.mt-2
          %h6.mb-3
            ðŸ“£Celebrate with a Slack Post ðŸ“¢
          - can_send_public = !@observation.draft? && policy(@observation).post_to_slack? && @observation.privacy_level != 'observer_only' && (@observation.privacy_level == 'public_to_company' || @observation.privacy_level == 'public_to_world')
          - is_public = @observation.privacy_level == 'public_to_company' || @observation.privacy_level == 'public_to_world'
          
          - if is_public
            - if @kudos_channel_organizations&.any?
              - company_org_info = @kudos_channel_organizations.first
              .mb-2
                %i.bi.bi-hash.me-2
                = company_org_info[:display_name]
                - if company_org_info[:already_sent]
                  %span.badge.bg-secondary.ms-2 Already sent
              - other_count = @kudos_channel_organizations.size - 1
              - if other_count.positive?
                .mb-2.text-muted.small
                  or one of the other #{other_count} public kudos channels
            
            - if can_send_public
              = link_to 'Select the channel to post the celebration', share_publicly_organization_observation_path(@organization, @observation), class: 'btn btn-sm btn-outline-primary mt-2'
            - else
              = link_to 'Select the channel to post the celebration', '#', class: 'btn btn-sm btn-outline-secondary mt-2', disabled: true, onclick: 'return false;'
          - else
            .alert.alert-info.mt-2
              %i.bi.bi-info-circle.me-2
              This is a private observation and therefore can't be shared in a channel
        
        / OR divider
        .d-flex.align-items-center.my-4
          %hr.flex-grow-1
          %span.mx-3.text-muted OR
          %hr.flex-grow-1
        
        / Bottom section: Notify people privately
        .mb-2
          %h6.mb-3
            Notify people privately
          - can_send_private = !@observation.draft? && policy(@observation).post_to_slack? && @observation.privacy_level != 'observer_only'
          
          - if @available_teammates_for_notification&.any?
            - @available_teammates_for_notification.each do |teammate_info|
              .mb-2
                %i.bi.bi-person.me-2
                %strong= teammate_info[:person].casual_name
                %small.text-muted.ms-2= teammate_info[:role]
          
          - if can_send_private
            = link_to 'Select who to send private notification', share_privately_organization_observation_path(@organization, @observation), class: 'btn btn-sm btn-outline-primary mt-2'
          - else
            = link_to 'Select who to send private notification', '#', class: 'btn btn-sm btn-outline-secondary mt-2', disabled: true, onclick: 'return false;'
