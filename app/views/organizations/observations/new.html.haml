- content_for :title, @observation.persisted? ? 'Edit Observation' : 'Create Observation'

- content_for :header do
  = @observation.persisted? ? 'Edit Observation' : 'Create Observation'
  - if @observable_moment
    .mt-2
      .alert.alert-info
        %strong Celebrating: 
        = @observable_moment.display_name
        %br
        %small= @observable_moment.description
- content_for :return_url do
  = @return_url || (@observation.persisted? ? organization_observation_path(organization, @observation) : organization_observations_path(organization))
- content_for :return_text do
  = @return_text || (@observation.persisted? ? 'Back to Observation' : 'Back')

.card.mb-3
  .card-header
    %h5.mb-0
      %i.bi.bi-person-check.me-2
      Observation Details
      - if @observation.persisted? && @observation.draft?
        .mt-2
          %small.text-muted
            = link_to "draft", organization_observation_path(organization, @observation), class: "text-muted text-decoration-none"
            = " saved at "
            = format_time_in_user_timezone(@observation.updated_at, format: "%l:%M %p on %B %d, %Y")
      - elsif @observation.persisted? && @observation.published?
        .mt-2
          %small.text-muted
            = link_to "published observation", organization_observation_path(organization, @observation), class: "text-muted text-decoration-none"
            = " published at "
            = format_time_in_user_timezone(@observation.published_at, format: "%l:%M %p on %B %d, %Y")
      - elsif @observation.new_record?
        .mt-2
          %small.text-muted
            This observation will be saved as a draft when you add assignments or publish.
  .card-body
    - form_url = @observation.persisted? ? update_draft_organization_observation_path(organization, @observation) : update_draft_organization_observation_path(organization, :new)
    = form_with model: @observation, url: form_url, method: :post, local: true, data: { turbo: false, turbo_method: false }, html: { id: 'observation_form' } do |form|
      / Add _method field only for buttons that need PATCH (Add Assignments and default form submission)
      = hidden_field_tag '_method', 'patch', id: 'form_method_field'
      / Explicitly include CSRF token for formaction compatibility
      = hidden_field_tag :authenticity_token, form_authenticity_token, id: 'form_authenticity_token'
      - if @observation.errors.any?
        .alert.alert-danger
          %h6 Please correct the following errors:
          %ul.mb-0
            - @observation.errors.full_messages.each do |message|
              %li= message
      
      / Hidden fields for publish action
      = hidden_field_tag :return_url, @return_url
      = hidden_field_tag :return_text, @return_text
      = hidden_field_tag :show_observations_for, params[:show_observations_for]
      - if @observable_moment || @observation.observable_moment_id.present? || params[:observable_moment_id].present?
        = hidden_field_tag "observation[observable_moment_id]", (@observable_moment&.id || @observation.observable_moment_id || params[:observable_moment_id])
      -# Preserve observee_ids through form submissions
      - @observation.observees.each do |observee|
        = hidden_field_tag "observee_ids[]", observee.teammate_id
      
      .container-fluid
        = render 'organizations/observations/form_sections/observees_section', form: form, observation: @observation
        = render 'organizations/observations/form_sections/story_field', form: form, observation: @observation, show_gifs: true, organization: organization
        = render 'organizations/observations/form_sections/feelings_section', form: form, observation: @observation
        = render 'organizations/observations/form_sections/rating_sections', form: form, observation: @observation, assignments: @assignments, abilities: @abilities, aspirations: @aspirations
      
      .mb-3
        %hr/
      
      = render 'organizations/observations/form_sections/privacy_selector', form: form, observation: @observation, allowed_levels: @allowed_privacy_levels, disabled_levels: @disabled_levels, organization: organization
      
      = render 'organizations/observations/form_sections/form_actions', form: form, observation: @observation, return_text: @return_text, organization: organization
