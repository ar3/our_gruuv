- content_for :title, @team.name

- content_for :go_back_link do
  = link_to organization_teams_path(@organization), class: "go-back-link" do
    %i.bi.bi-arrow-left.me-2
    Back to Teams

- content_for :header do
  .d-flex.align-items-center.justify-content-between
    .d-flex.align-items-center
      %h1.mb-0.me-2
        %i.bi.bi-people.me-2
        = @team.name
    .d-flex.align-items-center.gap-2
      - if policy(@team).update?
        = link_to edit_organization_team_path(@organization, @team), class: "btn btn-outline-secondary" do
          %i.bi.bi-pencil.me-1
          Edit
        = link_to manage_members_organization_team_path(@organization, @team), class: "btn btn-outline-primary" do
          %i.bi.bi-person-check.me-1
          Manage Members
      - if policy(@team).archive?
        = button_to archive_organization_team_path(@organization, @team), method: :patch, class: "btn btn-outline-danger", data: { confirm: "Are you sure you want to archive this team?" } do
          %i.bi.bi-archive.me-1
          Archive

.row.justify-content-center
  .col-lg-12
    .card.mb-4
      .card-header
        %h5.mb-0
          %i.bi.bi-people.me-2
          Team Members
          %span.badge.bg-secondary.ms-2
            = @team_members.count
      .card-body
        - if @team_members.any?
          .d-flex.align-items-center.justify-content-center.flex-wrap.gap-0.mb-4{style: "margin-left: -0.5rem;"}
            - @team_members.each_with_index do |team_member, idx|
              - teammate = team_member.company_teammate
              = link_to organization_company_teammate_path(@organization, teammate), class: "d-inline-block text-decoration-none", style: "margin-left: #{idx.zero? ? 0 : -1.25}rem; z-index: #{@team_members.size - idx};", title: teammate.person.preferred_first_then_last_display_name, data: { bs_toggle: "tooltip", bs_placement: "top" } do
                .rounded-circle.border.border-3.border-white.shadow-sm{style: "width: 80px; height: 80px; overflow: hidden; box-sizing: content-box;"}
                  = teammate_profile_image(teammate, size: 80)
          .table-responsive
            %table.table.table-hover.mb-0
              %thead
                %tr
                  %th Name
                  %th Email
              %tbody
                - @team_members.each do |team_member|
                  - person = team_member.company_teammate.person
                  %tr
                    %td
                      = link_to organization_company_teammate_path(@organization, team_member.company_teammate), class: "text-decoration-none" do
                        = person.preferred_first_then_last_display_name
                    %td
                      = person.email
        - else
          .alert.alert-light.mb-0
            %p.mb-0
              %i.bi.bi-info-circle.me-2
              No members have been added to this team yet.
              - if policy(@team).update?
                = link_to "Add members", manage_members_organization_team_path(@organization, @team), class: "alert-link"
                to get started.

    .card.mb-4
      .card-header
        %h5.mb-0
          %i.bi.bi-info-circle.me-2
          Team Details
      .card-body
        .row
          .col-md-6
            %dl.row.mb-0
              %dt.col-sm-4 Name
              %dd.col-sm-8= @team.name
              %dt.col-sm-4 Company
              %dd.col-sm-8= @team.company.display_name
              %dt.col-sm-4 Department
              %dd.col-sm-8
                - if @team.department.present?
                  = link_to @team.department.display_name, organization_department_path(@organization, @team.department), class: "text-decoration-none"
                - else
                  No department
              %dt.col-sm-4 Created
              %dd.col-sm-8= @team.created_at.strftime('%B %d, %Y')

    - team_asana_link_policy_record = @team.team_asana_link.presence || TeamAsanaLink.new(team_id: @team.id)
    - can_access_asana_link_page = policy(team_asana_link_policy_record).update?
    - asana_link_access_tooltip = "You need to be a team member or have manage teams permission to access the team Asana link."
    - if policy(team_asana_link_policy_record).show?
      .card.mb-4
        .card-header.d-flex.justify-content-between.align-items-center
          %h5.mb-0
            %i.bi.bi-link-45deg.me-2
            Team Asana Link
          - if @team.team_asana_link&.url.present?
            - if can_access_asana_link_page
              = link_to organization_team_team_asana_link_path(@organization, @team), class: "btn btn-sm btn-outline-primary" do
                %i.bi.bi-box-arrow-up-right.me-1
                View &amp; sync
            - else
              .d-inline-flex.align-items-center
                .btn.btn-sm.btn-outline-secondary.disabled{ style: "opacity: 0.6; cursor: not-allowed;" }
                  %i.bi.bi-box-arrow-up-right.me-1
                  View &amp; sync
                %i.bi.bi-exclamation-triangle.text-warning.ms-2{ "data-bs-toggle" => "tooltip", "data-bs-title" => asana_link_access_tooltip }
        .card-body
          - if @team.team_asana_link&.url.present?
            - asana_cache = @team.team_asana_link.external_project_cache_for('asana')
            - if asana_cache
              %p.mb-2
                - section_count = asana_cache.sections_data.size
                - task_count = asana_cache.items_data.size
                %span.text-muted
                  = "#{section_count} #{'section'.pluralize(section_count)} with #{task_count} #{'task'.pluralize(task_count)}"
                  - if asana_cache.last_synced_at
                    , last synced
                    = asana_cache.last_synced_at.strftime('%b %d, %Y at %I:%M %p')
                    - if asana_cache.last_synced_by_teammate
                      by
                      = asana_cache.last_synced_by_teammate.person.display_name
            - else
              %p.mb-2
                Team Asana project is configured but not synced yet. Connect Asana and sync to see sections and tasks.
              - if can_access_asana_link_page
                = form_with url: sync_organization_team_team_asana_link_path(@organization, @team), method: :post, local: true, class: "d-inline" do
                  = hidden_field_tag :source, 'asana'
                  = button_tag type: "submit", class: "btn btn-primary me-2" do
                    %i.bi.bi-arrow-repeat.me-1
                    Sync
            %p.mb-0
              - if can_access_asana_link_page
                = link_to "Open team Asana link", organization_team_team_asana_link_path(@organization, @team), class: "btn btn-outline-primary"
              - else
                .btn.btn-outline-secondary.disabled{ style: "opacity: 0.6; cursor: not-allowed;" }
                  Open team Asana link
                %i.bi.bi-exclamation-triangle.text-warning.ms-2{ "data-bs-toggle" => "tooltip", "data-bs-title" => asana_link_access_tooltip }
          - else
            %p.mb-0.text-muted
              No team Asana link yet.
            - if can_access_asana_link_page
              = link_to "Set up team Asana link", organization_team_team_asana_link_path(@organization, @team), class: "btn btn-sm btn-primary"

    .card
      .card-header.d-flex.justify-content-between.align-items-center
        %h5.mb-0
          %i.bi.bi-calendar-event.me-2
          Huddles
          %span.badge.bg-secondary.ms-2= @team.huddles.size
        .btn-group.btn-group-sm{role: "group"}
          = button_to start_huddle_from_team_huddles_path(team_id: @team.id), method: :post, class: "btn btn-outline-primary btn-sm", data: { turbo: false } do
            %i.bi.bi-plus-circle.me-1
            Start Huddle
          - if @team.huddles.any?
            = link_to huddles_path(organization_id: @organization.id, team_id: @team.id), class: "btn btn-outline-info btn-sm" do
              %i.bi.bi-list.me-1
              View Huddles
      .card-body
        %dl.row.mb-0
          %dt.col-sm-3 Huddle Channel
          %dd.col-sm-9
            - if @team.huddle_channel_id.present?
              %code= @team.huddle_channel&.display_name || @team.huddle_channel_id
            - else
              %small.text-muted Not configured
          - if @team.huddles.any?
            %dt.col-sm-3 Recent Activity
            %dd.col-sm-9
              - latest_huddle = @team.huddles.max_by(&:created_at)
              %small.text-muted
                Last huddle: #{time_ago_in_words(latest_huddle.created_at)} ago
                - if latest_huddle.huddle_participants.any?
                  %span.badge.bg-success.ms-1= "#{latest_huddle.huddle_participants.size} participants"
            %dt.col-sm-3 Recent Huddles
            %dd.col-sm-9
              %ul.list-unstyled.mb-0
                - @team.huddles.sort_by(&:created_at).reverse.first(5).each do |huddle|
                  %li.mb-1
                    = link_to huddle_path(huddle), class: "text-decoration-none" do
                      %i.bi.bi-calendar-event.me-1
                      = huddle.display_name
                      %small.text-muted.ms-2= format_date_in_user_timezone(huddle.created_at, format: "%b %d, %Y")
                      - if huddle.huddle_participants.any?
                        %span.badge.bg-success.ms-1= huddle.huddle_participants.size
        - unless @team.huddles.any?
          .alert.alert-light.mb-0.mt-2
            %small.text-muted
              No huddles yet for this team.
              = button_to "Start a huddle", start_huddle_from_team_huddles_path(team_id: @team.id), method: :post, class: "btn btn-link p-0 align-baseline alert-link text-muted", data: { turbo: false }
              to get started.
