= form_with model: team, url: (team.persisted? ? organization_team_path(@organization, team) : organization_teams_path(@organization)), local: true, class: "needs-validation" do |form|
  - if team.errors.any?
    .alert.alert-danger
      %h6.alert-heading
        %i.bi.bi-exclamation-triangle.me-2
        = pluralize(team.errors.count, "error")
        prohibited this team from being saved:
      %ul.mb-0
        - team.errors.full_messages.each do |message|
          %li= message

  .mb-3
    = form.label :name, class: "form-label" do
      %strong Team Name
      %span.text-danger *
    = form.text_field :name, class: "form-control", placeholder: "Enter team name", required: true, autofocus: true
    .form-text
      Give your team a descriptive name that identifies its purpose or members.

  - if defined?(@departments) && @departments.present?
    .mb-3
      = form.label :department_id, "Department", class: "form-label"
      = form.select :department_id, options_from_collection_for_select(@departments, :id, :display_name, team.department_id), { include_blank: "Company-wide (no department)" }, { class: "form-select" }
      .form-text.text-muted
        The department this team belongs to (optional).

  - if team.persisted? && defined?(@slack_channels) && @slack_channels.present?
    .mb-3
      = form.label :huddle_channel_id, "Slack channel for huddles", class: "form-label"
      - used_ids = @huddle_channel_ids_used_by_other_teams || Set.new
      - channel_options = @slack_channels.map { |ch| [ch.display_name, ch.third_party_id, { disabled: used_ids.include?(ch.third_party_id) && ch.third_party_id != team.huddle_channel_id }] }
      = form.select :huddle_channel_id, options_for_select(channel_options, team.huddle_channel_id), { prompt: 'Select channel', include_blank: 'None' }, { class: 'form-select' }
    .form-text.text-muted
      Huddle start and summary notifications will be posted to this channel. Channels already used by other teams are disabled.

  .d-flex.gap-2
    = form.submit team.persisted? ? 'Update Team' : 'Create Team', class: "btn btn-primary"
    = link_to 'Cancel', team.persisted? ? organization_team_path(@organization, team) : organization_teams_path(@organization), class: "btn btn-outline-secondary"
