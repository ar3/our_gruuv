- content_for :title, "Edit #{@prompt_template.title} (#{@prompt.company_teammate.person.casual_name})"

- content_for :go_back_link do
  = link_to organization_prompts_path(@organization), class: "go-back-link" do
    %i.bi.bi-arrow-left.me-2
    Back to My #{company_label_plural('reflection', 'Reflection')}

- view_mode = params[:view] || 'split'
- content_for :header do
  .d-flex.align-items-center.justify-content-between
    %h1.mb-0.me-2
      %i.bi.bi-file-text.me-2
      Edit #{@prompt_template.title} (#{@prompt.company_teammate.person.casual_name})
    .d-flex.gap-2
      - if view_mode == 'split'
        %span.badge.bg-primary Split View
      - else
        %span.badge.bg-secondary Vertical View

.card.mb-4
  .card-header
    %h5.mb-0
      %i.bi.bi-clock-history.me-2
      #{company_label_for('reflection', 'Reflection')} Details
  .card-body
    .row
      .col-md-6
        %p.mb-2
          %strong Created:
          = format_time_in_user_timezone(@prompt.created_at)
      .col-md-6
        %p.mb-2
          %strong Last Updated:
          = format_time_in_user_timezone(@prompt.updated_at)

.card
  .card-header
    %h5.mb-0
      %i.bi.bi-question-circle.me-2
      Answer Questions
  .card-body
    = form_with url: organization_prompt_path(@organization, @prompt, view: view_mode), method: :patch, local: true, id: "prompt-edit-form" do |form|
      - if @prompt.errors.any?
        .alert.alert-danger
          %h4= "#{pluralize(@prompt.errors.count, "error")} prohibited this prompt from being saved:"
          %ul.mb-0
            - @prompt.errors.full_messages.each do |message|
              %li= message
      
      - if view_mode == 'vertical'
        / Vertical View: full width layout
        - @prompt_questions.each do |question|
          .mb-4
            = form.label "prompt_answers[#{question.id}][text]", question.label, class: 'form-label fw-bold'
            - if question.helper_text.present?
              %small.text-muted.d-block.mt-1.mb-2= question.helper_text
            = form.text_area "prompt_answers[#{question.id}][text]", 
                            value: @prompt_answers[question.id]&.text,
                            class: 'form-control', 
                            rows: 4,
                            placeholder: question.placeholder_text.presence || 'Enter your answer...',
                            disabled: !@can_edit
      - else
        / Split View: 3x9 column layout
        - @prompt_questions.each do |question|
          .row.mb-4
            .col-sm-3.col-12.mb-3.mb-sm-0
              = form.label "prompt_answers[#{question.id}][text]", question.label, class: 'form-label fw-bold'
              - if question.helper_text.present?
                %small.text-muted.d-block.mt-1= question.helper_text
            .col-sm-9.col-12
              = form.text_area "prompt_answers[#{question.id}][text]", 
                              value: @prompt_answers[question.id]&.text,
                              class: 'form-control', 
                              rows: 4,
                              placeholder: question.placeholder_text.presence || 'Enter your answer...',
                              disabled: !@can_edit
      
      - archived_questions_with_answers = @archived_questions.select { |q| @archived_answers[q.id]&.text.present? }
      - if archived_questions_with_answers.any?
        .mt-4.pt-4.border-top
          %h6.mb-3
            %i.bi.bi-archive.me-2
            Archived Questions (Read-Only)
          - archived_questions_with_answers.each do |question|
            .row.mb-4
              .col-sm-3.col-12.mb-3.mb-sm-0
                %label.form-label.fw-bold.text-muted= question.label
                - if question.helper_text.present?
                  %small.text-muted.d-block.mt-1= question.helper_text
              .col-sm-9.col-12
                - answer = @archived_answers[question.id]
                .p-3.bg-light.rounded
                  = simple_format(answer.text)
      
      .d-flex.justify-content-between.mt-4
        = link_to 'Cancel', organization_prompts_path(@organization), class: 'btn btn-secondary'
        .d-flex.gap-2
          - if @can_edit
            = form.submit 'Save and continue editing', class: 'btn btn-primary', name: 'save_and_continue'
            - if @next_prompt
              = form.submit "Save and go to #{@next_prompt.prompt_template.title}", class: 'btn btn-outline-primary', name: 'save_and_next'
          - else
            .btn.btn-primary.disabled Save and continue editing
            - if @next_prompt
              .btn.btn-outline-primary.disabled Save and go to #{@next_prompt.prompt_template.title}
      - if @can_edit
        .mt-2
          = button_tag type: 'submit', form: 'prompt-edit-form', name: 'save_and_close_and_start_new', value: '1', class: "btn btn-link p-0 text-muted border-0 bg-transparent", style: "font-size: 0.9em; text-decoration: none;", data: { turbo_confirm: "Are you sure? You will not lose any data, but the form will clear so that you can start fresh." } do
            Close and Start Fresh

- quote_popover_content = capture do
  %div.markdown-content
    %blockquote.mb-2
      "If your goals aren't synced with the substance of your heart, then achieving them won't matter much."
    %p.mb-0.text-muted.small
      â€•
      %strong Danielle LaPorte
      %span.text-muted,
      %a.text-muted.text-decoration-none{:href => "/work/quotes/18136546"} The Fire Starter Sessions: A Soulful + Practical Guide to Creating Success on Your Own Terms

.card.mb-4
  .card-header.d-flex.justify-content-between.align-items-center
    %h5.mb-0
      %i.bi.bi-bullseye.me-2
      Associated Goals
    .d-flex.align-items-center.gap-2
      %span.text-muted.text-decoration-none{style: "cursor: pointer;", "data-bs-toggle" => "popover", "data-bs-trigger" => "hover focus", "data-bs-placement" => "top", "data-bs-html" => "true", "data-bs-content" => quote_popover_content}= "Why associate goals with #{@prompt_template.title}?"
      - if @can_edit
        = button_tag type: 'submit', form: 'prompt-edit-form', name: 'save_and_manage_goals', value: '1', class: "btn btn-sm btn-primary" do
          %i.bi.bi-plus.me-1
          Add New / Associate Goals
  .card-body
    - non_archived_goals = @prompt.goals.reject { |g| g.deleted_at.present? }
    - if non_archived_goals.any?
      - if @can_edit
        .mb-3
          = button_tag type: 'submit', form: 'prompt-edit-form', name: 'save_and_edit_goals', value: '1', class: "btn btn-sm btn-outline-secondary" do
            Check-in on / Edit all goals
      - # Get all descendant goal IDs (includes children, grandchildren, etc.)
      - all_descendant_goal_ids = @linked_goals.keys.to_set
      - prompt_goal_ids = non_archived_goals.map(&:id).to_set
      
      - # Group goals by type
      - goals_by_type = non_archived_goals.group_by(&:goal_type)
      - goal_types = ['stepping_stone_activity', 'quantitative_key_result', 'qualitative_key_result', 'inspirational_objective']
      - goal_type_labels = { 'stepping_stone_activity' => 'Stepping Stones/Activities', 'quantitative_key_result' => 'Measurable Outcomes', 'qualitative_key_result' => 'Sentiment Outcomes', 'inspirational_objective' => 'Objectives' }
      
      - # Find root goals (goals with no incoming links from other prompt goals or their descendants)
      - goals_that_are_children = Set.new
      - GoalLink.where(parent_id: all_descendant_goal_ids, child_id: all_descendant_goal_ids).each do |link|
        - goals_that_are_children.add(link.child_id)
      - root_goals = non_archived_goals.reject { |goal| goals_that_are_children.include?(goal.id) }
      
      - goal_types.each do |goal_type|
        - goals_for_type = (goals_by_type[goal_type] || []).select { |g| root_goals.include?(g) }
        - if goals_for_type.any?
          - sorted_goals = goals_for_type.sort_by do |goal|
            - [goal.most_likely_target_date&.day || 99, goal.title.downcase]
          .mb-4
            %h6.mb-2
              = goal_type_labels[goal_type]
              %span.badge{class: goal_badge_class(goal_type), style: "font-size: 0.75em;"}
                = pluralize(goals_for_type.count, 'goal')
            %ul.list-unstyled
              - sorted_goals.each do |goal|
                = render 'organizations/prompts/goal_hierarchy_item', goal: goal, indent_level: 0, all_descendant_goal_ids: all_descendant_goal_ids, linked_goal_check_ins: @linked_goal_check_ins
    - else
      %em.text-muted No goals associated with this prompt.
      - if @can_edit
        = link_to manage_goals_organization_prompt_path(@organization, @prompt, return_url: edit_organization_prompt_path(@organization, @prompt), return_text: @prompt_template.title), class: "text-decoration-none", target: '_blank' do
          Associate goals
