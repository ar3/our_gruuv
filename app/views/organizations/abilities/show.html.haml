- content_for :title, @ability.name

- content_for :header do
  = render 'shared/header', 
    header_name: content_tag(:i, '', class: 'bi bi-lightning me-2') + @ability.name,
    header_quick_action_url: edit_organization_ability_path(@organization, @ability),
    header_quick_action_content: content_tag(:i, '', class: 'bi bi-pencil me-2'),
    header_quick_action_is_enabled: policy(@ability).update?,
    header_quick_action_disabled_tooltip: "You need MAAP management permissions for this organization to edit abilities"
      
- content_for :go_back_link do
  = link_to organization_abilities_path(@organization), class: "text-muted text-decoration-none" do
    %i.bi.bi-arrow-left.me-2
    Back to Abilities

- content_for :header_action do
  = render 'mode_switcher'

- if @ability.archived?
  .alert.alert-warning.alert-dismissible.fade.show.mb-4{ role: "alert" }
    %h5.alert-heading
      %i.bi.bi-archive.me-2
      Archived as of #{l(@ability.deleted_at, format: :long)}
    %p.mb-0 This ability is archived. It no longer appears in lists or selectors but remains viewable and its data (milestones, ratings, etc.) is preserved.

.row
  .col-md-8
    .card.mb-4{ role: "region", "aria-labelledby": "ability-details" }
      .card-header
        %h5.mb-0{ id: "ability-details" }
          %i.bi.bi-info-circle.me-2
          Ability Details
      .card-body
        %dl.row
          %dt.col-sm-3 Name:
          %dd.col-sm-9= @ability.name
          %dt.col-sm-3 Description:
          %dd.col-sm-9
            - if @ability.description.present?
              .markdown-content= render_markdown(@ability.description)
            - else
              %em.text-muted No description provided
          %dt.col-sm-3 Version:
          %dd.col-sm-9
            %span.badge.bg-primary= @ability.semantic_version
          %dt.col-sm-3 Department:
          %dd.col-sm-9= @ability.company.display_name
          %dt.col-sm-3 Created:
          %dd.col-sm-9= format_time_in_user_timezone(@ability.created_at)
          %dt.col-sm-3 Updated:
          %dd.col-sm-9= format_time_in_user_timezone(@ability.updated_at)

    .card.mb-4{ role: "region", "aria-labelledby": "milestone-descriptions" }
      .card-header
        %h5.mb-0{ id: "milestone-descriptions" }
          %i.bi.bi-list-ol.me-2
          Milestone Descriptions
      .card-body
        - (1..5).each do |level|
          - description = @ability.send("milestone_#{level}_description")
          - if description.present?
            .mb-3
              %h6.text-primary Milestone #{level}
              .markdown-content.markdown-content--bordered= render_markdown(description)
        - if (1..5).all? { |level| @ability.send("milestone_#{level}_description").blank? }
          %em.text-muted No milestone descriptions provided

    - if @ability.is_required_by_assignments?
      .card.mb-4{ role: "region", "aria-labelledby": "assignments" }
        .card-header
          %h5.mb-0{ id: "assignments" }
            %i.bi.bi-clipboard-check.me-2
            Assignments Requiring This Ability
        .card-body
          - @ability.required_by_assignments.each_with_index do |assignment_ability, index|
            - if index > 0
              %hr
            .mb-3
              = link_to organization_assignment_path(assignment_ability.assignment.company, assignment_ability.assignment), class: "text-decoration-none" do
                %h6.mb-1= assignment_ability.assignment.title
              %p.mb-0.text-muted.small
                Required milestone level: #{milestone_level_display(assignment_ability.milestone_level)} (M#{assignment_ability.milestone_level})

    - if @ability.is_required_by_positions?
      .card.mb-4{ role: "region", "aria-labelledby": "positions" }
        .card-header
          %h5.mb-0{ id: "positions" }
            %i.bi.bi-briefcase.me-2
            Positions Requiring This Ability
        .card-body
          - @ability.required_by_positions.each_with_index do |position_ability, index|
            - if index > 0
              %hr
            .mb-3
              = link_to organization_position_path(position_ability.position.company, position_ability.position), class: "text-decoration-none" do
                %h6.mb-1= position_ability.position.display_name
              %p.mb-0.text-muted.small
                Required milestone level: #{milestone_level_display(position_ability.milestone_level)} (M#{position_ability.milestone_level})

  .col-md-4
    .card.mb-4
      .card-header
        %h6.mb-0
          %i.bi.bi-star.me-2
          Spotlight
      .card-body
        .mb-3
          %h6.text-muted.small.mb-2 Analytics
          .d-flex.justify-content-between
            %span Version:
            %strong= @ability.semantic_version
          .d-flex.justify-content-between
            %span Department:
            %strong= @ability.company.display_name
          .d-flex.justify-content-between
            %span Created:
            %strong= format_date_in_user_timezone(@ability.created_at, format: "%b %d, %Y")
          .d-flex.justify-content-between
            %span Required by:
            %strong= @ability.required_by_assignments_count
            %small.text-muted assignments
          .d-flex.justify-content-between
            %span Required by (position):
            %strong= @ability.required_by_positions_count
            %small.text-muted positions
          .d-flex.justify-content-between
            %span People with milestones:
            %strong= @ability.person_attainments_count
            %small.text-muted people
        
        .mb-3
          %h6.text-muted.small.mb-2 Interesting Tidbits
          - if @ability.description.present?
            %p.small
              %i.bi.bi-check-circle.text-success.me-1
              Has detailed description
          - else
            %p.small
              %i.bi.bi-exclamation-circle.text-warning.me-1
              Missing description
          
          - milestone_count = (1..5).count { |level| @ability.send("milestone_#{level}_description").present? }
          %p.small
            %i.bi.bi-list-ol.text-info.me-1
            #{milestone_count} of 5 milestones defined
          
          - if @ability.is_required_by_assignments?
            %p.small
              %i.bi.bi-clipboard-check.text-primary.me-1
              Required by #{@ability.required_by_assignments_count} assignment#{'s' if @ability.required_by_assignments_count != 1}
          - else
            %p.small
              %i.bi.bi-clipboard.text-muted.me-1
              Not required by any assignments
          - if @ability.is_required_by_positions?
            %p.small
              %i.bi.bi-briefcase.text-primary.me-1
              Required by #{@ability.required_by_positions_count} position#{'s' if @ability.required_by_positions_count != 1}
          - else
            %p.small
              %i.bi.bi-briefcase.text-muted.me-1
              Not required by any positions
        
        .mb-3
          %h6.text-muted.small.mb-2 Actions
          - if policy(@ability).update?
            = link_to organization_ability_assignment_milestones_path(@organization, @ability), class: "btn btn-outline-primary btn-sm w-100" do
              %i.bi.bi-link-45deg.me-2
              Manage Assignment Milestones
          - else
            .d-flex.align-items-center.gap-2
              .flex-grow-1
                %button.btn.btn-outline-secondary.btn-sm.w-100.disabled{disabled: true, type: "button"}
                  %i.bi.bi-link-45deg.me-2
                  Manage Assignment Milestones
              %i.bi.bi-exclamation-triangle.text-warning{data: {bs_toggle: "tooltip", bs_title: "You need MAAP management permissions to manage assignment milestones"}}
          
          - if @ability.has_person_attainments?
            %p.small
              %i.bi.bi-people.text-success.me-1
              #{@ability.person_attainments_count} person#{'s' if @ability.person_attainments_count != 1} have milestone#{'s' if @ability.person_attainments_count != 1}
          - else
            %p.small
              %i.bi.bi-person.text-muted.me-1
              No milestone attainments yet

    / Comments Section
    = render 'shared/comment_summary', commentable: @ability, organization: @organization


