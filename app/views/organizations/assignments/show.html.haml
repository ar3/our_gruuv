- content_for :title, @assignment.title

- content_for :header do
  %h1.mb-0= @assignment.title

- content_for :header_action do
  = render 'assignments/view_switcher'

- content_for :go_back_link do
  = link_to organization_assignments_path(@organization), class: "go-back-link" do
    %i.bi.bi-arrow-left.me-2
    Back to Assignments

- if @assignment.archived?
  .alert.alert-warning.alert-dismissible.fade.show.mb-4{ role: "alert" }
    %h5.alert-heading
      %i.bi.bi-archive.me-2
      Archived as of #{l(@assignment.deleted_at, format: :long)}
    %p.mb-0 This assignment is archived. It no longer appears in lists or selectors but remains viewable and its data (check-ins, ratings, etc.) is preserved.

.row.justify-content-center
  .col-12
    .card.mb-4
      .card-header
        %h5.mb-0
          %i.bi.bi-info-circle.me-2
          Assignment Details
      .card-body
        .row
          .col-md-8
            - if @assignment.department.present?
              .mb-3
                %h6.text-muted Department
                - if policy(@organization).show?
                  = link_to @organization.name, organization_path(@organization), class: "text-decoration-none"
                - else
                  %span= @organization.name
                - if @assignment.department.present?
                  %span.text-muted.mx-1
                    %i.bi.bi-chevron-right
                  - if policy(@assignment.department).show?
                    = link_to @assignment.department.name, organization_department_path(@organization, @assignment.department), class: "text-decoration-none"
                  - else
                    %span= @assignment.department.name
            
            - if @assignment.tagline.present?
              .mb-3
                %h6.text-muted Tagline
                %p.mb-0= @assignment.tagline
            
            - if @assignment.assignment_outcomes.any?
              .mb-3
                %h6.text-muted
                  = link_to "Outcomes", edit_organization_assignment_path(@organization, @assignment), class: "text-muted text-decoration-none"
                - @assignment.assignment_outcomes.ordered.each do |outcome|
                  .card.mb-2
                    .card-body.py-2
                      .d-flex.justify-content-between.align-items-start
                        .flex-grow-1
                          .markdown-content
                            = render_markdown(outcome.description)
                          - if outcome.progress_report_url.present? || outcome.management_relationship_filter.present? || outcome.team_relationship_filter.present? || outcome.consumer_assignment_filter.present?
                            .mt-2.pt-2.border-top
                              - if outcome.progress_report_url.present?
                                .mb-1
                                  %small.text-muted
                                    %strong Progress Report:
                                  %br
                                  = link_to outcome.progress_report_url, outcome.progress_report_url, target: "_blank", class: "text-decoration-none"
                              
                              - if outcome.management_relationship_filter.present?
                                .mb-1
                                  %small.text-muted
                                    %strong Who to Ask (Management):
                                  %br
                                  %small= assignment_outcome_management_relationship_label(outcome.management_relationship_filter)
                              
                              - if outcome.team_relationship_filter.present?
                                .mb-1
                                  %small.text-muted
                                    %strong Who to Ask (Team):
                                  %br
                                  %small= assignment_outcome_team_relationship_label(outcome.team_relationship_filter)
                              
                              - if outcome.consumer_assignment_filter.present?
                                .mb-1
                                  %small.text-muted
                                    %strong Who to Ask (Consumer Assignment):
                                  %br
                                  %small= assignment_outcome_consumer_assignment_label(outcome.consumer_assignment_filter, @assignment)
                        .d-flex.flex-column.align-items-end.gap-1
                          %span.badge{class: outcome.outcome_type == 'sentiment' ? 'bg-warning' : 'bg-info'}
                            = outcome.outcome_type.titleize
                          - if policy(outcome).edit?
                            = link_to edit_organization_assignment_assignment_outcome_path(@organization, @assignment, outcome), class: "badge text-decoration-none #{outcome.has_additional_configuration? ? 'bg-info' : 'bg-secondary'}" do
                              = outcome.additional_configuration_badge_label
            - else
              .mb-3
                .alert.alert-warning
                  %h6.mb-2
                    %i.bi.bi-exclamation-triangle.me-2
                    No Outcomes Defined
                  %p.mb-2 Outcomes help clarify what success looks like for this assignment.
                  = link_to "Add Outcomes", edit_organization_assignment_path(@organization, @assignment), class: "btn btn-warning btn-sm"

          .col-md-4.border-start.border-secondary
            .d-grid.gap-2
              - if @assignment.required_activities.present?
                .mb-3
                  %h6.text-muted Required Activities
                  .markdown-content.markdown-content--bordered
                    = render_markdown(@assignment.required_activities)

              - if @assignment.published_url.present? || @assignment.draft_url.present?
                .mb-3
                  %h6.text-muted Source Documents
                  - if @assignment.published_url.present?
                    .mb-2
                      = link_to @assignment.published_url, target: "_blank", class: "btn btn-outline-primary btn-sm w-100" do
                        %i.bi.bi-file-earmark-text.me-1
                        Published Version
                  - if @assignment.draft_url.present?
                    .mb-2
                      = link_to @assignment.draft_url, target: "_blank", class: "btn btn-outline-secondary btn-sm w-100" do
                        %i.bi.bi-file-earmark-text.me-1
                        Draft Version

    - if @assignment.handbook.present?
      .card.mb-4
        .card-header
          %h5.mb-0
            %i.bi.bi-book.me-2
            Handbook
        .card-body
          .markdown-content.markdown-content--bordered
            = render_markdown(@assignment.handbook)

    - if @assignment.has_ability_requirements?
      .card.mb-4{ role: "region", "aria-labelledby": "abilities" }
        .card-header
          %h5.mb-0{ id: "abilities" }
            %i.bi.bi-lightning.me-2
            Abilities Required for This Assignment
        .card-body
          %p.mb-0.text-muted
            = render 'shared/abilities_sentence', 
                     assignment_abilities: @assignment.required_abilities,
                     public_view: false,
                     show_milestone_parentheticals: true,
                     include_prefix: true

    - if @consumer_assignments.any? || policy(@assignment).show?
      .card.mb-4{ role: "region", "aria-labelledby": "consumer-assignments" }
        .card-header
          %h5.mb-0{ id: "consumer-assignments" }
            %i.bi.bi-arrow-down-circle.me-2
            Assignments that benefit from / consume the results of #{@assignment.title}
        .card-body
          - if @consumer_assignments.any?
            .row
              - @consumer_assignments.each_slice((@consumer_assignments.count.to_f / 3).ceil) do |slice|
                .col-md-4
                  - slice.each do |consumer_assignment|
                    .mb-2
                      = link_to consumer_assignment.title, organization_assignment_path(@organization, consumer_assignment), class: "text-decoration-none"
                      - if consumer_assignment.department
                        %br
                        %small.text-muted= consumer_assignment.department.display_name
          - else
            %p.text-muted.mb-0 No assignments currently benefit from this assignment.

    - if @position_assignments.any?
      .card.mb-4{ role: "region", "aria-labelledby": "positions" }
        .card-header
          %h5.mb-0{ id: "positions" }
            %i.bi.bi-briefcase.me-2
            Positions that Require or Suggest This Assignment
        .card-body
          - required_positions = @position_assignments.select { |pa| pa.assignment_type == 'required' }
          - suggested_positions = @position_assignments.select { |pa| pa.assignment_type == 'suggested' }
          
          - if required_positions.any?
            %h6.text-primary.mb-3 Required Positions (#{required_positions.count})
            .row
              - required_positions.each_slice((required_positions.count.to_f / 3).ceil) do |slice|
                .col-md-4
                  - slice.each do |position_assignment|
                    .mb-2
                      = link_to position_assignment.position.display_name, organization_position_path(position_assignment.position.company, position_assignment.position), class: "text-decoration-none"
                      - if position_assignment.energy_percentage_suffix.present?
                        = " #{position_assignment.energy_percentage_suffix}"
          
          - if suggested_positions.any?
            %h6.text-info.mb-3{class: required_positions.any? ? 'mt-3' : ''} Suggested Positions (#{suggested_positions.count})
            .row
              - suggested_positions.each_slice((suggested_positions.count.to_f / 3).ceil) do |slice|
                .col-md-4
                  - slice.each do |position_assignment|
                    .mb-2
                      = link_to position_assignment.position.display_name, organization_position_path(position_assignment.position.company, position_assignment.position), class: "text-decoration-none"
                      - if position_assignment.energy_percentage_suffix.present?
                        = " #{position_assignment.energy_percentage_suffix}"

    .card.mb-4{ role: "region", "aria-labelledby": "current-holders" }
      .card-header
        %h5.mb-0{ id: "current-holders" }
          %i.bi.bi-people.me-2
          Current Holders of This Assignment
      .card-body
        - if @data_quality_warnings.present?
          .alert.alert-warning.mb-3{ role: "alert" }
            %strong Data quality (for debugging):
            %ul.mb-0.mt-1
              - @data_quality_warnings.each do |msg|
                %li= msg
        - if @current_holders.any?
          .row
            - @current_holders.each_slice((@current_holders.count.to_f / 3).ceil) do |slice|
              .col-md-4
                - slice.each do |teammate|
                  .mb-2
                    = link_to teammate.person.display_name, internal_organization_company_teammate_path(@organization, teammate), class: "text-decoration-none"
                    - if @holder_energy_percentages[teammate.id].present?
                      %span.text-muted.ms-2
                        (#{@holder_energy_percentages[teammate.id]}%)
        - else
          %p.text-muted.mb-0 No current holders

    .card.mb-4{ role: "region", "aria-labelledby": "analytics" }
      .card-header
        %h5.mb-0{ id: "analytics" }
          %i.bi.bi-graph-up.me-2
          Analytics
      .card-body
        .row
          .col-md-6.mb-3
            %h6.text-muted Teammates with Tenure
            %p.mb-0= @teammates_with_tenure_count
          .col-md-6.mb-3
            %h6.text-muted Total Finalized Check-ins
            %p.mb-0= @finalized_check_ins_count
          .col-md-6.mb-3
            %h6.text-muted Active Assignment Tenures
            %p.mb-0= @active_tenures_count
          .col-md-6.mb-3
            %h6.text-muted Average Anticipated Energy
            %p.mb-0
              - if @average_energy_percentage.present?
                = "#{@average_energy_percentage}%"
              - else
                %span.text-muted Not available
          .col-md-6.mb-3
            %h6.text-muted Most Popular Official Rating
            %p.mb-0
              - if @teammates_with_finalized_check_ins_count > 5
                - if @most_popular_official_rating.present?
                  = @most_popular_official_rating.humanize
                - else
                  %span.text-muted No ratings available
              - else
                %span.text-muted These analytics will be available once 5 or more teammates have had a finalized check-in.
          .col-md-6.mb-3
            %h6.text-muted Most Popular Personal Alignment
            %p.mb-0
              - if @teammates_with_finalized_check_ins_count > 5
                - if @most_popular_personal_alignment.present?
                  = @most_popular_personal_alignment.humanize
                - else
                  %span.text-muted No alignments available
              - else
                %span.text-muted These analytics will be available once 5 or more teammates have had a finalized check-in.

    / Comments Section
    = render 'shared/comment_summary', commentable: @assignment, organization: @organization
              