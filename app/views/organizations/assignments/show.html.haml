- content_for :title, @assignment.title

- content_for :header do
  %h1.mb-0= @assignment.title

- content_for :header_action do
  = render 'assignments/view_switcher'

- content_for :go_back_link do
  = link_to organization_assignments_path(@organization), class: "go-back-link" do
    %i.bi.bi-arrow-left.me-2
    Back to Assignments

.row.justify-content-center
  .col-12
    .card.mb-4
      .card-header
        %h5.mb-0
          %i.bi.bi-info-circle.me-2
          Assignment Details
      .card-body
        .row
          .col-md-8
            - if @assignment.department.present?
              .mb-3
                %h6.text-muted Department
                - hierarchy_path = []
                - current_org = @assignment.department
                - while current_org
                  - hierarchy_path.unshift(current_org)
                  - current_org = current_org.parent
                - hierarchy_path.each_with_index do |org, index|
                  - if org.company?
                    - if policy(org).show?
                      = link_to org.name, organization_path(org), class: "text-decoration-none"
                    - else
                      %span= org.name
                  - else
                    - if policy(org).show?
                      = link_to org.name, organization_departments_and_team_path(@organization, org), class: "text-decoration-none"
                    - else
                      %span= org.name
                  - unless index == hierarchy_path.length - 1
                    %span.text-muted.mx-1
                      %i.bi.bi-chevron-right
            
            - if @assignment.tagline.present?
              .mb-3
                %h6.text-muted Tagline
                %p.mb-0= @assignment.tagline
            
            - if @assignment.assignment_outcomes.any?
              .mb-3
                %h6.text-muted Outcomes
                - @assignment.assignment_outcomes.ordered.each do |outcome|
                  .card.mb-2
                    .card-body.py-2
                      .d-flex.justify-content-between.align-items-start
                        .flex-grow-1
                          .markdown-content
                            = render_markdown(outcome.description)
                        %span.badge{class: outcome.outcome_type == 'sentiment' ? 'bg-warning' : 'bg-info'}
                          = outcome.outcome_type.titleize
            - else
              .mb-3
                .alert.alert-warning
                  %h6.mb-2
                    %i.bi.bi-exclamation-triangle.me-2
                    No Outcomes Defined
                  %p.mb-2 Outcomes help clarify what success looks like for this assignment.
                  = link_to "Add Outcomes", edit_organization_assignment_path(@organization, @assignment), class: "btn btn-warning btn-sm"

          .col-md-4.border-start.border-secondary
            .d-grid.gap-2
              - if @assignment.required_activities.present?
                .mb-3
                  %h6.text-muted Required Activities
                  .markdown-content.markdown-content--bordered
                    = render_markdown(@assignment.required_activities)

              - if @assignment.published_url.present? || @assignment.draft_url.present?
                .mb-3
                  %h6.text-muted Source Documents
                  - if @assignment.published_url.present?
                    .mb-2
                      = link_to @assignment.published_url, target: "_blank", class: "btn btn-outline-primary btn-sm w-100" do
                        %i.bi.bi-file-earmark-text.me-1
                        Published Version
                  - if @assignment.draft_url.present?
                    .mb-2
                      = link_to @assignment.draft_url, target: "_blank", class: "btn btn-outline-secondary btn-sm w-100" do
                        %i.bi.bi-file-earmark-text.me-1
                        Draft Version

    - if @assignment.handbook.present?
      .card.mb-4
        .card-header
          %h5.mb-0
            %i.bi.bi-book.me-2
            Handbook
        .card-body
          .markdown-content.markdown-content--bordered
            = render_markdown(@assignment.handbook)

    - if @assignment.has_ability_requirements?
      .card.mb-4{ role: "region", "aria-labelledby": "abilities" }
        .card-header
          %h5.mb-0{ id: "abilities" }
            %i.bi.bi-lightning.me-2
            Abilities Required for This Assignment
        .card-body
          %p.mb-0.text-muted
            = render 'shared/abilities_sentence', 
                     assignment_abilities: @assignment.required_abilities,
                     public_view: false,
                     show_milestone_parentheticals: true,
                     include_prefix: true

    .card.mb-4{ role: "region", "aria-labelledby": "current-holders" }
      .card-header
        %h5.mb-0{ id: "current-holders" }
          %i.bi.bi-people.me-2
          Current Holders of This Assignment
      .card-body
        - if @current_holders.any?
          .row
            - @current_holders.each_slice((@current_holders.count.to_f / 3).ceil) do |slice|
              .col-md-4
                - slice.each do |teammate|
                  .mb-2
                    = link_to teammate.person.display_name, internal_organization_company_teammate_path(@organization, teammate), class: "text-decoration-none"
        - else
          %p.text-muted.mb-0 No current holders

    .card.mb-4{ role: "region", "aria-labelledby": "analytics" }
      .card-header
        %h5.mb-0{ id: "analytics" }
          %i.bi.bi-graph-up.me-2
          Analytics
      .card-body
        .row
          .col-md-6.mb-3
            %h6.text-muted Teammates with Tenure
            %p.mb-0= @teammates_with_tenure_count
          .col-md-6.mb-3
            %h6.text-muted Total Finalized Check-ins
            %p.mb-0= @finalized_check_ins_count
          .col-md-6.mb-3
            %h6.text-muted Active Assignment Tenures
            %p.mb-0= @active_tenures_count
          .col-md-6.mb-3
            %h6.text-muted Average Anticipated Energy
            %p.mb-0
              - if @average_energy_percentage.present?
                = "#{@average_energy_percentage}%"
              - else
                %span.text-muted Not available
          .col-md-6.mb-3
            %h6.text-muted Most Popular Official Rating
            %p.mb-0
              - if @teammates_with_finalized_check_ins_count > 5
                - if @most_popular_official_rating.present?
                  = @most_popular_official_rating.humanize
                - else
                  %span.text-muted No ratings available
              - else
                %span.text-muted These analytics will be available once 5 or more teammates have had a finalized check-in.
          .col-md-6.mb-3
            %h6.text-muted Most Popular Personal Alignment
            %p.mb-0
              - if @teammates_with_finalized_check_ins_count > 5
                - if @most_popular_personal_alignment.present?
                  = @most_popular_personal_alignment.humanize
                - else
                  %span.text-muted No alignments available
              - else
                %span.text-muted These analytics will be available once 5 or more teammates have had a finalized check-in.

    / Comments Section
    = render 'shared/comment_summary', commentable: @assignment, organization: @organization
              