- content_for :title, "Assignments"

- content_for :go_back_link do
  = link_to organization_path(@organization), class: "go-back-link" do
    %i.bi.bi-arrow-left.me-2
    Back to #{@organization.display_name}

- content_for :header do
  .d-flex.justify-content-between.align-items-center
    %h1.mb-0 
      %i.bi.bi-briefcase.me-2
      Assignments
      = link_to new_organization_assignment_path(@organization), class: "btn btn-primary" do
        %i.bi.bi-plus

- content_for :header_action do
  - customize_params = params.except(:controller, :action, :page).permit!.to_h
  = link_to customize_view_organization_assignments_path(@organization, customize_params), class: "btn btn-outline-secondary" do
    %i.bi.bi-sliders.me-2
    Customize View

/ Spotlight Section
- if @current_spotlight && @current_spotlight != 'none'
  .row.justify-content-center.mb-4
    .col-lg-12
      .card.border-0.shadow-sm
        .card-body
          - case @current_spotlight
          - when 'by_department'
            = render partial: 'organizations/assignments/spotlights/by_organization'
          - else
            .row
              .col-md-8
                .row.text-center
                  .col-3
                    .h3.text-primary= @assignments.count
                    %small.text-muted Total Assignments
        .card-footer.bg-light
          .row.align-items-center
            .col-md-6
              %small.text-muted
                %i.bi.bi-funnel.me-1
                Filters: 
                - filter_parts = []
                - if params[:departments].present?
                  - department_params = params[:departments].to_s.split(',').map(&:strip).reject(&:blank?)
                  - department_ids = department_params.reject { |p| p == 'none' || p == '' }.map(&:to_i).reject(&:zero?)
                  - selected_departments = Organization.where(id: department_ids) if department_ids.any?
                  - has_none = department_params.include?('none') || department_params.include?('')
                  - if has_none && selected_departments&.any?
                    - filter_parts << "#{selected_departments.count + 1} department#{'s' if selected_departments.count + 1 != 1} (including no department)"
                  - elsif has_none
                    - filter_parts << 'No department'
                  - elsif selected_departments&.any?
                    - filter_parts << "#{selected_departments.count} department#{'s' if selected_departments.count != 1}"
                - else
                  - filter_parts << 'All departments'
                - if params[:outcomes_filter].present? && params[:outcomes_filter] != 'all'
                  - filter_parts << "Outcomes: #{params[:outcomes_filter] == 'with' ? 'W/' : 'W/o'}"
                - if params[:abilities_filter].present? && params[:abilities_filter] != 'all'
                  - filter_parts << "Abilities: #{params[:abilities_filter] == 'with' ? 'W/' : 'W/o'}"
                - if params[:major_version].present?
                  - filter_parts << "v#{params[:major_version]}.x.x"
                = filter_parts.any? ? filter_parts.join(' / ') : 'All'
                %br
                %i.bi.bi-sort-down.me-1
                Sort: 
                - sort_display = case params[:sort]
                - when 'department_and_title'
                  - 'Department and Title'
                - when 'title'
                  - 'Title (A-Z)'
                - when 'title_desc'
                  - 'Title (Z-A)'
                - when 'company'
                  - 'Company (A-Z)'
                - when 'company_desc'
                  - 'Company (Z-A)'
                - when 'outcomes'
                  - 'Most Outcomes'
                - when 'outcomes_desc'
                  - 'Fewest Outcomes'
                - when 'abilities'
                  - 'Most Abilities'
                - when 'abilities_desc'
                  - 'Fewest Abilities'
                - else
                  - 'Department and Title'
                = sort_display
            .col-md-6.text-end
              %small.text-muted
                %i.bi.bi-table.me-1
                View: Table
                %br
                %i.bi.bi-eye.me-1
                Spotlight: #{@current_spotlight&.humanize || 'None'}

.row.justify-content-center
  .col-lg-12
    - if @assignments_by_department.any?
      - @assignments_by_department.each do |department, assignments|
        - stats = @department_stats[department] || { assignments_count: 0 }
        .card.mb-4
          .card-header.bg-primary.text-white
            %h5.mb-0.d-flex.align-items-center.justify-content-between
              .d-flex.align-items-center
                - if department
                  %i.bi.bi-building.me-2
                  = department.display_name
                  = link_to organization_departments_and_team_path(@organization, department), class: "text-white ms-2", title: "View department" do
                    %i.bi.bi-link-45deg
                - else
                  %i.bi.bi-question-circle.me-2
                  No Department
              .d-flex.align-items-center.gap-2
                %span.badge.bg-light.text-dark
                  = stats[:assignments_count]
                  assignment#{'s' if stats[:assignments_count] != 1}
          .card-body.p-0
            .table-responsive
              %table.table.table-hover.mb-0
                %thead.table-light
                  %tr
                    %th Assignment
                    %th Outcomes
                    %th Abilities
                    %th Positions
                %tbody
                  - assignments.each do |assignment|
                    %tr
                      %td
                        - if assignment.department&.display_name || assignment.company_name
                          %small.text-muted
                            %i.bi.bi-building.me-1
                            = assignment.department&.display_name || assignment.company_name
                          %br
                        %strong
                          = link_to assignment.title, organization_assignment_path(@organization, assignment), class: "text-decoration-none"
                          %small.text-muted.ms-2
                            v#{assignment.semantic_version}
                        %br
                        %small.text-muted= assignment.tagline
                      %td
                        - if assignment.assignment_outcomes.any?
                          - assignment.assignment_outcomes.each do |outcome|
                            = link_to edit_organization_assignment_assignment_outcome_path(@organization, assignment, outcome), class: "badge bg-light me-1 mb-1 text-decoration-none text-spice-#{outcome.outcome_type == 'sentiment' ? '1' : '2'}", data: {bs_toggle: 'tooltip', bs_title: outcome.description} do
                              = outcome.outcome_type.titleize
                            %br
                        - else
                          %span.text-muted
                            %i.bi.bi-exclamation-triangle.me-1
                            None
                      %td
                        - if assignment.abilities.any?
                          - assignment.assignment_abilities.includes(:ability).each do |assignment_ability|
                            - ability = assignment_ability.ability
                            - milestone_level = assignment_ability.milestone_level
                            = link_to organization_ability_path(@organization, ability), class: "badge bg-light text-spice-4 me-1 mb-1 text-decoration-none" do
                              = "#{ability.name} (M#{milestone_level})"
                            %br
                        - else
                          %span.text-muted
                            %i.bi.bi-exclamation-triangle.me-1
                            None
                      %td
                        - if assignment.position_assignments.any?
                          - position_assignments_by_title = assignment.position_assignments.group_by { |pa| pa.position.title }
                          - position_assignments_by_title.each_with_index do |(title, position_assignments), index|
                            - if position_assignments.count > 1
                              - collapse_id = "assignment_#{assignment.id}_title_#{title.id}"
                              %small
                                %a.text-decoration-none{"data-bs-toggle" => "collapse", "data-bs-target" => "##{collapse_id}", "aria-expanded" => "false", "aria-controls" => collapse_id, style: "cursor: pointer;"}
                                  %span.not-collapsed
                                    %i.bi.bi-chevron-up.me-1
                                  %span.collapsed
                                    %i.bi.bi-chevron-down.me-1
                                  = title.external_title
                                .collapse{id: collapse_id}
                                  - position_assignments.each do |position_assignment|
                                    - position = position_assignment.position
                                    %small.d-block.ms-3.mt-1
                                      %i.bi.bi-arrow-right.me-1
                                      = link_to organization_position_path(@organization, position), class: "text-decoration-none" do
                                        = position.position_level.level
                                      - if position_assignment.energy_percentage_suffix.present?
                                        = " #{position_assignment.energy_percentage_suffix}"
                            - else
                              - position_assignment = position_assignments.first
                              - position = position_assignment.position
                              %small
                                = link_to organization_position_path(@organization, position), class: "text-decoration-none" do
                                  = position.display_name
                                - if position_assignment.energy_percentage_suffix.present?
                                  = " #{position_assignment.energy_percentage_suffix}"
                            - unless index == position_assignments_by_title.size - 1
                              %br
                        - else
                          %span.text-muted
                            %i.bi.bi-dash.me-1
                            None
    - else
      .alert.alert-info
        %h6.mb-2
          %i.bi.bi-info-circle.me-2
          No Assignments Created
        %p.mb-2 
          Create your first assignment to define clear roles and responsibilities for your team.
        = link_to "Create First Assignment", new_organization_assignment_path(@organization), class: "btn btn-primary btn-sm"
