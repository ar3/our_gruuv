- content_for :title, "Search"

- content_for :go_back_link do
  = link_to organization_path(@organization), class: "go-back-link" do
    %i.bi.bi-arrow-left.me-2
    Back to #{@organization.display_name}

- content_for :header do
  .d-flex.align-items-center
    %h1.mb-0.me-2
      %i.bi.bi-search.me-2
      Search Results
    - if @results[:total_count] > 0
      %span.badge.bg-primary.ms-2= "#{@results[:total_count]} results"

.row.justify-content-center.mb-4
  .col-lg-12
    .card.border-0.shadow-sm
      .card-body
        = form_with url: organization_search_path(@organization), method: :get, local: true, class: "mb-0" do |f|
          .row
            .col-md-10
              = f.text_field :q, 
                  value: @query, 
                  placeholder: "Search people, organizations, observations, assignments, and abilities...", 
                  class: "form-control form-control-lg",
                  autofocus: true,
                  style: "font-size: 1.25rem; padding: 1rem;"
            .col-md-2
              = f.submit "Search", class: "btn btn-primary btn-lg w-100", style: "padding: 1rem; font-size: 1.1rem;"

- if @query.present?
  - if @results[:total_count] > 0
    .row.justify-content-center
      .col-lg-12
        - if @results[:people].any?
          .card.mb-4
            .card-header
              %h5.mb-0
                %i.bi.bi-people.me-2
                People (#{@results[:people].count})
            .card-body
              .table-responsive
                %table.table.table-hover
                  %thead
                    %tr
                      %th Name
                      %th Email
                      %th Actions
                  %tbody
                    - @results[:people].each do |person|
                      - teammate = person.teammates.find_by(organization: @organization, type: 'CompanyTeammate')
                      %tr
                        %td
                          - if teammate
                            = link_to person.display_name, internal_organization_company_teammate_path(@organization, teammate), class: "text-decoration-none fw-bold"
                          - else
                            = person.display_name
                        %td= person.email
                        %td
                          .btn-group.btn-group-sm
                            - if teammate
                              = link_to internal_organization_company_teammate_path(@organization, teammate), class: "btn btn-outline-primary" do
                                %i.bi.bi-eye

        - if @results[:organizations].any?
          .card.mb-4
            .card-header
              %h5.mb-0
                %i.bi.bi-building.me-2
                Organizations (#{@results[:organizations].count})
            .card-body
              .table-responsive
                %table.table.table-hover
                  %thead
                    %tr
                      %th Name
                      %th Type
                      %th Actions
                  %tbody
                    - @results[:organizations].each do |organization|
                      %tr
                        %td= organization.display_name
                        %td= organization.type
                        %td
                          .btn-group.btn-group-sm
                            = link_to organization_path(organization), class: "btn btn-outline-primary" do
                              %i.bi.bi-eye

        - if @results[:observations].any?
          .card.mb-4
            .card-header
              %h5.mb-0
                %i.bi.bi-chat-text.me-2
                Observations (#{@results[:observations].count})
            .card-body
              .table-responsive
                %table.table.table-hover
                  %thead
                    %tr
                      %th Story Preview
                      %th Observer
                      %th Date
                      %th Actions
                  %tbody
                    - @results[:observations].each do |observation|
                      %tr
                        %td
                          = truncate(observation.story, length: 100)
                        %td= observation.observer.display_name
                        %td= format_date_in_user_timezone(observation.observed_at, format: "%b %d, %Y")
                        %td
                          .btn-group.btn-group-sm
                            = link_to organization_observation_path(@organization, observation), class: "btn btn-outline-primary" do
                              %i.bi.bi-eye

        - if @results[:assignments].any?
          .card.mb-4
            .card-header
              %h5.mb-0
                %i.bi.bi-briefcase.me-2
                Assignments (#{@results[:assignments].count})
            .card-body
              .table-responsive
                %table.table.table-hover
                  %thead
                    %tr
                      %th Title
                      %th Tagline
                      %th Company
                      %th Actions
                  %tbody
                    - @results[:assignments].each do |assignment|
                      %tr
                        %td= assignment.title
                        %td= truncate(assignment.tagline, length: 50)
                        %td= assignment.company.display_name
                        %td
                          .btn-group.btn-group-sm
                            = link_to organization_assignment_path(@organization, assignment), class: "btn btn-outline-primary" do
                              %i.bi.bi-eye

        - if @results[:abilities].any?
          .card.mb-4
            .card-header
              %h5.mb-0
                %i.bi.bi-award.me-2
                Abilities (#{@results[:abilities].count})
            .card-body
              .table-responsive
                %table.table.table-hover
                  %thead
                    %tr
                      %th Name
                      %th Description
                      %th Organization
                      %th Actions
                  %tbody
                    - @results[:abilities].each do |ability|
                      %tr
                        %td= ability.name
                        %td= truncate(ability.description, length: 100)
                        %td= ability.organization.display_name
                        %td
                          .btn-group.btn-group-sm
                            = link_to organization_ability_path(@organization, ability), class: "btn btn-outline-primary" do
                              %i.bi.bi-eye
  - else
    .row.justify-content-center
      .col-lg-12
        .alert.alert-info
          %h6.mb-2
            %i.bi.bi-info-circle.me-2
            No Results Found
          %p.mb-2 
            No results found for "#{@query}". Try different keywords or check your spelling.
          %p.mb-0
            %small.text-muted Search across people, organizations, observations, assignments, and abilities in #{@organization.display_name}.
- else
  .row.justify-content-center
    .col-lg-12
      .alert.alert-light
        %h6.mb-2
          %i.bi.bi-search.me-2
          Start Searching
        %p.mb-2 
          Enter a search term above to find people, organizations, observations, assignments, and abilities.
        %p.mb-0
          %small.text-muted Search is scoped to #{@organization.display_name} and respects your permissions.
