- if @seats_by_department && @seats_by_department.any?
  - @seats_by_department.each do |department, seats|
    - stats = @department_stats[department] || { titles_count: 0, seats_count: 0 }
    .card.mb-4
      .card-header.bg-primary.text-white
        %h5.mb-0.d-flex.align-items-center.justify-content-between
          .d-flex.align-items-center
            - if department
              %i.bi.bi-building.me-2
              = department.display_name
            - else
              %i.bi.bi-question-circle.me-2
              No Department
          .d-flex.align-items-center.gap-2
            %span.badge.bg-light.text-dark
              = stats[:titles_count]
              title#{'s' if stats[:titles_count] != 1}
            %span.badge.bg-light.text-dark
              = stats[:seats_count]
              seat#{'s' if stats[:seats_count] != 1}
    
    - seats_by_title = seats.group_by { |seat| seat.title }
    - seats_by_title.each do |title, title_seats|
      .card.mb-3.ms-4
        .card-header.d-flex.justify-content-between.align-items-center
          .d-flex.align-items-center
            %a.text-decoration-none.text-dark.fw-bold{"data-bs-toggle" => "collapse", "data-bs-target" => "#seatTitle#{title&.id || 'none'}", "aria-expanded" => "false", "aria-controls" => "seatTitle#{title&.id || 'none'}", style: "cursor: pointer;"}
              %span.not-collapsed{id: "seatTitleExpandIcon#{title&.id || 'none'}"}
                %i.bi.bi-chevron-down.me-2
              %span.collapsed{id: "seatTitleCollapseIcon#{title&.id || 'none'}"}
                %i.bi.bi-chevron-right.me-2
              = title&.external_title || 'No Title'
            %span.badge.bg-secondary.ms-2= "#{title_seats.size} seat#{'s' if title_seats.size != 1}"
          - if title
            = link_to organization_title_path(organization, title), class: "btn btn-sm btn-outline-secondary", title: "View Title" do
              %i.bi.bi-eye
      
        .collapse{"id" => "seatTitle#{title&.id || 'none'}"}
          .card-body.p-0
            - if title_seats.any?
              .table-responsive
                %table.table.table-hover.mb-0
                  %thead.table-light
                    %tr
                      %th Position Type
                      %th Needed By
                      %th State
                      %th Actions
                  %tbody
                    - title_seats.each do |seat|
                      %tr
                        %td= seat.title&.external_title || 'No Title'
                        %td= seat.seat_needed_by&.strftime('%B %d, %Y') || 'N/A'
                        %td
                          %span.badge{class: seat_state_badge_class(seat.state)}
                            = seat.state.titleize
                            - if seat.needs_reconciliation?
                              %span.badge.bg-warning.ms-1
                                %i.bi.bi-exclamation-triangle
                        %td
                          .btn-group.btn-group-sm
                            = link_to organization_seat_path(organization, seat), class: "btn btn-outline-primary" do
                              %i.bi.bi-eye
                            = link_to edit_organization_seat_path(organization, seat), class: "btn btn-outline-secondary" do
                              %i.bi.bi-pencil
                            - if seat.needs_reconciliation?
                              = link_to reconcile_organization_seat_path(organization, seat), method: :patch, class: "btn btn-outline-warning", data: { confirm: "Reconcile seat state?" } do
                                %i.bi.bi-arrow-clockwise
                            = link_to organization_seat_path(organization, seat), method: :delete, class: "btn btn-outline-danger", data: { confirm: "Are you sure?" } do
                              %i.bi.bi-trash
- elsif @filtered_seats && @filtered_seats.any?
  / Fallback to old view if seats_by_department is not set
  .table-responsive
    %table.table.table-hover.mb-0
      %thead.table-light
        %tr
          %th Position Type
          %th Needed By
          %th State
          %th Actions
      %tbody
        - @filtered_seats.each do |seat|
          %tr
            %td= seat.title.external_title
            %td= seat.seat_needed_by.strftime('%B %d, %Y')
            %td
              %span.badge{class: seat_state_badge_class(seat.state)}
                = seat.state.titleize
                - if seat.needs_reconciliation?
                  %span.badge.bg-warning.ms-1
                    %i.bi.bi-exclamation-triangle
            %td
              .btn-group.btn-group-sm
                = link_to organization_seat_path(organization, seat), class: "btn btn-outline-primary" do
                  %i.bi.bi-eye
                = link_to edit_organization_seat_path(organization, seat), class: "btn btn-outline-secondary" do
                  %i.bi.bi-pencil
                - if seat.needs_reconciliation?
                  = link_to reconcile_organization_seat_path(organization, seat), method: :patch, class: "btn btn-outline-warning", data: { confirm: "Reconcile seat state?" } do
                    %i.bi.bi-arrow-clockwise
                = link_to organization_seat_path(organization, seat), method: :delete, class: "btn btn-outline-danger", data: { confirm: "Are you sure?" } do
                  %i.bi.bi-trash
- else
  .alert.alert-info
    %h6.mb-2
      %i.bi.bi-info-circle.me-2
      No Seats Found
    %p.mb-2
      - if @has_active_filters
        No seats match your current filters. Try adjusting your filter settings.
      - else
        This organization doesn't have any seats yet.
    - unless @has_active_filters
      - if policy(Seat).create?
        = link_to "Create First Seat", new_organization_seat_path(organization), class: "btn btn-primary btn-sm"

