- content_for :title, "Seats"

- content_for :header do
  .d-flex.align-items-center
    %h1.mb-0.me-2
      Seats
    .d-flex.align-items-center
      - if policy(Seat).create?
        = link_to new_organization_seat_path(organization), class: "btn btn-primary ml-2" do
          %i.bi.bi-plus
      - else
        .btn.btn-primary.disabled{style: "opacity: 0.6; cursor: not-allowed;"}
          %i.bi.bi-plus
        %i.bi.bi-exclamation-triangle.text-warning.ms-2{"data-bs-toggle" => "tooltip", "data-bs-title" => "You need MAAP management permissions for this organization to create seats"}
- content_for :header_action do
  - customize_params = params.except(:controller, :action, :page).permit!.to_h
  = link_to customize_view_organization_seats_path(organization, customize_params), class: "btn btn-outline-secondary" do
    %i.bi.bi-sliders.me-2
    Customize View

-# Authorization Debug Section
- if params[:debug] == 'true' && @debug_data
  .alert.alert-secondary.mt-3
    %h5.mb-3
      %i.bi.bi-bug.me-2
      Authorization Debug
    .row
      .col-md-6
        %strong Logged-in Teammate:
        %br
        - if @debug_data[:viewing_teammate]
          - teammate_info = @debug_data[:viewing_teammate]
          ID: #{teammate_info[:id]}
          %br
          Type: #{teammate_info[:type]}
          %br
          Person: #{teammate_info[:person_name]} (ID: #{teammate_info[:person_id]})
          %br
          Organization: #{teammate_info[:organization_name]} (ID: #{teammate_info[:organization_id]})
          %br
          - if teammate_info[:og_admin]
            %span.badge.bg-danger Admin
        - else
          %span.text-muted Not logged in
      .col-md-6
        %strong Policy Information:
        %br
        Policy Class: #{@debug_data[:policy_class]}
        %br
        Policy Record: #{@debug_data[:policy_record].class.name} (new instance)
        %br
        Policy Action: #{@debug_data[:policy_action]}
    - if @debug_data[:viewing_teammate]
      %hr
      %strong Authorization Fields (from viewing_teammate):
      %br
      %small.text-muted
        Viewing Teammate ID: 
        %strong= @debug_data[:viewing_teammate][:id]
        |  - These values control whether the user can create seats. Seat creation requires can_manage_maap to be true.
      .row.mt-2
        - teammate_info = @debug_data[:viewing_teammate]
        - auth_fields = teammate_info[:authorization_fields]
        .col-md-4
          .card.border{class: auth_fields[:can_manage_maap][:method_result] ? 'border-success' : 'border-secondary'}
            .card-body.p-2
              %strong.text-primary can_manage_maap
              %br
              %small
                Raw DB Value: 
                - if auth_fields[:can_manage_maap][:raw_value].nil?
                  %span.text-muted nil
                - elsif auth_fields[:can_manage_maap][:raw_value]
                  %span.text-success true
                - else
                  %span.text-danger false
              %br
              %small
                Method Result: 
                - if auth_fields[:can_manage_maap][:method_result]
                  %span.text-success.badge.bg-success true (REQUIRED for seat creation)
                - else
                  %span.text-danger.badge.bg-danger false (BLOCKS seat creation)
        .col-md-4
          .card.border.border-secondary
            .card-body.p-2
              %strong can_manage_employment
              %br
              %small
                Raw DB Value: 
                - if auth_fields[:can_manage_employment][:raw_value].nil?
                  %span.text-muted nil
                - elsif auth_fields[:can_manage_employment][:raw_value]
                  %span.text-success true
                - else
                  %span.text-danger false
              %br
              %small
                Method Result: 
                - if auth_fields[:can_manage_employment][:method_result]
                  %span.text-success.badge.bg-success true
                - else
                  %span.text-muted.badge.bg-secondary false
        .col-md-4
          .card.border.border-secondary
            .card-body.p-2
              %strong can_create_employment
              %br
              %small
                Raw DB Value: 
                - if auth_fields[:can_create_employment][:raw_value].nil?
                  %span.text-muted nil
                - elsif auth_fields[:can_create_employment][:raw_value]
                  %span.text-success true
                - else
                  %span.text-danger false
              %br
              %small
                Method Result: 
                - if auth_fields[:can_create_employment][:method_result]
                  %span.text-success.badge.bg-success true
                - else
                  %span.text-muted.badge.bg-secondary false
    %hr
    %strong Policy Conditions Breakdown (create? method):
    %br
    %small.text-muted Each condition is checked in order. The first true condition grants access.
    .mt-2
      - conditions = @debug_data[:conditions]
      -# Condition 1: admin_bypass?
      - admin_bypass = conditions[:admin_bypass]
      .mb-2
        - if admin_bypass[:result]
          %span.text-success
            %i.bi.bi-check-circle-fill.me-1
        - else
          %span.text-muted
            %i.bi.bi-circle.me-1
        %code= admin_bypass[:description]
        - if admin_bypass[:result]
          %span.text-success (PASS - Admin bypass granted)
        - else
          %span.text-muted (FAIL - #{admin_bypass[:details]})
      -# Condition 2: viewing_teammate present
      - viewing_teammate_present = conditions[:viewing_teammate_present]
      .mb-2
        - if viewing_teammate_present[:result]
          %span.text-success
            %i.bi.bi-check-circle-fill.me-1
        - else
          %span.text-danger
            %i.bi.bi-x-circle-fill.me-1
        %code= viewing_teammate_present[:description]
        - if viewing_teammate_present[:result]
          %span.text-success (PASS - #{viewing_teammate_present[:details]})
        - else
          %span.text-danger (FAIL - #{viewing_teammate_present[:details]})
      -# Condition 3: actual_organization present
      - actual_org_present = conditions[:actual_organization_present]
      .mb-2
        - if actual_org_present[:result]
          %span.text-success
            %i.bi.bi-check-circle-fill.me-1
        - else
          %span.text-danger
            %i.bi.bi-x-circle-fill.me-1
        %code= actual_org_present[:description]
        - if actual_org_present[:result]
          %span.text-success (PASS - #{actual_org_present[:details]})
        - else
          %span.text-danger (FAIL - #{actual_org_present[:details]})
      -# Condition 4: organization matches route
      - org_matches = conditions[:organization_matches]
      .mb-2
        - if org_matches[:result]
          %span.text-success
            %i.bi.bi-check-circle-fill.me-1
        - else
          %span.text-warning
            %i.bi.bi-exclamation-triangle-fill.me-1
        %code= org_matches[:description]
        - if org_matches[:result]
          %span.text-success (PASS - #{org_matches[:details]})
        - else
          %span.text-warning (WARNING - #{org_matches[:details]})
      -# Condition 5: can_manage_maap
      - can_manage_maap = conditions[:can_manage_maap]
      - if can_manage_maap[:result] != nil
        .mb-2
          - if can_manage_maap[:result]
            %span.text-success
              %i.bi.bi-check-circle-fill.me-1
          - else
            %span.text-muted
              %i.bi.bi-circle.me-1
          %code= can_manage_maap[:description]
          - if can_manage_maap[:result]
            %span.text-success (PASS - #{can_manage_maap[:details]})
          - else
            %span.text-muted (FAIL - #{can_manage_maap[:details]})
    %hr
    %strong Final Result:
    - final_result = @debug_data[:final_result]
    - if final_result
      %span.badge.bg-success.fs-6
        %i.bi.bi-check-circle-fill.me-1
        #{@debug_data[:policy_action]} = TRUE (Access Granted)
    - else
      %span.badge.bg-danger.fs-6
        %i.bi.bi-x-circle-fill.me-1
        #{@debug_data[:policy_action]} = FALSE (Access Denied)

/ Spotlight Section - Employee Seats
.row.justify-content-center.mb-4
  .col-lg-12
    .card.border-0.shadow-sm
      .card-body
        .row
          .col-md-8
            / Main statistics/metrics area
            .row.text-center
              .col-3
                .h3.text-primary= @spotlight_stats[:employees][:total]
                %small.text-muted Total Active Employees
              .col-3
                .h3.text-success= @spotlight_stats[:employees][:with_seats]
                %small.text-muted With Seats
              .col-3
                .h3.text-warning= @spotlight_stats[:employees][:without_seats]
                %small.text-muted Without Seats
              .col-3
                - if @spotlight_stats[:employees][:without_seats] > 0
                  - if policy(Seat).create?
                    = button_to create_missing_employee_seats_organization_seats_path(organization), method: :post, class: "btn btn-primary btn-sm", data: { confirm: "Create seats for #{@spotlight_stats[:employees][:without_seats]} employee(s) without seats?" } do
                      %i.bi.bi-plus-circle.me-2
                      Create Missing Seats
                  - else
                    .d-flex.align-items-center.justify-content-center
                      .btn.btn-primary.btn-sm.disabled{style: "opacity: 0.6; cursor: not-allowed;"}
                        %i.bi.bi-plus-circle.me-2
                        Create Missing Seats
                      %i.bi.bi-exclamation-triangle.text-warning.ms-2{"data-bs-toggle" => "tooltip", "data-bs-title" => "You need MAAP management permissions for this organization to create seats"}
                - else
                  .h3.text-success= "✓"
                  %small.text-muted All Covered
          
          .col-md-4
            / Action alerts or status messages
            - if @spotlight_stats[:employees][:without_seats] > 0
              .alert.alert-warning.small
                %i.bi.bi-exclamation-triangle.me-2
                %strong #{@spotlight_stats[:employees][:without_seats]} employee#{'s' if @spotlight_stats[:employees][:without_seats] != 1} #{'does' if @spotlight_stats[:employees][:without_seats] == 1} #{'do' if @spotlight_stats[:employees][:without_seats] != 1} not have a seat assigned
            - else
              .alert.alert-success.small
                %i.bi.bi-check-circle.me-2
                %strong All active employees have seats assigned

/ Spotlight Section - Position Type Seats
.row.justify-content-center.mb-4
  .col-lg-12
    .card.border-0.shadow-sm
      .card-body
        .row
          .col-md-8
            / Main statistics/metrics area
            .row.text-center
              .col-3
                .h3.text-primary= @spotlight_stats[:position_types][:total]
                %small.text-muted Total Position Types
              .col-3
                .h3.text-success= @spotlight_stats[:position_types][:with_seats]
                %small.text-muted With Seats
              .col-3
                .h3.text-warning= @spotlight_stats[:position_types][:without_seats]
                %small.text-muted Without Seats
              .col-3
                - if @spotlight_stats[:position_types][:without_seats] > 0
                  - if policy(Seat).create?
                    = button_to create_missing_position_type_seats_organization_seats_path(organization), method: :post, class: "btn btn-primary btn-sm", data: { confirm: "Create seats for #{@spotlight_stats[:position_types][:without_seats]} position type(s) without seats?" } do
                      %i.bi.bi-plus-circle.me-2
                      Create Missing Seats
                  - else
                    .d-flex.align-items-center.justify-content-center
                      .btn.btn-primary.btn-sm.disabled{style: "opacity: 0.6; cursor: not-allowed;"}
                        %i.bi.bi-plus-circle.me-2
                        Create Missing Seats
                      %i.bi.bi-exclamation-triangle.text-warning.ms-2{"data-bs-toggle" => "tooltip", "data-bs-title" => "You need MAAP management permissions for this organization to create seats"}
                - else
                  .h3.text-success= "✓"
                  %small.text-muted All Covered
          
          .col-md-4
            / Action alerts or status messages
            - if @spotlight_stats[:position_types][:without_seats] > 0
              .alert.alert-warning.small
                %i.bi.bi-exclamation-triangle.me-2
                %strong #{@spotlight_stats[:position_types][:without_seats]} position type#{'s' if @spotlight_stats[:position_types][:without_seats] != 1} #{'does' if @spotlight_stats[:position_types][:without_seats] == 1} #{'do' if @spotlight_stats[:position_types][:without_seats] != 1} not have any seats
            - else
              .alert.alert-success.small
                %i.bi.bi-check-circle.me-2
                %strong All position types have at least one seat

/ Main Content Area
.row.justify-content-center
  .col-lg-12
    - if @current_view == 'seat_hierarchy'
      = render 'organizations/seats/displays/seat_hierarchy'
    - elsif @current_view == 'seat_maap_health'
      = render 'organizations/seats/displays/seat_maap_health'
    - elsif @current_view == 'table_with_employee'
      = render 'organizations/seats/displays/table_with_employee'
    - else
      = render 'organizations/seats/displays/table'
