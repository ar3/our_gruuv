- content_for :go_back_link do
  = link_to organization_company_teammate_check_ins_path(@organization, @teammate), class: "go-back-link" do
    %i.bi.bi-arrow-left.me-2
    Back to Check-ins

- content_for :header do
  .d-flex.justify-content-between.align-items-center
    %h1.mb-0=#{@teammate.person.last_first_display_name} - Position Details

- content_for :header_action do
  = render 'people/view_switcher'

-# Authorization Debug Section
- if params[:debug] == 'true' && @debug_data
  .alert.alert-secondary.mt-3
    %h5.mb-3
      %i.bi.bi-bug.me-2
      Authorization Debug
    .row
      .col-md-6
        %strong Logged-in Teammate:
        %br
        - if current_company_teammate
          - teammate = current_company_teammate
          ID: #{teammate.id}
          %br
          Person: #{teammate.person.display_name} (ID: #{teammate.person.id})
          %br
          Organization: #{teammate.organization.name} (ID: #{teammate.organization.id})
          %br
          - if teammate.person.og_admin?
            %span.badge.bg-danger Admin
        - else
          %span.text-muted Not logged in
      .col-md-6
        %strong Policy Information:
        %br
        Policy Class: #{@debug_data[:policy_class]}
        %br
        Policy Record: #{@debug_data[:policy_record].display_name} (ID: #{@debug_data[:policy_record].id})
        %br
        Policy Action: #{@debug_data[:policy_action]}
    %hr
    %strong Policy Conditions Breakdown (audit? method):
    %br
    %small.text-muted Each condition is checked in order. The first true condition grants access.
    .mt-2
      - conditions = @debug_data[:conditions]
      -# Condition 1: admin_bypass?
      - admin_bypass = conditions[:admin_bypass]
      .mb-2
        - if admin_bypass[:result]
          %span.text-success
            %i.bi.bi-check-circle-fill.me-1
        - else
          %span.text-muted
            %i.bi.bi-circle.me-1
        %code= admin_bypass[:description]
        - if admin_bypass[:result]
          %span.text-success (PASS - Admin bypass granted)
        - else
          %span.text-muted (FAIL - #{admin_bypass[:details]})
      -# Condition 2: viewing_teammate && record
      - both_exist = conditions[:viewing_teammate_and_record]
      .mb-2
        - if both_exist[:result]
          %span.text-success
            %i.bi.bi-check-circle-fill.me-1
        - else
          %span.text-danger
            %i.bi.bi-x-circle-fill.me-1
        %code= both_exist[:description]
        - if both_exist[:result]
          %span.text-success (PASS)
        - else
          %span.text-danger (FAIL - #{both_exist[:details]})
      -# Condition 3: viewing_teammate.terminated?
      - not_terminated = conditions[:not_terminated]
      - if not_terminated[:result] != nil
        .mb-2
          - if not_terminated[:result]
            %span.text-success
              %i.bi.bi-check-circle-fill.me-1
          - else
            %span.text-danger
              %i.bi.bi-x-circle-fill.me-1
          %code= not_terminated[:description]
          - if not_terminated[:result]
            %span.text-success (PASS - #{not_terminated[:details]})
          - else
            %span.text-danger (FAIL - #{not_terminated[:details]})
      -# Condition 4: viewing_teammate.person == record
      - own_profile = conditions[:own_profile]
      - if own_profile[:result] != nil
        .mb-2
          - if own_profile[:result]
            %span.text-success
              %i.bi.bi-check-circle-fill.me-1
          - else
            %span.text-muted
              %i.bi.bi-circle.me-1
          %code= own_profile[:description]
          - if own_profile[:result]
            %span.text-success (PASS - #{own_profile[:details]})
          - else
            %span.text-muted (FAIL - #{own_profile[:details]})
      -# Condition 5: viewing_teammate.can_manage_employment?
      - can_manage = conditions[:can_manage_employment]
      - if can_manage[:result] != nil
        .mb-2
          - if can_manage[:result]
            %span.text-success
              %i.bi.bi-check-circle-fill.me-1
          - else
            %span.text-muted
              %i.bi.bi-circle.me-1
          %code= can_manage[:description]
          - if can_manage[:result]
            %span.text-success (PASS - #{can_manage[:details]})
          - else
            %span.text-muted (FAIL - #{can_manage[:details]})
      -# Condition 6: viewing_teammate.person.in_managerial_hierarchy_of?(record, viewing_teammate.organization)
      - in_hierarchy = conditions[:in_managerial_hierarchy]
      - if in_hierarchy[:result] != nil
        .mb-2
          - if in_hierarchy[:result]
            %span.text-success
              %i.bi.bi-check-circle-fill.me-1
          - else
            %span.text-muted
              %i.bi.bi-circle.me-1
          %code= in_hierarchy[:description]
          - if in_hierarchy[:result]
            %span.text-success (PASS - #{in_hierarchy[:details]})
          - else
            %span.text-muted (FAIL - #{in_hierarchy[:details]})
    %hr
    %strong Final Result:
    - final_result = @debug_data[:final_result]
    - if final_result
      %span.badge.bg-success.fs-6
        %i.bi.bi-check-circle-fill.me-1
        #{@debug_data[:policy_action]} = TRUE (Access Granted)
    - else
      %span.badge.bg-danger.fs-6
        %i.bi.bi-x-circle-fill.me-1
        #{@debug_data[:policy_action]} = FALSE (Access Denied)

.row.justify-content-center
  .col-lg-12
    / Position Details Section
    - if @current_employment
      .card.mb-4
        .card-header
          %h5.mb-0 Current Position
        .card-body
          %p.mb-0
            %strong= @current_employment.position.display_name
            - if @current_employment.manager
              %br
              %small.text-muted Manager: #{@current_employment.manager.display_name}
          
          / Inline Edit Form
          - can_manage = policy(@teammate).update?
          = form_with model: @form, url: organization_teammate_position_path(@organization, @teammate), local: true, method: :patch do |form|
            - if @form.errors.any?
              .alert.alert-danger.mt-3
                %h6 Please fix the following errors:
                %ul.mb-0
                  - @form.errors.full_messages.each do |message|
                    %li= message
            
            .row.mt-3
              .col-md-6
                = render 'shared/forms/manager_field', form: form, managers: @managers, disabled: !can_manage
              
              .col-md-6
                = render 'shared/forms/position_field', form: form, positions: @positions, disabled: !can_manage
            
            .row
              .col-md-6
                .mb-3
                  = form.label :employment_type, "Employment Type", class: "form-label"
                  = form.select :employment_type, options_for_select([['Full Time', 'full_time'], ['Part Time', 'part_time'], ['Contract', 'contract'], ['Contractor', 'contractor'], ['Intern', 'intern'], ['Temporary', 'temporary'], ['Consultant', 'consultant'], ['Freelance', 'freelance']], form.object.employment_type), { prompt: 'Select employment type' }, { class: "form-select", disabled: !can_manage }
              
              .col-md-6
                = render 'shared/forms/seat_field', form: form, seats: @seats, disabled: !can_manage
            
            .row
              .col-md-6
                .mb-3
                  = form.label :termination_date, "Termination Date (Optional)", class: "form-label"
                  = form.date_field :termination_date, class: "form-control", disabled: !can_manage
              
              .col-md-6
                .mb-3
                  = form.label :reason, "Reason (Optional)", class: "form-label"
                  = form.text_area :reason, class: "form-control", rows: 2, disabled: !can_manage
                  %small.form-text.text-muted Only saved when a major change is made (manager, position, employment type, or termination date)
            
            .d-flex.justify-content-end.gap-2.mt-4
              - if can_manage
                = form.submit "Update Position", class: "btn btn-primary"
              - else
                .d-flex.align-items-center.gap-2
                  .flex-grow-1
                    = form.submit "Update Position", class: "btn btn-outline-secondary", disabled: true
                  %i.bi.bi-exclamation-triangle.text-warning{data: {bs_toggle: "tooltip", bs_title: "You need employment management permission to update position information"}}

    / Employment Tenures Table
    .card.mb-4
      .card-header
        %h5.mb-0 Employment Tenures
        %small.text-muted Complete history of employment tenures
      .card-body
        - if @employment_tenures.any?
          .table-responsive
            %table.table.table-hover
              %thead.table-light
                %tr
                  %th Started
                  %th Ended
                  %th Position
                  %th Manager
                  %th Employment Type
                  %th Seat
                  %th Status
              %tbody
                - @employment_tenures.each do |tenure|
                  %tr{class: tenure.active? ? 'table-success' : ''}
                    %td
                      %strong= tenure.started_at.strftime('%B %d, %Y')
                      %br
                      %small.text-muted= tenure.started_at.strftime('%I:%M %p')
                    %td
                      - if tenure.ended_at
                        %strong= tenure.ended_at.strftime('%B %d, %Y')
                        %br
                        %small.text-muted= tenure.ended_at.strftime('%I:%M %p')
                      - else
                        %span.text-muted —
                    %td= tenure.position.display_name
                    %td
                      - if tenure.manager
                        = tenure.manager.display_name
                      - else
                        %span.text-muted —
                    %td
                      - if tenure.employment_type
                        = tenure.employment_type.humanize
                      - else
                        %span.text-muted —
                    %td
                      - if tenure.seat
                        = tenure.seat.display_name
                      - else
                        %span.text-muted —
                    %td
                      - if tenure.active?
                        %span.badge.bg-success Active
                      - else
                        %span.badge.bg-secondary Inactive
        - else
          .alert.alert-info.text-center
            %h6.mb-2
              %i.bi.bi-info-circle.me-2
              No Employment Tenures Found
            %p.mb-0 No employment tenures have been recorded yet.

    / Check-in History Table
    .card.mb-4
      .card-header
        %h5.mb-0 All Position Check-ins
        %small.text-muted Complete history of position check-ins across all employment tenures
      .card-body
        - if @check_ins.any?
          .table-responsive
            %table.table.table-hover
              %thead.table-light
                %tr
                  %th Started
                  %th Employee Completion
                  %th Manager Completion
                  %th Finalization
                  %th Status
                  %th Actions
              %tbody
                - @check_ins.each do |check_in|
                  %tr{class: check_in.officially_completed? ? 'table-success' : check_in.ready_for_finalization? ? 'table-warning' : ''}
                    %td
                      %strong= check_in.check_in_started_on.strftime('%B %d, %Y')
                      %br
                      %small.text-muted= check_in.check_in_started_on.strftime('%I:%M %p')
                    
                    %td
                      - if check_in.employee_completed?
                        %span.badge.bg-success.me-1 ✓ Complete
                        %br
                        %small.text-muted= check_in.employee_completed_at.strftime('%m/%d/%Y %I:%M %p')
                      - else
                        %span.badge.bg-warning Pending
                    
                    %td
                      - if check_in.manager_completed?
                        %span.badge.bg-success.me-1 ✓ Complete
                        %br
                        %small.text-muted= check_in.manager_completed_at.strftime('%m/%d/%Y %I:%M %p')
                        - if check_in.manager_completed_by
                          %br
                          %small.text-muted by #{check_in.manager_completed_by.display_name}
                      - else
                        %span.badge.bg-warning Pending
                    
                    %td
                      - if check_in.officially_completed?
                        %span.badge.bg-primary.me-1 ✓ Finalized
                        %br
                        %small.text-muted= check_in.official_check_in_completed_at.strftime('%m/%d/%Y %I:%M %p')
                        - if check_in.finalized_by
                          %br
                          %small.text-muted by #{check_in.finalized_by.display_name}
                        %br
                        %small.text-muted Rating: #{position_rating_display(check_in.official_rating)}
                      - elsif check_in.ready_for_finalization?
                        %span.badge.bg-warning Ready for Finalization
                      - else
                        %span.badge.bg-secondary In Progress
                    
                    %td
                      - if check_in.officially_completed?
                        %span.badge.bg-success Closed
                      - elsif check_in.ready_for_finalization?
                        %span.badge.bg-warning Ready to Finalize
                      - else
                        %span.badge.bg-info Open
                    
                    %td
                      - if check_in.officially_completed?
                        = link_to "View Details", "#", class: "btn btn-sm btn-outline-primary", "data-bs-toggle" => "modal", "data-bs-target" => "#checkInModal#{check_in.id}"
                      - elsif check_in.ready_for_finalization?
                        = link_to "Finalize", organization_company_teammate_check_ins_path(@organization, @teammate), class: "btn btn-sm btn-warning"
                      - else
                        = link_to "Continue", organization_company_teammate_check_ins_path(@organization, @teammate), class: "btn btn-sm btn-primary"

          - @check_ins.each do |check_in|
            / Modal for each check-in
            .modal.fade{id: "checkInModal#{check_in.id}", "aria-hidden" => "true", "aria-labelledby" => "checkInModalLabel#{check_in.id}", tabindex: "-1"}
              .modal-dialog.modal-lg
                .modal-content
                  .modal-header
                    %h5.modal-title{id: "checkInModalLabel#{check_in.id}"}
                      Check-in Details - #{check_in.check_in_started_on.strftime('%B %d, %Y')}
                    %button.btn-close{"aria-label" => "Close", "data-bs-dismiss" => "modal", type: "button"}
                  .modal-body
                    .row
                      .col-md-6
                        %h6 Employee Responses
                        .mb-3
                          %label.form-label Employee Rating
                          .form-control-plaintext= position_rating_display(check_in.employee_rating)
                        .mb-3
                          %label.form-label Private Notes
                          .form-control-plaintext= check_in.employee_private_notes || 'No notes'
                      
                      .col-md-6
                        %h6 Manager Responses
                        .mb-3
                          %label.form-label Manager Rating
                          .form-control-plaintext= position_rating_display(check_in.manager_rating)
                        .mb-3
                          %label.form-label Manager Private Notes
                          .form-control-plaintext= check_in.manager_private_notes || 'No notes'
                        
                        - if check_in.officially_completed?
                          %hr
                          %h6 Finalization
                          .mb-3
                            %label.form-label Final Rating
                            .form-control-plaintext= position_rating_display(check_in.official_rating)
                          .mb-3
                            %label.form-label Shared Notes
                            .form-control-plaintext= check_in.shared_notes || 'No shared notes'
                  .modal-footer
                    %button.btn.btn-secondary{"data-bs-dismiss" => "modal", type: "button"} Close
        - else
          .alert.alert-info.text-center
            %h6.mb-2
              %i.bi.bi-info-circle.me-2
              No Check-ins Found
            %p.mb-0 No position check-ins have been created yet.
            = link_to "Start First Check-in", organization_company_teammate_check_ins_path(@organization, @teammate), class: "btn btn-primary btn-sm mt-2"

    / Current Check-in Form (if open check-in exists)
    - if @open_check_in
      .card
        .card-header
          %h5.mb-0 Current Check-in
        .card-body
          %p.text-muted Use the main check-ins page to complete your position check-in.

