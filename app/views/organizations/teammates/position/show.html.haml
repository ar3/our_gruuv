- content_for :go_back_link do
  = link_to organization_person_check_ins_path(@organization, @teammate.person), class: "go-back-link" do
    %i.bi.bi-arrow-left.me-2
    Back to Check-ins

- content_for :header do
  .d-flex.justify-content-between.align-items-center
    %h1.mb-0 Position Check-ins
    %small.text-muted #{@teammate.person.display_name}

.row.justify-content-center
  .col-lg-12
    / Position Details Section
    - if @current_employment
      .card.mb-4
        .card-header
          %h5.mb-0 Current Position
        .card-body
          %p.mb-0
            %strong= @current_employment.position.display_name
            - if @current_employment.manager
              %br
              %small.text-muted Manager: #{@current_employment.manager.display_name}
          
          / Inline Edit Form
          - can_manage = current_person&.can_manage_employment?(@organization)
          = form_with model: @form, url: organization_teammate_position_path(@organization, @teammate), local: true, method: :patch do |form|
            - if @form.errors.any?
              .alert.alert-danger.mt-3
                %h6 Please fix the following errors:
                %ul.mb-0
                  - @form.errors.full_messages.each do |message|
                    %li= message
            
            .row.mt-3
              .col-md-6
                = render 'shared/forms/manager_field', form: form, managers: @managers, disabled: !can_manage
              
              .col-md-6
                = render 'shared/forms/position_field', form: form, positions: @positions, disabled: !can_manage
            
            .row
              .col-md-6
                .mb-3
                  = form.label :employment_type, "Employment Type", class: "form-label"
                  = form.select :employment_type, options_for_select([['Full Time', 'full_time'], ['Part Time', 'part_time'], ['Contract', 'contract'], ['Contractor', 'contractor'], ['Intern', 'intern'], ['Temporary', 'temporary'], ['Consultant', 'consultant'], ['Freelance', 'freelance']], form.object.employment_type), { prompt: 'Select employment type' }, { class: "form-select", disabled: !can_manage }
              
              .col-md-6
                = render 'shared/forms/seat_field', form: form, seats: @seats, disabled: !can_manage
            
            .row
              .col-md-6
                .mb-3
                  = form.label :termination_date, "Termination Date (Optional)", class: "form-label"
                  = form.date_field :termination_date, class: "form-control", disabled: !can_manage
              
              .col-md-6
                .mb-3
                  = form.label :reason, "Reason (Optional)", class: "form-label"
                  = form.text_area :reason, class: "form-control", rows: 2, disabled: !can_manage
                  %small.form-text.text-muted Only saved when a major change is made (manager, position, employment type, or termination date)
            
            .d-flex.justify-content-end.gap-2.mt-4
              - if can_manage
                = form.submit "Update Position", class: "btn btn-primary"
              - else
                .d-flex.align-items-center.gap-2
                  .flex-grow-1
                    = form.submit "Update Position", class: "btn btn-outline-secondary", disabled: true
                  %i.bi.bi-exclamation-triangle.text-warning{data: {bs_toggle: "tooltip", bs_title: "You need employment management permission to update position information"}}

    / Check-in History Table
    .card.mb-4
      .card-header
        %h5.mb-0 All Position Check-ins
        %small.text-muted Complete history of position check-ins across all employment tenures
      .card-body
        - if @check_ins.any?
          .table-responsive
            %table.table.table-hover
              %thead.table-light
                %tr
                  %th Started
                  %th Employee Completion
                  %th Manager Completion
                  %th Finalization
                  %th Status
                  %th Actions
              %tbody
                - @check_ins.each do |check_in|
                  %tr{class: check_in.officially_completed? ? 'table-success' : check_in.ready_for_finalization? ? 'table-warning' : ''}
                    %td
                      %strong= check_in.check_in_started_on.strftime('%B %d, %Y')
                      %br
                      %small.text-muted= check_in.check_in_started_on.strftime('%I:%M %p')
                    
                    %td
                      - if check_in.employee_completed?
                        %span.badge.bg-success.me-1 ✓ Complete
                        %br
                        %small.text-muted= check_in.employee_completed_at.strftime('%m/%d/%Y %I:%M %p')
                      - else
                        %span.badge.bg-warning Pending
                    
                    %td
                      - if check_in.manager_completed?
                        %span.badge.bg-success.me-1 ✓ Complete
                        %br
                        %small.text-muted= check_in.manager_completed_at.strftime('%m/%d/%Y %I:%M %p')
                        - if check_in.manager_completed_by
                          %br
                          %small.text-muted by #{check_in.manager_completed_by.display_name}
                      - else
                        %span.badge.bg-warning Pending
                    
                    %td
                      - if check_in.officially_completed?
                        %span.badge.bg-primary.me-1 ✓ Finalized
                        %br
                        %small.text-muted= check_in.official_check_in_completed_at.strftime('%m/%d/%Y %I:%M %p')
                        - if check_in.finalized_by
                          %br
                          %small.text-muted by #{check_in.finalized_by.display_name}
                        %br
                        %small.text-muted Rating: #{position_rating_display(check_in.official_rating)}
                      - elsif check_in.ready_for_finalization?
                        %span.badge.bg-warning Ready for Finalization
                      - else
                        %span.badge.bg-secondary In Progress
                    
                    %td
                      - if check_in.officially_completed?
                        %span.badge.bg-success Closed
                      - elsif check_in.ready_for_finalization?
                        %span.badge.bg-warning Ready to Finalize
                      - else
                        %span.badge.bg-info Open
                    
                    %td
                      - if check_in.officially_completed?
                        = link_to "View Details", "#", class: "btn btn-sm btn-outline-primary", "data-bs-toggle" => "modal", "data-bs-target" => "#checkInModal#{check_in.id}"
                      - elsif check_in.ready_for_finalization?
                        = link_to "Finalize", organization_person_check_ins_path(@organization, @teammate.person), class: "btn btn-sm btn-warning"
                      - else
                        = link_to "Continue", organization_person_check_ins_path(@organization, @teammate.person), class: "btn btn-sm btn-primary"

          - @check_ins.each do |check_in|
            / Modal for each check-in
            .modal.fade{id: "checkInModal#{check_in.id}", "aria-hidden" => "true", "aria-labelledby" => "checkInModalLabel#{check_in.id}", tabindex: "-1"}
              .modal-dialog.modal-lg
                .modal-content
                  .modal-header
                    %h5.modal-title{id: "checkInModalLabel#{check_in.id}"}
                      Check-in Details - #{check_in.check_in_started_on.strftime('%B %d, %Y')}
                    %button.btn-close{"aria-label" => "Close", "data-bs-dismiss" => "modal", type: "button"}
                  .modal-body
                    .row
                      .col-md-6
                        %h6 Employee Responses
                        .mb-3
                          %label.form-label Employee Rating
                          .form-control-plaintext= position_rating_display(check_in.employee_rating)
                        .mb-3
                          %label.form-label Private Notes
                          .form-control-plaintext= check_in.employee_private_notes || 'No notes'
                      
                      .col-md-6
                        %h6 Manager Responses
                        .mb-3
                          %label.form-label Manager Rating
                          .form-control-plaintext= position_rating_display(check_in.manager_rating)
                        .mb-3
                          %label.form-label Manager Private Notes
                          .form-control-plaintext= check_in.manager_private_notes || 'No notes'
                        
                        - if check_in.officially_completed?
                          %hr
                          %h6 Finalization
                          .mb-3
                            %label.form-label Final Rating
                            .form-control-plaintext= position_rating_display(check_in.official_rating)
                          .mb-3
                            %label.form-label Shared Notes
                            .form-control-plaintext= check_in.shared_notes || 'No shared notes'
                  .modal-footer
                    %button.btn.btn-secondary{"data-bs-dismiss" => "modal", type: "button"} Close
        - else
          .alert.alert-info.text-center
            %h6.mb-2
              %i.bi.bi-info-circle.me-2
              No Check-ins Found
            %p.mb-0 No position check-ins have been created yet.
            = link_to "Start First Check-in", organization_person_check_ins_path(@organization, @teammate.person), class: "btn btn-primary btn-sm mt-2"

    / Current Check-in Form (if open check-in exists)
    - if @open_check_in
      .card
        .card-header
          %h5.mb-0 Current Check-in
        .card-body
          %p.text-muted Use the main check-ins page to complete your position check-in.

