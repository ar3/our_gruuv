- content_for :title, @huddle_playbook.display_name

.container-fluid
  .row
    .col-12
      .d-flex.justify-content-between.align-items-center.mb-4
        %h1.mb-0= @huddle_playbook.display_name
        .d-flex.gap-2
          = link_to organization_path(@organization), class: "btn btn-outline-primary" do
            %i.bi.bi-building.me-2
            Back to Organization
          = link_to organization_huddle_playbooks_path(@organization), class: "btn btn-outline-secondary" do
            %i.bi.bi-arrow-left.me-2
            Back to Playbooks
      
      / Playbook Details Card
      .card.mb-4
        .card-header
          %h5.mb-0 Playbook Details
        .card-body
          .row
            .col-md-6
              %dl.row
                %dt.col-sm-4 Playbook Name
                %dd.col-sm-8= @huddle_playbook.display_name
                - if @huddle_playbook.special_session_name.present?
                  %dt.col-sm-4 Special Session
                  %dd.col-sm-8= @huddle_playbook.special_session_name
                %dt.col-sm-4 Organization
                %dd.col-sm-8= @huddle_playbook.organization.display_name
                - if @huddle_playbook.slack_channel.present?
                  %dt.col-sm-4 Slack Channel
                  %dd.col-sm-8= @huddle_playbook.slack_channel
            .col-md-6
              %dl.row
                %dt.col-sm-4 Total Huddles
                %dd.col-sm-8= @huddles.count
                %dt.col-sm-4 Created
                %dd.col-sm-8= format_date_in_user_timezone(@huddle_playbook.created_at)
                %dt.col-sm-4 Last Updated
                %dd.col-sm-8= format_date_in_user_timezone(@huddle_playbook.updated_at)
      
      / Actions
      .row.mb-4
        .col-12
          .d-grid.gap-2.d-md-flex
            = link_to edit_organization_huddle_playbook_path(@organization, @huddle_playbook), class: "btn btn-primary" do
              %i.bi.bi-pencil.me-2
              Edit Playbook
            = link_to new_huddle_path(huddle_playbook_id: @huddle_playbook.id), class: "btn btn-success" do
              %i.bi.bi-plus-circle.me-2
              Start New Huddle
      
      / Huddles List
      .card
        .card-header
          %h5.mb-0 Recent Huddles
        .card-body
          - if @huddles.any?
            .table-responsive
              %table.table.table-striped
                %thead
                  %tr
                    %th Date
                    %th Participants
                    %th Feedbacks
                    %th Avg Rating
                    %th Actions
                %tbody
                  - @huddles.each do |huddle|
                    %tr
                      %td= format_time_in_user_timezone(huddle.started_at)
                      %td
                        - participant_count = huddle.huddle_participants.count
                        - participant_names = huddle.huddle_participants.includes(teammate: :person).map { |hp| hp.teammate.person.full_name }.join(", ")
                        - if participant_names.present?
                          %span{title: participant_names, data: {bs_toggle: "tooltip", bs_placement: "top"}, style: "cursor: pointer"}
                            = participant_count
                            %i.bi.bi-info-circle.text-muted.ms-1{style: "font-size: 0.8em"}
                        - else
                          = participant_count
                      %td= huddle.huddle_feedbacks.count
                      %td
                        - if huddle.huddle_feedbacks.any?
                          - avg_score = huddle.huddle_feedbacks.map(&:nat_20_score).sum.to_f / huddle.huddle_feedbacks.count
                          = avg_score.round(1)
                        - else
                          %span.text-muted No feedback
                      %td
                        = link_to huddle_path(huddle), class: "btn btn-sm btn-outline-primary" do
                          %i.bi.bi-eye.me-1
                          View
                        = link_to feedback_huddle_path(huddle), class: "btn btn-sm btn-outline-info" do
                          %i.bi.bi-chat.me-1
                          Feedback
          - else
            .text-center.py-4
              %p.text-muted No huddles have been created with this playbook yet.
              = link_to new_huddle_path(huddle_playbook_id: @huddle_playbook.id), class: "btn btn-success" do
                %i.bi.bi-plus-circle.me-2
                Start First Huddle
      
      / Participant Statistics
      - if @participant_stats.any?
        .card.mt-4
          .card-header
            %h5.mb-0 Participant Statistics
          .card-body
            .table-responsive
              %table.table.table-striped
                %thead
                  %tr
                    %th Participant
                    %th Huddles Attended
                    %th Feedbacks Given
                    %th First Huddle
                    %th Last Huddle
                %tbody
                  - @participant_stats.each do |stat|
                    %tr
                      %td= "#{stat.first_name} #{stat.last_name} (#{stat.email})"
                      %td= stat.huddle_count
                      %td= stat.feedback_count
                      %td= stat.first_huddle_date&.strftime("%B %d, %Y")
                      %td= stat.last_huddle_date&.strftime("%B %d, %Y") 