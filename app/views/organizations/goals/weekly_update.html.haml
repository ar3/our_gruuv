- content_for :title, "Weekly Update - #{@goal.title}"

- content_for :header do
  %h1.mb-0= @goal.title

- content_for :header_action do
  = render 'mode_switcher', organization: @organization, goal: @goal, current_mode: :check_in

- content_for :go_back_link do
  = link_to @return_url, class: "go-back-link" do
    %i.bi.bi-arrow-left.me-2
    = @return_text

.alert.alert-info.mb-4
  %i.bi.bi-info-circle.me-2
  Once you've updated the weekly check-in, close this page to return to #{@return_text}

/ Timeline View
.timeline-view
  / Top: Starting Date
  - if @goal.started_at.present?
    .timeline-item.mb-4
      .card.border-primary
        .card-body
          .d-flex.align-items-center
            .timeline-marker.bg-primary.text-white.rounded-circle.d-flex.align-items-center.justify-content-center.me-3{style: "width: 40px; height: 40px; min-width: 40px;"}
              %i.bi.bi-play-circle
            .flex-grow-1
              %h5.mb-1 Goal Started
              %p.mb-0.text-muted= @goal.started_at.strftime("%B %d, %Y at %I:%M %p")
  
  / Middle: Check-in History (chronological, oldest to newest)
  - if @all_check_ins.any?
    .timeline-item.mb-4
      %h5.mb-3 Check-In History
      - @all_check_ins.each do |check_in|
        .card.mb-3
          .card-body
            .d-flex.align-items-start
              .timeline-marker.bg-info.text-white.rounded-circle.d-flex.align-items-center.justify-content-center.me-3{style: "width: 40px; height: 40px; min-width: 40px;"}
                %i.bi.bi-calendar-check
              .flex-grow-1
                %h6.mb-2
                  Week of #{check_in.check_in_week_start.strftime('%B %d')} - #{check_in.check_in_week_start.end_of_week(:sunday).strftime('%B %d, %Y')}
                %p.mb-1
                  = render 'organizations/goals/goal_check_in_sentence', check_in: check_in, goal: @goal
                - if check_in.confidence_reason.present?
                  %p.mb-1
                    %strong Notes:
                    = simple_format(check_in.confidence_reason)
  
  / Current Week Form (between history and target dates)
  .timeline-item.mb-4
    .card.border-success
      .card-header.bg-success.text-white
        %h5.mb-0
          %i.bi.bi-calendar-event.me-2
          Current Week Check-In
      .card-body
        - current_week_start = @current_week_start || Date.current.beginning_of_week(:monday)
        - current_week_end = current_week_start.end_of_week(:sunday)
        
        %p.small.text-muted.mb-3
          Week of #{current_week_start.strftime('%B %d')} - #{current_week_end.strftime('%B %d, %Y')}
        
        = form_with url: check_in_organization_goal_path(@organization, @goal, return_url: @return_url, return_text: @return_text), method: :post, local: true do |f|
          .mb-3
            %p.mb-2
              As of 
              %strong= current_week_start.strftime('%B %d, %Y')
              , 
              %strong= current_person.display_name
              reports a 
              = f.select :confidence_percentage, 
                  options_for_select(confidence_percentage_options, @current_check_in&.confidence_percentage),
                  { include_blank: 'Select confidence...' },
                  { class: 'form-select d-inline-block w-auto mx-1', style: 'vertical-align: baseline;', required: true }
              confidence we will achieve 
              %strong= @goal.title
              by 
              = f.date_field :most_likely_target_date, value: @goal.most_likely_target_date, class: 'form-control d-inline-block w-auto mx-1', style: 'vertical-align: baseline;'
          
          .mb-3
            = f.label :confidence_reason, "Notes", class: "form-label"
            = f.text_area :confidence_reason, value: @current_check_in&.confidence_reason, class: 'form-control', rows: 3, placeholder: 'Optional notes...'
          
          .d-grid
            = f.submit "Save Check-In", class: "btn btn-primary"
  
  / Bottom: Target Dates
  .timeline-item.mb-4
    .card.border-secondary
      .card-header
        %h5.mb-0
          %i.bi.bi-calendar-range.me-2
          Target Dates
      .card-body
        - calculated_date = @goal.calculated_target_date
        %dl.row.mb-0
          - if @goal.earliest_target_date.present?
            %dt.col-sm-4 Earliest:
            %dd.col-sm-8= @goal.earliest_target_date.strftime("%B %d, %Y")
          - if @goal.most_likely_target_date.present?
            %dt.col-sm-4 Most Likely:
            %dd.col-sm-8= @goal.most_likely_target_date.strftime("%B %d, %Y")
          - if @goal.latest_target_date.present?
            %dt.col-sm-4 Latest:
            %dd.col-sm-8= @goal.latest_target_date.strftime("%B %d, %Y")
          - if calculated_date.nil?
            %dt.col-sm-4 Calculated Target:
            %dd.col-sm-8
              %em.text-muted No target date calculated (all dates are nil)

