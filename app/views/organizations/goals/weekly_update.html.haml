- content_for :title, "Weekly Update - #{@goal.title}"

- content_for :header do
  %h1.mb-0= @goal.title

- content_for :header_action do
  = render 'mode_switcher', organization: @organization, goal: @goal, current_mode: :check_in

- content_for :go_back_link do
  = link_to @return_url, class: "go-back-link" do
    %i.bi.bi-arrow-left.me-2
    = @return_text

/ Timeline View
.timeline-view
  / Top: Starting Date
  - if @goal.started_at.present?
    .timeline-item.mb-4
      .card.border-primary
        .card-body
          .d-flex.align-items-center
            .timeline-marker.bg-primary.text-white.rounded-circle.d-flex.align-items-center.justify-content-center.me-3{style: "width: 40px; height: 40px; min-width: 40px;"}
              %i.bi.bi-play-circle
            .flex-grow-1
              %h5.mb-1 Goal Started
              %p.mb-0.text-muted= format_time_in_user_timezone(@goal.started_at)
  
  / Middle: Check-in History (chronological, oldest to newest)
  - if @all_check_ins.any?
    .timeline-item.mb-4
      %h5.mb-3 Check-In History
      - @all_check_ins.each do |check_in|
        .card.mb-3
          .card-body
            .d-flex.align-items-start
              .timeline-marker.bg-info.text-white.rounded-circle.d-flex.align-items-center.justify-content-center.me-3{style: "width: 40px; height: 40px; min-width: 40px;"}
                %i.bi.bi-calendar-check
              .flex-grow-1
                %h6.mb-2
                  Week of #{check_in.check_in_week_start.strftime('%B %d')} - #{check_in.check_in_week_start.end_of_week(:sunday).strftime('%B %d, %Y')}
                %p.mb-1
                  = render 'organizations/goals/goal_check_in_sentence', check_in: check_in, goal: @goal
                  = render 'shared/on_track_pill', status: @goal.on_track_status_for_check_in(check_in)
                - if check_in.confidence_reason.present?
                  %p.mb-1
                    %strong Notes:
                    = simple_format(check_in.confidence_reason)
  
  / Current Week Form (between history and target dates)
  .timeline-item.mb-4
    .card.border-success
      .card-header.bg-success.text-white
        %h5.mb-0
          %i.bi.bi-calendar-event.me-2
          Current Week Check-In
      .card-body
        - current_week_start = @current_week_start || Date.current.beginning_of_week(:monday)
        - current_week_end = current_week_start.end_of_week(:sunday)
        
        %p.small.text-muted.mb-3
          Week of #{current_week_start.strftime('%B %d')} - #{current_week_end.strftime('%B %d, %Y')}
        
        = form_with url: check_in_organization_goal_path(@organization, @goal, return_url: @return_url, return_text: @return_text), method: :post, local: true do |f|
          .mb-3
            %p.mb-2
              As of 
              %strong= current_week_start.strftime('%B %d, %Y')
              , 
              %strong= current_person.display_name
              reports a 
              = f.select :confidence_percentage, 
                  options_for_select(confidence_percentage_options, @current_check_in&.confidence_percentage),
                  { include_blank: 'Select confidence...' },
                  { class: 'form-select d-inline-block w-auto mx-1', style: 'vertical-align: baseline;', required: true }
              confidence we will achieve 
              %strong= @goal.title
              by 
              = f.date_field :most_likely_target_date, value: @goal.most_likely_target_date, class: 'form-control d-inline-block w-auto mx-1', style: 'vertical-align: baseline;'
          
          .mb-3
            = f.label :confidence_reason, "Notes", class: "form-label"
            = f.text_area :confidence_reason, value: @current_check_in&.confidence_reason, class: 'form-control', rows: 3, placeholder: 'Optional notes...'
          
          .d-grid
            = f.submit "Save Check-In", class: "btn btn-primary"
  
  / Bottom: Target Dates
  .timeline-item.mb-4
    .card.border-secondary
      .card-header
        %h5.mb-0
          %i.bi.bi-calendar-range.me-2
          Target Dates
      .card-body
        - calculated_date = @goal.calculated_target_date
        %dl.row.mb-0
          - if @goal.earliest_target_date.present?
            %dt.col-sm-4 Earliest:
            %dd.col-sm-8= @goal.earliest_target_date.strftime("%B %d, %Y")
          - if @goal.most_likely_target_date.present?
            %dt.col-sm-4 Most Likely:
            %dd.col-sm-8= @goal.most_likely_target_date.strftime("%B %d, %Y")
          - if @goal.latest_target_date.present?
            %dt.col-sm-4 Latest:
            %dd.col-sm-8= @goal.latest_target_date.strftime("%B %d, %Y")
          - if calculated_date.nil?
            %dt.col-sm-4 Calculated Target:
            %dd.col-sm-8
              %em.text-muted No target date calculated (all dates are nil)

  / Progress confidence chart (thresholds + actual check-ins)
  - if @progress_chart_data.present?
    .timeline-item.mb-4
      .card.border-secondary
        .card-header
          %h5.mb-0
            %i.bi.bi-graph-up.me-2
            Confidence vs. On-Track Thresholds
        .card-body
          #goal-progress-confidence-chart{style: "height: 400px;"}
          %p.small.text-muted.mt-2.mb-0
            Colored bands show on-track zones by week. Blue points are your actual check-ins.
          - if @progress_chart_data[:thresholds_table].present?
            .mt-3
              %a.btn.btn-outline-secondary.btn-sm{"data-bs-toggle" => "collapse", "data-bs-target" => "#goal-thresholds-table-collapse", "aria-expanded" => "false", "aria-controls" => "goal-thresholds-table-collapse", href: "#"}
                %i.bi.bi-table.me-1
                Thresholds by week
              .collapse.mt-2#goal-thresholds-table-collapse
                .table-responsive
                  %table.table.table-sm.table-bordered
                    %thead
                      %tr
                        %th
                        - @progress_chart_data[:thresholds_table].each do |row|
                          %th.text-center= row[:week]
                    %tbody
                      %tr
                        %th.text-nowrap{scope: "row"}= "behind_schedule_if_confidence_below".humanize
                        - @progress_chart_data[:thresholds_table].each do |row|
                          %td.text-center= "#{row[:behind_schedule_if_confidence_below]}%"
                      %tr
                        %th.text-nowrap{scope: "row"}= "on_schedule_if_confidence_above".humanize
                        - @progress_chart_data[:thresholds_table].each do |row|
                          %td.text-center= "#{row[:on_schedule_if_confidence_above]}%"
                      %tr
                        %th.text-nowrap{scope: "row"}= "ahead_of_schedule_if_confidence_above".humanize
                        - @progress_chart_data[:thresholds_table].each do |row|
                          %td.text-center= "#{row[:ahead_of_schedule_if_confidence_above]}%"
                      %tr
                        %th.text-nowrap{scope: "row"}= "check_in_confidence".humanize
                        - @progress_chart_data[:thresholds_table].each do |row|
                          %td.text-center= row[:check_in_confidence].present? ? "#{row[:check_in_confidence]}%" : "â€”"
        :javascript
          (function() {
            var chartData = #{@progress_chart_data.to_json};
            function initProgressChart() {
              if (typeof Highcharts === 'undefined') return;
              var el = document.getElementById('goal-progress-confidence-chart');
              if (!el || !chartData.series || chartData.series.length === 0) return;
              var series = chartData.series.map(function(s) {
                var opts = { name: s.name, data: s.data };
                if (s.color) opts.color = s.color;
                if (s.type === 'scatter') {
                  opts.type = 'scatter';
                  opts.marker = s.marker || { radius: 6 };
                } else if (s.type === 'area') {
                  opts.type = 'area';
                  opts.stacking = s.stack ? 'normal' : undefined;
                  opts.stack = s.stack;
                  opts.fillOpacity = 0.7;
                  opts.lineWidth = 0;
                  opts.states = { inactive: { opacity: 1 } };
                }
                return opts;
              });
              Highcharts.chart('goal-progress-confidence-chart', {
                chart: { type: 'area' },
                title: { text: null },
                accessibility: { enabled: false },
                xAxis: { type: 'datetime', title: { text: 'Week (Monday)' } },
                yAxis: {
                  min: 0,
                  max: 100,
                  title: { text: 'Confidence %' },
                  stackLabels: { enabled: false }
                },
                tooltip: {
                  shared: true,
                  crosshairs: true,
                  formatter: function() {
                    var d = this.points && this.points[0];
                    if (!d) return '';
                    var dateStr = Highcharts.dateFormat('%b %d, %Y', d.point.x);
                    var idx = -1;
                    if (chartData.series[0] && chartData.series[0].data) {
                      for (var i = 0; i < chartData.series[0].data.length; i++) {
                        if (chartData.series[0].data[i][0] === d.point.x) { idx = i; break; }
                      }
                    }
                    if (idx >= 0 && chartData.thresholds_table && chartData.thresholds_table[idx]) {
                      var t = chartData.thresholds_table[idx];
                      var parts = ['<b>' + dateStr + '</b>',
                        'Ahead of schedule (above): ' + t.ahead_of_schedule_if_confidence_above + '%',
                        'On schedule (above): ' + t.on_schedule_if_confidence_above + '%',
                        'Behind schedule (below): ' + t.behind_schedule_if_confidence_below + '%'];
                      var actualPoint = this.points && this.points.find(function(p) { return p.series.name === 'Actual confidence'; });
                      if (actualPoint && actualPoint.y != null) {
                        parts.push('Actual confidence: ' + Math.round(actualPoint.y) + '%');
                      }
                      return parts.join('<br/>');
                    }
                    var lines = this.points ? this.points.map(function(p) { return p.series.name + ': ' + (p.y != null ? Math.round(p.y) + '%' : ''); }).filter(Boolean) : [];
                    return '<b>' + dateStr + '</b><br/>' + lines.join('<br/>');
                  }
                },
                plotOptions: {
                  area: { stacking: 'normal', lineWidth: 0, marker: { enabled: false } },
                  scatter: { marker: { radius: 6 } }
                },
                series: series
              });
            }
            function waitForHighcharts() {
              if (typeof Highcharts !== 'undefined') {
                initProgressChart();
              } else {
                var script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.3.0/highcharts.js';
                script.onload = initProgressChart;
                document.head.appendChild(script);
              }
            }
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', waitForHighcharts);
            } else {
              waitForHighcharts();
            }
          })();

