- hierarchy = Goals::HierarchyQuery.new(goals: @goals).call
- root_goals = hierarchy[:root_goals]
- parent_child_map = hierarchy[:parent_child_map]
- categories = @goals.map { |g| [g.id, g.goal_category] }.to_h

- if @goals.empty?
  .alert.alert-info
    %h6.mb-2
      %i.bi.bi-info-circle.me-2
      No goals to visualize
    %p.mb-0
      Create goals and link them together to see a nested visualization.
- else
  
  .nested-visualization{style: "padding: 20px;"}
    - if root_goals.empty?
      .alert.alert-warning
        %i.bi.bi-info-circle.me-2
        No root goals found. All goals appear to be linked as children.
        %br
        %small Showing all goals:
      - @goals.each do |goal|
        - children = parent_child_map[goal.id] || []
        - category = categories[goal.id]
        - badge_class_map = { vision: 'bg-info', objective: 'bg-primary', key_result: 'bg-success', bad_key_result: 'bg-danger' }
        - badge_class = badge_class_map[category] || 'bg-secondary'
        .nested-goal-card{style: "margin-bottom: 15px;"}
          .card
            .card-body
              .d-flex.align-items-center.justify-content-between
                .flex-grow-1
                  = link_to goal.title, organization_goal_path(@organization, goal), class: "text-decoration-none fw-bold"
                  %br
                  %span.badge{class: badge_class, style: "font-size: 0.7em; margin-top: 5px;"}
                    = goal_category_label(goal)
                - if children.any?
                  %span.badge.bg-light.text-dark
                    = pluralize(children.count, 'child')
    - else
      - root_goals.each do |root_goal|
        = render_nested_goal(root_goal, 0, parent_child_map, categories, @organization)

