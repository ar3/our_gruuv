- current_week_start = Date.current.beginning_of_week(:monday)
- current_week_end = current_week_start.end_of_week(:sunday)

.row.justify-content-center.mb-3
  .col-lg-12
    .alert.alert-info
      %h6.mb-2
        %i.bi.bi-calendar-event.me-2
        Current Check-in Week: #{current_week_start.strftime('%B %d')} - #{current_week_end.strftime('%B %d, %Y')}

= form_with url: bulk_update_check_ins_organization_goals_path(@organization), method: :post, local: true do |f|
  / Preserve all current params
  - @current_filters.each do |key, value|
    - if value.present?
      - if value.is_a?(Array)
        - value.each do |v|
          = hidden_field_tag "#{key}[]", v
      - else
        = hidden_field_tag key, value
  
  .table-responsive
    %table.table.table-hover
      %thead
        %tr
          %th Goal Title
          %th Due Date
          %th Last 3 Weeks
          %th Current Week Confidence
          %th Reason
      %tbody
        - @goals.each do |goal|
          - check_in = @goal_check_ins&.[](goal.id)
          - recent_check_ins = @recent_check_ins_by_goal&.[](goal.id) || []
          %tr
            %td
              = link_to goal.title, organization_goal_path(@organization, goal), class: "text-decoration-none"
            %td
              - if goal.most_likely_target_date.present?
                = goal.most_likely_target_date.strftime('%b %d, %Y')
              - else
                %span.text-muted Not set
            %td
              - if recent_check_ins.any?
                .d-flex.gap-2
                  - recent_check_ins.each do |ci|
                    - tooltip_content = goal_check_in_tooltip_content(ci)
                    %span.badge.bg-secondary{
                      "data-bs-toggle" => "tooltip",
                      "data-bs-html" => "true",
                      "data-bs-title" => tooltip_content
                    }
                      = "#{ci.confidence_percentage}%"
              - else
                %span.text-muted No previous check-ins

            %td
              = select_tag "goal_check_ins[#{goal.id}][confidence_percentage]", 
                  options_for_select(confidence_percentage_options, check_in&.confidence_percentage),
                  { include_blank: 'Select confidence...', class: 'form-select form-select-sm', required: true }
            %td
              = text_area_tag "goal_check_ins[#{goal.id}][confidence_reason]", 
                  check_in&.confidence_reason,
                  { class: 'form-control form-control-sm', rows: 2, placeholder: 'Optional reason...' }
  
  .row.mt-4
    .col-12.text-center
      = f.submit "Save All Goal Check-ins", class: "btn btn-primary btn-lg"

