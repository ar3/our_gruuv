- current_week_start = Date.current.beginning_of_week(:monday)
- current_week_end = current_week_start.end_of_week(:sunday)

.row.justify-content-center.mb-3
  .col-lg-12
    .alert.alert-info
      %h6.mb-2
        %i.bi.bi-calendar-event.me-2
        Current Check-in Week: #{current_week_start.strftime('%B %d')} - #{current_week_end.strftime('%B %d, %Y')}

= form_with url: bulk_update_check_ins_organization_goals_path(@organization), method: :post, local: true do |f|
  / Preserve all current params
  - @current_filters.each do |key, value|
    - if value.present?
      - if value.is_a?(Array)
        - value.each do |v|
          = hidden_field_tag "#{key}[]", v
      - else
        = hidden_field_tag key, value
  
  .table-responsive
    %table.table.table-hover
      %thead
        %tr
          %th Goal Title
          %th Started / Due Date
          %th Last 3 Weeks
          %th Current Week Confidence
          %th Reason
      %tbody
        - @goals.each do |goal|
          - check_in = @goal_check_ins&.[](goal.id)
          - recent_check_ins = @recent_check_ins_by_goal&.[](goal.id) || []
          - is_completed = goal_is_completed?(goal)
          - last_check_in = is_completed ? goal.goal_check_ins.recent.first : nil
          %tr
            %td
              = link_to goal.title, organization_goal_path(@organization, goal), class: "text-decoration-none"
            %td
              .d-flex.gap-2
                - if goal.started_at.present?
                  %span
                    %strong Started:
                    = goal.started_at.strftime('%b %d, %Y')
                - else
                  %span.text-muted Started: Not set
                %span |
                - if goal.most_likely_target_date.present?
                  %span
                    %strong Due:
                    = goal.most_likely_target_date.strftime('%b %d, %Y')
                - else
                  %span.text-muted Due: Not set
            %td
              - if recent_check_ins.any?
                .d-flex.gap-2
                  - recent_check_ins.each do |ci|
                    - sentence_html = render 'organizations/goals/goal_check_in_sentence', check_in: ci, goal: goal
                    %span.badge.bg-secondary{
                      "data-bs-toggle" => "tooltip",
                      "data-bs-html" => "true",
                      "data-bs-title" => sentence_html.to_s.html_safe
                    }
                      = "#{ci.confidence_percentage}%"
              - else
                %span.text-muted No previous check-ins

            %td
              - if is_completed && last_check_in
                - completion_badge_text = goal_completion_badge_text(goal)
                - badge_class = case goal_completion_outcome(goal)
                -   when :hit then 'bg-success'
                -   when :hit_late then 'bg-warning'
                -   when :miss then 'bg-danger'
                -   else 'bg-secondary'
                - if completion_badge_text
                  %span.badge{class: badge_class}
                    = completion_badge_text
                - else
                  %span.text-muted Completed
              - else
                = select_tag "goal_check_ins[#{goal.id}][confidence_percentage]", 
                    options_for_select(confidence_percentage_options, check_in&.confidence_percentage),
                    { include_blank: 'Select confidence...', class: 'form-select form-select-sm' }
            %td
              - if is_completed && last_check_in
                .completion-info
                  - if last_check_in.confidence_reason.present?
                    %div.mb-2
                      %strong Reason:
                      = last_check_in.confidence_reason
                  - if last_check_in.confidence_reporter
                    %div.mb-1
                      %small.text-muted
                        Completed by: #{last_check_in.confidence_reporter.display_name}
                  - if goal.completed_at.present?
                    %div
                      %small.text-muted
                        Completed on: #{goal.completed_at.strftime('%b %d, %Y')}
              - else
                = text_area_tag "goal_check_ins[#{goal.id}][confidence_reason]", 
                    check_in&.confidence_reason,
                    { class: 'form-control form-control-sm', rows: 2, placeholder: 'Optional reason...' }
  
  .row.mt-4
    .col-12.text-center
      = f.submit "Save All Goal Check-ins", class: "btn btn-primary btn-lg"

