- content_for :title, @goal.title

- content_for :header do
  %h1.mb-0= @goal.title

- content_for :header_action do
  = render 'mode_switcher', organization: @organization, goal: @goal, current_mode: :view

- content_for :go_back_link do
  = link_to organization_goals_path(@organization), class: "go-back-link" do
    %i.bi.bi-arrow-left.me-2
    Back to Goals

.row
  .col-md-8
    / Goal Details Card
    .card.mb-4{ role: "region", "aria-labelledby": "goal-details" }
      .card-header
        %h5.mb-0{ id: "goal-details" }
          %i.bi.bi-info-circle.me-2
          Goal Details
      .card-body
        %dl.row
          %dt.col-sm-4 Owner:
          %dd.col-sm-8
            - if @goal.owner_type == 'CompanyTeammate'
              = @goal.owner.person.display_name
            - elsif @goal.owner_type.in?(['Company', 'Department', 'Team'])
              = @goal.owner.display_name
            - else
              = @goal.owner.display_name

          %dt.col-sm-4 Title:
          %dd.col-sm-8= @goal.title

          %dt.col-sm-4 Description:
          %dd.col-sm-8
            - if @goal.description.present?
              = simple_format(@goal.description)
            - else
              %em.text-muted No description provided


          %dt.col-sm-4 Status:
          %dd.col-sm-8
            %span.badge{class: status_badge_class(@goal.status)}
              = @goal.status.to_s.humanize
          - if @goal.started_at.present?
            %dt.col-sm-4 Started:
            %dd.col-sm-8= format_time_in_user_timezone(@goal.started_at)
          - if @goal.became_top_priority.present?
            %dt.col-sm-4 Top Priority Since:
            %dd.col-sm-8= format_time_in_user_timezone(@goal.became_top_priority)

          %dt.col-sm-4 Timeframe:
          %dd.col-sm-8
            %span.badge{class: timeframe_badge_class(@goal.timeframe)}
              = @goal.timeframe.to_s.humanize
          %dt.col-sm-4 Target Dates:
          %dd.col-sm-8
            - if @goal.earliest_target_date.present? || @goal.most_likely_target_date.present? || @goal.latest_target_date.present?
              - if @goal.earliest_target_date.present?
                .mb-1
                  %strong Earliest:
                  = @goal.earliest_target_date.strftime("%B %d, %Y")
              - if @goal.most_likely_target_date.present?
                .mb-1
                  %strong Most Likely:
                  = @goal.most_likely_target_date.strftime("%B %d, %Y")
              - if @goal.latest_target_date.present?
                .mb-1
                  %strong Latest:
                  = @goal.latest_target_date.strftime("%B %d, %Y")
            - else
              %em.text-muted No target dates set
          %dt.col-sm-4 Privacy Level:
          %dd.col-sm-8
            %span.badge.bg-secondary= @goal.privacy_level.humanize

          - if @prompt_goals.any?
            %dt.col-sm-4 Linked to prompt(s):
            %dd.col-sm-8
              - @prompt_goals.each_with_index.each do |prompt_goal, idx|
                - if idx > 0
                  %span.text-muted= ", "
                = link_to prompt_goal.prompt.prompt_template.title, edit_organization_prompt_path(@organization, prompt_goal.prompt), class: "text-decoration-none"

          - if @goal.completed_at.present?
            %dt.col-sm-4 Completed:
            %dd.col-sm-8
              - completion_badge = goal_completion_badge_text(@goal)
              - if completion_badge
                %span.badge{class: completion_badge == 'Missed' ? 'bg-danger' : completion_badge == 'Hit (Late)' ? 'bg-warning' : 'bg-success', style: "margin-right: 0.5rem;"}
                  = completion_badge
              = format_time_in_user_timezone(@goal.completed_at)
              - last_check_in = @goal.goal_check_ins.recent.first
              - if last_check_in && last_check_in.confidence_reason.present?
                .mt-2
                  %strong Learnings:
                  = simple_format(last_check_in.confidence_reason)

    / Prompt Attachments Card
    - if @prompt_goals.any?
      .card.mb-4{ role: "region", "aria-labelledby": "prompt-attachments" }
        .card-header
          %h5.mb-0{ id: "prompt-attachments" }
            %i.bi.bi-file-text.me-2
            Associated with Prompts
        .card-body
          - @prompt_goals.each do |prompt_goal|
            .mb-3.pb-3{class: "#{'border-bottom' unless prompt_goal == @prompt_goals.last}"}
              = link_to edit_organization_prompt_path(@organization, prompt_goal.prompt), class: "text-decoration-none" do
                %h6.mb-1
                  %i.bi.bi-file-text.me-2
                  = prompt_goal.prompt.prompt_template.title
              %small.text-muted
                Associated on #{format_time_in_user_timezone(prompt_goal.created_at)}

    / Outgoing Links Card
    .card.mb-4{ role: "region", "aria-labelledby": "outgoing-links" }
      .card-header
        %h5.mb-0{ id: "outgoing-links" }
          %i.bi.bi-arrow-right-circle.me-2
          In pursuit of #{@goal.title}, here are some things that will help get there.
      .card-body
        - if policy(@goal).update?
          .mb-3
            %span.text-muted.mb-0 In order to achieve #{@goal.title}, we need to see
            - if policy(@goal).update?
              .dropdown.d-inline.ms-1
                %button.btn.btn-link.p-0.text-decoration-underline.dropdown-toggle{"data-bs-toggle" => "dropdown", "aria-expanded" => "false", type: "button", style: "border: none; box-shadow: none; font-weight: inherit; color: inherit; vertical-align: baseline;"}
                  %i.bi.bi-node-plus-fill.text-success
                  New Child Goal
                %ul.dropdown-menu
                  %li= link_to "... this new stepping stone / activity / output", new_outgoing_link_organization_goal_goal_links_path(@organization, @goal, goal_type: 'stepping_stone_activity', return_url: request.url, return_text: 'Goal'), class: "dropdown-item"
                  %li= link_to "... this new measurable outcome", new_outgoing_link_organization_goal_goal_links_path(@organization, @goal, goal_type: 'quantitative_key_result', return_url: request.url, return_text: 'Goal'), class: "dropdown-item"
                  %li= link_to "... this new sentiment outcome", new_outgoing_link_organization_goal_goal_links_path(@organization, @goal, goal_type: 'qualitative_key_result', return_url: request.url, return_text: 'Goal'), class: "dropdown-item"
                  %li= link_to "... this new objective", new_outgoing_link_organization_goal_goal_links_path(@organization, @goal, goal_type: 'inspirational_objective', return_url: request.url, return_text: 'Goal'), class: "dropdown-item"

        - non_archived_outgoing_links = @goal.outgoing_links.includes(:child).select { |link| link.child&.deleted_at.nil? }
        - if non_archived_outgoing_links.any?
          = render 'grouped_goal_list', 
              links: non_archived_outgoing_links, 
              linked_goals: @linked_goals, 
              linked_goal_check_ins: @linked_goal_check_ins, 
              organization: @organization, 
              show_unlink: true,
              parent_goal: @goal,
              return_url: request.url,
              return_text: 'Goal',
              display_children_goal_hierarchy: true

    / Advanced Settings
    .card.mb-4
      .card-header
        %button.btn.btn-link.p-0.text-decoration-none.w-100.text-start{type: "button", "data-bs-toggle": "collapse", "data-bs-target": "#advancedSettings", "aria-expanded": "false", "aria-controls": "advancedSettings"}
          %i.bi.bi-chevron-down.me-2
          Advanced Settings
      .collapse#advancedSettings
        .card-body
          %dl.row
            %dt.col-sm-4 Goal Type:
            %dd.col-sm-8
              %span.badge{class: goal_badge_class(@goal.goal_type)}
                = @goal.goal_type.humanize

            %dt.col-sm-4 Creator:
            %dd.col-sm-8= @goal.creator.person.display_name
            %dt.col-sm-4 Created:
            %dd.col-sm-8= format_time_in_user_timezone(@goal.created_at)
            %dt.col-sm-4 Updated:
            %dd.col-sm-8= format_time_in_user_timezone(@goal.updated_at)

          / Incoming Links Section
          .mt-4.pt-4.border-top
            %h6.mb-3
              %i.bi.bi-arrow-left-circle.me-2
              Pursuing #{@goal.title}, is in part in service to the following goals/visions
            - if policy(@goal).update?
              .mb-3
                = link_to choose_incoming_link_organization_goal_goal_links_path(@organization, @goal, return_url: request.url, return_text: 'Goal'), class: "btn btn-sm btn-primary" do
                  %i.bi.bi-plus.me-1
                  Add Parent Goal
            - if @goal.incoming_links.any?
              = render 'grouped_goal_list', 
                  links: @goal.incoming_links.includes(:parent), 
                  linked_goals: @linked_goals, 
                  linked_goal_check_ins: @linked_goal_check_ins, 
                  organization: @organization, 
                  show_unlink: true,
                  parent_goal: @goal,
                  return_url: request.url,
                  return_text: 'Goal'
            - else
              %em.text-muted No Parent Goals linked to this goal yet.
              - if policy(@goal).update?
                = link_to choose_incoming_link_organization_goal_goal_links_path(@organization, @goal, return_url: request.url, return_text: 'Goal'), class: "text-decoration-none" do
                  Add a link to a parent goal

  .col-md-4
    / Actions Card
    .card.mb-4
      .card-header
        %h6.mb-0
          %i.bi.bi-gear.me-2
          Actions
      .card-body
        - if @goal.deleted_at.present?
          .alert.alert-warning.mb-3
            %strong This goal has been archived.
            = format_time_in_user_timezone(@goal.deleted_at)
          - if policy(@goal).update?
            .d-grid.gap-2.mb-3
              = button_to undelete_organization_goal_path(@organization, @goal), method: :patch, class: "btn btn-success w-100" do
                %i.bi.bi-arrow-counterclockwise.me-2
                Unarchive Goal
        - if @goal.started_at.nil?
          / Unstarted goal - show Start Now button
          - can_edit = policy(@goal).update?
          .d-grid.gap-2
            - if can_edit
              = button_to start_organization_goal_path(@organization, @goal), method: :patch, class: "btn btn-primary w-100" do
                %i.bi.bi-play-circle.me-2
                Start Now
            - else
              .d-flex.align-items-center.gap-2
                = link_to "#", class: "btn btn-primary w-100 disabled", "aria-disabled" => "true", tabindex: "-1", "data-bs-toggle" => "tooltip", "data-bs-title" => goal_no_edit_access_tooltip(@goal) do
                  %i.bi.bi-play-circle.me-2
                  Start Now
                %i.bi.bi-exclamation-triangle.text-warning{"data-bs-toggle" => "tooltip", "data-bs-title" => goal_no_edit_access_tooltip(@goal)}
            - if can_edit
              = link_to edit_organization_goal_path(@organization, @goal), class: "btn btn-outline-secondary" do
                %i.bi.bi-pencil.me-2
                Edit Goal
            - else
              .d-flex.align-items-center.gap-2
                = link_to "#", class: "btn btn-outline-secondary disabled", "aria-disabled" => "true", tabindex: "-1", "data-bs-toggle" => "tooltip", "data-bs-title" => goal_no_edit_access_tooltip(@goal) do
                  %i.bi.bi-pencil.me-2
                  Edit Goal
                %i.bi.bi-exclamation-triangle.text-warning{"data-bs-toggle" => "tooltip", "data-bs-title" => goal_no_edit_access_tooltip(@goal)}
            - if policy(@goal).destroy? && @goal.status != :deleted
              = button_to organization_goal_path(@organization, @goal), method: :delete, class: "btn btn-outline-danger w-100", data: { confirm: "Are you sure you want to archive this goal?" } do
                %i.bi.bi-archive.me-2
                Archive Goal
            - elsif @goal.status != :deleted
              .d-flex.align-items-center.gap-2
                = link_to "#", class: "btn btn-outline-danger w-100 disabled", "aria-disabled" => "true", tabindex: "-1", "data-bs-toggle" => "tooltip", "data-bs-title" => goal_no_edit_access_tooltip(@goal) do
                  %i.bi.bi-archive.me-2
                  Archive Goal
                %i.bi.bi-exclamation-triangle.text-warning{"data-bs-toggle" => "tooltip", "data-bs-title" => goal_no_edit_access_tooltip(@goal)}
        - else
          / Started goal - show check-in button
          - can_edit = policy(@goal).update?
          - can_add_check_in = policy(GoalCheckIn.new(goal: @goal)).create?
          - return_url = request.url
          - return_text = 'Goal'
          
          / Last check-in display
          - last_check_in = @goal.goal_check_ins.includes(:confidence_reporter).recent.first
          - if last_check_in.present?
            - check_in_date = format_date_in_user_timezone(last_check_in.created_at)
            - teammate_name = last_check_in.confidence_reporter.display_name
            - confidence = last_check_in.confidence_percentage
            - calculated_due_date = @goal.calculated_target_date
            %p.mb-3
              = "#{teammate_name} checked in on #{check_in_date}, and we are #{confidence}% confident we'll accomplish this goal"
              - if calculated_due_date.present?
                = " by #{calculated_due_date.strftime('%B %d, %Y')}"
              = "."
              = render 'shared/on_track_pill', status: @goal.on_track_status_for_check_in(last_check_in)
          - else
            .alert.alert-info.mb-3
              %i.bi.bi-info-circle.me-2
              Add first check-in
          
          .d-grid.gap-2.mb-3
            - if can_add_check_in
              = link_to weekly_update_organization_goal_path(@organization, @goal, return_url: return_url, return_text: return_text), class: "btn btn-primary w-100" do
                %i.bi.bi-calendar-check.me-2
                Add/Edit & View All Check-In
            - else
              .d-flex.align-items-center.gap-2
                = link_to "#", class: "btn btn-primary w-100 disabled", "aria-disabled" => "true", tabindex: "-1", "data-bs-toggle" => "tooltip", "data-bs-title" => goal_no_check_in_access_tooltip(@goal) do
                  %i.bi.bi-calendar-check.me-2
                  Check-In
                %i.bi.bi-exclamation-triangle.text-warning{"data-bs-toggle" => "tooltip", "data-bs-title" => goal_no_check_in_access_tooltip(@goal)}
          
          - if can_edit && !goal_is_completed?(@goal)
            .mt-3.pt-3.border-top
              .d-grid.gap-2
                = link_to done_organization_goal_path(@organization, @goal, return_url: return_url, return_text: return_text), class: "btn btn-success w-100" do
                  %i.bi.bi-check-circle.me-2
                  Mark Completed
          - elsif !goal_is_completed?(@goal)
            .mt-3.pt-3.border-top
              .d-flex.align-items-center.gap-2
                = link_to "#", class: "btn btn-success w-100 disabled", "aria-disabled" => "true", tabindex: "-1", "data-bs-toggle" => "tooltip", "data-bs-title" => goal_no_edit_access_tooltip(@goal) do
                  %i.bi.bi-check-circle.me-2
                  Mark Completed
                %i.bi.bi-exclamation-triangle.text-warning{"data-bs-toggle" => "tooltip", "data-bs-title" => goal_no_edit_access_tooltip(@goal)}
          
          .mt-3.pt-3.border-top
            .d-grid.gap-2
              - if can_edit
                = link_to edit_organization_goal_path(@organization, @goal), class: "btn btn-outline-secondary btn-sm" do
                  %i.bi.bi-pencil.me-2
                  Edit Goal
              - else
                .d-flex.align-items-center.gap-2
                  = link_to "#", class: "btn btn-outline-secondary btn-sm disabled", "aria-disabled" => "true", tabindex: "-1", "data-bs-toggle" => "tooltip", "data-bs-title" => goal_no_edit_access_tooltip(@goal) do
                    %i.bi.bi-pencil.me-2
                    Edit Goal
                  %i.bi.bi-exclamation-triangle.text-warning{"data-bs-toggle" => "tooltip", "data-bs-title" => goal_no_edit_access_tooltip(@goal)}
              - if policy(@goal).destroy? && @goal.status != :deleted
                = button_to organization_goal_path(@organization, @goal), method: :delete, class: "btn btn-outline-danger btn-sm w-100", data: { confirm: "Are you sure you want to archive this goal?" } do
                  %i.bi.bi-archive.me-2
                  Archive Goal
              - elsif @goal.status != :deleted
                .d-flex.align-items-center.gap-2
                  = link_to "#", class: "btn btn-outline-danger btn-sm w-100 disabled", "aria-disabled" => "true", tabindex: "-1", "data-bs-toggle" => "tooltip", "data-bs-title" => goal_no_edit_access_tooltip(@goal) do
                    %i.bi.bi-archive.me-2
                    Archive Goal
                  %i.bi.bi-exclamation-triangle.text-warning{"data-bs-toggle" => "tooltip", "data-bs-title" => goal_no_edit_access_tooltip(@goal)}
          
        - if @goal.goal_type != 'inspirational_objective' && @goal.most_likely_target_date.nil?
          .mt-3.pt-3.border-top
            %p.small.text-muted.mb-3
              These types of goals should have due dates... what is your due date?
            .btn-group-vertical.w-100{role: "group", "aria-label": "Timeframe selection"}
              = button_to set_timeframe_organization_goal_path(@organization, @goal), method: :patch, params: { timeframe: 'near_term' }, class: "btn btn-outline-primary mb-2" do
                Near-Term (< 3 months)
              = button_to set_timeframe_organization_goal_path(@organization, @goal), method: :patch, params: { timeframe: 'medium_term' }, class: "btn btn-outline-primary mb-2" do
                Medium-Term (< 3 quarters)
              = button_to set_timeframe_organization_goal_path(@organization, @goal), method: :patch, params: { timeframe: 'long_term' }, class: "btn btn-outline-primary mb-2" do
                Long-Term (< 3 years)
              = button_to set_timeframe_organization_goal_path(@organization, @goal), method: :patch, params: { timeframe: 'vision' }, class: "btn btn-outline-primary" do
                This is a vision, not a goal

