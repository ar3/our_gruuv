- content_for :header do
  .d-flex.align-items-center
    %h1.mb-0.me-2= @goal.title
    - if policy(@goal).update?
      = link_to edit_organization_goal_path(@organization, @goal), class: "btn btn-outline-secondary ml-2" do
        %i.bi.bi-pencil.me-2
        Edit
    - else
      .btn.btn-outline-secondary.disabled{style: "opacity: 0.6; cursor: not-allowed;"}
        %i.bi.bi-pencil.me-2
        Edit

- content_for :go_back_link do
  = link_to organization_goals_path(@organization), class: "go-back-link" do
    %i.bi.bi-arrow-left.me-2
    Back to Goals

.row
  .col-md-8
    / Goal Details Card
    .card.mb-4{ role: "region", "aria-labelledby": "goal-details" }
      .card-header
        %h5.mb-0{ id: "goal-details" }
          %i.bi.bi-info-circle.me-2
          Goal Details
      .card-body
        %dl.row
          %dt.col-sm-4 Owner:
          %dd.col-sm-8
            - if @goal.owner_type == 'Teammate'
              = @goal.owner.person.display_name
            - elsif @goal.owner_type.in?(['Company', 'Department', 'Team'])
              = @goal.owner.display_name
            - else
              = @goal.owner.display_name

          %dt.col-sm-4 Title:
          %dd.col-sm-8= @goal.title

          %dt.col-sm-4 Description:
          %dd.col-sm-8
            - if @goal.description.present?
              = simple_format(@goal.description)
            - else
              %em.text-muted No description provided

          %dt.col-sm-4 Goal Type:
          %dd.col-sm-8
            %span.badge{class: goal_badge_class(@goal.goal_type)}
              = @goal.goal_type.humanize

          %dt.col-sm-4 Timeframe:
          %dd.col-sm-8
            %span.badge{class: timeframe_badge_class(@goal.timeframe)}
              = @goal.timeframe.to_s.humanize

          %dt.col-sm-4 Status:
          %dd.col-sm-8
            %span.badge{class: status_badge_class(@goal.status)}
              = @goal.status.to_s.humanize
          - if @goal.started_at.present?
            %dt.col-sm-4 Started:
            %dd.col-sm-8= @goal.started_at.strftime("%B %d, %Y at %I:%M %p")
          - if @goal.became_top_priority.present?
            %dt.col-sm-4 Top Priority Since:
            %dd.col-sm-8= @goal.became_top_priority.strftime("%B %d, %Y at %I:%M %p")

          %dt.col-sm-4 Target Dates:
          %dd.col-sm-8
            - if @goal.earliest_target_date.present? || @goal.most_likely_target_date.present? || @goal.latest_target_date.present?
              - if @goal.earliest_target_date.present?
                .mb-1
                  %strong Earliest:
                  = @goal.earliest_target_date.strftime("%B %d, %Y")
              - if @goal.most_likely_target_date.present?
                .mb-1
                  %strong Most Likely:
                  = @goal.most_likely_target_date.strftime("%B %d, %Y")
              - if @goal.latest_target_date.present?
                .mb-1
                  %strong Latest:
                  = @goal.latest_target_date.strftime("%B %d, %Y")
            - else
              %em.text-muted No target dates set
          %dt.col-sm-4 Privacy Level:
          %dd.col-sm-8
            %span.badge.bg-secondary= @goal.privacy_level.humanize

          - if @goal.completed_at.present?
            %dt.col-sm-4 Completed:
            %dd.col-sm-8= @goal.completed_at.strftime("%B %d, %Y at %I:%M %p")
          - if @goal.cancelled_at.present?
            %dt.col-sm-4 Cancelled:
            %dd.col-sm-8= @goal.cancelled_at.strftime("%B %d, %Y at %I:%M %p")

          %dt.col-sm-4 Creator:
          %dd.col-sm-8= @goal.creator.person.display_name
          %dt.col-sm-4 Created:
          %dd.col-sm-8= @goal.created_at.strftime("%B %d, %Y at %I:%M %p")
          %dt.col-sm-4 Updated:
          %dd.col-sm-8= @goal.updated_at.strftime("%B %d, %Y at %I:%M %p")

    / Outgoing Links Card
    .card.mb-4{ role: "region", "aria-labelledby": "outgoing-links" }
      .card-header
        %h5.mb-0{ id: "outgoing-links" }
          %i.bi.bi-arrow-right-circle.me-2
          In pursuit of #{@goal.title}, here are some things that will help get there.
      .card-body
        - grouped_links = @goal.outgoing_links.includes(:child).group_by { |link| link.child.goal_type }
        - goal_types = ['stepping_stone_activity', 'quantitative_key_result', 'qualitative_key_result', 'inspirational_objective']
        - goal_type_labels = { 'stepping_stone_activity' => 'Stepping Stones/Activities', 'quantitative_key_result' => 'Measurable Outcomes', 'qualitative_key_result' => 'Sentiment Outcomes', 'inspirational_objective' => 'Objectives' }
        
        - goal_types.each do |goal_type|
          - links_for_type = grouped_links[goal_type] || []
          - if links_for_type.any?
            .mb-4
              %h6.mb-2
                = goal_type_labels[goal_type]
                %span.badge{class: goal_badge_class(goal_type), style: "font-size: 0.75em;"}
                  = pluralize(links_for_type.count, 'goal')
              %ul.list-unstyled
                - links_for_type.each do |link|
                  %li.mb-2
                    .d-flex.justify-content-between.align-items-start
                      .flex-grow-1
                        = link_to organization_goal_path(@organization, link.child), class: "text-decoration-none" do
                          %strong= link.child.title
                        - if link.metadata.present? && link.metadata['notes'].present?
                          %small.text-muted.d-block.mt-1= link.metadata['notes']
                      - if policy(link).destroy?
                        = button_to organization_goal_goal_link_path(@organization, @goal, link), method: :delete, class: "btn btn-sm btn-outline-danger ms-2", form: { style: "display: inline-block;" }, data: { confirm: "Are you sure you want to remove this link?" } do
                          %i.bi.bi-trash
        
        - if policy(@goal).update?
          .mt-4.pt-3.border-top
            .d-grid.gap-2
              = link_to new_outgoing_link_organization_goal_goal_links_path(@organization, @goal, goal_type: 'stepping_stone_activity', return_url: request.url, return_text: 'Goal'), class: "btn btn-outline-primary" do
                %i.bi.bi-plus.me-1
                Add stepping stones/activities that need to happen in order to achieve #{@goal.title}
              = link_to new_outgoing_link_organization_goal_goal_links_path(@organization, @goal, goal_type: 'quantitative_key_result', return_url: request.url, return_text: 'Goal'), class: "btn btn-outline-primary" do
                %i.bi.bi-plus.me-1
                Add measurable outcomes that need to happen in order to achieve #{@goal.title}
              = link_to new_outgoing_link_organization_goal_goal_links_path(@organization, @goal, goal_type: 'qualitative_key_result', return_url: request.url, return_text: 'Goal'), class: "btn btn-outline-primary" do
                %i.bi.bi-plus.me-1
                Add sentiment outcomes that need to happen in order to achieve #{@goal.title}
              = link_to new_outgoing_link_organization_goal_goal_links_path(@organization, @goal, goal_type: 'inspirational_objective', return_url: request.url, return_text: 'Goal'), class: "btn btn-outline-primary" do
                %i.bi.bi-plus.me-1
                Add objectives that need to happen in order to achieve #{@goal.title}

    / Incoming Links Card
    .card.mb-4{ role: "region", "aria-labelledby": "incoming-links" }
      .card-header.d-flex.justify-content-between.align-items-center
        %h5.mb-0{ id: "incoming-links" }
          %i.bi.bi-arrow-left-circle.me-2
          Pursuing #{@goal.title}, is in part in service to the following goals/visions
        - if policy(@goal).update?
          = link_to new_incoming_link_organization_goal_goal_links_path(@organization, @goal, return_url: request.url, return_text: 'Goal'), class: "btn btn-sm btn-primary" do
            %i.bi.bi-plus.me-1
            Add Link
      .card-body
        - if @goal.incoming_links.any?
          %ul.list-unstyled
            - @goal.incoming_links.each do |link|
              %li.mb-2
                .d-flex.justify-content-between.align-items-start
                  .flex-grow-1
                    = link_to organization_goal_path(@organization, link.parent), class: "text-decoration-none" do
                      %strong= link.parent.title
                    - if link.metadata.present? && link.metadata['notes'].present?
                      %small.text-muted.d-block.mt-1= link.metadata['notes']
                  - if policy(link).destroy?
                    = button_to organization_goal_goal_link_path(@organization, @goal, link), method: :delete, class: "btn btn-sm btn-outline-danger ms-2", form: { style: "display: inline-block;" }, data: { confirm: "Are you sure you want to remove this link?" } do
                      %i.bi.bi-trash
        - else
          %em.text-muted No incoming links. No other goals relate to this goal yet.
          - if policy(@goal).update?
            = link_to new_incoming_link_organization_goal_goal_links_path(@organization, @goal, return_url: request.url, return_text: 'Goal'), class: "text-decoration-none" do
              Add a link

  .col-md-4
    / Actions Card
    .card.mb-4
      .card-header
        %h6.mb-0
          %i.bi.bi-gear.me-2
          Actions
      .card-body
        - if @goal.started_at.nil?
          / Unstarted goal - show Start Now button
          .d-grid.gap-2
            - if policy(@goal).update?
              = button_to start_organization_goal_path(@organization, @goal), method: :patch, class: "btn btn-primary w-100" do
                %i.bi.bi-play-circle.me-2
                Start Now
            - if policy(@goal).update?
              = link_to edit_organization_goal_path(@organization, @goal), class: "btn btn-outline-secondary" do
                %i.bi.bi-pencil.me-2
                Edit Goal
            - if policy(@goal).destroy?
              = link_to organization_goal_path(@organization, @goal), method: :delete, class: "btn btn-outline-danger", data: { confirm: "Are you sure you want to delete this goal? This action cannot be undone." } do
                %i.bi.bi-trash.me-2
                Delete Goal
        - else
          / Started goal - show weekly check-in form
          - current_week_start = @current_week_start || Date.current.beginning_of_week(:monday)
          - current_week_end = current_week_start.end_of_week(:sunday)
          
          %h6.mb-3 Weekly Check-In
          %p.small.text-muted.mb-3
            Week of #{current_week_start.strftime('%B %d')} - #{current_week_end.strftime('%B %d, %Y')}
          
          - if @current_check_in.present?
            %p.small.text-muted.mb-3
              Filled out by #{@current_check_in.confidence_reporter.display_name} on #{@current_check_in.created_at.strftime('%B %d, %Y at %I:%M %p')}
          
          = form_with url: check_in_organization_goal_path(@organization, @goal), method: :post, local: true do |f|
            .mb-3
              = f.label :confidence_percentage, "Confidence", class: "form-label"
              = f.select :confidence_percentage, 
                  options_for_select(confidence_percentage_options, @current_check_in&.confidence_percentage),
                  { include_blank: 'Select confidence...' },
                  { class: 'form-select', required: true }
            
            .mb-3
              = f.label :confidence_reason, "Notes", class: "form-label"
              = f.text_area :confidence_reason, value: @current_check_in&.confidence_reason, class: 'form-control', rows: 3, placeholder: 'Optional notes...'
            
            .d-grid
              = f.submit "Save Check-In", class: "btn btn-primary"
          
          - if @last_check_in.present?
            .mt-4.pt-3.border-top
              %h6.mb-2 Last Check-In
              %p.small.mb-1
                %strong Week:
                = @last_check_in.week_display
              %p.small.mb-1
                %strong Confidence:
                = "#{@last_check_in.confidence_percentage}%"
              - if @last_check_in.confidence_reason.present?
                %p.small.mb-1
                  %strong Notes:
                  = @last_check_in.confidence_reason
              %p.small.text-muted.mb-0
                By #{@last_check_in.confidence_reporter.display_name} on #{@last_check_in.created_at.strftime('%B %d, %Y')}
          
          .mt-3.pt-3.border-top
            .d-grid.gap-2
              - if policy(@goal).update?
                = link_to edit_organization_goal_path(@organization, @goal), class: "btn btn-outline-secondary btn-sm" do
                  %i.bi.bi-pencil.me-2
                  Edit Goal
              - if policy(@goal).destroy?
                = link_to organization_goal_path(@organization, @goal), method: :delete, class: "btn btn-outline-danger btn-sm", data: { confirm: "Are you sure you want to delete this goal? This action cannot be undone." } do
                  %i.bi.bi-trash.me-2
                  Delete Goal
        
        - if @goal.goal_type != 'inspirational_objective' && @goal.most_likely_target_date.nil?
          .mt-3.pt-3.border-top
            %p.small.text-muted.mb-3
              These types of goals should have due dates... what is your due date?
            .btn-group-vertical.w-100{role: "group", "aria-label": "Timeframe selection"}
              = button_to set_timeframe_organization_goal_path(@organization, @goal), method: :patch, params: { timeframe: 'near_term' }, class: "btn btn-outline-primary mb-2" do
                Near-Term (< 3 months)
              = button_to set_timeframe_organization_goal_path(@organization, @goal), method: :patch, params: { timeframe: 'medium_term' }, class: "btn btn-outline-primary mb-2" do
                Medium-Term (< 3 quarters)
              = button_to set_timeframe_organization_goal_path(@organization, @goal), method: :patch, params: { timeframe: 'long_term' }, class: "btn btn-outline-primary mb-2" do
                Long-Term (< 3 years)
              = button_to set_timeframe_organization_goal_path(@organization, @goal), method: :patch, params: { timeframe: 'vision' }, class: "btn btn-outline-primary" do
                This is a vision, not a goal


