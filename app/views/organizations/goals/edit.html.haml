- content_for :title, "Edit Goal"

- content_for :go_back_link do
  = link_to organization_goal_path(@organization, @goal), class: "go-back-link" do
    %i.bi.bi-arrow-left.me-2
    Back to Goal

- content_for :header do
  .d-flex.align-items-center
    %h1.mb-0.me-2 Edit Goal

.container-fluid
  .row
    .col-12
      .card
        .card-body
          = form_with model: [@organization, @form], url: organization_goal_path(@organization, @goal), local: true do |form|
            - if @form.errors.any?
              .alert.alert-danger
                %h4= "#{pluralize(@form.errors.count, "error")} prohibited this goal from being saved:"
                %ul.mb-0
                  - @form.errors.full_messages.each do |message|
                    %li= message
            
            .mb-3
              = form.label :title, class: 'form-label' do
                Title
                %span.text-danger *
              = form.text_field :title, class: 'form-control', required: true
            
            .mb-3
              = form.label :description, class: 'form-label'
              = form.text_area :description, class: 'form-control', rows: 4
            
            / Timeframe Selection - Large Button Group
            - if @goal.most_likely_target_date.present?
              / Derive timeframe from existing most_likely_target_date
              - days_from_now = (@goal.most_likely_target_date - Date.today).to_i
              - existing_timeframe = days_from_now < 120 ? 'near_term' : (days_from_now < 365 ? 'medium_term' : (days_from_now < 1095 ? 'long_term' : 'vision'))
            - else
              - existing_timeframe = 'vision'
           
            / Advanced Settings Collapse
            .mb-3
              %button.btn.btn-link.p-0.text-decoration-none{type: "button", "data-bs-toggle": "collapse", "data-bs-target": "#advancedSettings", "aria-expanded": "false", "aria-controls": "advancedSettings"}
                %i.bi.bi-chevron-down.me-2
                Advanced Settings
            
            .collapse#advancedSettings
              .card.card-body.bg-light.mt-3
                = render 'goal_type_selection', form: form
                
                .mb-3
                  %label.form-label
                    Target Dates
                    %small.text-muted (Optional)
                  %small.form-text.text-muted.mb-2.d-block
                    If you set dates here, they will override the timeframe selection above.
                  .row
                    .col-md-4.mb-2
                      = form.label :earliest_target_date, 'Earliest Target Date', class: 'form-label small'
                      = form.date_field :earliest_target_date, class: 'form-control'
                    .col-md-4.mb-2
                      = form.label :most_likely_target_date, 'Most Likely Target Date', class: 'form-label small'
                      = form.date_field :most_likely_target_date, class: 'form-control'
                    .col-md-4.mb-2
                      = form.label :latest_target_date, 'Latest Target Date', class: 'form-label small'
                      = form.date_field :latest_target_date, class: 'form-control'
                  %small.form-text.text-muted
                    All dates are optional. If provided, Earliest ≤ Most Likely ≤ Latest
                
                .mb-3
                  = form.label :owner_id, class: 'form-label' do
                    Owner
                    %span.text-danger *
                  - current_owner_value = "#{@goal.owner_type}_#{@goal.owner_id}"
                  = form.select :owner_id, 
                    available_goal_owners,
                    { selected: current_owner_value },
                    { class: 'form-select', required: true }
                  %small.form-text.text-muted
                    Choose who this goal belongs to: yourself, an employee, a team, department, or company
                
                .mb-3
                  = form.label :privacy_level, class: 'form-label' do
                    Privacy Level
                    %span.text-danger *
                  - Goal.privacy_levels.each do |privacy_level, value|
                    .form-check
                      = form.radio_button :privacy_level, privacy_level, class: 'form-check-input', required: true
                      = form.label :privacy_level, privacy_level.humanize, value: privacy_level, class: 'form-check-label'
                      - if privacy_level == 'only_creator'
                        %small.text-muted.d-block.ms-4 Only you can view this goal
                      - elsif privacy_level == 'only_creator_and_owner'
                        %small.text-muted.d-block.ms-4 You and the goal owner can view this goal
                      - elsif privacy_level == 'only_creator_owner_and_managers'
                        %small.text-muted.d-block.ms-4 You, the owner, and their managers can view this goal
                      - elsif privacy_level == 'everyone_in_company'
                        %small.text-muted.d-block.ms-4 Everyone in your company can view this goal
                
                .mb-3
                  %label.form-label
                    Status Dates
                    %small.text-muted (Optional)
                  %small.form-text.text-muted.mb-2.d-block
                    Set when this goal was started, completed, or cancelled.
                  .row
                    .col-md-4.mb-2
                      = form.label :started_at, 'Started At', class: 'form-label small'
                      = form.datetime_local_field :started_at, class: 'form-control'
                    .col-md-4.mb-2
                      = form.label :completed_at, 'Completed At', class: 'form-label small'
                      = form.datetime_local_field :completed_at, class: 'form-control'
                  %small.form-text.text-muted
                    %strong Current Status:
                    = @goal.status.to_s.humanize
            
            .d-flex
              = form.submit 'Update Goal', class: 'btn btn-primary'
              = link_to 'Cancel', organization_goal_path(@organization, @goal), class: 'btn btn-outline-secondary ms-2'
    
    .col-12
      / Goal Links Section (Read-Only)
      - if @goal.outgoing_links.any? || @goal.incoming_links.any?
        .card.mt-4
          .card-header.d-flex.justify-content-between.align-items-center
            %h5.mb-0
              %i.bi.bi-link-45deg.me-2
              Parent / Child Goals
          .card-body
            .row
              - if @goal.incoming_links.any?
                .col-md-6
                  %h6.mb-3
                    %i.bi.bi-arrow-left-circle.me-2
                    Parent Goals
                  %ul.list-unstyled
                    - @goal.incoming_links.each do |link|
                      - linked_goal = @linked_goals[link.parent_id] || link.parent
                      - next unless linked_goal.present?
                      - most_recent_check_in = @linked_goal_check_ins[linked_goal.id]
                      - status_icon = goal_status_icon(linked_goal)
                      - is_struck_through = goal_should_be_struck_through?(linked_goal)
                      %li.mb-2
                        = link_to organization_goal_path(@organization, linked_goal), class: "text-decoration-none #{'text-decoration-line-through' if is_struck_through}" do
                          %i.bi{class: status_icon, style: "margin-right: 0.5rem;"}
                          %strong= linked_goal.title
                        - if link.metadata.present? && link.metadata['notes'].present?
                          %i.bi.bi-file-text.text-muted.ms-2{"data-bs-toggle" => "tooltip", "data-bs-title" => link.metadata['notes'], style: "cursor: help;"}
                        - if most_recent_check_in.present?
                          %small.text-muted.d-block.mt-1
                            As of #{most_recent_check_in.check_in_week_start.strftime('%b %d, %Y')}, we are #{most_recent_check_in.confidence_percentage}% confident we'll accomplish this.
              - else
                .col-md-6
                  %h6.mb-3
                    %i.bi.bi-arrow-left-circle.me-2
                    Parent Goals
                  %em.text-muted No linked parent goals yet.
      
              - if @goal.outgoing_links.any?
                .col-md-6
                  %h6.mb-3
                    %i.bi.bi-arrow-right-circle.me-2
                    Child Goals
                  - valid_links = @goal.outgoing_links.includes(:child).select { |link| (@linked_goals[link.child_id] || link.child).present? }
                  - grouped_links = valid_links.group_by { |link| (@linked_goals[link.child_id] || link.child).goal_type }
                  - goal_types = ['stepping_stone_activity', 'quantitative_key_result', 'qualitative_key_result', 'inspirational_objective']
                  - goal_type_labels = { 'stepping_stone_activity' => 'Stepping Stones/Activities', 'quantitative_key_result' => 'Measurable Outcomes', 'qualitative_key_result' => 'Sentiment Outcomes', 'inspirational_objective' => 'Objectives' }
                  
                  - goal_types.each do |goal_type|
                    - links_for_type = grouped_links[goal_type] || []
                    - if links_for_type.any?
                      .mb-3
                        %h6.mb-2.small
                          = goal_type_labels[goal_type]
                          %span.badge{class: goal_badge_class(goal_type), style: "font-size: 0.75em;"}
                            = pluralize(links_for_type.count, 'goal')
                        %ul.list-unstyled
                          - links_for_type.each do |link|
                            - linked_goal = @linked_goals[link.child_id] || link.child
                            - next unless linked_goal.present?
                            - most_recent_check_in = @linked_goal_check_ins[linked_goal.id]
                            - status_icon = goal_status_icon(linked_goal)
                            - is_struck_through = goal_should_be_struck_through?(linked_goal)
                            %li.mb-2
                              = link_to organization_goal_path(@organization, linked_goal), class: "text-decoration-none #{'text-decoration-line-through' if is_struck_through}" do
                                %i.bi{class: status_icon, style: "margin-right: 0.5rem;"}
                                %strong= linked_goal.title
                              - if link.metadata.present? && link.metadata['notes'].present?
                                %i.bi.bi-file-text.text-muted.ms-2{"data-bs-toggle" => "tooltip", "data-bs-title" => link.metadata['notes'], style: "cursor: help;"}
                              - if most_recent_check_in.present?
                                %small.text-muted.d-block.mt-1
                                  As of #{most_recent_check_in.check_in_week_start.strftime('%b %d, %Y')}, we are #{most_recent_check_in.confidence_percentage}% confident we'll accomplish this.
              - else
                .col-md-6
                  %h6.mb-3
                    %i.bi.bi-arrow-right-circle.me-2
                    Child Goals
                  %em.text-muted No linked child goals yet.
              
              
      / Goal Links Info
      .alert.alert-info.mt-4
        %i.bi.bi-info-circle.me-2
        You can add other parent and children goals after you save this goal

