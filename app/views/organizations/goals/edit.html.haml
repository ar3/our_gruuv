- content_for :title, "Edit Goal"

- content_for :go_back_link do
  = link_to organization_goal_path(@organization, @goal), class: "go-back-link" do
    %i.bi.bi-arrow-left.me-2
    Back to Goal

- content_for :header do
  %h1.mb-0 Edit Goal

- content_for :header_action do
  = render 'mode_switcher', organization: @organization, goal: @goal, current_mode: :edit, return_url: organization_goal_path(@organization, @goal), return_text: 'Back to Goal'

.container-fluid
  .row
    .col-12
      .card
        .card-body
          = form_with model: [@organization, @form], url: organization_goal_path(@organization, @goal), local: true do |form|
            - if @form.errors.any?
              .alert.alert-danger
                %h4= "#{pluralize(@form.errors.count, "error")} prohibited this goal from being saved:"
                %ul.mb-0
                  - @form.errors.full_messages.each do |message|
                    %li= message
            
            .mb-3
              = form.label :owner_id, class: 'form-label' do
                Owner
                %span.text-danger *
              - current_owner_value = (@goal.owner_type == 'Organization') ? "Company_#{@goal.owner_id}" : "#{@goal.owner_type}_#{@goal.owner_id}"
              = render 'goal_owner_select',
                options: available_goal_owners,
                selected_value: current_owner_value,
                name: 'goal[owner_id]',
                select_class: 'form-select',
                required: true
              %small.form-text.text-muted
                Choose who this goal belongs to: yourself, an employee, a team, department, or company

            .mb-3
              = form.label :title, class: 'form-label' do
                Title
                %span.text-danger *
              = form.text_field :title, class: 'form-control', required: true
            
            .mb-3
              = form.label :description, class: 'form-label'
              = form.text_area :description, class: 'form-control', rows: 4

            = render 'goal_dates_sentence', form: form

            .mb-3
              = render 'goal_type_selection', form: form

            .mb-3
              = form.label :privacy_level, class: 'form-label' do
                Privacy Level
                %span.text-danger *
              - Goal.privacy_levels.each do |privacy_level, value|
                .form-check
                  = form.radio_button :privacy_level, privacy_level, class: 'form-check-input', required: true
                  = form.label :privacy_level, privacy_level.humanize, value: privacy_level, class: 'form-check-label'
                  - if privacy_level == 'only_creator'
                    %small.text-muted.d-block.ms-4 Only you can view this goal
                  - elsif privacy_level == 'only_creator_and_owner'
                    %small.text-muted.d-block.ms-4 You and the goal owner can view this goal
                  - elsif privacy_level == 'only_creator_owner_and_managers'
                    %small.text-muted.d-block.ms-4 You, the owner, and their managers can view this goal
                  - elsif privacy_level == 'everyone_in_company'
                    %small.text-muted.d-block.ms-4 Everyone in your company can view this goal

            / Advanced Settings Collapse
            .mb-3
              %button.btn.btn-link.p-0.text-decoration-none{type: "button", "data-bs-toggle": "collapse", "data-bs-target": "#advancedSettings", "aria-expanded": "false", "aria-controls": "advancedSettings"}
                %i.bi.bi-chevron-down.me-2
                Advanced Settings

            .collapse#advancedSettings
              .card.card-body.bg-light.mt-3
                .mb-3
                  = form.label :initial_confidence, 'Initial Confidence', class: 'form-label'
                  - initial_confidence_value = @form.initial_confidence.presence || 'stretch'
                  .form-check
                    = form.radio_button :initial_confidence, 'commit', class: 'form-check-input', id: 'goal_initial_confidence_commit', checked: (initial_confidence_value == 'commit')
                    = form.label :initial_confidence, nil, value: 'commit', class: 'form-check-label', for: 'goal_initial_confidence_commit' do
                      %strong Commit
                      %small.text-muted.d-block.ms-4 At the time of starting this goal, I was more than 80% confident it would be hit by the due date (well within my/our control).
                  .form-check
                    = form.radio_button :initial_confidence, 'stretch', class: 'form-check-input', id: 'goal_initial_confidence_stretch', checked: (initial_confidence_value == 'stretch')
                    = form.label :initial_confidence, nil, value: 'stretch', class: 'form-check-label', for: 'goal_initial_confidence_stretch' do
                      %strong Stretch
                      %small.text-muted.d-block.ms-4 At the time of starting this goal, I was about 50/50 on whether it would be hit by the due date (striving for it, but not certain).
                  .form-check
                    = form.radio_button :initial_confidence, 'transform', class: 'form-check-input', id: 'goal_initial_confidence_transform', checked: (initial_confidence_value == 'transform')
                    = form.label :initial_confidence, nil, value: 'transform', class: 'form-check-label', for: 'goal_initial_confidence_transform' do
                      %strong Transform
                      %small.text-muted.d-block.ms-4 At the time of starting this goal, I was less than 30% confident it would be hit by the due dateâ€”but if hit, it would change or make us rethink everything (big-hairy-audacious goals).

                .mb-3
                  %label.form-label
                    Status Dates
                    %small.text-muted (Optional)
                  %small.form-text.text-muted.mb-2.d-block
                    Set when this goal was completed or cancelled.
                  .row
                    .col-md-6.mb-2
                      = form.label :completed_at, 'Completed At', class: 'form-label small'
                      = form.datetime_local_field :completed_at, class: 'form-control'
                  %small.form-text.text-muted
                    %strong Current Status:
                    = @goal.status.to_s.humanize
            
            .d-flex
              = form.submit 'Update Goal', class: 'btn btn-primary'
              = link_to 'Cancel', organization_goal_path(@organization, @goal), class: 'btn btn-outline-secondary ms-2'
    
    .col-12
      / Goal Links Section (Read-Only)
      - if @goal.outgoing_links.any? || @goal.incoming_links.any?
        .card.mt-4
          .card-header.d-flex.justify-content-between.align-items-center
            %h5.mb-0
              %i.bi.bi-link-45deg.me-2
              Parent / Child Goals
          .card-body
            .row
              - if @goal.incoming_links.any?
                .col-md-6
                  %h6.mb-3
                    %i.bi.bi-arrow-left-circle.me-2
                    Parent Goals
                  = render 'grouped_goal_list', 
                      links: @goal.incoming_links.includes(:parent), 
                      linked_goals: @linked_goals, 
                      linked_goal_check_ins: @linked_goal_check_ins, 
                      organization: @organization, 
                      show_unlink: true,
                      parent_goal: @goal,
                      return_url: request.url,
                      return_text: 'Edit Goal'
              - else
                .col-md-6
                  %h6.mb-3
                    %i.bi.bi-arrow-left-circle.me-2
                    Parent Goals
                  %em.text-muted No linked parent goals yet.
      
              - if @goal.outgoing_links.any?
                .col-md-6
                  %h6.mb-3
                    %i.bi.bi-arrow-right-circle.me-2
                    Child Goals
                  = render 'grouped_goal_list', 
                      links: @goal.outgoing_links.includes(:child), 
                      linked_goals: @linked_goals, 
                      linked_goal_check_ins: @linked_goal_check_ins, 
                      organization: @organization, 
                      show_unlink: true,
                      parent_goal: @goal,
                      return_url: request.url,
                      return_text: 'Edit Goal',
                      display_children_goal_hierarchy: true
              - else
                .col-md-6
                  %h6.mb-3
                    %i.bi.bi-arrow-right-circle.me-2
                    Child Goals
                  %em.text-muted No linked child goals yet.
              
      / Goal Links Info
      .alert.alert-info.mt-4
        %i.bi.bi-info-circle.me-2
        You can add other parent and children goals after you save this goal

