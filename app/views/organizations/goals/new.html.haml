- content_for :title, "New Goal"

- content_for :go_back_link do
  = link_to organization_goals_path(@organization), class: "go-back-link" do
    %i.bi.bi-arrow-left.me-2
    Back to Goals

- content_for :header do
  .d-flex.align-items-center
    %h1.mb-0.me-2 New Goal

.container-fluid
  .row
    .col-12
      .card
        .card-body
          = form_with model: [@organization, @form], url: organization_goals_path(@organization), local: true do |form|
            - if @form.errors.any?
              .alert.alert-danger
                %h4= "#{pluralize(@form.errors.count, "error")} prohibited this goal from being saved:"
                %ul.mb-0
                  - @form.errors.full_messages.each do |message|
                    %li= message
            
            / Hidden field for privacy_level (defaulted in controller)
            = form.hidden_field :privacy_level, value: @form.privacy_level || 'only_creator_owner_and_managers'
            
            .mb-3
              = form.label :title, class: 'form-label' do
                Title
                %span.text-danger *
              = form.text_field :title, class: 'form-control', required: true
            
            .mb-3
              = form.label :description, class: 'form-label'
              = form.text_area :description, class: 'form-control', rows: 4
            
            .mb-4 
              = render 'goal_type_selection', form: form
              
            / Timeframe Selection - Large Button Group
            .mb-4#timeframe-selection
              %label.form-label Timeframe
              #timeframe-target-date-info.small.text-muted.mb-2{style: "display: none;"}
              .btn-group.w-100{role: "group", "aria-label": "Timeframe selection"}
                = form.radio_button :timeframe, 'vision', class: 'btn-check', id: 'timeframe_vision', checked: true
                = form.label :timeframe, 'Vision (no timeframe)', value: 'vision', class: 'btn btn-outline-primary btn-lg', for: 'timeframe_vision'
                
                = form.radio_button :timeframe, 'long_term', class: 'btn-check', id: 'timeframe_long_term', checked: false
                = form.label :timeframe, 'Long-term goal', value: 'long_term', class: 'btn btn-outline-primary btn-lg', for: 'timeframe_long_term'
                
                = form.radio_button :timeframe, 'medium_term', class: 'btn-check', id: 'timeframe_medium_term', checked: false
                = form.label :timeframe, 'Medium-term goal', value: 'medium_term', class: 'btn btn-outline-primary btn-lg', for: 'timeframe_medium_term'
                
                = form.radio_button :timeframe, 'near_term', class: 'btn-check', id: 'timeframe_near_term', checked: false
                = form.label :timeframe, 'Near-term goal', value: 'near_term', class: 'btn btn-outline-primary btn-lg', for: 'timeframe_near_term'
              
              %small.form-text.text-muted.mt-2.d-block
                Select a timeframe to automatically set the target date.
            
            .mb-3
              = form.label :owner_id, class: 'form-label' do
                Owner
                %span.text-danger *
              - viewing_teammate_id = current_company_teammate&.id || @form.current_teammate&.id
              - default_owner_id = @form.owner_id || (viewing_teammate_id ? "CompanyTeammate_#{viewing_teammate_id}" : nil)
              - raise "MAJOR ISSUE WITH GOALS... SOMEHOW THE CURRENT TEAMMATE IS NIL?!?!" if default_owner_id.blank?
              = form.select :owner_id, 
                available_goal_owners,
                { selected: default_owner_id },
                { class: 'form-select' }
              %small.form-text.text-muted
                Choose who this goal belongs to: yourself, an employee, a team, department, or company
            
            .alert.alert-info.mb-4
              %i.bi.bi-info-circle.me-2
              You can customize privacy settings and target dates after creating the goal.
            
            .d-flex
              = form.submit 'Create Goal', class: 'btn btn-primary'
              = link_to 'Cancel', organization_goals_path(@organization), class: 'btn btn-outline-secondary ms-2'

:javascript
  function formatDate(date) {
    var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    return months[date.getMonth()] + ' ' + date.getDate() + ', ' + date.getFullYear();
  }
  
  function calculateTargetDate(timeframe) {
    var today = new Date();
    var targetDate = new Date();
    
    switch(timeframe) {
      case 'near_term':
        targetDate.setDate(today.getDate() + 90);
        break;
      case 'medium_term':
        targetDate.setDate(today.getDate() + 270);
        break;
      case 'long_term':
        targetDate.setFullYear(today.getFullYear() + 3);
        break;
      case 'vision':
        return null;
      default:
        return null;
    }
    
    return targetDate;
  }
  
  function updateTargetDateDisplay() {
    var timeframeInfo = document.getElementById('timeframe-target-date-info');
    if (!timeframeInfo) return;
    
    var selectedTimeframe = document.querySelector('input[name="goal[timeframe]"]:checked');
    
    if (!selectedTimeframe) {
      timeframeInfo.style.display = 'none';
      return;
    }
    
    var targetDate = calculateTargetDate(selectedTimeframe.value);
    
    if (targetDate) {
      var formattedDate = formatDate(targetDate);
      timeframeInfo.textContent = 'Target date: ' + formattedDate + '. This date can be changed after creating the goal.';
      timeframeInfo.style.display = 'block';
    } else {
      timeframeInfo.style.display = 'none';
    }
  }
  
  function setupTimeframeListeners() {
    var timeframeRadios = document.querySelectorAll('input[name="goal[timeframe]"]');
    timeframeRadios.forEach(function(radio) {
      radio.addEventListener('change', updateTargetDateDisplay);
    });
    
    // Initial check in case a timeframe is pre-selected
    updateTargetDateDisplay();
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    setupTimeframeListeners();
  });
  document.addEventListener('turbo:load', function() {
    setupTimeframeListeners();
  });
