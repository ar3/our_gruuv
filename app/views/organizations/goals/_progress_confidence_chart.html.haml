-# Renders the progress confidence chart (red/yellow/green bands + actual check-in points).
-# Expects: progress_chart_data (hash from Goals::ProgressChartDataBuilder), optional chart_dom_id (default: goal-progress-confidence-chart)
- progress_chart_data = local_assigns[:progress_chart_data]
- chart_dom_id = local_assigns.fetch(:chart_dom_id, 'goal-progress-confidence-chart')
- if progress_chart_data.present?
  %div
    %div{id: chart_dom_id, style: "height: 400px;"}
    %p.small.text-muted.mt-2.mb-0
      Colored bands show on-track zones by week. Blue points are your actual check-ins.
    - if progress_chart_data[:thresholds_table].present?
      .mt-3
        %a.btn.btn-outline-secondary.btn-sm{"data-bs-toggle" => "collapse", "data-bs-target" => "##{chart_dom_id}-thresholds-table-collapse", "aria-expanded" => "false", "aria-controls" => "#{chart_dom_id}-thresholds-table-collapse", href: "#"}
          %i.bi.bi-table.me-1
          Thresholds by week
        .collapse.mt-2{id: "#{chart_dom_id}-thresholds-table-collapse"}
          .table-responsive
            %table.table.table-sm.table-bordered
              %thead
                %tr
                  %th
                  - progress_chart_data[:thresholds_table].each do |row|
                    %th.text-center= row[:week]
              %tbody
                %tr
                  %th.text-nowrap{scope: "row"}= "behind_schedule_if_confidence_below".humanize
                  - progress_chart_data[:thresholds_table].each do |row|
                    %td.text-center= "#{row[:behind_schedule_if_confidence_below]}%"
                %tr
                  %th.text-nowrap{scope: "row"}= "on_schedule_if_confidence_above".humanize
                  - progress_chart_data[:thresholds_table].each do |row|
                    %td.text-center= "#{row[:on_schedule_if_confidence_above]}%"
                %tr
                  %th.text-nowrap{scope: "row"}= "ahead_of_schedule_if_confidence_above".humanize
                  - progress_chart_data[:thresholds_table].each do |row|
                    %td.text-center= "#{row[:ahead_of_schedule_if_confidence_above]}%"
                %tr
                  %th.text-nowrap{scope: "row"}= "check_in_confidence".humanize
                  - progress_chart_data[:thresholds_table].each do |row|
                    %td.text-center= row[:check_in_confidence].present? ? "#{row[:check_in_confidence]}%" : "â€”"
  :javascript
    (function() {
    var chartData = #{progress_chart_data.to_json};
    var chartDomId = #{chart_dom_id.to_json};
    function initProgressChart() {
      if (typeof Highcharts === 'undefined') return;
      var el = document.getElementById(chartDomId);
      if (!el || !chartData.series || chartData.series.length === 0) return;
      var series = chartData.series.map(function(s) {
        var opts = { name: s.name, data: s.data };
        if (s.color) opts.color = s.color;
        if (s.type === 'scatter') {
          opts.type = 'scatter';
          opts.marker = s.marker || { radius: 6 };
        } else if (s.type === 'area') {
          opts.type = 'area';
          opts.stacking = s.stack ? 'normal' : undefined;
          opts.stack = s.stack;
          opts.fillOpacity = 0.7;
          opts.lineWidth = 0;
          opts.states = { inactive: { opacity: 1 } };
        }
        return opts;
      });
      Highcharts.chart(chartDomId, {
        chart: { type: 'area' },
        title: { text: null },
        accessibility: { enabled: false },
        xAxis: { type: 'datetime', title: { text: 'Week (Monday)' } },
        yAxis: {
          min: 0,
          max: 100,
          title: { text: 'Confidence %' },
          stackLabels: { enabled: false }
        },
        tooltip: {
          shared: true,
          crosshairs: true,
          formatter: function() {
            var d = this.points && this.points[0];
            if (!d) return '';
            var dateStr = Highcharts.dateFormat('%b %d, %Y', d.point.x);
            var idx = -1;
            if (chartData.series[0] && chartData.series[0].data) {
              for (var i = 0; i < chartData.series[0].data.length; i++) {
                if (chartData.series[0].data[i][0] === d.point.x) { idx = i; break; }
              }
            }
            if (idx >= 0 && chartData.thresholds_table && chartData.thresholds_table[idx]) {
              var t = chartData.thresholds_table[idx];
              var parts = ['<b>' + dateStr + '</b>',
                'Ahead of schedule (above): ' + t.ahead_of_schedule_if_confidence_above + '%',
                'On schedule (above): ' + t.on_schedule_if_confidence_above + '%',
                'Behind schedule (below): ' + t.behind_schedule_if_confidence_below + '%'];
              var actualPoint = this.points && this.points.find(function(p) { return p.series.name === 'Actual confidence'; });
              if (actualPoint && actualPoint.y != null) {
                parts.push('Actual confidence: ' + Math.round(actualPoint.y) + '%');
              }
              return parts.join('<br/>');
            }
            var lines = this.points ? this.points.map(function(p) { return p.series.name + ': ' + (p.y != null ? Math.round(p.y) + '%' : ''); }).filter(Boolean) : [];
            return '<b>' + dateStr + '</b><br/>' + lines.join('<br/>');
          }
        },
        plotOptions: {
          area: { stacking: 'normal', lineWidth: 0, marker: { enabled: false } },
          scatter: { marker: { radius: 6 } }
        },
        series: series
      });
    }
    function waitForHighcharts() {
      if (typeof Highcharts !== 'undefined') {
        initProgressChart();
      } else {
        var script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.3.0/highcharts.js';
        script.onload = initProgressChart;
        document.head.appendChild(script);
      }
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', waitForHighcharts);
    } else {
      waitForHighcharts();
    }
    })();
