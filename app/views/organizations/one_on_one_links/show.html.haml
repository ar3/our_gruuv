- content_for :header do
  %h1.mb-0 1:1 Area for #{@person.display_name}
  %p.text-muted.mb-0 Manage your 1:1 link and integration

- content_for :go_back_link do
  = link_to organization_person_check_ins_path(@organization, @person), class: "go-back-link" do
    %i.bi.bi-arrow-left.me-2
    Back to Check-Ins

.card
  .card-body
    = form_with model: [@organization, @person, @one_on_one_link], url: organization_person_one_on_one_link_path(@organization, @person), method: :patch, local: true do |f|
      .mb-3
        = f.label :url, "1:1 Link URL", class: "form-label"
        = f.url_field :url, class: "form-control", placeholder: "https://app.asana.com/0/123456/789 or https://docs.google.com/..."
        - if @one_on_one_link.errors[:url].any?
          .invalid-feedback.d-block
            = @one_on_one_link.errors[:url].join(', ')
        %small.form-text.text-muted
          Enter a link to your 1:1 document, project, or system. 
          %br
          Supported systems: Asana (with integration), Google Docs, Notion, etc.
      
      - if @one_on_one_link.url.present?
        .mb-3
          %strong Current Link:
          = link_to @one_on_one_link.url, @one_on_one_link.url, target: '_blank', rel: 'noopener noreferrer', class: "ms-2"
          - if @one_on_one_link.is_asana_link?
            %span.badge.bg-info.ms-2 Asana Project Detected
      
      - if @one_on_one_link.is_asana_link? && !@one_on_one_link.has_deep_integration?
        .alert.alert-info
          %strong Asana Project Detected
          %p.mb-2
            This appears to be an Asana project link. 
            %br
            To enable full integration (sections, tasks, etc.), you'll need to connect your Asana account.
          - if @teammate && !@teammate.has_asana_identity?
            %p.mb-2
              = link_to asana_oauth_authorize_organization_person_one_on_one_link_path(@organization, @person), 
                        class: "btn btn-primary" do
                %i.bi.bi-link-45deg.me-2
                Connect Your Asana Account
          - elsif @teammate && @teammate.has_asana_identity?
            %p.mb-0.text-success
              %i.bi.bi-check-circle.me-2
              Asana account connected. Integration will be enabled after saving.
      
      - if @one_on_one_link.has_deep_integration?
        .alert.alert-success.mb-3
          %strong Deep Integration Active
          %p.mb-0
            This 1:1 is fully integrated. 
            %br
            - if @one_on_one_link.asana_project_id
              Asana Project ID: #{@one_on_one_link.asana_project_id}
        
        -# Display Asana project data if available
        - if @one_on_one_link.is_asana_link? && @teammate&.has_asana_identity? && @asana_sections&.any?
          .mt-3.mb-3
            %h5.mb-3 Project Sections & Tasks
            - @asana_sections.each do |section|
              .card.mb-3
                .card-header
                  %strong= section['name'] || 'Unnamed Section'
                .card-body
                  - section_tasks = @asana_section_tasks[section['gid']] || []
                  - if section_tasks.any?
                    %ul.list-unstyled.mb-0
                      - section_tasks.each do |task|
                        %li.mb-2
                          %i.bi.bi-circle.me-2
                          - task_url = AsanaService.task_url(task['gid'], @one_on_one_link.asana_project_id)
                          = link_to task['name'], task_url, target: '_blank', rel: 'noopener noreferrer', class: 'text-decoration-none'
                          - if task['due_on']
                            %small.text-muted.ms-2
                              Due: #{Date.parse(task['due_on']).strftime('%b %d, %Y')}
                  - else
                    %p.text-muted.mb-0 No incomplete tasks in this section.
        - elsif @one_on_one_link.is_asana_link? && @teammate&.has_asana_identity?
          .alert.alert-info.mb-3
            %p.mb-0
              %i.bi.bi-info-circle.me-2
              Project data will be displayed here once fetched. If you just saved the link, try refreshing the page.
      
      .d-flex.gap-2
        = f.submit "Save 1:1 Link", class: "btn btn-primary"
        = link_to "Cancel", organization_person_check_ins_path(@organization, @person), class: "btn btn-outline-secondary"

