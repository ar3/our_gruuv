-# Local variables expected:
  -# - snapshot: MaapSnapshot instance
  -# - show_checkbox: boolean, whether to show checkbox column (for pending acknowledgements)
  -# - person: Person instance
  -# - organization: Organization instance
  -# - previous_snapshot: MaapSnapshot instance (the chronologically previous snapshot, or nil if first)
- all_fields = format_snapshot_all_fields(snapshot, person, organization, previous_snapshot: previous_snapshot)
- has_data = all_fields.present? && (all_fields[:employment].present? || all_fields[:assignments].present? || all_fields[:abilities].present? || all_fields[:aspirations].present?)
- # Calculate total columns: checkbox (if shown) + date + created_by + reason + status (if not checkbox) + acknowledgement (if shown) + details
- total_cols = (show_checkbox ? 1 : 0) + 3 + (show_checkbox ? 0 : 1) + 1 + 1
%tr
  - if show_checkbox
    %td
      = check_box_tag 'snapshot_ids[]', snapshot.id, false, 
                      class: 'snapshot-checkbox',
                      id: "snapshot_#{snapshot.id}"
  %td
    = format_time_in_user_timezone(snapshot.created_at, format: "%Y-%m-%d %I:%M %p")
  %td
    = snapshot.creator_company_teammate&.person&.display_name || "System"
  %td
    = truncate(snapshot.reason, length: 50)
  - unless show_checkbox
    %td
      - if snapshot.executed?
        - executed_popover = executed_popover_content(snapshot)
        - if executed_popover.present?
          %span.badge.bg-success{"data-bs-toggle" => "popover", "data-bs-trigger" => "hover", "data-bs-placement" => "top", "data-bs-html" => "true", "data-bs-content" => executed_popover, style: "cursor: pointer;"} Executed
        - else
          %span.badge.bg-success Executed
        %br
        %small.text-muted= "on #{format_date_in_user_timezone(snapshot.effective_date, format: '%Y-%m-%d')}"
      - else
        %span.badge.bg-warning Pending
  %td
    - if snapshot.executed?
      - if snapshot.acknowledged?
        - acknowledged_popover = acknowledged_popover_content(snapshot)
        - if acknowledged_popover.present?
          %span.badge.bg-success{"data-bs-toggle" => "popover", "data-bs-trigger" => "hover", "data-bs-placement" => "top", "data-bs-html" => "true", "data-bs-content" => acknowledged_popover, style: "cursor: pointer;"}
            %i.bi.bi-check-circle.me-1
            Acknowledged
        - else
          %span.badge.bg-success
            %i.bi.bi-check-circle.me-1
            Acknowledged
        %br
        %small.text-muted= "on #{format_date_in_user_timezone(snapshot.employee_acknowledged_at, format: '%Y-%m-%d')}"
      - else
        %span.badge.bg-warning
          %i.bi.bi-exclamation-triangle.me-1
          Pending
    - else
      %span.text-muted.text-decoration-none
        %i.bi.bi-clock.me-1
        Not Executed
  %td
    - if has_data
      %a.text-decoration-none{"data-bs-toggle" => "collapse", "data-bs-target" => "#snapshot_#{snapshot.id}_details", "aria-expanded" => "false", "aria-controls" => "snapshot_#{snapshot.id}_details", style: "cursor: pointer;"}
        %span.not-collapsed
          %i.bi.bi-chevron-up.me-1
          %small.text-muted Hide details
        %span.collapsed
          %i.bi.bi-chevron-down.me-1
          %small.text-muted Show details
    - else
      %small.text-muted No data to display

- if has_data
  %tr
    %td{colspan: total_cols, style: "padding: 0;"}
      .collapse{id: "snapshot_#{snapshot.id}_details"}
        .card.border-light.m-2
          .card-body
            - if all_fields[:employment].present?
              .mb-3
                .d-flex.justify-content-between.align-items-center.mb-2
                  %h6.text-muted.mb-0
                    %i.bi.bi-briefcase.me-2
                    Position
                  .form-check
                    = check_box_tag "show_changes_#{snapshot.id}_employment", "1", true, class: "form-check-input audit-show-changes-toggle", id: "show_changes_#{snapshot.id}_employment", data: { section: "employment", snapshot_id: snapshot.id }
                    = label_tag "show_changes_#{snapshot.id}_employment", "Only show changes", class: "form-check-label small text-muted"
                %table.table.table-sm.table-bordered.audit-details-table
                  %thead
                    %tr
                      %th{style: "width: 40%;"} Field
                      %th{style: "width: 30%;"} Old
                      %th{style: "width: 30%;"} New
                  %tbody{id: "audit_#{snapshot.id}_employment"}
                    - all_fields[:employment].each do |field|
                      - row_class = field[:old] == field[:new] ? "audit_value_row audit_value_row_no_diff" : "audit_value_row audit_value_row_diff"
                      %tr{class: row_class}
                        %td= field[:label]
                        %td= field[:old]
                        %td= field[:new]
            
            - if all_fields[:assignments].present?
              .mb-3
                .d-flex.justify-content-between.align-items-center.mb-2
                  %h6.text-muted.mb-0
                    %i.bi.bi-clipboard-check.me-2
                    Assignments
                  .form-check
                    = check_box_tag "show_changes_#{snapshot.id}_assignments", "1", true, class: "form-check-input audit-show-changes-toggle", id: "show_changes_#{snapshot.id}_assignments", data: { section: "assignments", snapshot_id: snapshot.id }
                    = label_tag "show_changes_#{snapshot.id}_assignments", "Only show changes", class: "form-check-label small text-muted"
                - all_fields[:assignments].each do |assignment|
                  .mb-3
                    %strong= assignment[:assignment_name]
                    %table.table.table-sm.table-bordered.mt-2.audit-details-table
                      %thead
                        %tr
                          %th{style: "width: 40%;"} Field
                          %th{style: "width: 30%;"} Old
                          %th{style: "width: 30%;"} New
                      %tbody{id: "audit_#{snapshot.id}_assignments_#{assignment[:assignment_id]}"}
                        - assignment[:fields].each do |field|
                          - row_class = field[:old] == field[:new] ? "audit_value_row audit_value_row_no_diff" : "audit_value_row audit_value_row_diff"
                          %tr{class: row_class}
                            %td= field[:label]
                            %td= field[:old]
                            %td= field[:new]
            
            - if all_fields[:abilities].present?
              .mb-3
                .d-flex.justify-content-between.align-items-center.mb-2
                  %h6.text-muted.mb-0
                    %i.bi.bi-trophy.me-2
                    Abilities
                  .form-check
                    = check_box_tag "show_changes_#{snapshot.id}_abilities", "1", true, class: "form-check-input audit-show-changes-toggle", id: "show_changes_#{snapshot.id}_abilities", data: { section: "abilities", snapshot_id: snapshot.id }
                    = label_tag "show_changes_#{snapshot.id}_abilities", "Only show changes", class: "form-check-label small text-muted"
                - all_fields[:abilities].each do |ability|
                  .mb-3
                    %strong= ability[:ability_name]
                    %table.table.table-sm.table-bordered.mt-2.audit-details-table
                      %thead
                        %tr
                          %th{style: "width: 40%;"} Field
                          %th{style: "width: 30%;"} Old
                          %th{style: "width: 30%;"} New
                      %tbody{id: "audit_#{snapshot.id}_abilities_#{ability[:ability_id]}"}
                        - ability[:fields].each do |field|
                          - row_class = field[:old] == field[:new] ? "audit_value_row audit_value_row_no_diff" : "audit_value_row audit_value_row_diff"
                          %tr{class: row_class}
                            %td= field[:label]
                            %td= field[:old]
                            %td= field[:new]
            
            - if all_fields[:aspirations].present?
              .mb-3
                .d-flex.justify-content-between.align-items-center.mb-2
                  %h6.text-muted.mb-0
                    %i.bi.bi-star.me-2
                    Aspirations
                  .form-check
                    = check_box_tag "show_changes_#{snapshot.id}_aspirations", "1", true, class: "form-check-input audit-show-changes-toggle", id: "show_changes_#{snapshot.id}_aspirations", data: { section: "aspirations", snapshot_id: snapshot.id }
                    = label_tag "show_changes_#{snapshot.id}_aspirations", "Only show changes", class: "form-check-label small text-muted"
                - all_fields[:aspirations].each do |aspiration|
                  .mb-3
                    %strong= aspiration[:aspiration_name]
                    %table.table.table-sm.table-bordered.mt-2.audit-details-table
                      %thead
                        %tr
                          %th{style: "width: 40%;"} Field
                          %th{style: "width: 30%;"} Old
                          %th{style: "width: 30%;"} New
                      %tbody{id: "audit_#{snapshot.id}_aspirations_#{aspiration[:aspiration_id]}"}
                        - aspiration[:fields].each do |field|
                          - row_class = field[:old] == field[:new] ? "audit_value_row audit_value_row_no_diff" : "audit_value_row audit_value_row_diff"
                          %tr{class: row_class}
                            %td= field[:label]
                            %td= field[:old]
                            %td= field[:new]

