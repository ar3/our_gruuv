- content_for :header do
  %h1.mb-0
    %i.bi.bi-clock-history.me-2
    = @person.display_name
    %small.text-muted.ms-2 (Audit View)
    - if current_person == @person && @pending_snapshots&.any?
      %span.badge.bg-warning.ms-2 #{@pending_snapshots.count} Pending

- content_for :header_action do
  = render 'people/view_switcher'

- content_for :go_back_link do
  = link_to organization_employees_path(@organization), class: "text-muted text-decoration-none" do
    %i.bi.bi-arrow-left.me-2
    ="Back to Employees in #{@organization.display_name}"

-# Pending Acknowledgements Section (for employees only)
- if current_person == @person && @pending_snapshots&.any?
  .row.mb-4
    .col-12
      .card.border-warning
        .card-header.bg-warning.text-dark
          %h5.mb-0
            %i.bi.bi-exclamation-triangle.me-2
            Pending Acknowledgements
          %small You have #{@pending_snapshots.count} finalized check-in#{'s' if @pending_snapshots.count != 1} that need your acknowledgement
        
        .card-body
          = form_with url: acknowledge_snapshots_organization_employee_path(@organization, @person), method: :patch, local: true do |f|
            .table-responsive
              %table.table.table-sm
                %thead
                  %tr
                    %th{style: "width: 40px;"}
                      = check_box_tag 'select_all', '1', false, id: 'select_all_snapshots'
                      = label_tag 'select_all_snapshots', 'All', class: 'form-check-label ms-1'
                    %th Date Finalized
                    %th Change Type
                    %th Finalized By
                    %th Reason
                    %th Actions
                %tbody
                  - @pending_snapshots.each do |snapshot|
                    %tr
                      %td
                        = check_box_tag 'snapshot_ids[]', snapshot.id, false, 
                                        class: 'snapshot-checkbox',
                                        id: "snapshot_#{snapshot.id}"
                      %td
                        = snapshot.created_at.strftime("%Y-%m-%d %I:%M %p")
                      %td
                        %span.badge.bg-primary= snapshot.change_type.humanize
                      %td
                        = snapshot.created_by&.display_name || "System"
                      %td
                        = truncate(snapshot.reason, length: 50)
                      %td
                        = link_to 'View Details', '#', 
                                  class: 'btn btn-sm btn-outline-info',
                                  data: { bs_toggle: 'modal', bs_target: "#snapshot_#{snapshot.id}_modal" }
            
            .mt-3
              = f.submit 'Acknowledge Selected Check-ins', 
                        class: 'btn btn-success',
                        data: { confirm: 'Are you sure you want to acknowledge the selected check-ins?' }
              %small.text-muted.ms-3 Select the check-ins you want to acknowledge

-# MAAP Change History Section
.row
  .col-12
    .card
      .card-header
        %h5.mb-0
          %i.bi.bi-file-earmark-text.me-2
          MAAP Change History
        %small.text-muted MAAP snapshots for #{@person.display_name} in #{@organization.display_name}
      
      .card-body
        - if @maap_snapshots.any?
          .table-responsive
            %table.table.table-hover
              %thead
                %tr
                  %th Date
                  %th Change Type
                  %th Created By
                  %th Reason
                  %th Status
                  - if current_person == @person
                    %th Acknowledgement
              %tbody
                - @maap_snapshots.each do |snapshot|
                  %tr
                    %td
                      = snapshot.created_at.strftime("%Y-%m-%d %I:%M %p")
                    %td
                      %span.badge.bg-primary= snapshot.change_type.humanize
                    %td
                      = snapshot.created_by&.display_name || "System"
                    %td
                      = truncate(snapshot.reason, length: 50)
                    %td
                      - if snapshot.executed?
                        %span.badge.bg-success Executed
                        %br
                        %small.text-muted= "on #{snapshot.effective_date.strftime('%Y-%m-%d')}"
                      - else
                        %span.badge.bg-warning Pending
                    - if current_person == @person
                      %td
                        - if snapshot.executed?
                          - if snapshot.acknowledged?
                            %span.badge.bg-success
                              %i.bi.bi-check-circle.me-1
                              Acknowledged
                            %br
                            %small.text-muted= "on #{snapshot.employee_acknowledged_at.strftime('%Y-%m-%d')}"
                          - else
                            %span.badge.bg-warning
                              %i.bi.bi-exclamation-triangle.me-1
                              Pending
                        - else
                          %span.text-muted.text-decoration-none
                            %i.bi.bi-clock.me-1
                            Not Executed
                    -# %td
                    -#   - if snapshot.executed?
                    -#     %span.text-muted.text-decoration-none
                    -#       %i.bi.bi-eye.me-1
                    -#       View Details
                    -#   - else
                    -#     = link_to execute_changes_organization_person_path(@organization, @person, snapshot), class: "btn btn-sm btn-outline-primary" do
                    -#       %i.bi.bi-play-circle.me-1
                    -#       Execute
        - else
          .text-center.py-5
            %i.bi.bi-clock-history.text-muted{style: "font-size: 3rem;"}
            %h5.text-muted.mt-3 No MAAP Changes Found
            %p.text-muted No MAAP snapshots have been created for #{@person.display_name} in #{@organization.display_name}.

-# JavaScript for Select All functionality
:javascript
  document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('select_all_snapshots');
    const snapshotCheckboxes = document.querySelectorAll('.snapshot-checkbox');
    
    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener('change', function() {
        snapshotCheckboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
        });
      });
      
      // Update "Select All" when individual checkboxes change
      snapshotCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const checkedCount = document.querySelectorAll('.snapshot-checkbox:checked').length;
          selectAllCheckbox.checked = checkedCount === snapshotCheckboxes.length;
          selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < snapshotCheckboxes.length;
        });
      });
    }
  });
