- content_for :header do
  .d-flex.align-items-center
    %h1.mb-0.me-2
      %i.bi.bi-people.me-2
      Teammates
    .d-flex.align-items-center
      - if current_person.can_manage_employment?(@organization)
        = link_to new_employee_organization_employees_path(@organization), class: "btn btn-primary ml-2" do
          %i.bi.bi-plus
      - else
        .btn.btn-primary.disabled{style: "opacity: 0.6; cursor: not-allowed;"}
          %i.bi.bi-plus
        %i.bi.bi-exclamation-triangle.text-warning.ms-2{"data-bs-toggle" => "tooltip", "data-bs-title" => "You need employment management permission to add teammates"}

.mb-4
  = content_for :go_back_link  # Single back link to dashboard

- content_for :go_back_link do
  = link_to organization_path(@organization), class: "go-back-link" do
    %i.bi.bi-arrow-left.me-2
    Back to #{@organization.display_name}

- content_for :header_action do
  %button.btn.btn-outline-secondary{"data-bs-toggle" => "modal", "data-bs-target" => "#teammates-filter-modal", type: "button"}
    %i.bi.bi-funnel.me-2
    Filter & Sort

/ Spotlight Section
= render 'organizations/employees/spotlights/teammates_overview'

/ Active Filters Display
- if @has_active_filters
  .row.justify-content-center.mb-3
    .col-lg-12
      .d-flex.flex-wrap.gap-2.align-items-center
        %span.text-muted.me-2 Active Filters:
        - @current_filters.each do |filter_name, filter_value|
          - Array(filter_value).each do |value|
            %span.badge.bg-primary.d-flex.align-items-center.gap-1
              = filter_display_name(filter_name, value)
              = link_to "Ã—", clear_filter_url(filter_name, value), class: "text-white text-decoration-none ms-1"
        = link_to "Clear All", organization_employees_path(@organization), class: "btn btn-sm btn-outline-secondary"

/ Pagination Info
.row.justify-content-center.mb-2
  .col-lg-12
    .d-flex.justify-content-between.align-items-center
      %small.text-muted== pagy_info(@pagy)
      - if @teammates.count > 0
        %small.text-muted Showing #{@current_view.humanize} view
        %br
        %small.text-muted Debug: Pages: #{@pagy.pages}, Current: #{@pagy.page}, Items: #{@pagy.items}

/ Main Content Area
.row.justify-content-center
  .col-lg-12
    - if @teammates.any?
      - case @current_view
      - when 'cards'
        = render 'organizations/employees/card_view'
      - when 'list'
        = render 'organizations/employees/list_view'
      - else
        = render 'organizations/employees/table_view'
      
      / Pagination
      .d-flex.justify-content-center.mt-4
        - if @pagy.pages > 1
          .pagination-debug
            %small.text-muted Debug: About to render pagination
            %br
            %small.text-muted Raw pagy_nav output:
            %pre.border.p-2.mt-2= pagy_nav(@pagy)
            %br
            %small.text-muted Rendered pagy_nav:
            == pagy_nav(@pagy)
        - else
          %small.text-muted No pagination needed (only 1 page)
    - else
      .alert.alert-info
        %h6.mb-2
          %i.bi.bi-info-circle.me-2
          No Teammates Found
        %p.mb-2 
          - if @has_active_filters
            No teammates match your current filters. Try adjusting your filter settings.
          - else
            This organization doesn't have any teammates yet. Teammates include employees, followers, and other people with access to the organization.
        - unless @has_active_filters
          = link_to "Add First Teammate", new_employee_organization_employees_path(@organization), class: "btn btn-primary btn-sm"

/ Modal for Filter & Sort
.modal.fade#teammates-filter-modal{"aria-hidden" => "true", "aria-labelledby" => "teammates-filter-modal-label", tabindex: "-1"}
  .modal-dialog.modal-lg
    .modal-content
      .modal-header
        %h5.modal-title#teammates-filter-modal-label
          %i.bi.bi-funnel.me-2
          Filter & Sort Teammates
        %button.btn-close{"aria-label" => "Close", "data-bs-dismiss" => "modal", type: "button"}
      = form_tag organization_employees_path(@organization), method: :get, local: true do
        .modal-body
          .row
            .col-md-6
              %h6.mb-3
                %i.bi.bi-funnel.me-2
                Filters
              .mb-3
                %label.form-label Employment Status
                .form-check
                  = check_box_tag 'status[]', 'follower', @current_filters[:status]&.include?('follower'), class: 'form-check-input', id: 'filter_followers'
                  = label_tag 'filter_followers', 'Followers', class: 'form-check-label'
                .form-check
                  = check_box_tag 'status[]', 'huddler', @current_filters[:status]&.include?('huddler'), class: 'form-check-input', id: 'filter_huddlers'
                  = label_tag 'filter_huddlers', 'Huddlers', class: 'form-check-label'
                .form-check
                  = check_box_tag 'status[]', 'unassigned_employee', @current_filters[:status]&.include?('unassigned_employee'), class: 'form-check-input', id: 'filter_unassigned'
                  = label_tag 'filter_unassigned', 'Unassigned Employees', class: 'form-check-label'
                .form-check
                  = check_box_tag 'status[]', 'assigned_employee', @current_filters[:status]&.include?('assigned_employee'), class: 'form-check-input', id: 'filter_assigned'
                  = label_tag 'filter_assigned', 'Active Employees', class: 'form-check-label'
                .form-check
                  = check_box_tag 'status[]', 'terminated', @current_filters[:status]&.include?('terminated'), class: 'form-check-input', id: 'filter_terminated'
                  = label_tag 'filter_terminated', 'Terminated', class: 'form-check-label'
              .mb-3
                %label.form-label Organization
                = select_tag 'organization_id', options_from_collection_for_select([@organization] + @organization.descendants, :id, :name, @current_filters[:organization_id]), { include_blank: 'All Organizations', class: 'form-select' }
              .mb-3
                %label.form-label Permissions
                .form-check
                  = check_box_tag 'permission[]', 'employment_mgmt', @current_filters[:permission]&.include?('employment_mgmt'), class: 'form-check-input', id: 'perm_employment_mgmt'
                  = label_tag 'perm_employment_mgmt', 'Employment Management', class: 'form-check-label'
                .form-check
                  = check_box_tag 'permission[]', 'employment_create', @current_filters[:permission]&.include?('employment_create'), class: 'form-check-input', id: 'perm_employment_create'
                  = label_tag 'perm_employment_create', 'Employment Creation', class: 'form-check-label'
                .form-check
                  = check_box_tag 'permission[]', 'maap_mgmt', @current_filters[:permission]&.include?('maap_mgmt'), class: 'form-check-input', id: 'perm_maap_mgmt'
                  = label_tag 'perm_maap_mgmt', 'MAAP Management', class: 'form-check-label'
            .col-md-6
              %h6.mb-3
                %i.bi.bi-sort-down.me-2
                Sort Options
              .mb-3
                %label.form-label Sort By
                = select_tag 'sort', options_for_select([['Name (A-Z)', 'name_asc'], ['Name (Z-A)', 'name_desc'], ['Employment Status', 'status'], ['Organization', 'organization'], ['Employment Date', 'employment_date']], @current_sort), class: 'form-select'
              .mb-3
                %label.form-label View Style
                .form-check
                  = radio_button_tag 'view', 'table', @current_view == 'table', class: 'form-check-input', id: 'view_table'
                  = label_tag 'view_table', 'Table View', class: 'form-check-label'
                .form-check
                  = radio_button_tag 'view', 'cards', @current_view == 'cards', class: 'form-check-input', id: 'view_cards'
                  = label_tag 'view_cards', 'Card View', class: 'form-check-label'
                .form-check
                  = radio_button_tag 'view', 'list', @current_view == 'list', class: 'form-check-input', id: 'view_list'
                  = label_tag 'view_list', 'List View', class: 'form-check-label'
        .modal-footer
          = link_to "Clear Filters", organization_employees_path(@organization), class: "btn btn-secondary"
          %button.btn.btn-primary{type: "submit"}
            %i.bi.bi-check.me-2
            Apply Filters
