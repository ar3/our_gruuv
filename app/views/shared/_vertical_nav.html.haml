- nav_structure = visible_navigation_structure
- prefs = current_user_preferences
- is_locked = prefs&.vertical_nav_locked? || false
- is_open = is_locked ? true : (prefs&.vertical_nav_open? || false)

/ Backdrop for mobile overlay
.vertical-nav-backdrop

.vertical-nav{data: { controller: "vertical-nav", vertical_nav_target: "nav", open: is_open.to_s, locked: is_locked.to_s }, class: "#{'open' if is_open} #{'locked' if is_locked}"}
  .vertical-nav-header
    %h5.mb-0 Navigation
    .vertical-nav-controls
      = button_to vertical_nav_user_preferences_path, method: :patch, params: { locked: !is_locked, open: true }, class: "btn btn-sm btn-link vertical-nav-lock-btn", title: is_locked ? "Unlock navigation" : "Lock navigation open", form: { style: "display: inline;" } do
        - if is_locked
          %i.bi.bi-pin-fill
        - else
          %i.bi.bi-pin
      - unless is_locked
        %button.btn.btn-sm.btn-link.vertical-nav-close-btn{type: "button", title: "Close navigation", data: { vertical_nav_target: "closeBtn", action: "click->vertical-nav#close" }}
          %i.bi.bi-x-lg
  
  .vertical-nav-body
    %nav.nav.flex-column
      - nav_structure.each do |section|
        - if section[:section].nil?
          / Dashboard link (no section)
          = link_to section[:path], class: "nav-link #{'active' if nav_item_active?(section[:path])}" do
            %i.bi{class: section[:icon]}
            = section[:label]
        - else
          / Section with items
          - visible_items = visible_nav_items(section[:items])
          - section_has_active = section_has_active_item?(visible_items)
          .nav-section
            %button.nav-section-toggle.btn.btn-link{type: "button", "data-bs-toggle": "collapse", "data-bs-target": "#navSection#{section[:section].capitalize}", "aria-expanded": section_has_active.to_s}
              %i.bi{class: section[:icon]}
              = section[:label]
              %i.bi.bi-chevron-down.float-end
            .collapse{id: "navSection#{section[:section].capitalize}", class: "#{'show' if section_has_active}"}
              - visible_items.each do |item|
                = link_to item[:path], class: "nav-link nav-item-link #{'active' if nav_item_active?(item[:path])}" do
                  %i.bi{class: item[:icon]}
                  = item[:label]
                  - if item[:coming_soon]
                    %span.badge.bg-secondary.ms-2 Coming Soon
    
      / Recently Visited section (last nav section)
      - if current_person && recent_page_visits.any?
        - recent_visits_has_active = recent_page_visits.any? { |visit| nav_item_active?(visit.url) }
        .nav-section
          %button.nav-section-toggle.btn.btn-link{type: "button", "data-bs-toggle": "collapse", "data-bs-target": "#navSectionRecentlyVisited", "aria-expanded": recent_visits_has_active.to_s}
            %i.bi.bi-clock-history
            Recently Visited
            %i.bi.bi-chevron-down.float-end
          .collapse{id: "navSectionRecentlyVisited", class: "#{'show' if recent_visits_has_active}"}
            - if recent_page_visits.any?
              - recent_page_visits.each do |visit|
                = link_to visit.url, class: "nav-link nav-item-link #{'active' if nav_item_active?(visit.url)}" do
                  = visit.page_title
            - else
              .nav-link.nav-item-link.text-muted
                No recent visits

