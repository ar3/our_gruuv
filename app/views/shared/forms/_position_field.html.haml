.mb-3
  = form.label :position_id, "Position", class: "form-label"
  - if positions_by_department.present?
    - # Build grouped options for select
    - grouped_options = []
    - organization = positions_by_department.keys.find { |org| org.is_a?(Organization) && !org.is_a?(Department) }
    - departments = positions_by_department.keys.select { |org| org.is_a?(Department) }.sort_by(&:display_name)

    - # Add organization positions first if they exist
    - if organization && positions_by_department[organization].any?
      - org_positions = positions_by_department[organization].map { |p| [p.display_name, p.id] }
      - grouped_options << [organization.display_name, org_positions]

    - # Add department positions
    - departments.each do |dept|
      - if positions_by_department[dept].any?
        - dept_positions = positions_by_department[dept].map { |p| [p.display_name, p.id] }
        - grouped_options << [dept.display_name, dept_positions]

    = form.select :position_id,
      grouped_options_for_select(grouped_options, form.object.position_id),
      { prompt: 'Select a position' },
      { class: "form-select", required: true, disabled: disabled }
  - else
    - # Fall back to simple collection_select for backward compatibility
    = form.collection_select :position_id, positions || [], :id, :display_name,
      { prompt: 'Select a position', selected: form.object.position_id },
      { class: "form-select", required: true, disabled: disabled }
