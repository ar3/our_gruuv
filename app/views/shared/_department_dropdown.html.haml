- company = organization.root_company || organization
- departments = company ? company.descendants.select { |org| org.type == 'Department' } : []
- # Exclude specified IDs (for parent selection, exclude self and descendants)
- exclude_ids = exclude_ids || []
- departments = departments.reject { |dept| exclude_ids.include?(dept.id) }
- # Sort departments so that children appear immediately after their parent
- # display_name includes full hierarchy (e.g., "Company > c > 1"), so string sorting
- # naturally groups children right after their parent: a, b, c, c > 1, c > 2, d
- sorted_departments = departments.sort_by { |dept| dept.display_name }
- # Build options: only departments (no company)
- department_options = sorted_departments.map { |dept| [dept.display_name, dept.id] }
- # Add company option if include_root_option is true (for parent selection, indicates root/company level)
- if include_root_option && company
  - department_options = [[company.name, company.id]] + department_options
- # Add "No Department" option if include_blank is true (for seats where department is optional)
- # "No Department" should be first and the default when no selection is provided
- if include_blank
  - department_options = [['No Department', '']] + department_options
- # Default to empty string if no selection provided (for blank option), otherwise use selected value
- default_selected_id = selected_department_id || ''
.mb-3
  = form.label field_name, label_text, class: "form-label"
  = form.select field_name, 
                department_options,
                { selected: default_selected_id },
                { class: 'form-select' }
  - if help_text.present?
    %small.form-text.text-muted= help_text

