- cache ||= local_assigns[:cache]
- cacheable ||= local_assigns[:cacheable]
- current_teammate ||= local_assigns[:current_teammate] || current_company_teammate
- source ||= local_assigns[:source]
- refresh_path ||= local_assigns[:refresh_path]

- has_identity = has_external_identity?(current_teammate, source)
- sync_error_type = flash[:sync_error_type]
- oauth_path = external_project_oauth_path(cacheable, source) if cacheable

.d-flex.flex-column.gap-2
  .d-flex.align-items-center.gap-2
    - if has_identity
      = form_with url: refresh_path, method: :post, local: true, class: "d-inline" do |f|
        = hidden_field_tag :source, source
        = f.submit "Sync Project", class: "btn btn-sm btn-outline-primary"
    - else
      = button_tag "Sync Project", type: "button", class: "btn btn-sm btn-outline-primary", disabled: true, data: { bs_toggle: "tooltip", bs_placement: "top", bs_title: "Connect your #{source_display_name(source)} account to sync" } do
        %i.bi.bi-exclamation-triangle.me-1
        Sync Project
    
    - if cache&.last_synced_at
      %small.text-muted
        Last synced: #{format_time_in_user_timezone(cache.last_synced_at, format: '%b %d, %Y at %I:%M %p')}
    - else
      %small.text-muted Never synced
  
  - if sync_error_type
    - if sync_error_type == 'token_expired' && oauth_path
      .alert.alert-warning.mb-0
        %i.bi.bi-exclamation-triangle.me-2
        Your #{source_display_name(source)} token has expired.
        = link_to "Reconnect your account", oauth_path, class: "alert-link"
    - elsif sync_error_type == 'not_authenticated' && oauth_path
      .alert.alert-info.mb-0
        %i.bi.bi-info-circle.me-2
        Please
        = link_to "connect your #{source_display_name(source)} account", oauth_path, class: "alert-link"
        to sync the project.
    - else
      .alert.alert-danger.mb-0
        %i.bi.bi-exclamation-circle.me-2
        Sync failed. Please try again.

