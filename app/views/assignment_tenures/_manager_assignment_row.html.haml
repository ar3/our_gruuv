%tr
  %td
    %strong= data[:assignment].title
    %br
    %small.text-muted
      - if data[:tenure]
        - # Check if there's a previous inactive tenure for this assignment
        - previous_tenure = data[:assignment].assignment_tenures.where(person: @person).inactive.order(:ended_at).last
        - if previous_tenure
          Went from #{previous_tenure.anticipated_energy_percentage || 0}% to #{data[:tenure].anticipated_energy_percentage || 0}% on #{previous_tenure.ended_at.strftime('%m/%d/%Y')}
        - else
          Started #{data[:tenure].started_at.strftime('%m/%d/%Y')}
      - elsif data[:most_recent_tenure]
        - most_recent = data[:most_recent_tenure]
        %small.text-muted Went from #{most_recent.anticipated_energy_percentage || 0}% to 0% on #{most_recent.ended_at.strftime('%m/%d/%Y')}
      - else
        Not started
    %br
    = link_to "Focus Assignment", person_assignment_path(@person, data[:assignment]), class: "btn btn-sm btn-outline-primary", target: "_blank"
  
  %td
    = form.select "tenure_#{data[:assignment].id}_anticipated_energy", options_for_select((0..20).map { |i| ["#{i * 5}%", i * 5] }, data[:tenure]&.anticipated_energy_percentage), { prompt: 'Select...' }, { class: "form-select form-select-sm energy-select" }
  
  %td
    = form.select "check_in_#{data[:assignment].id}_manager_rating", options_for_select([['Working to Meet Expectations', 'working_to_meet'], ['Meeting Expectations', 'meeting'], ['Exceeding Expectations', 'exceeding']], data[:open_check_in]&.manager_rating), { prompt: 'Select...' }, { class: "form-select form-select-sm", disabled: data[:open_check_in]&.manager_completed? }
  
  %td
    = form.text_area "check_in_#{data[:assignment].id}_manager_private_notes", value: data[:open_check_in]&.manager_private_notes, rows: 2, class: "form-control form-control-sm", placeholder: "Notes...", disabled: data[:open_check_in]&.manager_completed?
  
  %td.text-center
    .form-check.form-switch.d-flex.justify-content-center
      = form.check_box "check_in_#{data[:assignment].id}_manager_complete", { checked: data[:open_check_in]&.manager_completed? || false, class: "form-check-input completion-toggle", data: { target: "manager-fields-#{data[:assignment].id}" } }
  
  %td
    .completion-status
      %small.text-muted
        %strong Last completed check-in: 
        = last_completed_check_in_date(data, @person)
      
      - if data[:open_check_in]
        %br
        %small.text-muted
          %strong This check-in began: 
          #{data[:open_check_in].check_in_started_on.strftime('%m/%d/%Y')}
      
      %br
      %small.text-muted
        %strong #{@person.first_name}: 
        = check_in_status_text(data[:open_check_in], :employee)
      
      %br
      %small.text-muted
        %strong Manager: 
        = check_in_status_text(data[:open_check_in], :manager)
