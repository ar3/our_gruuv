- content_for :go_back_link do
  = link_to organization_person_check_ins_path(current_organization, @person), class: "go-back-link" do
    %i.bi.bi-arrow-left.me-2
    Back to #{@person.display_name}'s Assignments

- content_for :header do
  .d-flex.justify-content-between.align-items-center
    %h1.mb-0 #{@person.display_name} - #{@assignment.title}

- content_for :header_action do
  .btn.btn-outline-primary What should go here?



.row.justify-content-center
  .col-lg-12
    .card
      .card-header
        %h5.mb-0 Details about #{@person.display_name} and #{@assignment.title}
        %small.text-muted Assignment information and current status

      .card-body
        .row
          .col-12
            .mb-3
              .d-flex.align-items-center.justify-content-between
                %div
                  %strong.form-control-plaintext= "#{@assignment.company.display_name}'s #{@assignment.title}"
                  .form-control-plaintext= @assignment.tagline || 'No tagline available'
                %div
                  %a.text-decoration-none{"data-bs-toggle" => "collapse", "data-bs-target" => "#assignment-details", "aria-expanded" => "false", "aria-controls" => "assignment-details", style: "cursor: pointer;"}
                    %span.not-collapsed
                      %i.bi.bi-chevron-up.me-2
                      %small.text-muted (Hide details)
                    %span.collapsed
                      %i.bi.bi-chevron-down.me-2
                      %small.text-muted (Show details)

            / Collapsible Assignment Details
            .collapse{"id" => "assignment-details"}
              .card.card-body.bg-light.mt-3
                .row
                  .col-md-6
                    - if @assignment.required_activities.present?
                      .mb-3
                        %label.form-label.fw-bold Required Activities
                        .form-control-plaintext= @assignment.required_activities
                    
                    - if @assignment.handbook.present?
                      .mb-3
                        %label.form-label.fw-bold Handbook
                        .form-control-plaintext= @assignment.handbook
                    
                    / Position Connection Status
                    .mb-3
                      %label.form-label.fw-bold Position Connection
                      - if @position_assignment
                        .form-control-plaintext
                          %span.badge.bg-primary.me-2= @position_assignment.assignment_type.titleize
                          Connected to #{@current_employment.position.position_type.external_title}
                          - if @position_assignment.min_estimated_energy.present? || @position_assignment.max_estimated_energy.present?
                            %br
                            %small.text-muted= @position_assignment.energy_range_display
                      - else
                        .form-control-plaintext
                          %span.badge.bg-secondary.me-2 Unconnected
                          Not connected to #{@current_employment&.position&.position_type&.external_title || 'current position'}
                  
                  .col-md-6
                    / Assignment Outcomes
                    - if @assignment_outcomes.any?
                      .mb-3
                        %label.form-label.fw-bold Expected Outcomes
                        - @assignment_outcomes.each do |outcome|
                          .form-control-plaintext.mb-1
                            %i.bi.bi-check-circle.text-success.me-2
                            = outcome.description
                    - else
                      .mb-3
                        %label.form-label.fw-bold Expected Outcomes
                        .form-control-plaintext.text-muted No outcomes defined
                    
                    / Required Abilities
                    - if @assignment_abilities.any?
                      .mb-3
                        %label.form-label.fw-bold Required Abilities
                        - @assignment_abilities.each do |assignment_ability|
                          .form-control-plaintext.mb-1
                            %i.bi.bi-star.text-warning.me-2
                            = assignment_ability.ability.name
                            %small.text-muted (Level #{assignment_ability.milestone_level})
                    - else
                      .mb-3
                        %label.form-label.fw-bold Required Abilities
                        .form-control-plaintext.text-muted No ability requirements defined
                
                / External References
                - if @assignment.published_external_reference.present? || @assignment.draft_external_reference.present?
                  .row.mt-3
                    .col-12
                      %label.form-label.fw-bold External References
                      - if @assignment.published_external_reference.present?
                        .mb-2
                          %i.bi.bi-link-45deg.text-primary.me-2
                          %strong Published:
                          = link_to @assignment.published_external_reference.url, @assignment.published_external_reference.url, target: "_blank", class: "text-decoration-none"
                      - if @assignment.draft_external_reference.present?
                        .mb-2
                          %i.bi.bi-file-earmark-text.text-secondary.me-2
                          %strong Draft:
                          = link_to @assignment.draft_external_reference.url, @assignment.draft_external_reference.url, target: "_blank", class: "text-decoration-none"
          
        .row.mt-4
          .col-md-6
            %h6 Assignment Tenure History
            - if @tenure_history.any?
              .table-responsive
                %table.table.table-sm
                  %thead
                    %tr
                      %th Started
                      %th Ended
                      %th Energy %
                      %th Duration
                  %tbody
                    - @tenure_history.order(ended_at: :desc).each do |tenure|
                      %tr
                        %td= tenure.started_at.strftime('%m/%d/%Y')
                        %td
                          - if tenure.ended_at
                            = tenure.ended_at.strftime('%m/%d/%Y')
                          - else
                            %span.text-success Active
                        %td= "#{tenure.anticipated_energy_percentage}%"
                        %td
                          - if tenure.ended_at
                            = distance_of_time_in_words(tenure.started_at, tenure.ended_at)
                          - else
                            = distance_of_time_in_words(tenure.started_at, Date.current)
            - else
              .alert.alert-info No tenure history found.
          
          .col-md-6
            %h6 Recent Check-ins
            - if @recent_check_ins.any?
              .table-responsive
                %table.table.table-sm
                  %thead
                    %tr
                      %th Started
                      %th Status
                      %th Employee
                      %th Manager
                      %th Finalized
                  %tbody
                    - @recent_check_ins.each do |check_in|
                      %tr
                        %td= check_in.check_in_started_on.strftime('%m/%d/%Y')
                        %td
                          - if check_in.officially_completed?
                            %span.badge.bg-success Finalized
                          - elsif check_in.ready_for_finalization?
                            %span.badge.bg-warning Ready
                          - else
                            %span.badge.bg-info Open
                        %td
                          - if check_in.employee_completed?
                            %span.badge.bg-success ✓
                          - else
                            %span.badge.bg-warning Pending
                        %td
                          - if check_in.manager_completed?
                            %span.badge.bg-success ✓
                          - else
                            %span.badge.bg-warning Pending
                        %td
                          - if check_in.officially_completed?
                            %span.badge.bg-success 
                              ✓
                              %small= check_in.official_check_in_completed_at.strftime('%m/%d/%Y')
                          - else
                            %span.badge.bg-secondary -
            - else
              .alert.alert-info No check-in history found.

        .row.mt-4
          .col-12
            %h6 Edit Assignment
            - if @open_check_in
              = form_with url: organization_person_check_ins_path(current_organization, @person), method: :patch, scope: :check_ins, local: true do |form|
                = form.fields_for :assignment_check_ins, @open_check_in, index: @open_check_in.id do |af|
                  .row
                    .col-12
                      .mb-1
                        Reflect on the past
                    - if current_person == @person
                      .col-md-6
                        .mb-3
                          %label.form-label Actual Energy
                          = af.number_field :actual_energy_percentage, min: 0, max: 100, class: "form-select", placeholder: '0-100%'
                    
                    - if current_person == @person
                      .col-md-6
                        .mb-3
                          %label.form-label Personal Alignment
                          = af.select :employee_personal_alignment, options_for_select([['Love', 'love'], ['Like', 'like'], ['Neutral', 'neutral'], ['Tolerate', 'tolerate']], @open_check_in.employee_personal_alignment), { include_blank: 'Select alignment' }, { class: "form-select" }
                    
                    - if current_person == @person
                      .col-md-6
                        .mb-3
                          %label.form-label My Rating
                          = af.select :employee_rating, assignment_rating_options, { include_blank: 'Select rating' }, { class: "form-select" }
                    
                    - if current_person == @person
                      .col-md-6
                        .mb-3
                          %label.form-label Private Notes
                          = af.text_area :employee_private_notes, rows: 3, class: "form-control", placeholder: "Notes..."
                    
                    - if current_person != @person
                      .col-md-6
                        .mb-3
                          %label.form-label Manager Rating
                          = af.select :manager_rating, assignment_rating_options, { include_blank: 'Select rating' }, { class: "form-select" }
                    
                    - if current_person != @person
                      .col-md-6
                        .mb-3
                          %label.form-label Manager Notes
                          = af.text_area :manager_private_notes, rows: 3, class: "form-control", placeholder: "Notes..."
                    
                    = af.hidden_field :assignment_id, value: @assignment.id
                    
                    .col-12
                      .mb-3
                        - is_complete = (current_person == @person ? @open_check_in.employee_completed? : @open_check_in.manager_completed?)
                        .form-check
                          = af.radio_button :status, 'draft', checked: !is_complete, class: 'form-check-input'
                          = af.label :status_draft, 'Draft', class: 'form-check-label'
                        .form-check
                          = af.radio_button :status, 'complete', checked: is_complete, class: 'form-check-input'
                          = af.label :status_complete, 'Complete', class: 'form-check-label'
                    
                    .col-12.text-end
                      = form.submit "Update Assignment", class: "btn btn-primary me-2"
                      = link_to "Back to All Assignments", organization_person_check_ins_path(current_organization, @person), class: "btn btn-outline-secondary"
