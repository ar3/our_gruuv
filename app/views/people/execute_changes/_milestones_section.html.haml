.card.mb-4
  .card-header
    .d-flex.justify-content-between.align-items-center
      %h5.mb-0 Milestones
      - milestone_changes_count = @current_milestones.count { |milestone| milestone_has_changes?(milestone) }
      - if milestone_changes_count > 0
        %span.badge.bg-warning #{milestone_changes_count} Change#{'s' if milestone_changes_count != 1}
      - else
        %span.badge.bg-success No Changes
  .card-body
    - milestones_with_changes = @current_milestones.select { |milestone| milestone_has_changes?(milestone) }
    - milestones_without_changes = @current_milestones.reject { |milestone| milestone_has_changes?(milestone) }
    
    / Show milestones with changes
    - if milestones_with_changes.any?
      - milestones_with_changes.each do |milestone|
        - proposed_data = maap_snapshot.maap_data['milestones'].find { |m| m['ability_id'] == milestone.ability_id }
        .milestone-change-item.mb-4.p-3.border.rounded
          %h6.mb-3= milestone.ability.name
          
          .table-responsive
            %table.table.table-sm.table-borderless
              %thead
                %tr
                  %th{style: "width: 30%"} Field
                  %th{style: "width: 70%"} Change
              
              %tbody
                - if proposed_data
                  / Milestone Level
                  %tr
                    %td
                      %strong Level
                    %td
                      - current_level = milestone.milestone_level
                      - proposed_level = proposed_data['milestone_level']
                      - if current_level != proposed_level
                        %span.badge.bg-warning.me-2 CHANGED
                        %span.text-muted #{current_level} 
                        %i.bi.bi-arrow-right.mx-1
                        %span.text-primary #{proposed_level}
                      - else
                        %span.text-muted #{current_level} (unchanged)
                  
                  / Certified By
                  %tr
                    %td
                      %strong Certified By
                    %td
                      - current_certified = milestone.certified_by&.display_name || 'Not set'
                      - proposed_certified = proposed_data['certified_by_id'] ? Person.find(proposed_data['certified_by_id']).display_name : 'Not set'
                      - if current_certified != proposed_certified
                        %span.badge.bg-warning.me-2 CHANGED
                        %span.text-muted #{current_certified} 
                        %i.bi.bi-arrow-right.mx-1
                        %span.text-primary #{proposed_certified}
                      - else
                        %span.text-muted #{current_certified} (unchanged)
                  
                  / Attained Date
                  %tr
                    %td
                      %strong Attained Date
                    %td
                      - current_attained = milestone.attained_at&.strftime('%Y-%m-%d') || 'Not set'
                      - proposed_attained = proposed_data['attained_at'] || 'Not set'
                      - if current_attained != proposed_attained
                        %span.badge.bg-warning.me-2 CHANGED
                        %span.text-muted #{current_attained} 
                        %i.bi.bi-arrow-right.mx-1
                        %span.text-primary #{proposed_attained}
                      - else
                        %span.text-muted #{current_attained} (unchanged)
    
    / Collapsible section for milestones without changes
    - if milestones_without_changes.any?
      .accordion#milestonesNoChangesAccordion
        .accordion-item
          %h2.accordion-header#milestonesNoChangesHeader
            %button.accordion-button.collapsed{"aria-controls" => "milestonesNoChangesCollapse", "aria-expanded" => "false", "data-bs-target" => "#milestonesNoChangesCollapse", "data-bs-toggle" => "collapse", :type => "button"}
              %i.bi.bi-chevron-down.me-2
              Milestones with No Changes (#{milestones_without_changes.count})
          .accordion-collapse.collapse#milestonesNoChangesCollapse{"aria-labelledby" => "milestonesNoChangesHeader", "data-bs-parent" => "#milestonesNoChangesAccordion"}
            .accordion-body
              - milestones_without_changes.each do |milestone|
                .milestone-no-change-item.mb-3.p-2.bg-light.rounded
                  %h6= milestone.ability.name
                  %p.mb-0
                    %strong Level: 
                    = milestone.milestone_level
                    %span.text-muted.ms-2 (No changes)