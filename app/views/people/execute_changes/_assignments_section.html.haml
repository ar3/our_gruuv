.card.mb-4
  .card-header
    .d-flex.justify-content-between.align-items-center
      %h5.mb-0 Assignments
      - assignment_changes_count = @assignment_data.count { |data| assignment_has_changes?(data[:assignment]) }
      - if assignment_changes_count > 0
        %span.badge.bg-warning #{assignment_changes_count} Change#{'s' if assignment_changes_count != 1}
      - else
        %span.badge.bg-success No Changes
  .card-body
    - assignments_with_changes = @assignment_data.select { |data| assignment_has_changes?(data[:assignment]) }
    - assignments_without_changes = @assignment_data.reject { |data| assignment_has_changes?(data[:assignment]) }
    
    / Show assignments with changes
    - if assignments_with_changes.any?
      - assignments_with_changes.each do |data|
        - assignment = data[:assignment]
        - current_tenure = data[:active_tenure]
        - proposed_data = maap_snapshot.maap_data['assignments'].find { |a| a['id'] == assignment.id }
        .assignment-change-item.mb-4.p-3.border.rounded
          %h6.mb-3= assignment.title
          .row
            .col-md-6
              %h6.text-muted Current Values
              - if current_tenure
                %p
                  %strong Energy: 
                  = "#{current_tenure.anticipated_energy_percentage}%"
                %p
                  %strong Started: 
                  = current_tenure.started_at.strftime('%m/%d/%Y')
              - else
                %p.text-muted No active tenure
              
            .col-md-6
              %h6.text-primary Proposed Values
              - if proposed_data&.dig('tenure')
                %p
                  %strong Energy: 
                  = "#{proposed_data['tenure']['anticipated_energy_percentage']}%"
                %p
                  %strong Started: 
                  = proposed_data['tenure']['started_at']
              - else
                %p.text-muted No proposed changes
              
              / Show check-in changes if any
              - if proposed_data&.dig('employee_check_in')&.values&.any?(&:present?)
                .mt-3
                  %h6.text-info Employee Check-in Changes
                  - if proposed_data['employee_check_in']['employee_rating'].present?
                    %p
                      %strong Rating: 
                      = proposed_data['employee_check_in']['employee_rating']
                  - if proposed_data['employee_check_in']['actual_energy_percentage'].present?
                    %p
                      %strong Actual Energy: 
                      = "#{proposed_data['employee_check_in']['actual_energy_percentage']}%"
                  - if proposed_data['employee_check_in']['employee_private_notes'].present?
                    %p
                      %strong Private Notes: 
                      = proposed_data['employee_check_in']['employee_private_notes']
              
              - if proposed_data&.dig('manager_check_in')&.values&.any?(&:present?)
                .mt-3
                  %h6.text-warning Manager Check-in Changes
                  - if proposed_data['manager_check_in']['manager_rating'].present?
                    %p
                      %strong Rating: 
                      = proposed_data['manager_check_in']['manager_rating']
                  - if proposed_data['manager_check_in']['manager_private_notes'].present?
                    %p
                      %strong Private Notes: 
                      - if can_see_manager_private_notes?
                        = proposed_data['manager_check_in']['manager_private_notes']
                      - else
                        %span.text-muted [Hidden - Manager Only]
              
              - if proposed_data&.dig('official_check_in')&.values&.any?(&:present?)
                .mt-3
                  %h6.text-success Official Check-in Changes
                  - if proposed_data['official_check_in']['official_rating'].present?
                    %p
                      %strong Rating: 
                      = proposed_data['official_check_in']['official_rating']
                  - if proposed_data['official_check_in']['shared_notes'].present?
                    %p
                      %strong Shared Notes: 
                      = proposed_data['official_check_in']['shared_notes']
    
    / Collapsible section for assignments without changes
    - if assignments_without_changes.any?
      .accordion#assignmentsNoChangesAccordion
        .accordion-item
          %h2.accordion-header#assignmentsNoChangesHeader
            %button.accordion-button.collapsed{"aria-controls" => "assignmentsNoChangesCollapse", "aria-expanded" => "false", "data-bs-target" => "#assignmentsNoChangesCollapse", "data-bs-toggle" => "collapse", :type => "button"}
              %i.bi.bi-chevron-down.me-2
              Assignments with No Changes (#{assignments_without_changes.count})
          .accordion-collapse.collapse#assignmentsNoChangesCollapse{"aria-labelledby" => "assignmentsNoChangesHeader", "data-bs-parent" => "#assignmentsNoChangesAccordion"}
            .accordion-body
              - assignments_without_changes.each do |data|
                - assignment = data[:assignment]
                - current_tenure = data[:active_tenure]
                .assignment-no-change-item.mb-3.p-2.bg-light.rounded
                  %h6= assignment.title
                  - if current_tenure
                    %p.mb-0
                      %strong Energy: 
                      = "#{current_tenure.anticipated_energy_percentage}%"
                      %span.text-muted.ms-2 (No changes)
                  - else
                    %p.text-muted.mb-0 No active tenure