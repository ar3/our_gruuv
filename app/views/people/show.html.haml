.container.mt-4
  .row
    .col-12
      .d-flex.justify-content-between.align-items-center.mb-2
        %h1.mb-0{id: "person-title"}
          - if @person == @current_person
            My Profile
          - else
            = @person.display_name
        .d-flex.align-items-center
          = render 'view_switcher'
      
      .mb-4
        = link_to people_path, class: "text-muted text-decoration-none" do
          %i.bi.bi-arrow-left.me-2
          Back to People
  
  / About Me Section
  .row
    .col-12
      .card.mb-4{ role: "region", "aria-labelledby": "about-me-section" }
        .card-header
          %h5.mb-0{ id: "about-me-section" }
            %i.bi.bi-person.me-2
            About Me
        .card-body
          .row.mt-3
            .col-12.col-md-8
              .row
                .col-md-6.col-12
                  %p
                    %strong Name:
                    = @person.full_name
                  %p
                    %strong Email:
                    = @person.email
                  %p
                    %strong Phone:
                    = @person.unique_textable_phone_number.present? ? @person.unique_textable_phone_number : "Not provided"

                .col-md-6.col-12

                  %p
                    %strong Time zone:
                    - if @person.timezone.present?
                      = @person.timezone
                      %small.text-muted Timezone
                    - else
                      Eastern Time
                      %small.text-muted Timezone (Default)
                  %p
                    %strong Gruuvin' Since:
                    = @person.created_at.strftime("%b %Y")
            .col-md-4.col-12.border-start.border-secondary
              .d-grid.gap-2
                - if @person == @current_person
                  = link_to edit_profile_path, class: "btn btn-primary" do
                    %i.bi.bi-pencil.me-2
                    Edit Profile
  
  
  / Security & Permissions Section
  .row
    .col-12  
      .card.mb-4{ role: "region", "aria-labelledby": "security-section" }
        .card-header
          %h5.mb-0{ id: "security-section" }
            %i.bi.bi-shield-lock.me-2
            Identities
        .card-body
          .row
            .col-md-8
              .table-responsive
                %table.table.table-hover
                  %thead
                    %tr
                      %th Account Type
                      %th Name
                      %th Email
                      %th Status
                      %th Connected
                      %th Actions
                  %tbody
                    - @person.person_identities.each do |identity|
                      %tr
                        %td
                          = identity_profile_image(identity, size: 24)
                          %i{class: "bi #{identity_provider_icon(identity)} me-2"}
                          = identity_provider_name(identity)
                        %td
                          - if identity.name.present?
                            = identity.name
                          - else
                            %span.text-muted Not provided
                        %td= identity.email
                        %td= identity_status_badge(identity)
                        %td= identity.created_at.strftime('%B %d, %Y')
                        %td
                          = disconnect_identity_button(identity)
                      %tr
                        %td{colspan: 6}
                          = identity_raw_data_display(identity)
                      - if @person.person_identities.none?
                        %tr
                          %td{colspan: 6}
                            .text-muted No connected accounts found.
              
            .col-md-4.border-start.border-secondary
              .d-grid.gap-2
                = link_to connect_google_identity_path, class: "btn btn-outline-primary" do
                  %i.bi.bi-google.me-2
                  Connect Google Account
                - if @person.person_identities.any?
                  = link_to "#", class: "btn btn-outline-info" do
                    %i.bi.bi-shield.me-2
                    Security Settings
          
  / Organization Permissions Section
  .row
    .col-12
      .card.mb-4{ role: "region", "aria-labelledby": "permissions-section" }
        .card-header
          %h5.mb-0{ id: "permissions-section" }
            %i.bi.bi-key.me-2
            Organization Permissions for #{current_organization.name}
        .card-body
          .row
            .col-md-8
              - current_access = @person.person_organization_accesses.find_by(organization: current_organization)
              - if current_access
                .table-responsive
                  %table.table.table-hover
                    %thead
                      %tr
                        %th Permission Type
                        %th Status
                        %th Source
                    %tbody
                      %tr
                        %td Employment Management
                        %td
                          - if current_access.can_manage_employment?
                            %span.badge.bg-success ALLOWED
                          - elsif current_access.can_manage_employment.nil?
                            - if current_organization.parent
                              %span.badge.bg-warning INHERITED
                            - else
                              %span.badge.bg-danger BLOCKED
                          - else
                            %span.badge.bg-danger BLOCKED
                        %td
                          - if current_access.can_manage_employment.nil?
                            - if current_organization.parent
                              - parent_access = @person.person_organization_accesses.find_by(organization: current_organization.parent)
                              - if parent_access&.can_manage_employment?
                                %span.text-muted Inherited from #{current_organization.parent.name} (ALLOWED)
                              - else
                                %span.text-muted Inherited from #{current_organization.parent.name} (BLOCKED)
                            - else
                              %span.text-muted No parent organization (BLOCKED)
                          - else
                            %span.text-muted Direct
                      %tr
                        %td Employment Creation
                        %td
                          - if current_access.can_create_employment?
                            %span.badge.bg-success ALLOWED
                          - elsif current_access.can_create_employment.nil?
                            - if current_organization.parent
                              %span.badge.bg-warning INHERITED
                            - else
                              %span.badge.bg-danger BLOCKED
                          - else
                            %span.badge.bg-danger BLOCKED
                        %td
                          - if current_access.can_create_employment.nil?
                            - if current_organization.parent
                              - parent_access = @person.person_organization_accesses.find_by(organization: current_organization.parent)
                              - if parent_access&.can_create_employment?
                                %span.text-muted Inherited from #{current_organization.parent.name} (ALLOWED)
                              - else
                                %span.text-muted Inherited from #{current_organization.parent.name} (BLOCKED)
                            - else
                              %span.text-muted No parent organization (BLOCKED)
                          - else
                            %span.text-muted Direct
                      %tr
                        %td MAAP Management
                        %td
                          - if current_access.can_manage_maap?
                            %span.badge.bg-success ALLOWED
                          - elsif current_access.can_manage_maap.nil?
                            - if current_organization.parent
                              %span.badge.bg-warning INHERITED
                            - else
                              %span.badge.bg-danger BLOCKED
                          - else
                            %span.badge.bg-danger BLOCKED
                        %td
                          - if current_access.can_manage_maap.nil?
                            - if current_organization.parent
                              - parent_access = @person.person_organization_accesses.find_by(organization: current_organization.parent)
                              - if parent_access&.can_manage_maap?
                                %span.text-muted Inherited from #{current_organization.parent.name} (ALLOWED)
                              - else
                                %span.text-muted Inherited from #{current_organization.parent.name} (BLOCKED)
                            - else
                              %span.text-muted No parent organization (BLOCKED)
                          - else
                            %span.text-muted Direct
              - else
                %p.text-muted No permissions set for this organization.
            
            .col-md-4.border-start.border-secondary
              .d-grid.gap-2
                - can_modify = current_person.can_manage_employment?(current_organization)
                - if can_modify
                  - if current_access
                    = link_to edit_organization_person_access_path(current_organization, current_access), class: 'btn btn-warning' do
                      %i.bi.bi-pencil.me-2
                      Modify Permissions
                  - else
                    = link_to new_organization_person_access_path(current_organization), class: 'btn btn-success' do
                      %i.bi.bi-plus.me-2
                      Add Organization Permission
                - else
                  .d-flex.align-items-center.gap-2
                    .flex-grow-1
                      %button.btn.btn-outline-secondary.w-100.disabled{disabled: true}
                        %i.bi.bi-pencil.me-2
                        Modify Permissions
                    %i.bi.bi-exclamation-triangle.text-warning{ data: { bs_toggle: "tooltip", bs_title: "You need employment management permissions in this organization to modify permissions" } }

  / Align Section
  .row.mb-4
    .col-12
      .card.mb-4{ role: "region", "aria-labelledby": "align-section" }
        .card-header
          %h5.mb-0{ id: "align-section" }
            %i.bi.bi-briefcase.me-2
            Align
        .card-body
          :ruby
            current_company = current_organization
            current_tenure = @employment_tenures.find { |t| t.company == current_company && t.active? }
            first_tenure = @employment_tenures.select { |t| t.company == current_company }.sort_by(&:started_at).first
          
          .row
            .col-md-8
              / Position Sub-section
              .align-subsection.mb-4
                %h6.text-muted.border-bottom.pb-2 Position
                - if current_tenure
                  .row
                    .col-md-6
                      %p.mb-1
                        %strong Current Position:
                        %br
                        = current_tenure.position&.display_name || "No position assigned"
                      %p.mb-1
                        %strong Time in Position:
                        %br
                        = distance_of_time_in_words(current_tenure.started_at, Date.current)
                    .col-md-6
                      %p.mb-1
                        %strong Company Tenure:
                        %br
                        = distance_of_time_in_words(first_tenure.started_at, Date.current)
                      %p.mb-1
                        %strong Manager:
                        %br
                        = current_tenure.manager_display || "No manager assigned"
                    .row.mt-3
                      .col-md-6
                        %p.mb-1
                          %strong Tenure Changes:
                          %br
                          %span.text-muted= pluralize(@employment_tenures.select { |t| t.company == current_company }.count, 'tenure')
                      .col-md-6
                        %p.mb-1
                          %strong Position Changes:
                          %br
                          %span.text-muted= pluralize(@employment_tenures.select { |t| t.company == current_company }.map(&:position).compact.uniq.count, 'distinct position')
                - else
                  %p.text-muted No active position in this organization.
              
              / Assignments Sub-section
              .align-subsection.mb-4
                %h6.text-muted.border-bottom.pb-2 Assignments
                - if @person.active_assignments(current_company).any?
                  - @person.active_assignments(current_company).each do |assignment|
                    :ruby
                      assignment_tenure = @person.assignment_tenures.find { |t| t.assignment == assignment && t.active? }
                      first_tenure = @person.assignment_tenures.select { |t| t.assignment == assignment && t.anticipated_energy_percentage&.positive? }.sort_by(&:started_at).first
                      last_check_in = assignment_tenure&.assignment_check_ins&.recent&.first
                    .d-flex.justify-content-between.align-items-center.py-3.border-bottom.border-light
                      .flex-grow-1
                        .container
                          .row
                            .col-md-5.col-10
                              %strong= link_to assignment.title, assignment_path(assignment), class: 'text-decoration-none', target: '_blank'
                            .col-2
                              %small.text-muted (#{assignment_tenure&.anticipated_energy_percentage || 0}%)
                            .col-md-2.col-6
                              %small.text-muted
                                %strong Since:
                                = distance_of_time_in_words(first_tenure&.started_at, Date.current) || "Never"
                            .col-md-3
                              %small.text-muted
                                %strong Last Check-in:
                                = last_check_in&.check_in_started_on&.strftime("%b %d, %Y") || "Never"
                          .row
                            %small.text-muted= assignment.tagline
                - else
                  %p.text-muted No assignments found.
              
              / Abilities & Milestones Sub-section
              .align-subsection.mb-4
                %h6.text-muted.border-bottom.pb-2 Abilities & Milestones
                %p.text-muted 
                  This section will display certifications, achievements, and milestone competencies that have been earned or awarded. 
                  Track professional development and skill advancement over time.
                .mt-3
                  .border.rounded.p-3.bg-light
                    %i.bi.bi-trophy.me-2.text-warning
                    %strong Coming Soon: 
                    Comprehensive milestone and certification tracking system
              
              / Observations Sub-section
              .align-subsection.mb-4
                %h6.text-muted.border-bottom.pb-2 Observations
                %p.text-muted 
                  This section will instill a culture that believes in 360-degree feedback 365 days of the year, because feedback is the best fuel for growth. 
                  Growing in skills, knowledge, and competencies is Gruuvin.
                .mt-3
                  .border.rounded.p-3.bg-light
                    %i.bi.bi-chat-quote.me-2.text-info
                    %strong Coming Soon: 
                    Comprehensive 360-degree feedback and observation system
            
            .col-md-4.border-start.border-secondary
              .d-grid.gap-3
                / Position Actions
                .action-group.d-grid.gap-2
                  - if policy(@person).view_employment_history?
                    = button_to "#", class: 'btn btn-outline-primary w-100', data: { action: 'click->coming-soon#show' } do
                      %i.bi.bi-clock-history.me-2
                      View Employment History
                  - else
                    .d-flex.align-items-center.gap-2
                      .flex-grow-1
                        %button.btn.btn-outline-secondary.w-100.disabled{disabled: true}
                          %i.bi.bi-clock-history.me-2
                          View Employment History
                      %i.bi.bi-exclamation-triangle.text-warning{ data: { bs_toggle: "tooltip", bs_title: "You need employment management permissions or be in the managerial hierarchy to view employment history" } }
                  
                  - if policy(@person).change_employment?
                    = link_to change_person_employment_tenures_path(@person, company_id: current_organization.id), class: 'btn btn-outline-primary w-100' do
                      %i.bi.bi-pencil-square.me-2
                      Update Position/Manager
                  - else
                    .d-flex.align-items-center.gap-2
                      .flex-grow-1
                        %button.btn.btn-outline-secondary.w-100.disabled{disabled: true}
                          %i.bi.bi-pencil-square.me-2
                          Update Position/Manager
                      %i.bi.bi-exclamation-triangle.text-warning{ data: { bs_toggle: "tooltip", bs_title: "You need employment management permissions or be in the managerial hierarchy to update position/manager" } }
                
                / Assignments Actions
                .action-group.d-grid.gap-2
                  - if policy(@person).manage_assignments?
                    = link_to assignments_path, class: 'btn btn-outline-primary w-100' do
                      %i.bi.bi-gear.me-2
                      Manage Assignments
                  - else
                    .d-flex.align-items-center.gap-2
                      .flex-grow-1
                        %button.btn.btn-outline-secondary.w-100.disabled{disabled: true}
                          %i.bi.bi-gear.me-2
                          Manage Assignments
                      %i.bi.bi-exclamation-triangle.text-warning{ data: { bs_toggle: "tooltip", bs_title: "You need both employment management AND MAAP management permissions to manage assignments" } }
                
                / Abilities & Milestones Actions
                .action-group.d-grid.gap-2
                  = button_to "#", class: 'btn btn-outline-info w-100', data: { action: 'click->coming-soon#show' } do
                    %i.bi.bi-eye.me-2
                    View All Milestone Details
                  = button_to "#", class: 'btn btn-outline-success w-100', data: { action: 'click->coming-soon#show' } do
                    %i.bi.bi-trophy.me-2
                    Earn/Grant New Milestone
                
                / Observations Actions
                .action-group.d-grid.gap-2
                  = button_to "#", class: 'btn btn-outline-primary w-100', data: { action: 'click->coming-soon#show' } do
                    %i.bi.bi-eye.me-2
                    View All Observations
                  = button_to "#", class: 'btn btn-outline-warning w-100', data: { action: 'click->coming-soon#show' } do
                    %i.bi.bi-chat-quote.me-2
                    Make an Observation

  / Collaborate Section
  .row.mb-4
    .col-12
      .card.mb-4{ role: "region", "aria-labelledby": "collaborate-section" }
        .card-header
          %h5.mb-0{ id: "collaborate-section" }
            %i.bi.bi-people.me-2
            Collaborate
        .card-body
          .row
            .col-md-8
              / Huddles Sub-section
              .align-subsection.mb-4
                %h6.text-muted.border-bottom.pb-2 Huddles
                - if @person.has_huddle_participation?
                  - @person.huddle_playbook_stats.each do |playbook, participations|
                    - next if playbook.organization.root_company != current_organization
                    - stats = @person.huddle_stats_for_playbook(playbook)
                    .mb-4
                      %h6.mb-3
                        = link_to playbook.display_name, organization_huddle_playbook_path(current_organization, playbook), class: 'text-decoration-none'
                      .row
                        .col-md-4
                          .text-center.p-3.border.rounded.bg-light
                            %h4.mb-1= stats[:participations_count]
                            %small.text-muted
                              = pluralize(stats[:participations_count], 'huddle')
                              %br
                              %span.text-info= stats[:participation_percentage]
                              = "% of huddles held"
                        .col-md-4
                          .text-center.p-3.border.rounded.bg-light
                            %h4.mb-1= stats[:feedback_count]
                            %small.text-muted
                              = pluralize(stats[:feedback_count], 'feedback')
                              %br
                              %span.text-success given
                        .col-md-4
                          .text-center.p-3.border.rounded.bg-light
                            %h4.mb-1= stats[:average_rating]
                            %small.text-muted
                              Average Rating
                              %br
                              %span.text-warning out of 20

                - else
                  %p.text-muted No huddle participation yet.
            
            .col-md-4.border-start.border-secondary
              .d-grid.gap-3
                / Collaborate Actions
                .action-group.d-grid.gap-2
                  = link_to huddles_path, class: 'btn btn-outline-primary w-100' do
                    %i.bi.bi-calendar-event.me-2
                    Today's Huddles
                  = link_to my_huddles_path, class: 'btn btn-outline-info w-100' do
                    %i.bi.bi-chat-heart.me-2
                    My Huddles

:javascript

  // Coming Soon alerts
  document.addEventListener('click', function(e) {
    if (e.target.closest('[data-action*="coming-soon#show"]')) {
      e.preventDefault();
      alert('ðŸš§ Coming Soon! This feature is currently under development.');
    }
  });

:css
  .align-subsection h6 {
    color: #6c757d;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
  }
  
  .action-group {
    padding-bottom: 1.5rem;
  }
  
  .action-group:last-child {
    padding-bottom: 0;
  }
