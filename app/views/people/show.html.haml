.container.mt-4
  .row.justify-content-center
    .col-lg-8
      .card
        .card-header.bg-primary.text-white
          %h3.mb-0
            %i.bi.bi-person-circle.me-2
            - if @person == @current_person
              My Profile
            - else
              = @person.display_name
        
        .card-body
          .row
            .col-md-6
              %h5.text-primary Personal Information
              %p
                %strong Name:
                = @person.full_name
              %p
                %strong Email:
                = @person.email
              - if @person.unique_textable_phone_number.present?
                %p
                  %strong Phone:
                  = @person.unique_textable_phone_number
              %p
                %strong Timezone:
                = @person.timezone.present? ? @person.timezone : 'Not set (using Eastern Time)'
            
            .col-md-6
              %h5.text-primary Account Statistics
              %p
                %strong Huddles Participated:
                = @person.huddles.count
              %p
                %strong Feedback Submitted:
                = @person.huddle_feedbacks.count
              %p
                %strong Member Since:
                = @person.created_at.strftime('%B %d, %Y')
          
          .mt-4
            - if @person == @current_person
              = link_to edit_profile_path, class: "btn btn-primary" do
                %i.bi.bi-pencil.me-2
                Edit Profile

        / Identity Management Section
        - if @person == @current_person
          .card.mt-4
            .card-header.bg-info.text-white
              %h5.mb-0
                %i.bi.bi-shield-lock.me-2
                Connected Accounts
        
          .card-body
            - if @person.person_identities.any?
              .table-responsive
                %table.table.table-hover
                  %thead
                    %tr
                      %th Account Type
                      %th Name
                      %th Email
                      %th Status
                      %th Connected
                      %th Actions
                  %tbody
                    - @person.person_identities.each do |identity|
                      %tr
                        %td
                          = identity_profile_image(identity, size: 24)
                          %i{class: "bi #{identity_provider_icon(identity)} me-2"}
                          = identity_provider_name(identity)
                        %td
                          - if identity.name.present?
                            = identity.name
                          - else
                            %span.text-muted Not provided
                        %td= identity.email
                        %td= identity_status_badge(identity)
                        %td= identity.created_at.strftime('%B %d, %Y')
                        %td
                          = disconnect_identity_button(identity)
                      %tr
                        %td{colspan: 6}
                          = identity_raw_data_display(identity)
            - else
              %p.text-muted No connected accounts found.
            
            -# .mt-3
            -#   = connect_google_button 
          

                / Permissions Section
        - if @person == @current_person && current_organization
          .card.mt-4
            .card-header.bg-warning.text-dark
              %h5.mb-0
                %i.bi.bi-key.me-2
                Organization Permissions for #{current_organization.name}
        
            .card-body
              - current_access = @person.person_organization_accesses.find_by(organization: current_organization)
              - if current_access
                .table-responsive
                  %table.table.table-hover
                    %thead
                      %tr
                        %th Permission Type
                        %th Status
                        %th Actions
                    %tbody
                      %tr
                        %td Employment Management
                        %td
                          - if current_access.can_manage_employment?
                            %span.badge.bg-success Yes
                          - elsif current_access.can_manage_employment.nil?
                            %span.badge.bg-warning Inherited
                          - else
                            %span.badge.bg-secondary No
                        %td
                          = link_to edit_organization_person_access_path(current_organization, current_access), class: 'btn btn-outline-primary btn-sm' do
                            %i.bi.bi-pencil.me-1
                            Edit
                      %tr
                        %td MAAP Management
                        %td
                          - if current_access.can_manage_maap?
                            %span.badge.bg-success Yes
                          - elsif current_access.can_manage_maap.nil?
                            %span.badge.bg-warning Inherited
                          - elsif current_access.can_manage_maap == false
                            %span.badge.bg-secondary No
                          - else
                            %span.badge.bg-secondary No
                        %td
                          = link_to edit_organization_person_access_path(current_organization, current_access), class: 'btn btn-outline-primary btn-sm' do
                            %i.bi.bi-pencil.me-1
                            Edit
                
                .mt-3
                  .d-flex.gap-2
                    = link_to edit_organization_person_access_path(current_organization, current_access), class: 'btn btn-warning' do
                      %i.bi.bi-pencil.me-2
                      Edit Permissions
                    = link_to organization_person_access_path(current_organization, current_access),
                      method: :delete,
                      class: 'btn btn-danger',
                      data: { confirm: 'Are you sure you want to remove this permission?' } do
                      %i.bi.bi-trash.me-2
                      Remove Permission
              - else
                %p.text-muted No permissions set for this organization.
                .mt-3
                  = link_to new_organization_person_access_path(current_organization), class: 'btn btn-success' do
                    %i.bi.bi-plus.me-2
                    Add Organization Permission

        / Employment History Section
        .card.mt-4
          .card-header.bg-success.text-white
            %h5.mb-0
              %i.bi.bi-briefcase.me-2
              Employment History
        
          .card-body
            - if @employment_tenures.any?
              - companies_with_employment = @employment_tenures.map(&:company).uniq
              - companies_with_employment.each do |company|
                .company-employment-group.mb-4
                  %h6.text-primary= company.name
                  
                  - company_tenures = @employment_tenures.select { |t| t.company == company }.sort_by(&:started_at).reverse
                  - active_tenure = company_tenures.find(&:active?)
                  
                  - if active_tenure
                    .active-employment.mb-3
                      .card.border-success
                        .card-body.py-2
                          .row.align-items-center
                            .col-md-8
                              %strong= active_tenure.position.display_name
                              %br
                              %small.text-muted
                                Manager: #{active_tenure.manager_display}
                                %br
                                Started: #{active_tenure.started_at.strftime('%B %d, %Y')}
                            .col-md-4.text-end
                              .btn-group.btn-group-sm
                                = link_to 'View', person_employment_tenure_path(@person, active_tenure), class: 'btn btn-outline-primary btn-sm'
                                - if @person == @current_person
                                  = link_to 'Change Employment', change_person_employment_tenures_path(@person, company_id: company.id), class: 'btn btn-warning btn-sm'
                                  = link_to 'Terminate', edit_person_employment_tenure_path(@person, active_tenure), class: 'btn btn-outline-danger btn-sm'
                  
                  - historical_tenures = company_tenures.reject(&:active?).first(5)
                  - if historical_tenures.any?
                    .historical-employment
                      %small.text-muted Previous positions:
                      %ul.list-unstyled.mb-2
                        - historical_tenures.each do |tenure|
                          %li
                            = link_to tenure.position.display_name, person_employment_tenure_path(@person, tenure), class: 'text-muted'
                            %small.text-muted
                              (#{tenure.started_at.strftime('%b %Y')} - #{tenure.ended_at&.strftime('%b %Y') || 'Present'})
                  
                  - if company_tenures.length > 6
                    .mt-2
                      = link_to "View all history", employment_summary_person_employment_tenure_path(@person, company_tenures.first), class: 'btn btn-sm btn-outline-secondary'
                  
                  .mt-3
                    - if @person == @current_person
                      - if active_tenure
                        = link_to change_person_employment_tenures_path(@person, company_id: company.id), class: 'btn btn-warning btn-sm' do
                          %i.bi.bi-arrow-repeat.me-1
                          Change Employment
                      - else
                        = link_to change_person_employment_tenures_path(@person, company_id: company.id), class: 'btn btn-success btn-sm' do
                          %i.bi.bi-plus.me-1
                          Add Employment
              
              .mt-4
                - if @person == @current_person
                  = link_to new_person_employment_tenure_path(@person), class: 'btn btn-success' do
                    %i.bi.bi-plus.me-2
                    Add Employment at New Company
            - else
              %p.text-muted No employment history found.
              .mt-3
                - if @person == @current_person
                  = link_to new_person_employment_tenure_path(@person), class: 'btn btn-success' do
                    %i.bi.bi-plus.me-2
                    Add Your First Employment Tenure

        / Assignment Management Section
        .card.mt-4
          .card-header.bg-info.text-white
            %h5.mb-0
              %i.bi.bi-list-task.me-2
              Assignment Management
        
          .card-body
            .text-center.py-3
              - if @person == @current_person
                %p.text-muted Manage your assignments and check-ins in one place.
                = link_to person_assignment_tenures_path(@person), class: 'btn btn-info' do
                  %i.bi.bi-gear.me-2
                  Manage Assignments
              - else
                %p.text-muted View assignments and check-ins for this person.
                = link_to person_assignment_tenures_path(@person), class: 'btn btn-info' do
                  %i.bi.bi-gear.me-2
                  View Assignments 