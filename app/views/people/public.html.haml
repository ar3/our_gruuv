- content_for :title, @person&.display_name || "Person"

.container.mt-4
  .row
    .col-12
      .d-flex.justify-content-between.align-items-center.mb-4
        %h1.mb-0.d-flex.align-items-center
          - if @person.latest_profile_image_url
            = image_tag @person.latest_profile_image_url, class: "rounded-circle me-2", style: "width: 48px; height: 48px; object-fit: cover;", alt: @person.display_name
          - else
            %i.bi.bi-person-badge.me-2
          = "#{@person.casual_name}"
        - if current_person && current_organization && current_company_teammate && policy(current_company_teammate).internal?
          - person_teammate = @person.teammates.find_by(organization: current_organization)
          - if person_teammate
            = link_to internal_organization_company_teammate_path(current_organization, person_teammate), class: "btn btn-outline-primary btn-sm" do
              %i.bi.bi-people.me-2
              View Teammate Profile

  .row
    .col-12
      / Public Observations Section
      - if @public_observations&.any?
        .card.mb-4
          .card-header
            %h5.mb-0
              %i.bi.bi-star.me-2
              Public Observations
          .card-body
            %p.text-muted.mb-3
              These are public observations where #{@person.first_name} was recognized.
            - @public_observations.each do |observation|
              .mb-3.pb-3.border-bottom
                .d-flex.justify-content-between.align-items-start
                  .flex-grow-1
                    %p.mb-1
                      = observation.decorate.story_html.html_safe
                    %small.text-muted
                      - if observation.observer
                        Observed by #{observation.observer.preferred_name || observation.observer.first_name}
                      - if observation.observed_at
                        %span.mx-1 â€¢
                        = format_date_in_user_timezone(observation.observed_at)
                  .ms-3
                    - if policy(observation).view_permalink?
                      = link_to observation.decorate.permalink_path, class: "btn btn-sm btn-outline-primary", title: "View permalink" do
                        %i.bi.bi-link-45deg
            - if @public_observations.count > 10
              %p.text-muted.mt-3
                %small Showing all #{@public_observations.count} public observations
      - else
        .card.mb-4
          .card-body
            %p.text-muted.mb-0
              %i.bi.bi-info-circle.me-2
              No public observations yet.

      / Milestones Section
      - if @milestones&.any?
        .card.mb-4
          .card-header
            %h5.mb-0
              %i.bi.bi-trophy.me-2
              Milestones Attained
          .card-body
            %p.text-muted.mb-3
              These are the ability milestones #{@person.first_name} has achieved across all organizations.
            - @milestones.group_by(&:ability).each do |ability, ability_milestones|
              .mb-3.pb-3.border-bottom
                %h6.mb-2
                  = link_to ability.name, organization_public_maap_ability_path(ability.company, ability), class: "text-decoration-none"
                  %small.text-muted.ms-2 (#{ability.company.display_name})
                - ability_milestones.sort_by(&:milestone_level).each do |milestone|
                  .d-flex.justify-content-between.align-items-center.mb-1
                    %div
                      %strong Milestone #{milestone.milestone_level}
                      - if milestone.certifying_teammate
                        %small.text-muted.ms-2
                          Certified by #{milestone.certifying_teammate.person.display_name}
                    %small.text-muted
                      = milestone.attained_at.strftime('%B %Y')
      - else
        .card.mb-4
          .card-body
            %p.text-muted.mb-0
              %i.bi.bi-info-circle.me-2
              No milestones attained yet.
