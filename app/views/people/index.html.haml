.container-fluid
  .row
    .col-12
      %h1 People Index
      %p.text-muted Admin-only view of all people in the system

  .row
    .col-12
      .card
        .card-header
          %h5.card-title.mb-0 People by Company
        .card-body
          - companies = Organization.companies.includes(:employment_tenures, :huddles).order(:name)
          - companies.each do |company|
            .company-group.mb-4
              %h4= company.name
              .table-responsive
                %table.table.table-sm
                  %thead
                    %tr
                      %th Name
                      %th Email
                      %th Position
                      %th Employment Status
                      %th Huddle Count
                      %th Actions
                  %tbody
                    - people_at_company = Person.joins(:employment_tenures).where(employment_tenures: { company: company }).distinct.includes(:employment_tenures, :huddles)
                    - people_at_company.each do |person|
                      - employment = EmploymentTenure.most_recent_for(person, company)
                      - huddle_count = person.huddles.joins(:organization).where(organizations: { id: company.id }).count
                      %tr
                        %td= person.display_name
                        %td= person.email
                        %td
                          - if employment
                            = employment.position.position_type.name
                            %small.text-muted
                              = employment.position.position_level.name
                          - else
                            %span.text-muted No active employment
                        %td
                          - if employment
                            %span.badge.bg-success Active
                          - else
                            %span.badge.bg-secondary Inactive
                        %td
                          = huddle_count
                          - if huddle_count > 0
                            %small.text-muted (#{huddle_count} huddles)
                        %td
                          = link_to "View Profile", person_path(person), class: "btn btn-sm btn-outline-primary"
                          - if employment
                            = link_to "Change Employment", change_person_employment_tenures_path(person, company_id: company.id), class: "btn btn-sm btn-warning ms-1"
                          - else
                            = link_to "Add Employment", change_person_employment_tenures_path(person, company_id: company.id), class: "btn btn-sm btn-success ms-1"
                    - if people_at_company.empty?
                      %tr
                        %td.text-muted{colspan: 6} No people employed at this company

          - if companies.empty?
            .text-center.text-muted
              %p No companies found in the system.
